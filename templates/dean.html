<!DOCTYPE html>
<html lang="tg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–î–µ–∫–∞–Ω ‚Äî –°–∏—Å—Ç–µ–º–∞–∏ –ú–µ—Ö-–º–∞—Ç</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#2563eb;--primary-dark:#1d4ed8;--primary-light:#dbeafe;--primary-xlight:#eff6ff;
  --success:#059669;--success-light:#d1fae5;
  --warning:#d97706;--warning-light:#fef3c7;
  --danger:#dc2626;--danger-light:#fee2e2;
  --purple:#7c3aed;--purple-light:#ede9fe;
  --cyan:#0891b2;--cyan-light:#cffafe;
  --bg:#f0f4ff;--surface:#fff;--surface2:#f8faff;--border:#dde5f7;--border-light:#eef2fb;
  --text:#0f172a;--text-2:#334155;--text-3:#64748b;--text-4:#94a3b8;
  --sidebar-w:260px;--topbar-h:60px;
  --radius:12px;--radius-sm:8px;--radius-lg:16px;
  --shadow-sm:0 1px 4px rgba(37,99,235,.08);
  --shadow:0 4px 16px rgba(37,99,235,.1);
  --tr:all 0.2s cubic-bezier(0.4,0,0.2,1);
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;overflow-x:hidden}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{width:var(--sidebar-w);min-height:100vh;background:var(--surface);border-right:1.5px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:200;transition:transform .3s ease;overflow-y:auto}
.sidebar-logo{padding:1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.75rem;flex-shrink:0}
.logo-icon{width:40px;height:40px;border-radius:10px;overflow:hidden;flex-shrink:0;box-shadow:var(--shadow-sm);border:2px solid var(--border)}
.logo-icon img{width:100%;height:100%;object-fit:cover}
.logo-brand{font-size:.85rem;font-weight:800;color:var(--text)}
.logo-brand span{display:block;font-size:.72rem;font-weight:500;color:var(--text-3);margin-top:1px}
.sidebar-user{padding:1rem 1.25rem;border-bottom:1px solid var(--border);flex-shrink:0}
.u-row{display:flex;align-items:center;gap:.75rem;margin-bottom:.5rem}
.u-avatar{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--purple));display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:800;color:#fff;flex-shrink:0}
.u-name{font-size:.875rem;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.u-sub{font-size:.72rem;color:var(--text-3)}
.badge{display:inline-flex;align-items:center;gap:.25rem;font-size:.7rem;font-weight:600;padding:.2rem .6rem;border-radius:20px}
.badge-blue{background:var(--primary-light);color:var(--primary)}
.badge-green{background:var(--success-light);color:var(--success)}
.sidebar-nav{flex:1;padding:.625rem .75rem}
.nav-sec{font-size:.68rem;font-weight:700;color:var(--text-4);text-transform:uppercase;letter-spacing:.08em;padding:.75rem .75rem .35rem}
.nav-item{display:flex;align-items:center;gap:.625rem;padding:.65rem .875rem;border-radius:var(--radius-sm);font-size:.83rem;font-weight:600;color:var(--text-3);cursor:pointer;transition:var(--tr);text-decoration:none;border:none;background:none;width:100%;text-align:left;margin-bottom:1px}
.nav-item:hover{background:var(--primary-xlight);color:var(--primary)}
.nav-item.active{background:var(--primary-light);color:var(--primary);font-weight:700}
.nav-item svg{width:15px;height:15px;flex-shrink:0}
.sidebar-foot{padding:.875rem .75rem;border-top:1px solid var(--border);flex-shrink:0;display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
.foot-btn{display:flex;align-items:center;justify-content:center;gap:.35rem;padding:.6rem .5rem;border-radius:var(--radius-sm);font-size:.75rem;font-weight:700;font-family:inherit;cursor:pointer;border:1.5px solid var(--border);background:var(--surface2);color:var(--text-2);text-decoration:none;transition:var(--tr)}
.foot-btn:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-xlight)}
.foot-btn.danger{color:var(--danger);border-color:var(--danger-light)}
.foot-btn.danger:hover{background:var(--danger-light)}
.foot-btn svg{width:13px;height:13px}

/* ‚îÄ‚îÄ OVERLAY ‚îÄ‚îÄ */
.overlay{display:none;position:fixed;inset:0;background:rgba(15,23,42,.4);z-index:150;backdrop-filter:blur(2px)}
.overlay.show{display:block}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh;transition:margin .3s ease}
.topbar{height:var(--topbar-h);background:var(--surface);border-bottom:1.5px solid var(--border);display:flex;align-items:center;padding:0 1.5rem;gap:.875rem;position:sticky;top:0;z-index:100;box-shadow:var(--shadow-sm)}
.menu-toggle{display:none;width:36px;height:36px;border:none;background:var(--bg);border-radius:var(--radius-sm);cursor:pointer;align-items:center;justify-content:center;color:var(--text-2);flex-shrink:0}
.menu-toggle svg{width:18px;height:18px}
.topbar-title{font-size:.95rem;font-weight:700;color:var(--text);flex:1}
.topbar-right{display:flex;align-items:center;gap:.625rem}
.topbar-info{font-size:.78rem;color:var(--text-3);background:var(--bg);padding:.35rem .75rem;border-radius:var(--radius-sm);border:1px solid var(--border);display:flex;align-items:center;gap:.4rem}
.content{padding:1.5rem;flex:1}
.section{display:none}
.section.active-section{display:block;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}

/* ‚îÄ‚îÄ PAGE HEADER ‚îÄ‚îÄ */
.ph{margin-bottom:1.25rem;display:flex;align-items:flex-start;justify-content:space-between;gap:.875rem;flex-wrap:wrap}
.ph h1{font-size:1.2rem;font-weight:800;color:var(--text)}
.ph p{font-size:.82rem;color:var(--text-3);margin-top:.2rem}
.ph-actions{display:flex;gap:.625rem;flex-wrap:wrap;flex-shrink:0}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem 1.125rem;border:none;border-radius:var(--radius-sm);font-size:.83rem;font-weight:700;font-family:inherit;cursor:pointer;transition:var(--tr)}
.btn svg{width:14px;height:14px;flex-shrink:0}
.btn-primary{background:var(--primary);color:#fff}
.btn-primary:hover{background:var(--primary-dark);transform:translateY(-1px);box-shadow:0 4px 12px rgba(37,99,235,.3)}
.btn-success{background:var(--success);color:#fff}
.btn-success:hover{background:#047857;transform:translateY(-1px)}
.btn-warning{background:var(--warning);color:#fff}
.btn-warning:hover{background:#b45309;transform:translateY(-1px)}
.btn-danger{background:var(--danger);color:#fff}
.btn-danger:hover{background:#b91c1c}
.btn-purple{background:var(--purple);color:#fff}
.btn-purple:hover{background:#6d28d9}
.btn-ghost{background:transparent;border:1.5px solid var(--border);color:var(--text-2)}
.btn-ghost:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-xlight)}
.btn-sm{padding:.45rem .875rem;font-size:.78rem}
.btn-xs{padding:.3rem .625rem;font-size:.72rem}
.btn:disabled{opacity:.6;cursor:not-allowed;transform:none!important}

/* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:.875rem;margin-bottom:1.25rem}
.kpi{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:1.125rem;display:flex;align-items:center;justify-content:space-between;gap:.875rem;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi.blue::before{background:var(--primary)}.kpi.green::before{background:var(--success)}.kpi.warning::before{background:var(--warning)}.kpi.danger::before{background:var(--danger)}.kpi.purple::before{background:var(--purple)}.kpi.cyan::before{background:var(--cyan)}
.kpi-text p{font-size:.78rem;color:var(--text-3);font-weight:500}
.kpi-text .val{font-size:1.875rem;font-weight:800;color:var(--text);font-family:'JetBrains Mono',monospace;line-height:1;margin-top:.25rem}
.kpi-ico{width:46px;height:46px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.kpi-ico svg{width:20px;height:20px}
.kpi.blue .kpi-ico{background:var(--primary-light);color:var(--primary)}
.kpi.green .kpi-ico{background:var(--success-light);color:var(--success)}
.kpi.warning .kpi-ico{background:var(--warning-light);color:var(--warning)}
.kpi.danger .kpi-ico{background:var(--danger-light);color:var(--danger)}
.kpi.purple .kpi-ico{background:var(--purple-light);color:var(--purple)}
.kpi.cyan .kpi-ico{background:var(--cyan-light);color:var(--cyan)}

/* ‚îÄ‚îÄ PANEL ‚îÄ‚îÄ */
.panel{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:1.125rem}
.panel-head{padding:.875rem 1.125rem;border-bottom:1px solid var(--border-light);display:flex;align-items:center;justify-content:space-between;gap:.875rem;flex-wrap:wrap}
.panel-head h3{font-size:.9rem;font-weight:700;color:var(--text);display:flex;align-items:center;gap:.5rem;margin:0}
.panel-head h3 svg{width:15px;height:15px;color:var(--primary);flex-shrink:0}
.panel-body{padding:1.125rem}

/* ‚îÄ‚îÄ DAILY CONTROL ‚îÄ‚îÄ */
.dc-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:.875rem;margin-bottom:1.25rem}
.dc-card{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:1rem;transition:var(--tr)}
.dc-card:hover{transform:translateY(-2px);box-shadow:var(--shadow)}
.dc-card.completed{border-color:var(--success);background:var(--success-light)}
.dc-card.in-progress{border-color:var(--warning);background:var(--warning-light)}
.dc-card.not-started{border-color:var(--danger-light)}
.dc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:.625rem}
.dc-group{font-size:.9rem;font-weight:800;color:var(--text)}
.dc-badge{font-size:.72rem;font-weight:700;padding:.25rem .625rem;border-radius:20px}
.dc-badge.done{background:var(--success-light);color:var(--success)}
.dc-badge.prog{background:var(--warning-light);color:var(--warning)}
.dc-badge.none{background:var(--danger-light);color:var(--danger)}
.dc-curator{font-size:.78rem;color:var(--text-3);display:flex;align-items:center;gap:.35rem;margin-bottom:.5rem}
.dc-progress{height:6px;background:var(--border);border-radius:6px;overflow:hidden}
.dc-progress-bar{height:100%;border-radius:6px;transition:width .5s ease}
.dc-stats{font-size:.72rem;color:var(--text-3);margin-top:.4rem}

/* ‚îÄ‚îÄ WEEKLY VIEW ‚îÄ‚îÄ */
.wv-table{width:100%;border-collapse:collapse}
.wv-table th{padding:.625rem .875rem;font-size:.72rem;font-weight:700;color:var(--text-3);text-align:left;border-bottom:1.5px solid var(--border);background:var(--surface2);text-transform:uppercase;letter-spacing:.04em}
.wv-table td{padding:.75rem .875rem;border-bottom:1px solid var(--border-light);font-size:.83rem;vertical-align:middle}
.wv-table tr:last-child td{border-bottom:none}
.wv-table tr:hover td{background:var(--primary-xlight)}
.day-dot{display:inline-flex;align-items:center;justify-content:center;width:28px;height:28px;border-radius:6px;font-size:.65rem;font-weight:700;margin:1px}
.day-dot.ok{background:var(--success-light);color:var(--success)}
.day-dot.miss{background:var(--danger-light);color:var(--danger)}
.day-dot.na{background:var(--border);color:var(--text-4)}
.prog-bar{height:8px;background:var(--border);border-radius:8px;overflow:hidden;min-width:80px}
.prog-fill{height:100%;border-radius:8px;transition:width .5s ease;background:linear-gradient(90deg,var(--success),#34d399)}

/* ‚îÄ‚îÄ TABLE GENERAL ‚îÄ‚îÄ */
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch}
table.tbl{width:100%;border-collapse:collapse;min-width:580px}
.tbl thead{background:var(--surface2)}
.tbl th{padding:.625rem .875rem;font-size:.72rem;font-weight:700;color:var(--text-3);text-align:left;border-bottom:1.5px solid var(--border);text-transform:uppercase;letter-spacing:.04em;white-space:nowrap}
.tbl td{padding:.75rem .875rem;border-bottom:1px solid var(--border-light);font-size:.83rem}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:var(--primary-xlight)}
.tbl td.mono{font-family:'JetBrains Mono',monospace;font-size:.8rem}

/* ‚îÄ‚îÄ CHIPS/BADGES ‚îÄ‚îÄ */
.chip{display:inline-flex;align-items:center;gap:.25rem;font-size:.72rem;font-weight:600;padding:.2rem .625rem;border-radius:20px}
.chip-green{background:var(--success-light);color:var(--success)}
.chip-red{background:var(--danger-light);color:var(--danger)}
.chip-warn{background:var(--warning-light);color:var(--warning)}
.chip-blue{background:var(--primary-light);color:var(--primary)}
.chip-purple{background:var(--purple-light);color:var(--purple)}

/* ‚îÄ‚îÄ FILTERS ‚îÄ‚îÄ */
.filters{display:flex;gap:.625rem;flex-wrap:wrap;margin-bottom:1rem;align-items:center}
.finp{padding:.65rem .875rem;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.83rem;color:var(--text);font-family:inherit;outline:none;transition:border-color .2s}
.finp:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.finp::placeholder{color:var(--text-4)}
.finp select{background:var(--surface)}
select.finp{min-width:150px}
.search-finp{flex:1;min-width:200px;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:.75rem center;padding-left:2.5rem}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(15,23,42,.5);z-index:9999;align-items:center;justify-content:center;padding:1rem;backdrop-filter:blur(4px)}
.modal-ov.show{display:flex}
.modal-box{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:1.5rem;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow)}
.modal-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem}
.modal-title h3{font-size:1rem;font-weight:800;color:var(--text)}
.modal-close{width:30px;height:30px;border:none;background:var(--bg);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-3);transition:var(--tr)}
.modal-close:hover{background:var(--danger-light);color:var(--danger)}
.modal-close svg{width:14px;height:14px}
.fg{margin-bottom:.875rem}
.fg label{display:block;font-size:.75rem;font-weight:700;color:var(--text-2);margin-bottom:.375rem;text-transform:uppercase;letter-spacing:.05em}
.fg .finp{width:100%}
.frow2{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
.modal-actions{display:flex;gap:.625rem;margin-top:1.125rem}
.modal-actions .btn{flex:1;justify-content:center}

/* ‚îÄ‚îÄ GRID 2 ‚îÄ‚îÄ */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:1.125rem;margin-bottom:1.125rem}

/* ‚îÄ‚îÄ ALERTS ‚îÄ‚îÄ */
.alert-item{border-radius:var(--radius-sm);padding:.875rem;margin-bottom:.625rem;border-left:4px solid;display:flex;align-items:flex-start;gap:.75rem}
.alert-item.warn-alert{background:var(--warning-light);border-color:var(--warning)}
.alert-item.danger-alert{background:var(--danger-light);border-color:var(--danger)}
.alert-item.info-alert{background:var(--primary-xlight);border-color:var(--primary)}
.alert-icon{width:32px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.alert-icon svg{width:15px;height:15px}
.alert-text h5{font-size:.83rem;font-weight:700;color:var(--text)}
.alert-text p{font-size:.75rem;color:var(--text-2);margin-top:.2rem}
.alert-time{font-size:.7rem;color:var(--text-4);margin-top:.35rem}

/* ‚îÄ‚îÄ LOADING / EMPTY ‚îÄ‚îÄ */
.loading{display:flex;align-items:center;justify-content:center;padding:3rem}
.spinner{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:3rem 1.5rem;color:var(--text-3)}
.empty svg{width:40px;height:40px;margin:0 auto .75rem;display:block;opacity:.25}
.empty p{font-size:.875rem}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast-cnt{position:fixed;top:72px;right:1.25rem;z-index:99999;display:flex;flex-direction:column;gap:.5rem;pointer-events:none}
.toast{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:.7rem 1rem;font-size:.83rem;display:flex;align-items:center;gap:.625rem;box-shadow:var(--shadow);animation:tIn .25s ease;pointer-events:auto;font-weight:600;max-width:320px}
.toast svg{flex-shrink:0;width:15px;height:15px}
.toast.succ{border-color:rgba(5,150,105,.4)}
.toast.succ svg{color:var(--success)}
.toast.err{border-color:rgba(220,38,38,.4)}
.toast.err svg{color:var(--danger)}
.toast.warn{border-color:rgba(217,119,6,.4)}
.toast.warn svg{color:var(--warning)}
@keyframes tIn{from{opacity:0;transform:translateX(15px)}to{opacity:1;transform:none}}

/* ‚îÄ‚îÄ PAGINATION ‚îÄ‚îÄ */
.pager{display:flex;align-items:center;gap:.375rem;flex-wrap:wrap}
.pager-btn{width:32px;height:32px;border:1.5px solid var(--border);border-radius:var(--radius-sm);background:var(--surface);color:var(--text-2);font-size:.8rem;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:var(--tr);font-family:inherit}
.pager-btn:hover{border-color:var(--primary);color:var(--primary)}
.pager-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}

/* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}
  .sidebar.open{transform:translateX(0);box-shadow:var(--shadow)}
  .main{margin-left:0}
  .menu-toggle{display:inline-flex}
  .content{padding:1rem}
  .kpi-grid{grid-template-columns:repeat(2,1fr)}
  .dc-grid{grid-template-columns:1fr}
  .g2{grid-template-columns:1fr}
  .frow2{grid-template-columns:1fr}
  .topbar-info{display:none}
  .toast-cnt{left:.875rem;right:.875rem;top:auto;bottom:.875rem}
}
@media(max-width:480px){
  .content{padding:.875rem}
  .kpi-grid{grid-template-columns:repeat(2,1fr)}
  .ph-actions{width:100%}
  .ph-actions .btn{flex:1;justify-content:center}
}
</style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="logo-icon"><img src="/static/logo.jpg" alt="Logo"></div>
    <div class="logo-brand">–î–µ–∫–∞–Ω<span>–°–∏—Å—Ç–µ–º–∞–∏ –ú–µ—Ö-–º–∞—Ç</span></div>
  </div>
  <div class="sidebar-user">
    <div class="u-row">
      <div class="u-avatar">{{ user.full_name[0].upper() if user.full_name else 'D' }}</div>
      <div style="flex:1;min-width:0">
        <div class="u-name">{{ user.full_name or '–î–µ–∫–∞–Ω' }}</div>
        <div class="u-sub">{{ faculty.name if faculty else '–§–∞–∫—É–ª—Ç–µ—Ç' }}</div>
      </div>
    </div>
    <span class="badge badge-blue">–î–µ–∫–∞–Ω</span>
  </div>
  <nav class="sidebar-nav">
    <div class="nav-sec">–ê—Å–æ—Å”£</div>
    <button class="nav-item active" onclick="showSection('dashboard',this)" id="navDashboard">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      –£–º—É–º”£
    </button>
    <button class="nav-item" onclick="showSection('daily-control',this)" id="navDailyControl">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      –ù–∞–∑–æ—Ä–∞—Ç–∏ —Ä”Ø–∑–æ–Ω–∞
    </button>
    <button class="nav-item" onclick="showSection('weekly',this)" id="navWeekly">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="16" y1="2" x2="16" y2="6"/></svg>
      –ù–∞–∑–æ—Ä–∞—Ç–∏ “≥–∞—Ñ—Ç–∞–∏–Ω–∞
    </button>
    <button class="nav-item" onclick="showSection('analytics',this)" id="navAnalytics">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
      –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
    </button>
    <div class="nav-sec">–ò–¥–æ—Ä–∞–∫—É–Ω”£</div>
    <button class="nav-item" onclick="showSection('curators',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
      –ö—É—Ä–∞—Ç–æ—Ä–æ–Ω
    </button>
    <button class="nav-item" onclick="showSection('groups',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
      –ì—É—Ä”Ø“≥“≥–æ
    </button>
    <button class="nav-item" onclick="showSection('students',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
      –î–æ–Ω–∏—à“∑”Ø—ë–Ω
    </button>
    <button class="nav-item" onclick="showSection('at-risk',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      –•–∞–≤—Ñ–Ω–æ–∫ (NB)
    </button>
    <div class="nav-sec">–°–∏—Å—Ç–µ–º–∞</div>
    <button class="nav-item" onclick="showSection('audit-log',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
      –ê—É–¥–∏—Ç –ª–æ–≥
    </button>
    <button class="nav-item" onclick="showSection('profile',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      –ü—Ä–æ—Ñ–∏–ª
    </button>
  </nav>
  <div class="sidebar-foot">
    <button class="foot-btn" onclick="showSection('change-password',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
      –ü–∞—Ä–æ–ª
    </button>
    <a href="/logout" class="foot-btn danger">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      –•—É—Ä—É“∑
    </a>
  </div>
</aside>

<!-- MAIN -->
<div class="main" id="mainContent">
  <header class="topbar">
    <button class="menu-toggle" onclick="openSidebar()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="topbar-title" id="page-title">–£–º—É–º”£</div>
    <div class="topbar-right">
      <div class="topbar-info">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="12" height="12"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
        {{ faculty.name if faculty else '–§–∞–∫—É–ª—Ç–µ—Ç' }}
      </div>
      <button class="btn btn-ghost btn-sm" onclick="refreshCurrentSection()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="13" height="13" id="refresh-icon"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
      </button>
    </div>
  </header>

  <div class="content">

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <section id="dashboard" class="section active-section">
    <div class="kpi-grid">
      <div class="kpi blue"><div class="kpi-text"><p>–î–æ–Ω–∏—à“∑”Ø—ë–Ω</p><div class="val" id="kpi-students">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg></div></div>
      <div class="kpi green"><div class="kpi-text"><p>–ö—É—Ä–∞—Ç–æ—Ä“≥–æ</p><div class="val" id="kpi-curators">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg></div></div>
      <div class="kpi purple"><div class="kpi-text"><p>–ì—É—Ä”Ø“≥“≥–æ</p><div class="val" id="kpi-groups">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div></div>
      <div class="kpi danger"><div class="kpi-text"><p>–ó–∏—ë–¥–∞ –∞–∑ NB</p><div class="val" id="kpi-high-absence">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/></svg></div></div>
      <div class="kpi warning"><div class="kpi-text"><p>–ò—à—Ç–∏—Ä–æ–∫ –∏–º—Ä”Ø–∑</p><div class="val" id="kpi-attendance">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg></div></div>
    </div>

    <!-- Charts row -->
    <div class="g2">
      <div class="panel">
        <div class="panel-head"><h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>–ò—à—Ç–∏—Ä–æ–∫</h3>
        <div style="display:flex;gap:.375rem">
          <button class="btn btn-sm" id="cBtn-daily" onclick="updateChart('daily')" style="background:var(--primary);color:#fff">–†”Ø–∑</button>
          <button class="btn btn-ghost btn-sm" id="cBtn-weekly" onclick="updateChart('weekly')">“≤–∞—Ñ—Ç–∞</button>
          <button class="btn btn-ghost btn-sm" id="cBtn-monthly" onclick="updateChart('monthly')">–ú–æ“≥</button>
        </div>
        </div>
        <div class="panel-body" style="height:220px"><canvas id="attendanceChart"></canvas></div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/></svg>–û–º–æ—Ä –±–æ –∫—É—Ä—Å“≥–æ</h3></div>
        <div class="panel-body" id="course-stats"><div class="loading"><div class="spinner"></div></div></div>
      </div>
    </div>

    <!-- Top/bottom groups -->
    <div class="g2">
      <div class="panel">
        <div class="panel-head"><h3>üèÜ –¢–û–ü-5 –ë–µ“≥—Ç–∞—Ä–∏–Ω –≥—É—Ä”Ø“≥</h3></div>
        <div class="tw"><table class="tbl" id="top-groups-table"><tbody><tr><td colspan="3" class="loading"><div class="spinner"></div></td></tr></tbody></table></div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>‚ö†Ô∏è –¢–û–ü-5 –ë–∞–¥—Ç–∞—Ä–∏–Ω –≥—É—Ä”Ø“≥</h3></div>
        <div class="tw"><table class="tbl" id="bottom-groups-table"><tbody><tr><td colspan="3" class="loading"><div class="spinner"></div></td></tr></tbody></table></div>
      </div>
    </div>

    <!-- Alerts -->
    <div class="panel">
      <div class="panel-head">
        <h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0"/></svg>–û–≥–æ“≥–∏“≥–æ (<span id="alert-count">0</span>)</h3>
        <button class="btn btn-ghost btn-sm" onclick="loadAlerts()">–ù–∞–≤—Å–æ–∑”£</button>
      </div>
      <div id="alerts-container" class="panel-body" style="max-height:280px;overflow-y:auto"><div class="loading"><div class="spinner"></div></div></div>
    </div>
  </section>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê DAILY CONTROL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <section id="daily-control" class="section">
    <div class="ph">
      <div>
        <h1>‚è∞ –ù–∞–∑–æ—Ä–∞—Ç–∏ —Ä”Ø–∑–æ–Ω–∞</h1>
        <p id="dc-date-label">–í–∞–∑—ä–∏ –∂—É—Ä–Ω–∞–ª–≥—É–∑–æ—Ä”£ –±–∞—Ä–æ–∏ –∏–º—Ä”Ø–∑</p>
      </div>
      <div class="ph-actions">
        <input type="date" class="finp btn-sm" id="dcDate" onchange="loadDailyControl()">
        <button class="btn btn-primary btn-sm" onclick="loadDailyControl()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="13" height="13"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
          –ù–∞–≤—Å–æ–∑”£
        </button>
      </div>
    </div>

    <!-- Summary row -->
    <div class="kpi-grid" id="dc-summary" style="grid-template-columns:repeat(3,1fr);max-width:600px;margin-bottom:1.25rem">
      <div class="kpi green" style="padding:.875rem"><div class="kpi-text"><p>–ü—É—Ä –∫–∞—Ä–¥–∞—à—É–¥–∞</p><div class="val" style="font-size:1.5rem" id="dc-done">‚Äî</div></div></div>
      <div class="kpi warning" style="padding:.875rem"><div class="kpi-text"><p>“∂–∞—Ä–∞—ë–Ω –¥–æ—Ä–∞–¥</p><div class="val" style="font-size:1.5rem" id="dc-prog">‚Äî</div></div></div>
      <div class="kpi danger" style="padding:.875rem"><div class="kpi-text"><p>“ö–∞–π–¥ –Ω–∞—à—É–¥</p><div class="val" style="font-size:1.5rem" id="dc-none">‚Äî</div></div></div>
    </div>

    <div id="dc-loading" class="loading"><div class="spinner"></div></div>
    <div class="dc-grid" id="dc-cards" style="display:none"></div>
  </section>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê WEEKLY CONTROL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <section id="weekly" class="section">
    <div class="ph">
      <div>
        <h1>üìÖ –ù–∞–∑–æ—Ä–∞—Ç–∏ “≥–∞—Ñ—Ç–∞–∏–Ω–∞</h1>
        <p>–í–∞–∑—ä–∏ –∂—É—Ä–Ω–∞–ª–≥—É–∑–æ—Ä”£ –±–∞—Ä–æ–∏ “≥–∞—Ñ—Ç–∞–∏ “∑–æ—Ä”£</p>
      </div>
      <div class="ph-actions">
        <input type="date" class="finp btn-sm" id="wvWeekStart" onchange="loadWeeklyControl()">
        <button class="btn btn-primary btn-sm" onclick="loadWeeklyControl()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="13" height="13"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
          –ù–∞–≤—Å–æ–∑”£
        </button>
      </div>
    </div>
    <div id="wv-loading" class="loading"><div class="spinner"></div></div>
    <div class="panel" id="wv-panel" style="display:none">
      <div class="panel-head">
        <h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="3" y1="10" x2="21" y2="10"/></svg>“≤–∞—Ñ—Ç–∞–≤”£ ‚Äî “≤–∞–º–∞ –≥—É—Ä”Ø“≥“≥–æ</h3>
        <div id="wv-legend" style="display:flex;gap:.625rem;font-size:.72rem;font-weight:600">
          <span style="display:flex;align-items:center;gap:.3rem"><span class="day-dot ok">–î</span>–ü—É—Ä</span>
          <span style="display:flex;align-items:center;gap:.3rem"><span class="day-dot miss">–î</span>–•–æ–ª”£</span>
        </div>
      </div>
      <div class="tw"><table class="wv-table" id="wv-table"><tbody></tbody></table></div>
    </div>
  </section>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ANALYTICS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <section id="analytics" class="section">
    <div class="ph"><div><h1>üìà –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h1><p>–¢–∞“≥–ª–∏–ª–∏ –∞–º–∏“õ–∏ –º–∞—ä–ª—É–º–æ—Ç</p></div></div>
    <div class="g2">
      <div class="panel">
        <div class="panel-head"><h3>–ù–∞–≤–±–∞—Ç 1 –≤–∞ 2</h3></div>
        <div class="panel-body">
          <div style="margin-bottom:1rem">
            <div style="display:flex;justify-content:space-between;margin-bottom:.4rem"><span style="font-size:.83rem;font-weight:600">–ù–∞–≤–±–∞—Ç–∏ 1</span><span id="shift-1-pct" style="font-weight:700">0%</span></div>
            <div class="prog-bar"><div class="prog-fill" id="shift-1-bar" style="width:0"></div></div>
            <div style="font-size:.72rem;color:var(--text-3);margin-top:.25rem" id="shift-1-students">0 –¥–æ–Ω–∏—à“∑”Ø</div>
          </div>
          <div>
            <div style="display:flex;justify-content:space-between;margin-bottom:.4rem"><span style="font-size:.83rem;font-weight:600">–ù–∞–≤–±–∞—Ç–∏ 2</span><span id="shift-2-pct" style="font-weight:700">0%</span></div>
            <div class="prog-bar"><div class="prog-fill" id="shift-2-bar" style="width:0;background:linear-gradient(90deg,var(--primary),#60a5fa)"></div></div>
            <div style="font-size:.72rem;color:var(--text-3);margin-top:.25rem" id="shift-2-students">0 –¥–æ–Ω–∏—à“∑”Ø</div>
          </div>
        </div>
      </div>
      <div class="panel">
        <div class="panel-head"><h3>“≤–∞—Ñ—Ç–∞–∏ –æ—Ö–∏—Ä</h3></div>
        <div class="panel-body" id="weekly-stats"><div class="loading"><div class="spinner"></div></div></div>
      </div>
    </div>
  </section>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CURATORS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <section id="curators" class="section">
    <div class="ph">
      <div><h1>üë®‚Äçüè´ –ö—É—Ä–∞—Ç–æ—Ä–æ–Ω</h1></div>
      <div class="ph-actions">
        <button class="btn btn-primary btn-sm" onclick="openModal('curator-modal')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" width="13" height="13"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          –ö—É—Ä–∞—Ç–æ—Ä–∏ –Ω–∞–≤
        </button>
      </div>
    </div>
    <div class="panel">
      <div class="panel-head"><h3>–†”Ø–π—Ö–∞—Ç–∏ –∫—É—Ä–∞—Ç–æ—Ä–æ–Ω</h3><input type="text" class="finp search-finp" id="curator-search" placeholder="“∂—É—Å—Ç—É“∑”Ø..." oninput="loadCurators()" style="max-width:250px"></div>
      <div class="tw"><table class="tbl">
        <thead><tr><th>#</th><th>–ù–æ–º</th><th>Username</th><th>–ì—É—Ä”Ø“≥</th><th>–¢–µ–ª.</th><th>–í–∞–∑—ä</th><th>–ê–º–∞–ª–∏—ë—Ç</th></tr></thead>
        <tbody id="curators-table"><tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
      </table></div>
    </div>
  </section>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê GROUPS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <section id="groups" class="section">
    <div class="ph">
      <div><h1>üë• –ì—É—Ä”Ø“≥“≥–æ</h1></div>
      <div class="ph-actions">
        <button class="btn btn-primary btn-sm" onclick="openGroupModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" width="13" height="13"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          –ì—É—Ä”Ø“≥–∏ –Ω–∞–≤
        </button>
      </div>
    </div>
    <div class="panel">
      <div class="tw"><table class="tbl">
        <thead><tr><th>#</th><th>–†–∞“õ–∞–º</th><th>–ö—É—Ä—Å</th><th>–ù–∞–≤–±–∞—Ç</th><th>–ö—É—Ä–∞—Ç–æ—Ä</th><th>–î-—ë–Ω</th><th>–ê–º–∞–ª–∏—ë—Ç</th></tr></thead>
        <tbody id="groups-table"><tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
      </table></div>
    </div>
  </section>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STUDENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <section id="students" class="section">
    <div class="ph">
      <div><h1>üéì –î–æ–Ω–∏—à“∑”Ø—ë–Ω</h1></div>
      <div class="ph-actions">
        <button class="btn btn-success btn-sm" onclick="exportData('students')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="13" height="13"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          –≠–∫—Å–ø–æ—Ä—Ç
        </button>
        <button class="btn btn-primary btn-sm" onclick="openStudentModal()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" width="13" height="13"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          –ù–∞–≤
        </button>
      </div>
    </div>
    <div class="panel">
      <div class="panel-head" style="flex-wrap:wrap;gap:.625rem">
        <div class="filters" style="margin:0;flex:1">
          <select class="finp" id="student-filter-group" onchange="loadStudents()" style="min-width:140px"><option value="">“≤–∞–º–∞ –≥—É—Ä”Ø“≥</option></select>
          <select class="finp" id="student-filter-course" onchange="loadStudents()" style="min-width:120px"><option value="">“≤–∞–º–∞ –∫—É—Ä—Å</option><option value="1">1-–∫—É—Ä—Å</option><option value="2">2-–∫—É—Ä—Å</option><option value="3">3-–∫—É—Ä—Å</option><option value="4">4-–∫—É—Ä—Å</option></select>
          <input type="text" class="finp" id="student-filter-birthplace" placeholder="“∂–æ–∏ —Ç–∞–≤–∞–ª–ª—É–¥..." oninput="debounceSearch()" style="min-width:150px">
          <input type="text" class="finp search-finp" id="student-search" placeholder="“∂—É—Å—Ç—É“∑”Ø..." oninput="debounceSearch()" style="flex:1">
        </div>
      </div>
      <div class="tw"><table class="tbl">
        <thead><tr><th><input type="checkbox" id="select-all-header" onchange="toggleAll('student')"></th><th>#</th><th>–ù–æ–º</th><th>–ö–æ–¥</th><th>–ì—É—Ä”Ø“≥</th><th>–ö—É—Ä—Å</th><th>“∂–æ–∏ —Ç–∞–≤.</th><th>NB</th><th>–ê–º–∞–ª–∏—ë—Ç</th></tr></thead>
        <tbody id="students-table"><tr><td colspan="8"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
      </table></div>
      <div style="padding:.875rem 1.125rem;border-top:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:.625rem">
        <div style="font-size:.8rem;color:var(--text-3)">“≤–∞–º–∞–≥”£: <strong id="total-students" style="color:var(--text)">0</strong> –¥–æ–Ω–∏—à“∑”Ø</div>
        <div id="pagination-controls" class="pager"></div>
      </div>
    </div>
  </section>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AT-RISK ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <section id="at-risk" class="section">
    <div class="ph">
      <div><h1>üö® –•–∞–≤—Ñ–Ω–æ–∫ (NB)</h1><p>–î–æ–Ω–∏—à“∑”Ø—ë–Ω–µ –∫–∏ NB –∞–∑ “≥–∞–¥ –∑–∏—ë–¥ –∞—Å—Ç</p></div>
      <div class="ph-actions">
        <button class="btn btn-success btn-sm" onclick="exportData('nb')">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="13" height="13"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          –≠–∫—Å–ø–æ—Ä—Ç NB
        </button>
      </div>
    </div>
    <div class="panel">
      <div class="panel-head">
        <div class="filters" style="margin:0">
          <select class="finp" id="at-risk-filter-group" onchange="loadAtRiskStudents()"><option value="">“≤–∞–º–∞ –≥—É—Ä”Ø“≥</option></select>
          <select class="finp" id="at-risk-filter-course" onchange="loadAtRiskStudents()"><option value="">“≤–∞–º–∞ –∫—É—Ä—Å</option><option value="1">1-–∫—É—Ä—Å</option><option value="2">2-–∫—É—Ä—Å</option><option value="3">3-–∫—É—Ä—Å</option><option value="4">4-–∫—É—Ä—Å</option></select>
        </div>
      </div>
      <div class="tw"><table class="tbl">
        <thead><tr><th>#</th><th>–ù–æ–º</th><th>–ö–æ–¥</th><th>–ì—É—Ä”Ø“≥</th><th>NB</th><th>–¢–µ–ª. –≤–æ–ª–∏–¥–∞–π–Ω</th><th>–ê–º–∞–ª–∏—ë—Ç</th></tr></thead>
        <tbody id="at-risk-table"><tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
      </table></div>
    </div>
  </section>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê AUDIT LOG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <section id="audit-log" class="section">
    <div class="ph"><div><h1>üìã –ê—É–¥–∏—Ç –ª–æ–≥</h1></div></div>
    <div class="panel">
      <div class="panel-head">
        <div class="filters" style="margin:0">
          <select class="finp" id="audit-filter-action"><option value="">“≤–∞–º–∞–∏ –∞–º–∞–ª–∏—ë—Ç“≥–æ</option></select>
          <input type="date" class="finp" id="audit-date">
          <button class="btn btn-primary btn-sm" onclick="loadAuditLog()">“∂—É—Å—Ç—É“∑”Ø</button>
        </div>
      </div>
      <div class="tw"><table class="tbl">
        <thead><tr><th>–°–∞–Ω–∞</th><th>–ö–æ—Ä–±–∞—Ä</th><th>–ê–º–∞–ª–∏—ë—Ç</th><th>–û–±—ä–µ–∫—Ç</th><th>–¢–∞—Ñ—Å–∏–ª–æ—Ç</th></tr></thead>
        <tbody id="audit-table"><tr><td colspan="5"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
      </table></div>
    </div>
  </section>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <section id="profile" class="section">
    <div class="ph"><div><h1>üë§ –ü—Ä–æ—Ñ–∏–ª</h1></div></div>
    <div style="max-width:500px">
      <div class="panel">
        <div class="panel-head"><h3>–ú–∞—ä–ª—É–º–æ—Ç–∏ —à–∞—Ö—Å”£</h3></div>
        <div class="panel-body">
          <form onsubmit="saveProfile(event)">
            <div class="fg"><label>–ù–æ–º—É –Ω–∞—Å–∞–± *</label><input class="finp" id="profile-full-name" value="{{ user.full_name or '' }}" required></div>
            <div class="fg"><label>Email</label><input type="email" class="finp" id="profile-email" value="{{ user.email or '' }}"></div>
            <div class="fg"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input class="finp" id="profile-phone" value="{{ user.phone or '' }}"></div>
            <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center">–°–∞–±—Ç –∫–∞—Ä–¥–∞–Ω</button>
          </form>
        </div>
      </div>
    </div>
  </section>

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHANGE PASSWORD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <section id="change-password" class="section">
    <div class="ph"><div><h1>üîê –ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—Ä–æ–ª</h1></div></div>
    <div style="max-width:400px">
      <div class="panel">
        <div class="panel-body">
          <form action="/dean/change-password" method="post">
            <div class="fg"><label>–ü–∞—Ä–æ–ª–∏ –Ω–∞–≤ (6 —Ä–∞“õ–∞–º)</label><input type="password" class="finp" name="new_password" maxlength="6" pattern="\d{6}" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="letter-spacing:6px;font-size:1.25rem;text-align:center"></div>
            <button type="submit" class="btn btn-warning" style="width:100%;justify-content:center">–ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω</button>
          </form>
        </div>
      </div>
    </div>
  </section>

  </div><!-- /content -->
</div><!-- /main -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- Curator Modal -->
<div class="modal-ov" id="curator-modal">
  <div class="modal-box">
    <div class="modal-title"><h3>üë®‚Äçüè´ –ö—É—Ä–∞—Ç–æ—Ä–∏ –Ω–∞–≤</h3><button class="modal-close" onclick="closeModal('curator-modal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <form id="curator-form" onsubmit="createCurator(event)">
      <div class="fg"><label>–ù–æ–º–∏ –ø—É—Ä—Ä–∞ *</label><input type="text" name="full_name" required class="finp" placeholder="–§–∞–º–∏–ª–∏—è –ù–æ–º"></div>
      <div class="fg"><label>Username *</label><input type="text" name="username" required class="finp" placeholder="username"></div>
      <div class="fg"><label>Email</label><input type="email" name="email" class="finp" placeholder="email@gmail.com"></div>
      <div class="fg"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="text" name="phone" class="finp" placeholder="+992..."></div>
      <div class="modal-actions">
        <button type="submit" class="btn btn-primary">–≠“∑–æ–¥ –∫–∞—Ä–¥–∞–Ω</button>
        <button type="button" class="btn btn-ghost" onclick="closeModal('curator-modal')">–ë–µ–∫–æ—Ä</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Curator Modal -->
<div class="modal-ov" id="edit-curator-modal">
  <div class="modal-box">
    <div class="modal-title"><h3>‚úèÔ∏è –í–∏—Ä–æ–∏—à–∏ –∫—É—Ä–∞—Ç–æ—Ä</h3><button class="modal-close" onclick="closeModal('edit-curator-modal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <form id="edit-curator-form" onsubmit="saveCuratorEdit(event)">
      <input type="hidden" id="edit-curator-id">
      <div class="fg"><label>–ù–æ–º–∏ –ø—É—Ä—Ä–∞ *</label><input type="text" id="edit-curator-full-name" required class="finp"></div>
      <div class="fg"><label>Email</label><input type="email" id="edit-curator-email" class="finp"></div>
      <div class="fg"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="text" id="edit-curator-phone" class="finp"></div>
      <div class="modal-actions">
        <button type="submit" class="btn btn-success">–°–∞–±—Ç</button>
        <button type="button" class="btn btn-ghost" onclick="closeModal('edit-curator-modal')">–ë–µ–∫–æ—Ä</button>
      </div>
    </form>
  </div>
</div>

<!-- Group Modal -->
<div class="modal-ov" id="group-modal">
  <div class="modal-box">
    <div class="modal-title"><h3 id="groupModalTitle">üë• –ì—É—Ä”Ø“≥–∏ –Ω–∞–≤</h3><button class="modal-close" onclick="closeModal('group-modal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <form id="group-form" onsubmit="saveGroup(event)">
      <input type="hidden" id="group-id">
      <div class="fg"><label>–†–∞“õ–∞–º–∏ –≥—É—Ä”Ø“≥ *</label><input type="text" name="number" id="group-number" required class="finp" placeholder="–§–ú-101"></div>
      <div class="frow2">
        <div class="fg"><label>–ö—É—Ä—Å *</label><select name="course_id" id="group-course-select" required class="finp"><option value="">–ò–Ω—Ç–∏—Ö–æ–±...</option></select></div>
        <div class="fg"><label>–ù–∞–≤–±–∞—Ç *</label><select name="shift" id="group-shift" required class="finp"><option value="">–ò–Ω—Ç–∏—Ö–æ–±...</option><option value="1">1-–Ω–∞–≤–±–∞—Ç</option><option value="2">2-–Ω–∞–≤–±–∞—Ç</option></select></div>
      </div>
      <div class="fg"><label>–ö—É—Ä–∞—Ç–æ—Ä</label><select name="curator_id" id="group-curator-select" class="finp"><option value="">–•–æ–ª”£</option></select></div>
      <div class="modal-actions">
        <button type="submit" class="btn btn-primary" id="groupSubmitBtn">–≠“∑–æ–¥</button>
        <button type="button" class="btn btn-ghost" onclick="closeModal('group-modal')">–ë–µ–∫–æ—Ä</button>
      </div>
    </form>
  </div>
</div>

<!-- Student Modal -->
<div class="modal-ov" id="student-modal">
  <div class="modal-box">
    <div class="modal-title"><h3 id="studentModalTitle">üéì –î–æ–Ω–∏—à“∑”Ø–∏ –Ω–∞–≤</h3><button class="modal-close" onclick="closeModal('student-modal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
    <form id="student-form" onsubmit="saveStudent(event)">
      <input type="hidden" id="student-id">
      <div class="fg"><label>–ù–æ–º—É –Ω–∞—Å–∞–± *</label><input type="text" id="s-full-name" required class="finp" placeholder="–§–∞–º–∏–ª–∏—è –ù–æ–º –û—Ç–∞—Å–º"></div>
      <div class="frow2">
        <div class="fg"><label>–ö–æ–¥</label><input type="text" id="s-code" class="finp" placeholder="STU-001"></div>
        <div class="fg"><label>–ì—É—Ä”Ø“≥ *</label><select id="s-group" required class="finp"><option value="">–ò–Ω—Ç–∏—Ö–æ–±...</option></select></div>
      </div>
      <div class="frow2">
        <div class="fg"><label>–°–æ–ª–∏ —Ç–∞–≤–∞–ª–ª—É–¥</label><input type="number" id="s-birth-year" class="finp" min="1990" max="2010"></div>
        <div class="fg"><label>“∂–æ–∏ —Ç–∞–≤–∞–ª–ª—É–¥</label><input type="text" id="s-birth-place" class="finp"></div>
      </div>
      <div class="frow2">
        <div class="fg"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input type="text" id="s-phone" class="finp" placeholder="+992..."></div>
        <div class="fg"><label>–¢–µ–ª. –≤–æ–ª–∏–¥–∞–π–Ω</label><input type="text" id="s-parent-phone" class="finp" placeholder="+992..."></div>
      </div>
      <div class="modal-actions">
        <button type="submit" class="btn btn-primary" id="studentSubmitBtn">–°–∞–±—Ç</button>
        <button type="button" class="btn btn-ghost" onclick="closeModal('student-modal')">–ë–µ–∫–æ—Ä</button>
      </div>
    </form>
  </div>
</div>

<div class="toast-cnt" id="toasts"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
'use strict';
let attendanceChart=null, currentChartMode='daily', currentSection='dashboard';
let searchTimeout=null, currentPage=1;
const pageSize=50;
let allCurators=[], allGroups=[];

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
function openSidebar(){document.getElementById('sidebar').classList.add('open');document.getElementById('overlay').classList.add('show')}
function closeSidebar(){document.getElementById('sidebar').classList.remove('open');document.getElementById('overlay').classList.remove('show')}

/* ‚îÄ‚îÄ NAV ‚îÄ‚îÄ */
const sectionTitles={dashboard:'–£–º—É–º”£','daily-control':'–ù–∞–∑–æ—Ä–∞—Ç–∏ —Ä”Ø–∑–æ–Ω–∞',weekly:'–ù–∞–∑–æ—Ä–∞—Ç–∏ “≥–∞—Ñ—Ç–∞–∏–Ω–∞',analytics:'–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',curators:'–ö—É—Ä–∞—Ç–æ—Ä–æ–Ω',groups:'–ì—É—Ä”Ø“≥“≥–æ',students:'–î–æ–Ω–∏—à“∑”Ø—ë–Ω','at-risk':'–•–∞–≤—Ñ–Ω–æ–∫ (NB)','audit-log':'–ê—É–¥–∏—Ç –ª–æ–≥',profile:'–ü—Ä–æ—Ñ–∏–ª','change-password':'–ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—Ä–æ–ª'};
function showSection(name,el){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active-section'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  document.getElementById(name).classList.add('active-section');
  if(el)el.classList.add('active');
  document.getElementById('page-title').textContent=sectionTitles[name]||name;
  currentSection=name; closeSidebar();
  const loaders={dashboard:loadDashboard,'daily-control':loadDailyControl,weekly:loadWeeklyControl,analytics:loadAnalytics,curators:loadCurators,groups:loadGroups,students:()=>{loadStudents();loadGroupsForFilter();},'at-risk':()=>{loadAtRiskStudents();loadGroupsForFilter();},'audit-log':loadAuditLog};
  if(loaders[name])loaders[name]();
}
function refreshCurrentSection(){
  const icon=document.getElementById('refresh-icon');
  icon.style.animation='spin .7s linear';
  setTimeout(()=>icon.style.animation='',700);
  showSection(currentSection,null);
}

/* ‚îÄ‚îÄ API ‚îÄ‚îÄ */
async function api(url,opts={}){
  const h={};if(!(opts.body instanceof FormData))h['Content-Type']='application/json';
  const r=await fetch(url,{credentials:'same-origin',...opts,headers:{...h,...(opts.headers||{})}});
  if(r.status===401||r.status===403){window.location.href='/login';throw new Error('–°–µ—Å—Å–∏—è —Ç–∞–º–æ–º —à—É–¥');}
  if(!r.ok){let m='–•–∞—Ç–æ–≥”£';try{const e=await r.json();m=e.detail||m;}catch(e){}throw new Error(m);}
  return r.json();
}
function fmt(d){if(!d)return'‚Äî';try{return new Date(d).toLocaleString('ru-RU',{day:'2-digit',month:'2-digit',year:'numeric',hour:'2-digit',minute:'2-digit'});}catch{return d;}}
function debounceSearch(){clearTimeout(searchTimeout);searchTimeout=setTimeout(()=>{currentPage=1;loadStudents();},500);}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
function openModal(id){document.getElementById(id).classList.add('show')}
function closeModal(id){document.getElementById(id).classList.remove('show')}
document.querySelectorAll('.modal-ov').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('show')}));

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
function toast(type,msg){
  const c=document.getElementById('toasts');const el=document.createElement('div');el.className=`toast ${type}`;
  const icons={succ:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>`,err:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>`,warn:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/></svg>`};
  el.innerHTML=`${icons[type]||icons.err}${msg}`;c.appendChild(el);setTimeout(()=>el.remove(),3500);
}

/* ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ */
async function loadDashboard(){
  try{const d=await api('/dean/api/stats');
    document.getElementById('kpi-students').textContent=d.total_students||0;
    document.getElementById('kpi-curators').textContent=d.total_curators||0;
    document.getElementById('kpi-groups').textContent=d.total_groups||0;
    document.getElementById('kpi-high-absence').textContent=d.high_absence_count||0;
    document.getElementById('kpi-attendance').textContent=(d.attendance_rate||0)+'%';
    if(d.shift_stats){
      document.getElementById('shift-1-pct').textContent=(d.shift_stats.shift1?.attendance_rate||0)+'%';
      document.getElementById('shift-2-pct').textContent=(d.shift_stats.shift2?.attendance_rate||0)+'%';
      document.getElementById('shift-1-bar').style.width=(d.shift_stats.shift1?.attendance_rate||0)+'%';
      document.getElementById('shift-2-bar').style.width=(d.shift_stats.shift2?.attendance_rate||0)+'%';
      document.getElementById('shift-1-students').textContent=(d.shift_stats.shift1?.total_students||0)+' –¥–æ–Ω–∏—à“∑”Ø';
      document.getElementById('shift-2-students').textContent=(d.shift_stats.shift2?.total_students||0)+' –¥–æ–Ω–∏—à“∑”Ø';
    }
    if(d.course_stats){
      const cs=document.getElementById('course-stats');
      cs.innerHTML=d.course_stats.map(c=>`<div style="margin-bottom:.875rem"><div style="display:flex;justify-content:space-between;margin-bottom:.3rem"><span style="font-size:.83rem;font-weight:600">${c.course_year}-–∫—É—Ä—Å</span><span style="font-size:.83rem;font-weight:700;color:var(--primary)">${c.attendance_rate||0}%</span></div><div class="prog-bar"><div class="prog-fill" style="width:${c.attendance_rate||0}%"></div></div><div style="font-size:.72rem;color:var(--text-3);margin-top:.2rem">${c.total_students||0} –¥–æ–Ω–∏—à“∑”Ø ¬∑ ${c.groups||0} –≥—É—Ä”Ø“≥</div></div>`).join('');
    }
    renderTopGroups(d.top_groups||[],d.bottom_groups||[]);
  }catch(e){toast('err',e.message);}
  loadAlerts();
  updateChart('daily');
}

function renderTopGroups(top,bot){
  const render=(arr,id,isTop)=>{
    const el=document.getElementById(id);
    if(!arr.length){el.innerHTML='<tr><td colspan="3"><div class="empty"><p>–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</p></div></td></tr>';return;}
  };
  render(top,'top-groups-table',true);render(bot,'bottom-groups-table',false);
}

async function loadAlerts(){
  try{const d=await api('/dean/api/alerts');
    document.getElementById('alert-count').textContent=d.length||0;
    const c=document.getElementById('alerts-container');
    if(!d.length){c.innerHTML='<div class="empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polyline points="20 6 9 17 4 12"/></svg><p>–û–≥–æ“≥–∏“≥–æ–∏ –Ω–∞–≤ –Ω–µ—Å—Ç</p></div>';return;}
    const cls={WARNING:'warn-alert',HIGH_ABSENCE:'danger-alert',INFO:'info-alert'};
    c.innerHTML=d.map(a=>`<div class="alert-item ${cls[a.alert_type]||'info-alert'}"><div class="alert-text"><h5>${a.message||'–û–≥–æ“≥”£'}</h5><div class="alert-time">${fmt(a.created_at)}</div></div></div>`).join('');
  }catch(e){}
}

async function updateChart(mode){
  currentChartMode=mode;
  ['daily','weekly','monthly'].forEach(m=>{
    const b=document.getElementById(`cBtn-${m}`);if(!b)return;
    b.className=m===mode?'btn btn-sm btn-primary':'btn btn-ghost btn-sm';
  });
  try{const d=await api(`/dean/api/attendance?mode=${mode}`);
    const ctx=document.getElementById('attendanceChart').getContext('2d');
    if(attendanceChart)attendanceChart.destroy();
    attendanceChart=new Chart(ctx,{type:'line',data:{labels:d.labels||[],datasets:[{label:'–ù–ë',data:d.values||[],borderColor:'var(--primary)',backgroundColor:'rgba(37,99,235,.1)',fill:true,tension:0.4,borderWidth:2,pointBackgroundColor:'var(--primary)',pointRadius:4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,grid:{color:'var(--border-light)'},ticks:{color:'var(--text-3)',font:{size:11}}},x:{grid:{display:false},ticks:{color:'var(--text-3)',font:{size:11}}}}}});
  }catch(e){}
}

/* ‚îÄ‚îÄ DAILY CONTROL ‚îÄ‚îÄ */
async function loadDailyControl(){
  const dc=document.getElementById('dcDate');
  if(!dc.value){dc.value=new Date().toISOString().split('T')[0];}
  const date=dc.value;
  document.getElementById('dc-loading').style.display='flex';
  document.getElementById('dc-cards').style.display='none';
  document.getElementById('dc-date-label').textContent=`–í–∞–∑—ä–∏ –∂—É—Ä–Ω–∞–ª–≥—É–∑–æ—Ä”£: ${new Date(date+'T00:00:00').toLocaleDateString('tg-TJ',{weekday:'long',day:'numeric',month:'long'})}`;
  try{
    const d=await api(`/dean/api/daily-control?target_date=${date}`);
    const groups=d.groups||d||[];
    const done=groups.filter(g=>g.status==='COMPLETED').length;
    const prog=groups.filter(g=>g.status==='IN_PROGRESS').length;
    const none=groups.filter(g=>g.status==='NOT_STARTED').length;
    document.getElementById('dc-done').textContent=done;
    document.getElementById('dc-prog').textContent=prog;
    document.getElementById('dc-none').textContent=none;
    const cards=document.getElementById('dc-cards');
    if(!groups.length){cards.innerHTML='<div class="empty"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><p>–ì—É—Ä”Ø“≥ —ë—Ñ—Ç –Ω–∞—à—É–¥</p></div>';cards.style.display='block';}
    else{
      cards.innerHTML=groups.map(g=>{
        const sc=g.status==='COMPLETED'?'completed':g.status==='IN_PROGRESS'?'in-progress':'not-started';
        const bc=g.status==='COMPLETED'?'done':g.status==='IN_PROGRESS'?'prog':'none';
        const blab=g.status==='COMPLETED'?'‚úÖ –ü—É—Ä':'‚è≥ “∂–∞—Ä–∞—ë–Ω –¥–æ—Ä–∞–¥';
        const blab2=g.status==='NOT_STARTED'?'‚ùå “ö–∞–π–¥ –Ω–∞—à—É–¥':blab;
        const pct=g.completion_percentage||Math.round((g.marked||g.marked_count||0)/Math.max(g.total_students||1,1)*100);
        return`<div class="dc-card ${sc}"><div class="dc-header"><span class="dc-group">–ì—É—Ä”Ø“≥ ${g.group_number||g.group||''}</span><span class="dc-badge ${bc}">${blab2}</span></div><div class="dc-curator"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="12" height="12"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>${g.curator_name||'–ö—É—Ä–∞—Ç–æ—Ä —Ç–∞—ä–∏–Ω –Ω–∞—à—É–¥'}</div><div class="dc-progress"><div class="dc-progress-bar" style="width:${pct}%;background:${pct>=100?'var(--success)':pct>0?'var(--warning)':'var(--danger)'}"></div></div><div class="dc-stats">${g.marked||g.marked_count||0} / ${g.total_students||0} –¥–æ–Ω–∏—à“∑”Ø “õ–∞–π–¥ —à—É–¥ ¬∑ ${pct}%</div></div>`;
      }).join('');
      cards.style.display='grid';
    }
    document.getElementById('dc-loading').style.display='none';
  }catch(e){document.getElementById('dc-loading').innerHTML=`<div class="empty"><p>${e.message}</p></div>`;}
}

/* ‚îÄ‚îÄ WEEKLY CONTROL ‚îÄ‚îÄ */
async function loadWeeklyControl(){
  const ws=document.getElementById('wvWeekStart');
  if(!ws.value){
    const d=new Date();const day=d.getDay()||7;d.setDate(d.getDate()-day+1);
    ws.value=d.toISOString().split('T')[0];
  }
  document.getElementById('wv-loading').style.display='flex';
  document.getElementById('wv-panel').style.display='none';
  try{
    const d=await api(`/dean/api/weekly-control?week_start=${ws.value}`);
    const groups=d.groups||[];
    const days=d.days||[];  // array of date strings e.g. ["2026-02-23", ...]
    const dayLabels=['–î—à','–ï—Å','–ß–∞','–ü—à','“∂–º','–®–±'];
    const tbl=document.getElementById('wv-table');
    let th=`<thead><tr><th>–ì—É—Ä”Ø“≥</th><th>–ö—É—Ä–∞—Ç–æ—Ä</th>`;
    days.forEach((day,i)=>{
      const short=typeof day==='string'?day.slice(5):(dayLabels[i]||i+1);
      th+=`<th>${short}</th>`;
    });
    th+=`<th>–ü—É—Ä—Å–æ–∑”£</th></tr></thead><tbody>`;
    let tbody='';
    groups.forEach(g=>{
      const daysObj=g.days||{};  // {date_str: {status, marked, total}}
      const pct=g.completion_pct||0;
      tbody+=`<tr><td><strong>–ì—É—Ä”Ø“≥ ${g.group_number||''}</strong></td><td style="color:var(--text-3)">${g.curator_name||'‚Äî'}</td>`;
      days.forEach(dayStr=>{
        const info=daysObj[dayStr]||{status:'NOT_STARTED'};
        const cls=info.status==='COMPLETED'?'ok':info.status==='IN_PROGRESS'?'na':'miss';
        const lbl=info.status==='COMPLETED'?'‚úì':'‚úó';
        tbody+=`<td><span class="day-dot ${cls}" title="${info.marked||0}/${info.total||0}">${lbl}</span></td>`;
      });
      tbody+=`<td><div class="prog-bar" style="min-width:60px"><div class="prog-fill" style="width:${pct}%"></div></div><div style="font-size:.68rem;color:var(--text-3);margin-top:.2rem">${pct}%</div></td></tr>`;
    });
    if(!groups.length)tbody='<tr><td colspan="'+(days.length+3)+'"><div class="empty"><p>–ì—É—Ä”Ø“≥ —ë—Ñ—Ç –Ω–∞—à—É–¥</p></div></td></tr>';
    tbl.innerHTML=th+tbody+'</tbody>';
    document.getElementById('wv-loading').style.display='none';
    document.getElementById('wv-panel').style.display='block';
  }catch(e){document.getElementById('wv-loading').innerHTML=`<div class="empty"><p>${e.message}</p></div>`;}
}

/* ‚îÄ‚îÄ ANALYTICS ‚îÄ‚îÄ */
async function loadAnalytics(){
  try{const d=await api('/dean/api/stats');
    if(d.shift_stats){
      const s1=d.shift_stats.shift1||{};const s2=d.shift_stats.shift2||{};
      document.getElementById('shift-1-pct').textContent=(s1.attendance_rate||0)+'%';
      document.getElementById('shift-2-pct').textContent=(s2.attendance_rate||0)+'%';
      document.getElementById('shift-1-bar').style.width=(s1.attendance_rate||0)+'%';
      document.getElementById('shift-2-bar').style.width=(s2.attendance_rate||0)+'%';
      document.getElementById('shift-1-students').textContent=(s1.total_students||0)+' –¥–æ–Ω–∏—à“∑”Ø';
      document.getElementById('shift-2-students').textContent=(s2.total_students||0)+' –¥–æ–Ω–∏—à“∑”Ø';
    }
  }catch(e){}
  try{const d=await api('/dean/api/weekly-stats');
    const el=document.getElementById('weekly-stats');
    el.innerHTML=(d||[]).map(w=>`<div style="display:flex;justify-content:space-between;padding:.5rem 0;border-bottom:1px solid var(--border-light)"><span style="font-size:.83rem">${w.week||w.date||'‚Äî'}</span><span style="font-size:.83rem;font-weight:700;color:var(--primary)">${w.avg_nb||w.value||0} –ù–ë</span></div>`).join('')||'<div class="empty"><p>–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</p></div>';
  }catch(e){document.getElementById('weekly-stats').innerHTML='<div class="empty"><p>–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</p></div>';}
}

/* ‚îÄ‚îÄ CURATORS ‚îÄ‚îÄ */
async function loadCurators(){
  const search=(document.getElementById('curator-search')?.value||'').toLowerCase();
  try{const d=await api('/dean/api/curators');allCurators=d;
    const filtered=search?d.filter(c=>c.full_name?.toLowerCase().includes(search)||c.username?.toLowerCase().includes(search)):d;
    const tb=document.getElementById('curators-table');
    if(!filtered.length){tb.innerHTML=`<tr><td colspan="7"><div class="empty"><p>–ö—É—Ä–∞—Ç–æ—Ä —ë—Ñ—Ç –Ω–∞—à—É–¥</p></div></td></tr>`;return;}
    tb.innerHTML=filtered.map((c,i)=>`<tr>
      <td class="mono">${i+1}</td>
      <td><strong>${c.full_name||'‚Äî'}</strong></td>
      <td class="mono">${c.username||'‚Äî'}</td>
      <td>${c.group?.number||'‚Äî'}</td>
      <td>${c.phone||'‚Äî'}</td>
      <td><span class="chip ${c.is_active!==false?'chip-green':'chip-red'}">${c.is_active!==false?'–§–∞—ä–æ–ª':'“í–∞–π—Ä–∏—Ñ–∞—ä–æ–ª'}</span></td>
      <td style="display:flex;gap:.375rem">
        <button class="btn btn-primary btn-xs" onclick="editCurator(${c.id})">‚úèÔ∏è</button>
        <button class="btn btn-warning btn-xs" onclick="resetCuratorPwd(${c.id},'${c.full_name||''}')">üîë</button>
        <button class="btn btn-danger btn-xs" onclick="deleteCurator(${c.id})">üóë</button>
      </td>
    </tr>`).join('');
  }catch(e){toast('err',e.message);}
}
async function createCurator(e){e.preventDefault();
  const fd=new FormData(e.target);
  try{await api('/dean/api/curators',{method:'POST',body:fd});toast('succ','‚úÖ –ö—É—Ä–∞—Ç–æ—Ä —ç“∑–æ–¥ —à—É–¥');closeModal('curator-modal');e.target.reset();loadCurators();}
  catch(err){toast('err',err.message);}
}
function editCurator(id){
  const c=allCurators.find(x=>x.id===id);if(!c)return;
  document.getElementById('edit-curator-id').value=id;
  document.getElementById('edit-curator-full-name').value=c.full_name||'';
  document.getElementById('edit-curator-email').value=c.email||'';
  document.getElementById('edit-curator-phone').value=c.phone||'';
  openModal('edit-curator-modal');
}
async function saveCuratorEdit(e){e.preventDefault();
  const id=document.getElementById('edit-curator-id').value;
  const fd=new FormData(e.target);
  try{await api(`/dean/api/curators/${id}`,{method:'PUT',body:fd});toast('succ','‚úÖ –°–∞–±—Ç —à—É–¥');closeModal('edit-curator-modal');loadCurators();}
  catch(err){toast('err',err.message);}
}
async function resetCuratorPwd(id,name){
  if(!confirm(`"${name}" –ø–∞—Ä–æ–ª–∏ –Ω–∞–≤—Ä–æ –±–∞ ${id}020304 —Ä–µ—Å–µ—Ç –º–µ–∫—É–Ω–µ–º?`))return;
  try{await api(`/dean/api/curators/${id}/reset-password`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})});toast('succ','üîë –ü–∞—Ä–æ–ª —Ä–µ—Å–µ—Ç —à—É–¥');}
  catch(e){toast('err',e.message);}
}
async function deleteCurator(id){
  if(!confirm('–ö—É—Ä–∞—Ç–æ—Ä –Ω–µ—Å—Ç –∫–∞—Ä–¥–∞ —à–∞–≤–∞–¥?'))return;
  try{await api(`/dean/api/curators/${id}`,{method:'DELETE'});toast('succ','üóë –ù–µ—Å—Ç —à—É–¥');loadCurators();}
  catch(e){toast('err',e.message);}
}

/* ‚îÄ‚îÄ GROUPS ‚îÄ‚îÄ */
async function loadGroups(){
  try{const d=await api('/dean/api/groups');allGroups=d;
    const tb=document.getElementById('groups-table');
    if(!d.length){tb.innerHTML='<tr><td colspan="7"><div class="empty"><p>–ì—É—Ä”Ø“≥ –Ω–µ—Å—Ç</p></div></td></tr>';return;}
    tb.innerHTML=d.map((g,i)=>`<tr>
      <td class="mono">${i+1}</td>
      <td><strong>${g.number||'‚Äî'}</strong></td>
      <td><span class="chip chip-blue">${g.course_year||'?'}-–∫—É—Ä—Å</span></td>
      <td>${g.shift}-–Ω–∞–≤–±–∞—Ç</td>
      <td>${g.curator_name||'‚Äî'}</td>
      <td class="mono">${g.total_students||g.student_count||0}</td>
      <td style="display:flex;gap:.375rem">
        <button class="btn btn-primary btn-xs" onclick="editGroup(${g.id})">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-xs" onclick="deleteGroup(${g.id})">üóë</button>
      </td>
    </tr>`).join('');
  }catch(e){toast('err',e.message);}
}
async function openGroupModal(id){
  document.getElementById('group-id').value=id||'';
  document.getElementById('groupModalTitle').textContent=id?'‚úèÔ∏è –¢–∞“≥—Ä–∏—Ä–∏ –≥—É—Ä”Ø“≥':'üë• –ì—É—Ä”Ø“≥–∏ –Ω–∞–≤';
  document.getElementById('groupSubmitBtn').textContent=id?'–°–∞–±—Ç':'–≠“∑–æ–¥';
  // Fill curators
  const cs=document.getElementById('group-curator-select');
  cs.innerHTML='<option value="">–•–æ–ª”£</option>';
  try{const curators=allCurators.length?allCurators:await api('/dean/api/curators');
    curators.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=c.full_name;cs.appendChild(o);});
  }catch(e){}
  // Fill courses
  try{const courses=await api('/dean/api/courses');
    const cs2=document.getElementById('group-course-select');cs2.innerHTML='<option value="">–ò–Ω—Ç–∏—Ö–æ–±...</option>';
    courses.forEach(c=>{const o=document.createElement('option');o.value=c.id;o.textContent=`${c.year}-–∫—É—Ä—Å`;cs2.appendChild(o);});
  }catch(e){}
  if(id){const g=allGroups.find(x=>x.id===id);if(g){document.getElementById('group-number').value=g.number||'';document.getElementById('group-shift').value=g.shift||'';}}
  openModal('group-modal');
}
function editGroup(id){openGroupModal(id);}
async function saveGroup(e){e.preventDefault();
  const id=document.getElementById('group-id').value;const isNew=!id;
  const fd=new FormData(e.target);
  try{await api(isNew?'/dean/api/groups':`/dean/api/groups/${id}`,{method:isNew?'POST':'PUT',body:fd});
    toast('succ',isNew?'‚úÖ –ì—É—Ä”Ø“≥ —ç“∑–æ–¥ —à—É–¥':'‚úÖ –°–∞–±—Ç —à—É–¥');closeModal('group-modal');loadGroups();}
  catch(err){toast('err',err.message);}
}
async function deleteGroup(id){
  if(!confirm('–ì—É—Ä”Ø“≥ –Ω–µ—Å—Ç –∫–∞—Ä–¥–∞ —à–∞–≤–∞–¥?'))return;
  try{await api(`/dean/api/groups/${id}`,{method:'DELETE'});toast('succ','üóë –ù–µ—Å—Ç —à—É–¥');loadGroups();}
  catch(e){toast('err',e.message);}
}

/* ‚îÄ‚îÄ STUDENTS ‚îÄ‚îÄ */
async function loadGroupsForFilter(){
  try{const d=await api('/dean/api/groups');
    const opts=d.map(g=>`<option value="${g.id}">–ì—É—Ä”Ø“≥ ${g.number}</option>`).join('');
    ['student-filter-group','at-risk-filter-group'].forEach(id=>{const el=document.getElementById(id);if(el){const cur=el.value;el.innerHTML='<option value="">“≤–∞–º–∞ –≥—É—Ä”Ø“≥</option>'+opts;el.value=cur;}});
  }catch(e){}
}
async function loadStudents(){
  const group=document.getElementById('student-filter-group')?.value||'';
  const course=document.getElementById('student-filter-course')?.value||'';
  const search=document.getElementById('student-search')?.value||'';
  const birthplace=document.getElementById('student-filter-birthplace')?.value||'';
  const params=new URLSearchParams();
  if(group)params.append('group_id',group);
  if(course)params.append('course',course);
  if(search)params.append('search',search);
  if(birthplace)params.append('birth_place',birthplace);
  params.append('page',currentPage);params.append('page_size',pageSize);
  try{const d=await api(`/dean/api/students?${params}`);
    const students=d.students||d||[];const total=d.total||students.length;
    const nb_lim=d.nb_limit||35;
    document.getElementById('total-students').textContent=total;
    const tb=document.getElementById('students-table');
    if(!students.length){tb.innerHTML='<tr><td colspan="9"><div class="empty"><p>–î–æ–Ω–∏—à“∑”Ø —ë—Ñ—Ç –Ω–∞—à—É–¥</p></div></td></tr>';return;}
    tb.innerHTML=students.map((s,i)=>`<tr>
      <td><input type="checkbox" class="student-cb" value="${s.id}"></td>
      <td class="mono">${(currentPage-1)*pageSize+i+1}</td>
      <td><strong>${s.full_name||'‚Äî'}</strong></td>
      <td class="mono">${s.student_code||'‚Äî'}</td>
      <td>${s.group_number||'‚Äî'}</td>
      <td>${s.course_year||'‚Äî'}</td>
      <td style="font-size:.78rem;color:var(--text-3)">${s.birth_place||'‚Äî'}</td>
      <td><span class="chip ${(s.total_absent_hours||0)>=nb_lim?'chip-red':(s.total_absent_hours||0)>=20?'chip-warn':'chip-green'}">${s.total_absent_hours||0}</span></td>
      <td style="display:flex;gap:.375rem">
        <button class="btn btn-primary btn-xs" onclick="editStudent(${s.id})">‚úèÔ∏è</button>
        <button class="btn btn-danger btn-xs" onclick="deleteStudent(${s.id})">üóë</button>
      </td>
    </tr>`).join('');
    const pages=Math.ceil(total/pageSize);
    const pc=document.getElementById('pagination-controls');pc.innerHTML='';
    for(let p=1;p<=Math.min(pages,10);p++){const b=document.createElement('button');b.className=`pager-btn${p===currentPage?' active':''}`;b.textContent=p;b.onclick=()=>{currentPage=p;loadStudents();};pc.appendChild(b);}
  }catch(e){toast('err',e.message);}
}
function toggleAll(type){const cbs=document.querySelectorAll(`.${type}-cb`);const all=document.getElementById(`select-all-${type==='student'?'header':'header'}`);cbs.forEach(cb=>cb.checked=all.checked);}
function openStudentModal(id){
  document.getElementById('student-id').value=id||'';
  document.getElementById('studentModalTitle').textContent=id?'‚úèÔ∏è –¢–∞“≥—Ä–∏—Ä–∏ –¥–æ–Ω–∏—à“∑”Ø':'üéì –î–æ–Ω–∏—à“∑”Ø–∏ –Ω–∞–≤';
  document.getElementById('studentSubmitBtn').textContent=id?'–°–∞–±—Ç':'–ò–ª–æ–≤–∞';
  // Fill group select
  const gs=document.getElementById('s-group');gs.innerHTML='<option value="">–ò–Ω—Ç–∏—Ö–æ–±...</option>';
  allGroups.forEach(g=>{const o=document.createElement('option');o.value=g.id;o.textContent=`–ì—É—Ä”Ø“≥ ${g.number}`;gs.appendChild(o);});
  if(id){api(`/dean/api/students/${id}`).then(s=>{document.getElementById('s-full-name').value=s.full_name||'';document.getElementById('s-code').value=s.student_code||'';document.getElementById('s-birth-year').value=s.birth_year||'';document.getElementById('s-birth-place').value=s.birth_place||'';document.getElementById('s-phone').value=s.phone||'';document.getElementById('s-parent-phone').value=s.parent_phone||'';document.getElementById('s-group').value=s.group_id||'';}).catch(()=>{});}
  else{['s-full-name','s-code','s-birth-place','s-phone','s-parent-phone'].forEach(i=>document.getElementById(i).value='');document.getElementById('s-birth-year').value='';}
  openModal('student-modal');
}
function editStudent(id){openStudentModal(id);}
async function saveStudent(e){e.preventDefault();
  const id=document.getElementById('student-id').value;const isNew=!id;
  const fd=new FormData();
  fd.append('full_name',document.getElementById('s-full-name').value);
  fd.append('student_code',document.getElementById('s-code').value||'');
  fd.append('group_id',document.getElementById('s-group').value);
  fd.append('birth_year',document.getElementById('s-birth-year').value||'');
  fd.append('birth_place',document.getElementById('s-birth-place').value||'');
  fd.append('phone',document.getElementById('s-phone').value||'');
  fd.append('parent_phone',document.getElementById('s-parent-phone').value||'');
  try{await api(isNew?'/dean/api/students':`/dean/api/students/${id}`,{method:isNew?'POST':'PUT',body:fd});
    toast('succ',isNew?'‚úÖ –î–æ–Ω–∏—à“∑”Ø –∏–ª–æ–≤–∞ —à—É–¥':'‚úÖ –°–∞–±—Ç —à—É–¥');closeModal('student-modal');loadStudents();}
  catch(err){toast('err',err.message);}
}
async function deleteStudent(id){
  if(!confirm('–î–æ–Ω–∏—à“∑”Ø –Ω–µ—Å—Ç –∫–∞—Ä–¥–∞ —à–∞–≤–∞–¥?'))return;
  try{await api(`/dean/api/students/${id}`,{method:'DELETE'});toast('succ','üóë –ù–µ—Å—Ç —à—É–¥');loadStudents();}
  catch(e){toast('err',e.message);}
}
async function loadAtRiskStudents(){
  const group=document.getElementById('at-risk-filter-group')?.value||'';
  const course=document.getElementById('at-risk-filter-course')?.value||'';
  const params=new URLSearchParams();if(group)params.append('group_id',group);if(course)params.append('course',course);
  try{const d=await api(`/dean/api/at-risk?${params}`);
    const tb=document.getElementById('at-risk-table');
    if(!d.length){tb.innerHTML='<tr><td colspan="7"><div class="empty"><p>–î–æ–Ω–∏—à“∑”Ø–∏ —Ö–∞–≤—Ñ–Ω–æ–∫ –Ω–µ—Å—Ç</p></div></td></tr>';return;}
    tb.innerHTML=d.map((s,i)=>`<tr><td class="mono">${i+1}</td><td><strong>${s.full_name||'‚Äî'}</strong></td><td class="mono">${s.student_code||'‚Äî'}</td><td>${s.group_number||'‚Äî'}</td><td><span class="chip chip-red">${s.total_absent_hours||0}</span></td><td>${s.parent_phone||'‚Äî'}</td><td><button class="btn btn-success btn-xs" onclick="justifyAbsence(${s.attendance_id||s.id})">Justify</button></td></tr>`).join('');
  }catch(e){toast('err',e.message);}
}
async function justifyAbsence(id){
  try{await api(`/dean/api/attendance/${id}/justify`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})});toast('succ','‚úÖ –¢–∞—Å–¥–∏“õ —à—É–¥');loadAtRiskStudents();}
  catch(e){toast('err',e.message);}
}

/* ‚îÄ‚îÄ EXPORT ‚îÄ‚îÄ */
async function exportData(type){
  try{window.open(`/dean/api/export/${type}`,'_blank');toast('succ','üì• –î–∞—Ä—ë—Ñ—Ç –º–µ—à–∞–≤–∞–¥...');}
  catch(e){toast('err',e.message);}
}

/* ‚îÄ‚îÄ AUDIT LOG ‚îÄ‚îÄ */
async function loadAuditLog(){
  const action=document.getElementById('audit-filter-action')?.value||'';
  const date=document.getElementById('audit-date')?.value||'';
  const params=new URLSearchParams();if(action)params.append('action',action);if(date)params.append('date',date);
  try{const d=await api(`/dean/api/audit-log?${params}`);
    const tb=document.getElementById('audit-table');
    if(!d.length){tb.innerHTML='<tr><td colspan="5"><div class="empty"><p>–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</p></div></td></tr>';return;}
    tb.innerHTML=d.map(l=>`<tr><td class="mono" style="font-size:.75rem">${fmt(l.created_at)}</td><td>${l.user_name||'‚Äî'}</td><td><span class="chip chip-blue">${l.action||'‚Äî'}</span></td><td>${l.object_type||'‚Äî'}</td><td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${l.details||'‚Äî'}</td></tr>`).join('');
  }catch(e){}
}

/* ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ */
async function saveProfile(e){e.preventDefault();
  const payload={
    full_name:document.getElementById('profile-full-name').value,
    email:document.getElementById('profile-email').value||'',
    phone:document.getElementById('profile-phone').value||''
  };
  try{await api('/dean/api/profile',{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});toast('succ','‚úÖ –ü—Ä–æ—Ñ–∏–ª —Å–∞–±—Ç —à—É–¥');}
  catch(e){toast('err',e.message);}
}

/* ‚îÄ‚îÄ INIT ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded',()=>{
  document.getElementById('dcDate').value=new Date().toISOString().split('T')[0];
  loadDashboard();loadCurators();loadGroups();
});
</script>
</body>
</html>