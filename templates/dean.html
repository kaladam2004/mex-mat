<!DOCTYPE html>
<html lang="tj">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü–∞–Ω–µ–ª–∏ –î–µ–∫–∞–Ω - –°–∏—Å—Ç–µ–º–∞–∏ –ò–¥–æ—Ä–∞–∫—É–Ω”£</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .sidebar { transition: all 0.3s; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .modal { display: none; }
        .modal.active { display: flex; }
        .loading { opacity: 0.5; pointer-events: none; position: relative; }
        .loading::after { content: ''; position: absolute; top: 50%; left: 50%; width: 24px; height: 24px; margin: -12px 0 0 -12px; border: 3px solid #3b82f6; border-radius: 50%; border-top-color: transparent; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .toast { position: fixed; animation: slideIn 0.3s ease-out; }
        .nav-item.active { background-color: rgb(51 65 85); border-left: 4px solid rgb(59 130 246); }
        .chart-btn.active { background-color: #3b82f6; color: white; }
        .bulk-checkbox { transform: scale(1.1); }
        .section { display: none; }
        .section.active-section { display: block; }
    </style>
</head>
<body class="bg-gray-100 font-sans">
    <div class="flex h-screen overflow-hidden">
        <!-- Sidebar -->
        <aside class="sidebar w-64 bg-slate-800 text-white flex-shrink-0 flex flex-col">
            <div class="p-4 border-b border-slate-700">
                <h1 class="text-xl font-bold"><i class="fas fa-university mr-2"></i>–°–∏—Å—Ç–µ–º–∞–∏ –∏–¥–æ—Ä–∞–∫—É–Ω”£</h1>
                <p class="text-sm text-gray-400">–ü–∞–Ω–µ–ª–∏ –¥–µ–∫–∞–Ω</p>
            </div>
            
            <nav class="mt-4 flex-1 overflow-y-auto">
                <div class="px-4 py-2 text-xs text-gray-400 uppercase font-semibold">–ê—Å–æ—Å”£</div>
                <a href="#" onclick="showSection('dashboard', this)" class="nav-item active block px-4 py-3 hover:bg-slate-700 transition">
                    <i class="fas fa-tachometer-alt w-6"></i> –£–º—É–º”£
                </a>
                <a href="#" onclick="showSection('analytics', this)" class="nav-item block px-4 py-3 hover:bg-slate-700 transition">
                    <i class="fas fa-chart-line w-6"></i> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
                </a>
                
                <div class="px-4 py-2 mt-4 text-xs text-gray-400 uppercase font-semibold">–ò–¥–æ—Ä–∞–∫—É–Ω”£</div>
                <a href="#" onclick="showSection('weekly', this)" class="nav-item block px-4 py-3 hover:bg-slate-700 transition">
                    <i class="fas fa-calendar-week w-6"></i> “≤–∞—Ñ—Ç–∞–≤”£
                </a>
                <a href="#" onclick="showSection('curators', this)" class="nav-item block px-4 py-3 hover:bg-slate-700 transition">
                    <i class="fas fa-chalkboard-teacher w-6"></i> –ö—É—Ä–∞—Ç–æ—Ä–æ–Ω
                </a>
                <a href="#" onclick="showSection('groups', this)" class="nav-item block px-4 py-3 hover:bg-slate-700 transition">
                    <i class="fas fa-users w-6"></i> –ì—É—Ä”Ø“≥“≥–æ
                </a>
                <a href="#" onclick="showSection('students', this)" class="nav-item block px-4 py-3 hover:bg-slate-700 transition">
                    <i class="fas fa-user-graduate w-6"></i> –î–æ–Ω–∏—à“∑”Ø—ë–Ω
                </a>
                <a href="#" onclick="showSection('at-risk', this)" class="nav-item block px-4 py-3 hover:bg-slate-700 transition">
                    <i class="fas fa-exclamation-triangle w-6"></i> –•–∞–≤—Ñ–Ω–æ–∫ (NB)
                </a>
                <a href="#" onclick="showSection('registry', this)" class="nav-item block px-4 py-3 hover:bg-slate-700 transition">
                    <i class="fas fa-list-alt w-6"></i> –†–µ–µ—Å—Ç—Ä–∏ –¥–æ–Ω–∏—à“∑”Ø—ë–Ω
                </a>
                
                <div class="px-4 py-2 mt-4 text-xs text-gray-400 uppercase font-semibold">–°–∏—Å—Ç–µ–º–∞</div>
                <a href="#" onclick="showSection('audit-log', this)" class="nav-item block px-4 py-3 hover:bg-slate-700 transition">
                    <i class="fas fa-history w-6"></i> –ê—É–¥–∏—Ç –ª–æ–≥
                </a>
                <a href="#" onclick="showSection('settings', this)" class="nav-item block px-4 py-3 hover:bg-slate-700 transition">
                    <i class="fas fa-cog w-6"></i> –¢–∞–Ω–∑–∏–º–æ—Ç
                </a>
            </nav>
            
            <!-- User block at bottom -->
            <div class="p-4 border-t border-slate-700">
                <div class="flex items-center mb-3">
                    <div class="w-10 h-10 rounded-full bg-blue-500 flex items-center justify-center font-bold text-lg cursor-pointer hover:bg-blue-600 transition" onclick="showSection('profile', null)" title="–ü—Ä–æ—Ñ–∏–ª">
                        {{ user.full_name[0].upper() if user.full_name else 'D' }}
                    </div>
                    <div class="ml-3 flex-1 min-w-0">
                        <p class="text-sm font-medium truncate">{{ user.full_name or '–î–µ–∫–∞–Ω' }}</p>
                        <p class="text-xs text-gray-400">–î–µ–∫–∞–Ω</p>
                    </div>
                    <button onclick="showSection('profile', null)" class="text-gray-400 hover:text-white transition ml-1" title="–ü—Ä–æ—Ñ–∏–ª">
                        <i class="fas fa-user-circle"></i>
                    </button>
                </div>
                <div class="grid grid-cols-2 gap-2">
                    <button onclick="showSection('change-password', null)" class="text-center py-2 bg-slate-700 hover:bg-slate-600 rounded transition text-xs text-gray-300">
                        <i class="fas fa-key mr-1"></i>–ü–∞—Ä–æ–ª
                    </button>
                    <a href="/logout" class="block text-center py-2 bg-red-600 hover:bg-red-700 rounded transition text-xs">
                        <i class="fas fa-sign-out-alt mr-1"></i>–ë–∞—Ä–æ–º–∞–¥–∞–Ω
                    </a>
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-gray-100">
            <!-- Header -->
            <header class="bg-white shadow-sm border-b px-6 py-4 sticky top-0 z-10">
                <div class="flex justify-between items-center">
                    <h2 id="page-title" class="text-2xl font-bold text-gray-800">–£–º—É–º”£</h2>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-600"><i class="fas fa-building mr-2"></i>{{ faculty.name if faculty else '–§–∞–∫—É–ª—Ç–µ—Ç' }}</span>
                        <span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium" id="current-year">{{ now().year if now else '2026' }}</span>
                        <button onclick="refreshCurrentSection()" class="p-2 text-gray-500 hover:text-blue-600 transition" title="–ù–∞–≤—Å–æ–∑”£">
                            <i class="fas fa-sync-alt" id="refresh-icon"></i>
                        </button>
                        <button onclick="showSection('profile', null)" class="p-2 text-gray-500 hover:text-blue-600 transition" title="–ü—Ä–æ—Ñ–∏–ª">
                            <i class="fas fa-user-circle text-xl"></i>
                        </button>
                    </div>
                </div>
            </header>

            <div class="p-6">

                <!-- ===== DASHBOARD SECTION ===== -->
                <section id="dashboard" class="section active-section fade-in">
                    <!-- KPI Cards -->
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                        <div class="bg-white rounded-lg shadow p-5 hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">–î–æ–Ω–∏—à“∑”Ø—ë–Ω</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-1" id="kpi-students">‚Äî</p>
                                </div>
                                <div class="w-14 h-14 bg-blue-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-user-graduate text-blue-600 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5 hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">–ö—É—Ä–∞—Ç–æ—Ä“≥–æ</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-1" id="kpi-curators">‚Äî</p>
                                </div>
                                <div class="w-14 h-14 bg-green-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-chalkboard-teacher text-green-600 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5 hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">–ì—É—Ä”Ø“≥“≥–æ</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-1" id="kpi-groups">‚Äî</p>
                                </div>
                                <div class="w-14 h-14 bg-purple-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-users text-purple-600 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5 hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">&gt; “≥–∞–¥–¥–∏ NB</p>
                                    <p class="text-3xl font-bold text-red-600 mt-1" id="kpi-high-absence">‚Äî</p>
                                </div>
                                <div class="w-14 h-14 bg-red-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-exclamation-triangle text-red-600 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5 hover:shadow-md transition">
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-gray-500 text-sm font-medium">–ò—à—Ç–∏—Ä–æ–∫ –∏–º—Ä”Ø–∑</p>
                                    <p class="text-3xl font-bold text-gray-800 mt-1" id="kpi-attendance">‚Äî</p>
                                </div>
                                <div class="w-14 h-14 bg-yellow-100 rounded-full flex items-center justify-center">
                                    <i class="fas fa-chart-pie text-yellow-600 text-2xl"></i>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Shift Stats -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div class="bg-white rounded-lg shadow p-4">
                            <h4 class="font-bold text-gray-700 mb-3"><i class="fas fa-sun mr-2 text-yellow-500"></i>–ù–∞–≤–±–∞—Ç–∏ 1</h4>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-2xl font-bold text-gray-800" id="shift-1-pct">0%</p>
                                    <p class="text-sm text-gray-500">–ò—à—Ç–∏—Ä–æ–∫</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-600" id="shift-1-students">0 –¥–æ–Ω–∏—à“∑”Ø</p>
                                </div>
                            </div>
                            <div class="mt-2 bg-gray-200 rounded-full h-2">
                                <div id="shift-1-bar" class="bg-yellow-500 h-2 rounded-full transition-all duration-500" style="width:0%"></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-4">
                            <h4 class="font-bold text-gray-700 mb-3"><i class="fas fa-moon mr-2 text-blue-500"></i>–ù–∞–≤–±–∞—Ç–∏ 2</h4>
                            <div class="flex items-center justify-between">
                                <div>
                                    <p class="text-2xl font-bold text-gray-800" id="shift-2-pct">0%</p>
                                    <p class="text-sm text-gray-500">–ò—à—Ç–∏—Ä–æ–∫</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-600" id="shift-2-students">0 –¥–æ–Ω–∏—à“∑”Ø</p>
                                </div>
                            </div>
                            <div class="mt-2 bg-gray-200 rounded-full h-2">
                                <div id="shift-2-bar" class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width:0%"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Alerts Panel -->
                    <div class="bg-white rounded-lg shadow mb-6">
                        <div class="px-5 py-4 border-b flex justify-between items-center">
                            <h3 class="font-bold text-gray-800 text-lg"><i class="fas fa-bell mr-2 text-yellow-500"></i>–û–≥–æ“≥–∏“≥–æ (<span id="alert-count">0</span>)</h3>
                            <button onclick="loadAlerts()" class="text-sm text-blue-600 hover:text-blue-800">
                                <i class="fas fa-sync-alt mr-1"></i>–ù–∞–≤—Å–æ–∑”£
                            </button>
                        </div>
                        <div id="alerts-container" class="p-5 space-y-3 max-h-96 overflow-y-auto">
                            <p class="text-gray-500 text-center py-8"><i class="fas fa-spinner fa-spin text-2xl"></i></p>
                        </div>
                    </div>

                    <!-- Charts -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow p-5">
                            <h3 class="font-bold text-gray-800 mb-4 text-lg"><i class="fas fa-chart-line mr-2 text-blue-500"></i>–ò—à—Ç–∏—Ä–æ–∫</h3>
                            <div class="flex space-x-2 mb-4">
                                <button onclick="updateChart('daily', event)" class="chart-btn active px-4 py-2 bg-blue-500 text-white rounded text-sm font-medium hover:bg-blue-600 transition">–†”Ø–∑</button>
                                <button onclick="updateChart('weekly', event)" class="chart-btn px-4 py-2 bg-gray-200 text-gray-700 rounded text-sm font-medium hover:bg-gray-300 transition">“≤–∞—Ñ—Ç–∞</button>
                                <button onclick="updateChart('monthly', event)" class="chart-btn px-4 py-2 bg-gray-200 text-gray-700 rounded text-sm font-medium hover:bg-gray-300 transition">–ú–æ“≥</button>
                            </div>
                            <div class="h-64">
                                <canvas id="attendanceChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5">
                            <h3 class="font-bold text-gray-800 mb-4 text-lg"><i class="fas fa-graduation-cap mr-2 text-purple-500"></i>–û–º–æ—Ä –±–æ –∫—É—Ä—Å“≥–æ</h3>
                            <div id="course-stats" class="space-y-3">
                                <div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- Top 5 Groups -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow p-5">
                            <h3 class="font-bold text-gray-800 mb-4 text-lg"><i class="fas fa-trophy mr-2 text-yellow-500"></i>üèÜ –¢–û–ü 5 ‚Äî –±–µ“≥—Ç–∞—Ä–∏–Ω –≥—É—Ä”Ø“≥</h3>
                            <div id="best-groups" class="space-y-2">
                                <div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5">
                            <h3 class="font-bold text-gray-800 mb-4 text-lg"><i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>‚ö†Ô∏è –¢–û–ü 5 ‚Äî –±–∞–¥—Ç–∞—Ä–∏–Ω –≥—É—Ä”Ø“≥</h3>
                            <div id="worst-groups" class="space-y-2">
                                <div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- Top 5 Students -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-lg shadow p-5">
                            <h3 class="font-bold text-gray-800 mb-4 text-lg"><i class="fas fa-star mr-2 text-yellow-500"></i>‚≠ê –¢–û–ü 5 ‚Äî –±–µ“≥—Ç–∞—Ä–∏–Ω –¥–æ–Ω–∏—à“∑”Ø</h3>
                            <div id="best-students" class="space-y-2">
                                <div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5">
                            <h3 class="font-bold text-gray-800 mb-4 text-lg"><i class="fas fa-arrow-down mr-2 text-red-500"></i>üìâ –¢–û–ü 5 ‚Äî –±–∞–¥—Ç–∞—Ä–∏–Ω –¥–æ–Ω–∏—à“∑”Ø</h3>
                            <div id="worst-students" class="space-y-2">
                                <div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ===== ANALYTICS SECTION ===== -->
                <section id="analytics" class="section fade-in">
                    <div class="bg-white rounded-lg shadow p-6 mb-6">
                        <h3 class="font-bold text-gray-800 text-xl mb-6"><i class="fas fa-chart-bar mr-2 text-blue-500"></i>–ê–Ω–∞–ª–∏—Ç–∏–∫–∞–∏ –º—É—Ñ–∞—Å—Å–∞–ª</h3>
                        <div id="analytics-content" class="text-center py-12 text-gray-500">
                            <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
                            <p>–ë–æ—Ä —à—É–¥–∞–Ω...</p>
                        </div>
                    </div>
                </section>

                <!-- ===== CURATORS SECTION ===== -->
                <section id="curators" class="section fade-in">
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-5 py-4 border-b flex justify-between items-center">
                            <h3 class="font-bold text-gray-800 text-lg"><i class="fas fa-chalkboard-teacher mr-2 text-blue-500"></i>üë®‚Äçüè´ –†”Ø–π—Ö–∞—Ç–∏ –∫—É—Ä–∞—Ç–æ—Ä–æ–Ω</h3>
                            <button onclick="openModal('curator-modal')" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium shadow">
                                <i class="fas fa-plus mr-2"></i>–ö—É—Ä–∞—Ç–æ—Ä–∏ –Ω–∞–≤
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">#</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ù–æ–º–∏ –ø—É—Ä—Ä–∞</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Username</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Email</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–¢–µ–ª–µ—Ñ–æ–Ω</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ì—É—Ä”Ø“≥</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ê–º–∞–ª–∏—ë—Ç“≥–æ</th>
                                    </tr>
                                </thead>
                                <tbody id="curators-table" class="divide-y divide-gray-200">
                                    <tr><td colspan="7" class="px-5 py-12 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- ===== GROUPS SECTION ===== -->
                <section id="groups" class="section fade-in">
                    <div class="bg-white rounded-lg shadow mb-4">
                        <div class="px-5 py-4 border-b flex justify-between items-center flex-wrap gap-3">
                            <h3 class="font-bold text-gray-800 text-lg"><i class="fas fa-users mr-2 text-purple-500"></i>üìã –†”Ø–π—Ö–∞—Ç–∏ –≥—É—Ä”Ø“≥“≥–æ</h3>
                            <div class="flex space-x-2">
                                <button onclick="openModal('group-modal')" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium shadow">
                                    <i class="fas fa-plus mr-2"></i>–ì—É—Ä”Ø“≥–∏ –Ω–∞–≤
                                </button>
                                <button onclick="exportData('students')" class="px-5 py-2.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-medium shadow">
                                    <i class="fas fa-file-csv mr-2"></i>CSV
                                </button>
                            </div>
                        </div>
                        <!-- Filters -->
                        <div class="px-5 py-4 bg-gray-50 border-b flex flex-wrap gap-3 items-center">
                            <select id="filter-course" onchange="loadGroups()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">“≤–∞–º–∞ –∫—É—Ä—Å“≥–æ</option>
                                <option value="1">1-–∫—É—Ä—Å</option>
                                <option value="2">2-–∫—É—Ä—Å</option>
                                <option value="3">3-–∫—É—Ä—Å</option>
                                <option value="4">4-–∫—É—Ä—Å</option>
                            </select>
                            <select id="filter-shift" onchange="loadGroups()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">“≤–∞–º–∞ –Ω–∞–≤–±–∞—Ç</option>
                                <option value="1">1-–Ω–∞–≤–±–∞—Ç</option>
                                <option value="2">2-–Ω–∞–≤–±–∞—Ç</option>
                            </select>
                            <div class="flex-1"></div>
                            <div class="flex items-center space-x-2 bg-white px-3 py-2 rounded-lg border">
                                <input type="checkbox" id="select-all-groups" onchange="toggleBulkSelectAll('group')" class="w-4 h-4 text-blue-600 rounded">
                                <label for="select-all-groups" class="text-sm text-gray-700 font-medium"><span id="bulk-count-groups">0</span> –∏–Ω—Ç–∏—Ö–æ–±</label>
                            </div>
                            <button onclick="openBulkCuratorModal()" class="px-4 py-2 bg-purple-500 text-white rounded-lg text-sm font-medium hover:bg-purple-600 transition">
                                <i class="fas fa-user-tie mr-1"></i>–ö—É—Ä–∞—Ç–æ—Ä —Ç–∞—ä–∏–Ω
                            </button>
                            <button onclick="bulkDeleteGroups()" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition">
                                <i class="fas fa-trash mr-1"></i>–ù–µ—Å—Ç
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-5 py-3"><input type="checkbox" id="select-all-groups-header" onchange="toggleBulkSelectAll('group')" class="w-4 h-4 bulk-checkbox"></th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">#</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ì—É—Ä”Ø“≥</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ö—É—Ä—Å</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ù–∞–≤–±–∞—Ç</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ö—É—Ä–∞—Ç–æ—Ä</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–î–æ–Ω–∏—à“∑”Ø—ë–Ω</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">NB</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ò—à—Ç–∏—Ä–æ–∫</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ê–º–∞–ª–∏—ë—Ç“≥–æ</th>
                                    </tr>
                                </thead>
                                <tbody id="groups-table" class="divide-y divide-gray-200">
                                    <tr><td colspan="10" class="px-5 py-12 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- ===== STUDENTS SECTION ===== -->
                <section id="students" class="section fade-in">
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-5 py-4 border-b flex justify-between items-center flex-wrap gap-3">
                            <h3 class="font-bold text-gray-800 text-lg"><i class="fas fa-user-graduate mr-2 text-green-500"></i>üë• –†”Ø–π—Ö–∞—Ç–∏ –¥–æ–Ω–∏—à“∑”Ø—ë–Ω</h3>
                            <div class="flex space-x-2">
                                <button onclick="openModal('import-modal')" class="px-5 py-2.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-medium shadow">
                                    <i class="fas fa-upload mr-2"></i>–ò–º–ø–æ—Ä—Ç
                                </button>
                                <button onclick="exportData('students')" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium shadow">
                                    <i class="fas fa-file-csv mr-2"></i>–≠–∫—Å–ø–æ—Ä—Ç
                                </button>
                            </div>
                        </div>
                        <!-- Filters -->
                        <div class="px-5 py-4 bg-gray-50 border-b flex flex-wrap gap-3 items-center">
                            <select id="student-filter-group" onchange="loadStudents()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">“≤–∞–º–∞ –≥—É—Ä”Ø“≥</option>
                            </select>
                            <select id="student-filter-course" onchange="loadStudents()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">“≤–∞–º–∞ –∫—É—Ä—Å</option>
                                <option value="1">1-–∫—É—Ä—Å</option>
                                <option value="2">2-–∫—É—Ä—Å</option>
                                <option value="3">3-–∫—É—Ä—Å</option>
                                <option value="4">4-–∫—É—Ä—Å</option>
                            </select>
                            <input type="text" id="student-search" placeholder="“∂—É—Å—Ç—É“∑”Ø (–ù–æ–º, –ö–æ–¥)..." onkeyup="debounceSearch()" class="px-4 py-2 border border-gray-300 rounded-lg flex-1 focus:ring-2 focus:ring-blue-500">
                            <div class="flex items-center space-x-2 bg-white px-3 py-2 rounded-lg border">
                                <input type="checkbox" id="select-all-students" onchange="toggleBulkSelectAll('student')" class="w-4 h-4 text-blue-600 rounded">
                                <label for="select-all-students" class="text-sm text-gray-700 font-medium"><span id="bulk-count-students">0</span> –∏–Ω—Ç–∏—Ö–æ–±</label>
                            </div>
                            <button onclick="bulkNBAction('justify')" class="px-4 py-2 bg-blue-500 text-white rounded-lg text-sm font-medium hover:bg-blue-600 transition">
                                <i class="fas fa-check mr-1"></i>Justify NB
                            </button>
                            <button onclick="bulkDeleteStudents()" class="px-4 py-2 bg-red-500 text-white rounded-lg text-sm font-medium hover:bg-red-600 transition">
                                <i class="fas fa-trash mr-1"></i>–ù–µ—Å—Ç
                            </button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-5 py-3"><input type="checkbox" id="select-all-students-header" onchange="toggleBulkSelectAll('student')" class="w-4 h-4 bulk-checkbox"></th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">#</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ù–æ–º –≤–∞ –Ω–∞—Å–∞–±</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ö–æ–¥</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ì—É—Ä”Ø“≥</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ö—É—Ä—Å</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ú–∏–Ω—Ç–∞“õ–∞</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">NB</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ê–º–∞–ª–∏—ë—Ç“≥–æ</th>
                                    </tr>
                                </thead>
                                <tbody id="students-table" class="divide-y divide-gray-200">
                                    <tr><td colspan="9" class="px-5 py-12 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></td></tr>
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination -->
                        <div class="px-5 py-4 border-t flex justify-between items-center">
                            <div class="text-sm text-gray-600">“≤–∞–º–∞–≥”£: <span id="total-students" class="font-bold">0</span> –¥–æ–Ω–∏—à“∑”Ø</div>
                            <div id="pagination-controls" class="flex space-x-2"></div>
                        </div>
                    </div>
                </section>

                <!-- ===== AT-RISK SECTION ===== -->
                <section id="at-risk" class="section fade-in">
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-5 py-4 border-b flex justify-between items-center">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg"><i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>üö® –î–æ–Ω–∏—à“∑”Ø—ë–Ω–∏ —Ö–∞–≤—Ñ–Ω–æ–∫</h3>
                                <p class="text-sm text-gray-500 mt-1">–î–æ–Ω–∏—à“∑”Ø—ë–Ω–µ, –∫–∏ NB –∞–∑ “≥–∞–¥–¥–∏ –º—É“õ–∞—Ä—Ä–∞—Ä—à—É–¥–∞ –∑–∏—ë–¥ –∞—Å—Ç.</p>
                            </div>
                            <button onclick="exportData('nb')" class="px-5 py-2.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-medium shadow">
                                <i class="fas fa-file-csv mr-2"></i>–≠–∫—Å–ø–æ—Ä—Ç NB
                            </button>
                        </div>
                        <div class="px-5 py-4 bg-gray-50 border-b flex gap-3">
                            <select id="at-risk-filter-group" onchange="loadAtRiskStudents()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">“≤–∞–º–∞ –≥—É—Ä”Ø“≥</option>
                            </select>
                            <select id="at-risk-filter-course" onchange="loadAtRiskStudents()" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="">“≤–∞–º–∞ –∫—É—Ä—Å</option>
                                <option value="1">1-–∫—É—Ä—Å</option>
                                <option value="2">2-–∫—É—Ä—Å</option>
                                <option value="3">3-–∫—É—Ä—Å</option>
                                <option value="4">4-–∫—É—Ä—Å</option>
                            </select>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">#</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ù–æ–º –≤–∞ –Ω–∞—Å–∞–±</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ö–æ–¥</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ì—É—Ä”Ø“≥</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ö—É—Ä—Å</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">NB</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–¢–µ–ª–µ—Ñ–æ–Ω–∏ –≤–æ–ª–∏–¥–∞–π–Ω</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ê–º–∞–ª–∏—ë—Ç“≥–æ</th>
                                    </tr>
                                </thead>
                                <tbody id="at-risk-table" class="divide-y divide-gray-200">
                                    <tr><td colspan="8" class="px-5 py-12 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- ===== AUDIT LOG SECTION ===== -->
                <section id="audit-log" class="section fade-in">
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-5 py-4 border-b flex justify-between items-center">
                            <h3 class="font-bold text-gray-800 text-lg"><i class="fas fa-history mr-2 text-gray-500"></i>üìã –ê—É–¥–∏—Ç –ª–æ–≥</h3>
                            <div class="flex gap-2">
                                <select id="audit-filter-action" onchange="loadAuditLog()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                                    <option value="">“≤–∞–º–∞ –∞–º–∞–ª“≥–æ</option>
                                    <option value="CREATE">–≠“∑–æ–¥</option>
                                    <option value="UPDATE">–ù–∞–≤—Å–æ–∑”£</option>
                                    <option value="DELETE">–ù–µ—Å—Ç</option>
                                </select>
                                <input type="date" id="audit-filter-date" onchange="loadAuditLog()" class="px-4 py-2 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500">
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–í–∞“õ—Ç</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ö–æ—Ä–±–∞—Ä</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ê–º–∞–ª</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">“∂–∞–¥–≤–∞–ª</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–¢–∞–≤—Å–∏—Ñ</th>
                                    </tr>
                                </thead>
                                <tbody id="audit-log-table" class="divide-y divide-gray-200">
                                    <tr><td colspan="5" class="px-5 py-12 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- ===== SETTINGS SECTION ===== -->
                <section id="settings" class="section fade-in">
                    <div class="bg-white rounded-lg shadow max-w-3xl">
                        <div class="px-5 py-4 border-b">
                            <h3 class="font-bold text-gray-800 text-lg"><i class="fas fa-cog mr-2 text-gray-500"></i>‚öôÔ∏è –¢–∞–Ω–∑–∏–º–æ—Ç–∏ —Å–∏—Å—Ç–µ–º–∞</h3>
                        </div>
                        <div class="p-6 space-y-5">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">NB_LIMIT (“≥–∞–¥–¥–∏ —Ö–∞–≤—Ñ)</label>
                                <input type="number" id="setting-nb-limit" value="35" min="1" max="100" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">–î–æ–Ω–∏—à“∑”Ø—ë–Ω–µ, –∫–∏ –∞–∑ –∏–Ω “≥–∞–¥–¥ –∑–∏—ë–¥ “ì–æ–∏–± —à–∞–≤–∞–Ω–¥, —Ö–∞–≤—Ñ–Ω–æ–∫ “≥–∏—Å–æ–± –º–µ—à–∞–≤–∞–Ω–¥.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ALERT_CONSECUTIVE_DAYS (—Ä”Ø–∑)</label>
                                <input type="number" id="setting-alert-days" value="5" min="1" max="30" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">–®—É–º–æ—Ä–∞–∏ —Ä”Ø–∑“≥–æ–∏ –ø–∞–π –¥–∞—Ä –ø–∞–π –±–∞—Ä–æ–∏ –æ–≥–æ“≥”£.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-2">ATTENDANCE_THRESHOLD (%)</label>
                                <input type="number" id="setting-attendance-threshold" value="70" min="0" max="100" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <p class="text-xs text-gray-500 mt-1">–ì—É—Ä”Ø“≥“≥–æ–µ, –∫–∏ –∏—à—Ç–∏—Ä–æ–∫–∞—à–æ–Ω –∞–∑ –∏–Ω —Ñ–æ–∏–∑ –∫–∞–º –∞—Å—Ç, –æ–≥–æ“≥”£ –º–µ–≥–∏—Ä–∞–Ω–¥.</p>
                            </div>
                            <div class="pt-4 border-t">
                                <button onclick="saveSettings()" class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium shadow">
                                    <i class="fas fa-save mr-2"></i>–°–∞–±—Ç –∫–∞—Ä–¥–∞–Ω
                                </button>
                            </div>
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                <p class="text-sm text-blue-700"><i class="fas fa-info-circle mr-2"></i>–¢–∞“ì–π–∏—Ä–æ—Ç –±–∞ “≥–∞–º–∞–∏ –∫–æ—Ä–±–∞—Ä–æ–Ω–∏ —Ñ–∞–∫—É–ª—Ç–µ—Ç —Ç–∞—ä—Å–∏—Ä –º–µ—Ä–∞—Å–æ–Ω–∞–¥.</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ===== PROFILE SECTION ===== -->
                <section id="profile" class="section fade-in">
                    <div class="max-w-2xl">
                        <div class="bg-white rounded-lg shadow overflow-hidden">
                            <div class="bg-gradient-to-r from-blue-600 to-blue-800 px-6 py-8">
                                <div class="flex items-center space-x-4">
                                    <div class="w-20 h-20 rounded-full bg-white bg-opacity-20 flex items-center justify-center text-white text-3xl font-bold">
                                        {{ user.full_name[0].upper() if user.full_name else 'D' }}
                                    </div>
                                    <div>
                                        <h2 class="text-2xl font-bold text-white">{{ user.full_name or '–î–µ–∫–∞–Ω' }}</h2>
                                        <p class="text-blue-200">–î–µ–∫–∞–Ω ‚Ä¢ {{ faculty.name if faculty else '–§–∞–∫—É–ª—Ç–µ—Ç' }}</p>
                                    </div>
                                </div>
                            </div>
                            <div class="p-6 space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <p class="text-xs text-gray-500 font-medium uppercase mb-1">Username</p>
                                        <p class="font-semibold text-gray-800">{{ user.username }}</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <p class="text-xs text-gray-500 font-medium uppercase mb-1">Email</p>
                                        <p class="font-semibold text-gray-800">{{ user.email or '‚Äî' }}</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <p class="text-xs text-gray-500 font-medium uppercase mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</p>
                                        <p class="font-semibold text-gray-800">{{ user.phone or '‚Äî' }}</p>
                                    </div>
                                    <div class="bg-gray-50 p-4 rounded-lg">
                                        <p class="text-xs text-gray-500 font-medium uppercase mb-1">–§–∞–∫—É–ª—Ç–µ—Ç</p>
                                        <p class="font-semibold text-gray-800">{{ faculty.name if faculty else '‚Äî' }}</p>
                                    </div>
                                </div>
                                <div class="pt-4 border-t flex space-x-3">
                                    <button onclick="openModal('edit-profile-modal')" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium shadow">
                                        <i class="fas fa-edit mr-2"></i>–í–∏—Ä–æ–∏—à–∏ –ø—Ä–æ—Ñ–∏–ª
                                    </button>
                                    <button onclick="showSection('change-password', null)" class="px-5 py-2.5 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition font-medium shadow">
                                        <i class="fas fa-key mr-2"></i>–ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—Ä–æ–ª
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ===== CHANGE PASSWORD SECTION ===== -->
                <section id="change-password" class="section fade-in">
                    <div class="max-w-md">
                        <div class="bg-white rounded-lg shadow">
                            <div class="px-6 py-4 border-b">
                                <h3 class="font-bold text-gray-800 text-lg"><i class="fas fa-key mr-2 text-yellow-500"></i>–ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—Ä–æ–ª</h3>
                            </div>
                            <div class="p-6 space-y-4">
                                <div id="cp-error" class="hidden bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg text-sm"></div>
                                <div id="cp-success" class="hidden bg-green-50 border border-green-200 text-green-700 px-4 py-3 rounded-lg text-sm"></div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">–ü–∞—Ä–æ–ª–∏ “≥–æ–∑–∏—Ä–∞ <span class="text-red-500">*</span></label>
                                    <input type="password" id="cp-current" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="–ü–∞—Ä–æ–ª–∏ “≥–æ–∑–∏—Ä–∞">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">–ü–∞—Ä–æ–ª–∏ –Ω–∞–≤ <span class="text-red-500">*</span></label>
                                    <input type="password" id="cp-new" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="–ü–∞—Ä–æ–ª–∏ –Ω–∞–≤ (“≥–∞–¥–¥–∏ –∞“õ–∞–ª 8 –∞–ª–æ–º–∞—Ç)">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">–¢–∞—Å–¥–∏“õ–∏ –ø–∞—Ä–æ–ª–∏nav <span class="text-red-500">*</span></label>
                                    <input type="password" id="cp-confirm" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="–ü–∞—Ä–æ–ª—Ä–æ –¥—É–±–æ—Ä–∞ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥">
                                </div>
                                <div class="pt-2">
                                    <button onclick="changePassword()" class="w-full py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium shadow">
                                        <i class="fas fa-save mr-2"></i>–°–∞–±—Ç –∫–∞—Ä–¥–∞–Ω
                                    </button>
                                </div>
                                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                                    <p class="text-xs text-yellow-700"><i class="fas fa-info-circle mr-1"></i>–ü–∞—Ä–æ–ª –±–æ—è–¥: “≥–∞–¥–¥–∏ –∞“õ–∞–ª 8 –∞–ª–æ–º–∞—Ç, —è–∫ “≥–∞—Ä—Ñ–∏ –∫–∞–ª–æ–Ω, —è–∫ —Ä–∞“õ–∞–º –¥–æ—à—Ç–∞ –±–æ—à–∞–¥.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- ===== WEEKLY SECTION ===== -->
                <section id="weekly" class="section fade-in">
                    <!-- Settings row -->
                    <div class="bg-white rounded-lg shadow p-4 mb-4 flex items-center gap-4 flex-wrap">
                        <label class="text-sm font-medium text-gray-700">–î–∞—Ä—Å“≥–æ/“≥–∞—Ñ—Ç–∞:</label>
                        <input type="number" id="weekly-lpw" value="25" min="1" max="100" class="px-3 py-2 border border-gray-300 rounded-lg w-24 focus:ring-2 focus:ring-blue-500">
                        <button onclick="loadWeeklyStats()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition text-sm font-medium">
                            <i class="fas fa-sync-alt mr-1"></i>–ù–∞–≤—Å–æ–∑”£
                        </button>
                        <span id="weekly-week-label" class="text-sm text-gray-500 ml-2"></span>
                    </div>

                    <!-- 4.2 + 4.3 Attendance overview -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div class="bg-white rounded-lg shadow p-5">
                            <p class="text-sm text-gray-500 font-medium">–ò—à—Ç–∏—Ä–æ–∫ (–∏–Ω “≥–∞—Ñ—Ç–∞)</p>
                            <p class="text-4xl font-bold text-blue-600 mt-1" id="weekly-att-this">‚Äî</p>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5">
                            <p class="text-sm text-gray-500 font-medium">–ò—à—Ç–∏—Ä–æ–∫ (“≥–∞—Ñ—Ç–∞–∏ –ø–µ—à)</p>
                            <p class="text-4xl font-bold text-gray-600 mt-1" id="weekly-att-prev">‚Äî</p>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5">
                            <p class="text-sm text-gray-500 font-medium">–î–∏–Ω–∞–º–∏–∫–∞</p>
                            <p class="text-4xl font-bold mt-1" id="weekly-dynamics">‚Äî</p>
                        </div>
                    </div>

                    <!-- 9 Smart Alerts -->
                    <div class="bg-white rounded-lg shadow mb-6">
                        <div class="px-5 py-4 border-b">
                            <h3 class="font-bold text-gray-800 text-lg"><i class="fas fa-bell mr-2 text-orange-500"></i>Smart Alerts</h3>
                        </div>
                        <div id="weekly-alerts" class="p-5 space-y-3 max-h-80 overflow-y-auto">
                            <div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></div>
                        </div>
                    </div>

                    <!-- 8 TOP 5 -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                        <div class="bg-white rounded-lg shadow p-5">
                            <h3 class="font-bold text-gray-800 mb-4 text-lg"><i class="fas fa-trophy mr-2 text-yellow-500"></i>üèÜ –¢–û–ü 5 ‚Äî –±–µ“≥—Ç–∞—Ä–∏–Ω –≥—É—Ä”Ø“≥ (–∏–Ω “≥–∞—Ñ—Ç–∞)</h3>
                            <div id="weekly-best-groups" class="space-y-2">
                                <div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></div>
                            </div>
                        </div>
                        <div class="bg-white rounded-lg shadow p-5">
                            <h3 class="font-bold text-gray-800 mb-4 text-lg"><i class="fas fa-exclamation-triangle mr-2 text-red-500"></i>‚ö†Ô∏è –¢–û–ü 5 ‚Äî –±–∞–¥—Ç–∞—Ä–∏–Ω –≥—É—Ä”Ø“≥ (–∏–Ω “≥–∞—Ñ—Ç–∞)</h3>
                            <div id="weekly-worst-groups" class="space-y-2">
                                <div class="text-center py-8 text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></div>
                            </div>
                        </div>
                    </div>

                    <!-- 5.1 Group Risk Table -->
                    <div class="bg-white rounded-lg shadow">
                        <div class="px-5 py-4 border-b">
                            <h3 class="font-bold text-gray-800 text-lg"><i class="fas fa-shield-alt mr-2 text-blue-500"></i>5.1 Risk Level ‚Äî “≥–∞–º–∞ –≥—É—Ä”Ø“≥“≥–æ</h3>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ì—É—Ä”Ø“≥</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–î–æ–Ω–∏—à“∑”Ø—ë–Ω</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">NB% (–∏–Ω “≥–∞—Ñ—Ç–∞)</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">NB% (–ø–µ—à)</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ò—à—Ç–∏—Ä–æ–∫%</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Risk</th>
                                    </tr>
                                </thead>
                                <tbody id="weekly-group-table" class="divide-y divide-gray-200">
                                    <tr><td colspan="6" class="px-5 py-12 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- ===== REGISTRY SECTION ===== -->
                <section id="registry" class="section fade-in">
                    <div class="bg-white rounded-lg shadow mb-4">
                        <div class="px-5 py-4 border-b flex justify-between items-center flex-wrap gap-3">
                            <div>
                                <h3 class="font-bold text-gray-800 text-lg"><i class="fas fa-list-alt mr-2 text-indigo-500"></i>üìã –†–µ–µ—Å—Ç—Ä–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–æ–Ω–∏—à“∑”Ø—ë–Ω</h3>
                                <p class="text-sm text-gray-500 mt-1">“≤–∞–º–∞–≥”£: <span id="registry-total" class="font-bold text-gray-800">‚Äî</span> –¥–æ–Ω–∏—à“∑”Ø</p>
                            </div>
                            <button onclick="exportData('students')" class="px-5 py-2.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-medium shadow">
                                <i class="fas fa-file-csv mr-2"></i>–≠–∫—Å–ø–æ—Ä—Ç CSV
                            </button>
                        </div>
                        <!-- Filter counts pills -->
                        <div class="px-5 py-4 bg-gray-50 border-b">
                            <div class="flex flex-wrap gap-3 items-start">
                                <!-- Course filters -->
                                <div>
                                    <p class="text-xs text-gray-500 uppercase font-semibold mb-2">–ö—É—Ä—Å</p>
                                    <div id="registry-course-filters" class="flex flex-wrap gap-2"></div>
                                </div>
                                <!-- Shift filters -->
                                <div class="ml-4">
                                    <p class="text-xs text-gray-500 uppercase font-semibold mb-2">–ù–∞–≤–±–∞—Ç</p>
                                    <div id="registry-shift-filters" class="flex flex-wrap gap-2"></div>
                                </div>
                                <!-- Birth place filters -->
                                <div class="ml-4 flex-1">
                                    <p class="text-xs text-gray-500 uppercase font-semibold mb-2">“∂–æ–∏ —Ç–∞–≤–∞–ª–ª—É–¥ / –ú–∏–Ω—Ç–∞“õ–∞</p>
                                    <div id="registry-bp-filters" class="flex flex-wrap gap-2 max-h-24 overflow-y-auto"></div>
                                </div>
                                <!-- Reset -->
                                <div class="ml-2 flex items-end pb-0.5">
                                    <button onclick="resetRegistryFilters()" class="px-3 py-1.5 bg-gray-200 text-gray-700 rounded-lg text-sm hover:bg-gray-300 transition">
                                        <i class="fas fa-times mr-1"></i>–¢–æ–∑–∞
                                    </button>
                                </div>
                            </div>
                        </div>
                        <!-- Table -->
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">#</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ù–æ–º –≤–∞ –Ω–∞—Å–∞–±</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ö–æ–¥</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ì—É—Ä”Ø“≥</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ö—É—Ä—Å</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–ù–∞–≤–±–∞—Ç</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">“∂–æ–∏ —Ç–∞–≤–∞–ª–ª—É–¥</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">–¢–µ–ª–µ—Ñ–æ–Ω –≤–æ–ª–∏–¥–∞–π–Ω</th>
                                        <th class="px-5 py-3 text-left text-xs font-semibold text-gray-500 uppercase">NB</th>
                                    </tr>
                                </thead>
                                <tbody id="registry-table" class="divide-y divide-gray-200">
                                    <tr><td colspan="9" class="px-5 py-12 text-center text-gray-500"><i class="fas fa-spinner fa-spin text-2xl"></i></td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

            </div><!-- /p-6 -->
        </main>
    </div>

    <!-- ==================== MODALS ==================== -->

    <!-- Curator Modal (Create) -->
    <div id="curator-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b flex justify-between items-center sticky top-0 bg-white">
                <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-chalkboard-teacher mr-2 text-blue-500"></i>–ö—É—Ä–∞—Ç–æ—Ä–∏ –Ω–∞–≤</h3>
                <button onclick="closeModal('curator-modal')" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="curator-form" onsubmit="createCurator(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ù–æ–º–∏ –ø—É—Ä—Ä–∞ <span class="text-red-500">*</span></label>
                    <input type="text" name="full_name" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Username <span class="text-red-500">*</span></label>
                    <input type="text" name="username" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" name="email" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="text" name="phone" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeModal('curator-modal')" class="px-5 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">–ë–µ–∫–æ—Ä</button>
                    <button type="submit" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium shadow">–≠“∑–æ–¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Curator Modal -->
    <div id="edit-curator-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4 max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b flex justify-between items-center sticky top-0 bg-white">
                <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-edit mr-2 text-green-500"></i>–í–∏—Ä–æ–∏—à–∏ –∫—É—Ä–∞—Ç–æ—Ä</h3>
                <button onclick="closeModal('edit-curator-modal')" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="edit-curator-form" onsubmit="saveCuratorEdit(event)" class="p-6 space-y-4">
                <input type="hidden" id="edit-curator-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ù–æ–º–∏ –ø—É—Ä—Ä–∞ <span class="text-red-500">*</span></label>
                    <input type="text" id="edit-curator-full-name" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="edit-curator-email" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="text" id="edit-curator-phone" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeModal('edit-curator-modal')" class="px-5 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">–ë–µ–∫–æ—Ä</button>
                    <button type="submit" class="px-5 py-2.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-medium shadow">–°–∞–±—Ç</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="edit-profile-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="px-6 py-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-user-edit mr-2 text-blue-500"></i>–í–∏—Ä–æ–∏—à–∏ –ø—Ä–æ—Ñ–∏–ª</h3>
                <button onclick="closeModal('edit-profile-modal')" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="edit-profile-form" onsubmit="saveProfile(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ù–æ–º–∏ –ø—É—Ä—Ä–∞ <span class="text-red-500">*</span></label>
                    <input type="text" id="profile-full-name" value="{{ user.full_name or '' }}" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="profile-email" value="{{ user.email or '' }}" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <input type="text" id="profile-phone" value="{{ user.phone or '' }}" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeModal('edit-profile-modal')" class="px-5 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">–ë–µ–∫–æ—Ä</button>
                    <button type="submit" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium shadow">–°–∞–±—Ç</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Group Modal -->
    <div id="group-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="px-6 py-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-users mr-2 text-purple-500"></i>–ì—É—Ä”Ø“≥–∏ –Ω–∞–≤</h3>
                <button onclick="closeModal('group-modal')" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="group-form" onsubmit="createGroup(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–†–∞“õ–∞–º–∏ –≥—É—Ä”Ø“≥ <span class="text-red-500">*</span></label>
                    <input type="text" name="number" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ö—É—Ä—Å <span class="text-red-500">*</span></label>
                    <select name="course_id" required id="group-course-select" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">–ò–Ω—Ç–∏—Ö–æ–±...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–≤–±–∞—Ç <span class="text-red-500">*</span></label>
                    <select name="shift" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">–ò–Ω—Ç–∏—Ö–æ–±...</option>
                        <option value="1">1-–Ω–∞–≤–±–∞—Ç</option>
                        <option value="2">2-–Ω–∞–≤–±–∞—Ç</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ö—É—Ä–∞—Ç–æ—Ä</label>
                    <select name="curator_id" id="group-curator-select" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">–•–æ–ª”£</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeModal('group-modal')" class="px-5 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">–ë–µ–∫–æ—Ä</button>
                    <button type="submit" class="px-5 py-2.5 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition font-medium shadow">–≠“∑–æ–¥</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Group Modal -->
    <div id="edit-group-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="px-6 py-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-edit mr-2 text-green-500"></i>–í–∏—Ä–æ–∏—à–∏ –≥—É—Ä”Ø“≥</h3>
                <button onclick="closeModal('edit-group-modal')" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="edit-group-form" onsubmit="saveGroupEdit(event)" class="p-6 space-y-4">
                <input type="hidden" id="edit-group-id">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–†–∞“õ–∞–º–∏ –≥—É—Ä”Ø“≥ <span class="text-red-500">*</span></label>
                    <input type="text" id="edit-group-number" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ù–∞–≤–±–∞—Ç <span class="text-red-500">*</span></label>
                    <select id="edit-group-shift" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="1">1-–Ω–∞–≤–±–∞—Ç</option>
                        <option value="2">2-–Ω–∞–≤–±–∞—Ç</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">–ö—É—Ä–∞—Ç–æ—Ä</label>
                    <select id="edit-group-curator" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">–•–æ–ª”£</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeModal('edit-group-modal')" class="px-5 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">–ë–µ–∫–æ—Ä</button>
                    <button type="submit" class="px-5 py-2.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-medium shadow">–°–∞–±—Ç</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Import Modal -->
    <div id="import-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="px-6 py-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-upload mr-2 text-green-500"></i>–ò–º–ø–æ—Ä—Ç –¥–æ–Ω–∏—à“∑”Ø—ë–Ω</h3>
                <button onclick="closeModal('import-modal')" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="import-form" onsubmit="importStudents(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ì—É—Ä”Ø“≥</label>
                    <select name="group_id" id="import-group-select" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">–ò–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–§–∞–π–ª–∏ Excel/CSV</label>
                    <input type="file" name="file" accept=".xlsx,.xls,.csv" required class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                    <p class="text-xs text-gray-500 mt-1">–§–æ—Ä–º–∞—Ç“≥–æ: .xlsx, .xls, .csv</p>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                    <p class="text-xs text-blue-700"><i class="fas fa-info-circle mr-1"></i>–°—É—Ç—É–Ω“≥–æ: full_name, student_code, region, birth_year, parent_phone</p>
                </div>
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeModal('import-modal')" class="px-5 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">–ë–µ–∫–æ—Ä</button>
                    <button type="submit" class="px-5 py-2.5 bg-green-500 text-white rounded-lg hover:bg-green-600 transition font-medium shadow">–ò–º–ø–æ—Ä—Ç</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bulk Curator Modal -->
    <div id="bulk-curator-modal" class="modal fixed inset-0 bg-black bg-opacity-50 items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md mx-4">
            <div class="px-6 py-4 border-b flex justify-between items-center">
                <h3 class="text-lg font-bold text-gray-800"><i class="fas fa-user-tie mr-2 text-purple-500"></i>–¢–∞—ä–∏–Ω–∏ –∫—É—Ä–∞—Ç–æ—Ä</h3>
                <button onclick="closeModal('bulk-curator-modal')" class="text-gray-400 hover:text-gray-600 transition"><i class="fas fa-times text-xl"></i></button>
            </div>
            <form id="bulk-curator-form" onsubmit="bulkAssignCurator(event)" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">–ò–Ω—Ç–∏—Ö–æ–±–∏ –∫—É—Ä–∞—Ç–æ—Ä</label>
                    <select name="curator_id" required id="bulk-curator-select" class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">–ò–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥...</option>
                    </select>
                </div>
                <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3">
                    <p class="text-xs text-yellow-700"><i class="fas fa-exclamation-triangle mr-1"></i><span id="bulk-groups-count">0</span> –≥—É—Ä”Ø“≥ —Ç–∞“ì–π–∏—Ä —Ö–æ“≥–∞–¥ —ë—Ñ—Ç</p>
                </div>
                <div class="flex justify-end space-x-3 pt-4 border-t">
                    <button type="button" onclick="closeModal('bulk-curator-modal')" class="px-5 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 transition font-medium">–ë–µ–∫–æ—Ä</button>
                    <button type="submit" class="px-5 py-2.5 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition font-medium shadow">–¢–∞—ä–∏–Ω –∫–∞—Ä–¥–∞–Ω</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container" class="fixed top-20 right-5 z-[9999] space-y-2 pointer-events-none"></div>

    <!-- ==================== JAVASCRIPT ==================== -->
    <script>
        // ============================================
        // GLOBAL STATE
        // ============================================
        let attendanceChart = null;
        let currentChartMode = 'daily';
        let currentSection = 'dashboard';
        let statsData = null;
        let searchTimeout = null;
        let currentPage = 1;
        const pageSize = 50;
        let allCurators = [];

        // ============================================
        // UTILITY
        // ============================================
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            const icons = {
                success: 'check-circle',
                error: 'exclamation-circle',
                warning: 'exclamation-triangle',
                info: 'info-circle'
            };
            toast.className = `pointer-events-auto px-5 py-3 rounded-lg shadow-lg text-white text-sm ${colors[type] || colors.info} flex items-center space-x-2`;
            toast.style.animation = 'slideIn 0.3s ease-out';
            toast.innerHTML = `<i class="fas fa-${icons[type] || 'info-circle'}"></i><span>${message}</span>`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 3500);
        }

        function setLoading(elementId, isLoading) {
            const el = document.getElementById(elementId);
            if (!el) return;
            isLoading ? el.classList.add('loading') : el.classList.remove('loading');
        }

        async function apiCall(url, options = {}) {
            const defaultHeaders = {};
            if (!(options.body instanceof FormData)) {
                defaultHeaders['Content-Type'] = 'application/json';
            }
            const response = await fetch(url, {
                credentials: 'same-origin',
                ...options,
                headers: { ...defaultHeaders, ...(options.headers || {}) }
            });
            if (response.status === 401 || response.status === 403) {
                window.location.href = '/login';
                throw new Error('–°–µ—Å—Å–∏—è —Ç–∞–º–æ–º —à—É–¥');
            }
            if (!response.ok) {
                let errMsg = '–•–∞—Ç–æ–≥”£ —Ä—É—Ö –¥–æ–¥';
                try { const err = await response.json(); errMsg = err.detail || errMsg; } catch(e) {}
                throw new Error(errMsg);
            }
            return response.json();
        }

        function formatDate(dateString) {
            if (!dateString) return '‚Äî';
            try {
                const d = new Date(dateString);
                return d.toLocaleString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
            } catch(e) { return dateString; }
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => { currentPage = 1; loadStudents(); }, 500);
        }

        // ============================================
        // NAVIGATION - FIX: pass element explicitly
        // ============================================
        function showSection(sectionId, el) {
            // Hide all sections
            document.querySelectorAll('.section').forEach(s => {
                s.classList.remove('active-section');
            });
            // Remove active from all nav items
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));

            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.add('active-section', 'fade-in');
            }

            // Find the nav item to activate
            if (el) {
                const navItem = el.closest ? el.closest('.nav-item') : null;
                if (navItem) navItem.classList.add('active');
            }

            const titles = {
                'dashboard': '–£–º—É–º”£',
                'analytics': '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
                'weekly': '“≤–∞—Ñ—Ç–∞–≤”£ ‚Äî –û–º–æ—Ä –≤–∞ –æ–≥–æ“≥–∏“≥–æ',
                'curators': '–ö—É—Ä–∞—Ç–æ—Ä–æ–Ω',
                'groups': '–ì—É—Ä”Ø“≥“≥–æ',
                'students': '–î–æ–Ω–∏—à“∑”Ø—ë–Ω',
                'at-risk': '–î–æ–Ω–∏—à“∑”Ø—ë–Ω–∏ —Ö–∞–≤—Ñ–Ω–æ–∫',
                'registry': '–†–µ–µ—Å—Ç—Ä–∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ –¥–æ–Ω–∏—à“∑”Ø—ë–Ω',
                'audit-log': '–ê—É–¥–∏—Ç –ª–æ–≥',
                'settings': '–¢–∞–Ω–∑–∏–º–æ—Ç',
                'profile': '–ü—Ä–æ—Ñ–∏–ª–∏ –º–∞–Ω',
                'change-password': '–ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—Ä–æ–ª'
            };
            const titleEl = document.getElementById('page-title');
            if (titleEl) titleEl.textContent = titles[sectionId] || '';

            currentSection = sectionId;
            loadSectionData(sectionId);

            // Prevent default anchor scroll
            return false;
        }

        function refreshCurrentSection() {
            const icon = document.getElementById('refresh-icon');
            if (icon) {
                icon.classList.add('fa-spin');
                setTimeout(() => icon.classList.remove('fa-spin'), 1000);
            }
            loadSectionData(currentSection);
        }

        function loadSectionData(sectionId) {
            switch(sectionId) {
                case 'dashboard': loadDashboard(); break;
                case 'analytics': loadAnalytics(); break;
                case 'weekly': loadWeeklyStats(); break;
                case 'curators': loadCurators(); break;
                case 'groups': loadGroups(); loadCuratorOptionsForGroups(); break;
                case 'students': loadStudents(); loadStudentFilters(); break;
                case 'at-risk': loadAtRiskStudents(); loadAtRiskFilters(); break;
                case 'registry': loadRegistry(); break;
                case 'audit-log': loadAuditLog(); break;
                case 'settings': loadSettings(); break;
                case 'profile': break; // Static Jinja2 data
                case 'change-password': 
                    document.getElementById('cp-current').value = '';
                    document.getElementById('cp-new').value = '';
                    document.getElementById('cp-confirm').value = '';
                    document.getElementById('cp-error').classList.add('hidden');
                    document.getElementById('cp-success').classList.add('hidden');
                    break;
            }
        }

        // ============================================
        // MODAL HELPERS
        // ============================================
        function openModal(modalId) {
            const m = document.getElementById(modalId);
            if (m) m.classList.add('active');
        }
        function closeModal(modalId) {
            const m = document.getElementById(modalId);
            if (m) m.classList.remove('active');
        }

        // Close modal on outside click
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

        // ============================================
        // DASHBOARD
        // ============================================
        async function loadDashboard() {
            try {
                setLoading('dashboard', true);
                const data = await apiCall('/dean/api/stats/overview');
                statsData = data;

                document.getElementById('kpi-students').textContent = data.total_students ?? 0;
                document.getElementById('kpi-curators').textContent = data.total_curators ?? 0;
                document.getElementById('kpi-groups').textContent = data.total_groups ?? 0;
                document.getElementById('kpi-high-absence').textContent = data.high_absence_count ?? 0;
                document.getElementById('kpi-attendance').textContent = `${data.att_today_pct ?? 0}%`;

                if (data.shift_stats) {
                    const s1 = data.shift_stats.find(s => s.shift === 1) || {pct:0, students:0};
                    const s2 = data.shift_stats.find(s => s.shift === 2) || {pct:0, students:0};
                    document.getElementById('shift-1-pct').textContent = `${s1.pct}%`;
                    document.getElementById('shift-1-students').textContent = `${s1.students} –¥–æ–Ω–∏—à“∑”Ø`;
                    document.getElementById('shift-1-bar').style.width = `${Math.min(s1.pct, 100)}%`;
                    document.getElementById('shift-2-pct').textContent = `${s2.pct}%`;
                    document.getElementById('shift-2-students').textContent = `${s2.students} –¥–æ–Ω–∏—à“∑”Ø`;
                    document.getElementById('shift-2-bar').style.width = `${Math.min(s2.pct, 100)}%`;
                }

                if (data.course_stats) {
                    const html = data.course_stats.map(c => `
                        <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <div>
                                <span class="font-bold text-gray-800">${c.year}-–∫—É—Ä—Å</span>
                                <span class="text-sm text-gray-500 ml-2">${c.groups} –≥—É—Ä”Ø“≥</span>
                            </div>
                            <span class="text-lg font-bold text-blue-600">${c.students}</span>
                        </div>`).join('');
                    document.getElementById('course-stats').innerHTML = html || '<p class="text-center text-gray-500 py-4">–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</p>';
                }

                updateChart('daily', null);
                loadAlerts();
                loadTopStats();
            } catch (error) {
                showToast('–•–∞—Ç–æ–≥”£: ' + error.message, 'error');
            } finally {
                setLoading('dashboard', false);
            }
        }

        async function loadAlerts() {
            try {
                const data = await apiCall('/dean/api/alerts');
                document.getElementById('alert-count').textContent = data.count || 0;
                if (!data.alerts || data.alerts.length === 0) {
                    document.getElementById('alerts-container').innerHTML = `<p class="text-gray-500 text-center py-8"><i class="fas fa-check-circle text-green-500 text-2xl mb-2 block"></i>–û–≥–æ“≥–∏“≥–æ –Ω–µ—Å—Ç</p>`;
                    return;
                }
                const html = data.alerts.map(a => `
                    <div class="flex items-start space-x-3 p-3 rounded-lg ${a.level === 'error' ? 'bg-red-50 border border-red-200' : 'bg-yellow-50 border border-yellow-200'}">
                        <i class="fas fa-${a.level === 'error' ? 'exclamation-circle text-red-500' : 'exclamation-triangle text-yellow-500'} text-xl mt-0.5"></i>
                        <div class="flex-1">
                            <p class="text-sm font-medium ${a.level === 'error' ? 'text-red-800' : 'text-yellow-800'}">${a.msg}</p>
                            <p class="text-xs ${a.level === 'error' ? 'text-red-600' : 'text-yellow-600'} mt-1">${a.time || ''}</p>
                        </div>
                    </div>`).join('');
                document.getElementById('alerts-container').innerHTML = html;
            } catch (e) { console.error('Alerts error:', e); }
        }

        async function loadTopStats() {
            try {
                const data = await apiCall('/dean/api/analytics/top');
                const renderGroup = (g, i, cls) => `
                    <div class="flex items-center justify-between p-3 ${cls} rounded-lg">
                        <div class="flex items-center space-x-3">
                            <span class="w-7 h-7 flex items-center justify-center bg-white bg-opacity-60 rounded-full font-bold text-sm">${i+1}</span>
                            <div>
                                <p class="font-medium text-gray-800 text-sm">–ì—É—Ä”Ø“≥ ${g.number}</p>
                                <p class="text-xs text-gray-500">${g.course}-–∫—É—Ä—Å</p>
                            </div>
                        </div>
                        <div class="text-right text-sm">
                            <p class="font-bold">${g.pct}%</p>
                            <p class="text-xs text-gray-500">NB: ${g.avg_nb}</p>
                        </div>
                    </div>`;

                document.getElementById('best-groups').innerHTML = (data.best_groups || []).map((g,i) => renderGroup(g,i,'bg-green-50 border border-green-200')).join('') || '<p class="text-center text-gray-500 py-4">–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</p>';
                document.getElementById('worst-groups').innerHTML = (data.worst_groups || []).map((g,i) => renderGroup(g,i,'bg-red-50 border border-red-200')).join('') || '<p class="text-center text-gray-500 py-4">–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</p>';

                const renderStu = (s, i, clsBadge) => `
                    <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                        <div class="flex items-center space-x-3">
                            <span class="w-7 h-7 flex items-center justify-center ${clsBadge} text-white rounded-full font-bold text-sm">${i+1}</span>
                            <div>
                                <p class="font-medium text-gray-800 text-sm">${s.name}</p>
                                <p class="text-xs text-gray-500">–ì—É—Ä”Ø“≥ ${s.group}</p>
                            </div>
                        </div>
                        <span class="font-bold text-sm">NB: ${s.absences}</span>
                    </div>`;

                document.getElementById('best-students').innerHTML = (data.best_students || []).map((s,i) => renderStu(s,i,'bg-blue-500')).join('') || '<p class="text-center text-gray-500 py-4">–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</p>';
                document.getElementById('worst-students').innerHTML = (data.worst_students || []).map((s,i) => renderStu(s,i,'bg-orange-500')).join('') || '<p class="text-center text-gray-500 py-4">–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</p>';
            } catch(e) { console.error('Top stats error:', e); }
        }

        function updateChart(mode, evt) {
            if (!statsData || !statsData.time_series) return;
            currentChartMode = mode;

            document.querySelectorAll('.chart-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-blue-500', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            if (evt && evt.target) {
                evt.target.classList.add('active', 'bg-blue-500', 'text-white');
                evt.target.classList.remove('bg-gray-200', 'text-gray-700');
            } else {
                // Default: activate first button
                const firstBtn = document.querySelector('.chart-btn');
                if (firstBtn) { firstBtn.classList.add('active', 'bg-blue-500', 'text-white'); firstBtn.classList.remove('bg-gray-200','text-gray-700'); }
            }

            const ctx = document.getElementById('attendanceChart');
            if (!ctx) return;
            const seriesData = (statsData.time_series[mode] || []).slice().reverse();
            const labels = seriesData.map(d => mode === 'daily' ? (d.date||'').slice(5) : mode === 'weekly' ? 'W'+(d.week||'').slice(5) : (d.month||'').slice(5));
            const values = seriesData.map(d => d.pct);

            if (attendanceChart) attendanceChart.destroy();
            attendanceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: '–ò—à—Ç–∏—Ä–æ–∫ (%)',
                        data: values,
                        borderColor: 'rgb(59, 130, 246)',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, max: 100, ticks: { callback: v => v + '%' } }
                    }
                }
            });
        }

        // ============================================
        // ANALYTICS
        // ============================================
        async function loadAnalytics() {
            const el = document.getElementById('analytics-content');
            try {
                const data = await apiCall('/dean/api/analytics/top');
                el.innerHTML = `
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-blue-600">${data.best_groups ? data.best_groups.length : 0}</p>
                            <p class="text-sm text-gray-600 mt-1">–ë–µ“≥—Ç–∞—Ä–∏–Ω –≥—É—Ä”Ø“≥</p>
                        </div>
                        <div class="bg-red-50 border border-red-200 rounded-lg p-4 text-center">
                            <p class="text-2xl font-bold text-red-600">${data.worst_groups ? data.worst_groups.length : 0}</p>
                            <p class="text-sm text-gray-600 mt-1">–ë–∞–¥—Ç–∞—Ä–∏–Ω –≥—É—Ä”Ø“≥</p>
                        </div>
                    </div>
                    <p class="text-gray-500 text-sm text-center mt-4">–ë–∞—Ä–æ–∏ –º–∞—ä–ª—É–º–æ—Ç–∏ –±–µ—à—Ç–∞—Ä –±–∞ –±–∞—Ö—à“≥–æ–∏ –¥–∏–≥–∞—Ä –≥—É–∑–∞—Ä–µ–¥.</p>`;
            } catch(e) {
                el.innerHTML = '<p class="text-red-500 text-center py-8">–•–∞—Ç–æ–≥”£ “≥–∞–Ω–≥–æ–º–∏ –±–æ—Ä —à—É–¥–∞–Ω</p>';
            }
        }

        // ============================================
        // CURATORS
        // ============================================
        async function loadCurators() {
            try {
                setLoading('curators', true);
                const data = await apiCall('/dean/api/curators');
                allCurators = data || [];

                if (!data || data.length === 0) {
                    document.getElementById('curators-table').innerHTML = '<tr><td colspan="7" class="px-5 py-12 text-center text-gray-500">–ö—É—Ä–∞—Ç–æ—Ä–æ–Ω –Ω–µ—Å—Ç</td></tr>';
                    return;
                }

                const html = data.map((c, i) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-5 py-3 text-gray-600">${i+1}</td>
                        <td class="px-5 py-3 font-medium text-gray-800">${escHtml(c.full_name)}</td>
                        <td class="px-5 py-3 text-gray-600">${escHtml(c.username)}</td>
                        <td class="px-5 py-3 text-gray-600">${escHtml(c.email || '‚Äî')}</td>
                        <td class="px-5 py-3 text-gray-600">${escHtml(c.phone || '‚Äî')}</td>
                        <td class="px-5 py-3">${c.group_number ? `<span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-sm">${escHtml(c.group_number)}</span>` : '‚Äî'}</td>
                        <td class="px-5 py-3 flex items-center space-x-2">
                            <button onclick="viewCurator(${c.id})" class="text-blue-600 hover:text-blue-800" title="–î–∏–¥–∞–Ω"><i class="fas fa-eye"></i></button>
                            <button onclick="editCurator(${c.id})" class="text-green-600 hover:text-green-800" title="–í–∏—Ä–æ–∏—à"><i class="fas fa-edit"></i></button>
                            <button onclick="resetPassword(${c.id})" class="text-yellow-600 hover:text-yellow-800" title="Reset –ø–∞—Ä–æ–ª"><i class="fas fa-key"></i></button>
                            <button onclick="deleteCurator(${c.id})" class="text-red-600 hover:text-red-800" title="–ù–µ—Å—Ç –∫–∞—Ä–¥–∞–Ω"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join('');

                document.getElementById('curators-table').innerHTML = html;
                loadCuratorOptions(data);
            } catch(e) {
                showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error');
            } finally {
                setLoading('curators', false);
            }
        }

        function loadCuratorOptions(curators) {
            const ids = ['group-curator-select', 'bulk-curator-select', 'edit-group-curator'];
            ids.forEach(id => {
                const sel = document.getElementById(id);
                if (!sel) return;
                const opts = (curators || []).map(c => `<option value="${c.id}">${escHtml(c.full_name)}</option>`).join('');
                sel.innerHTML = '<option value="">‚Äî –•–æ–ª”£ ‚Äî</option>' + opts;
            });
        }

        async function loadCuratorOptionsForGroups() {
            if (allCurators.length > 0) {
                loadCuratorOptions(allCurators);
            } else {
                try {
                    const data = await apiCall('/dean/api/curators');
                    allCurators = data || [];
                    loadCuratorOptions(allCurators);
                } catch(e) {}
            }
        }

        async function createCurator(e) {
            e.preventDefault();
            const form = e.target;
            try {
                const data = await apiCall('/dean/api/curators', { method: 'POST', body: new FormData(form), headers: {} });
                showToast(`–ö—É—Ä–∞—Ç–æ—Ä —ç“∑–æ–¥ —à—É–¥. –ü–∞—Ä–æ–ª–∏ –º—É–≤–∞“õ“õ–∞—Ç”£: ${data.temp_password}`, 'success');
                closeModal('curator-modal');
                form.reset();
                loadCurators();
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        async function editCurator(id) {
            try {
                const data = await apiCall(`/dean/api/curators/${id}/profile`);
                document.getElementById('edit-curator-id').value = id;
                document.getElementById('edit-curator-full-name').value = data.full_name || '';
                document.getElementById('edit-curator-email').value = data.email || '';
                document.getElementById('edit-curator-phone').value = data.phone || '';
                openModal('edit-curator-modal');
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        async function saveCuratorEdit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-curator-id').value;
            const body = JSON.stringify({
                full_name: document.getElementById('edit-curator-full-name').value,
                email: document.getElementById('edit-curator-email').value,
                phone: document.getElementById('edit-curator-phone').value,
            });
            try {
                await apiCall(`/dean/api/curators/${id}`, { method: 'PATCH', body });
                showToast('–ö—É—Ä–∞—Ç–æ—Ä –Ω–∞–≤—Å–æ–∑”£ —à—É–¥', 'success');
                closeModal('edit-curator-modal');
                loadCurators();
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        async function viewCurator(id) {
            try {
                const data = await apiCall(`/dean/api/curators/${id}/profile`);
                const groupsList = (data.groups || []).map(g =>
                    `<li class="py-1.5 border-b text-sm text-gray-700">–ì—É—Ä”Ø“≥ ${g.number} (${g.course}-–∫—É—Ä—Å, ${g.students} –¥–æ–Ω–∏—à“∑”Ø)</li>`
                ).join('');
                const html = `
                    <div class="modal active fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target===this)this.remove()">
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="px-6 py-4 border-b flex justify-between items-center sticky top-0 bg-white">
                                <h3 class="text-lg font-bold text-gray-800">–ü—Ä–æ—Ñ–∏–ª–∏ –∫—É—Ä–∞—Ç–æ—Ä</h3>
                                <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                            </div>
                            <div class="p-6 space-y-4">
                                <div class="grid grid-cols-2 gap-4">
                                    <div><p class="text-xs text-gray-500 uppercase">–ù–æ–º–∏ –ø—É—Ä—Ä–∞</p><p class="font-medium">${escHtml(data.full_name)}</p></div>
                                    <div><p class="text-xs text-gray-500 uppercase">Username</p><p class="font-medium">${escHtml(data.username)}</p></div>
                                    <div><p class="text-xs text-gray-500 uppercase">Email</p><p class="font-medium">${escHtml(data.email||'‚Äî')}</p></div>
                                    <div><p class="text-xs text-gray-500 uppercase">–¢–µ–ª–µ—Ñ–æ–Ω</p><p class="font-medium">${escHtml(data.phone||'‚Äî')}</p></div>
                                </div>
                                <div class="border-t pt-4">
                                    <div class="grid grid-cols-4 gap-3">
                                        <div class="bg-blue-50 p-3 rounded-lg text-center"><p class="text-xl font-bold text-blue-600">${data.total_groups||0}</p><p class="text-xs text-gray-600">–ì—É—Ä”Ø“≥“≥–æ</p></div>
                                        <div class="bg-green-50 p-3 rounded-lg text-center"><p class="text-xl font-bold text-green-600">${data.total_students||0}</p><p class="text-xs text-gray-600">–î–æ–Ω–∏—à“∑”Ø—ë–Ω</p></div>
                                        <div class="bg-purple-50 p-3 rounded-lg text-center"><p class="text-xl font-bold text-purple-600">${data.attendance_pct||0}%</p><p class="text-xs text-gray-600">–ò—à—Ç–∏—Ä–æ–∫</p></div>
                                        <div class="bg-red-50 p-3 rounded-lg text-center"><p class="text-xl font-bold text-red-600">${data.high_absence_count||0}</p><p class="text-xs text-gray-600">–•–∞–≤—Ñ–Ω–æ–∫</p></div>
                                    </div>
                                </div>
                                <div class="border-t pt-4">
                                    <h4 class="font-bold text-gray-800 mb-2">–ì—É—Ä”Ø“≥“≥–æ</h4>
                                    <ul>${groupsList || '<li class="text-gray-500 text-sm">–ì—É—Ä”Ø“≥–µ –Ω–µ—Å—Ç</li>'}</ul>
                                </div>
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', html);
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        async function deleteCurator(id) {
            if (!confirm('–ö—É—Ä–∞—Ç–æ—Ä–∏ –∏–Ω—Ç–∏—Ö–æ–±—à—É–¥–∞—Ä–æ –Ω–µ—Å—Ç –∫—É–Ω–µ–º?')) return;
            try {
                await apiCall(`/dean/api/curators/${id}`, { method: 'DELETE' });
                showToast('–ö—É—Ä–∞—Ç–æ—Ä –Ω–µ—Å—Ç –∫–∞—Ä–¥–∞ —à—É–¥', 'success');
                loadCurators();
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        async function resetPassword(id) {
            if (!confirm('–ü–∞—Ä–æ–ª—Ä–æ –±–∞—Ä“õ–∞—Ä–æ—Ä —Å–æ–∑–µ–º?')) return;
            try {
                const data = await apiCall(`/dean/api/curators/${id}/reset-password`, { method: 'POST' });
                // Use modal-like alert for password display
                showToast(`–ü–∞—Ä–æ–ª–∏ –Ω–∞–≤: ${data.temp_password} (–ù—É—Å—Ö–∞–±–∞—Ä–¥–æ—Ä”£ –∫—É–Ω–µ–¥!)`, 'warning');
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        // ============================================
        // GROUPS
        // ============================================
        async function loadGroups() {
            try {
                setLoading('groups', true);
                const courseId = document.getElementById('filter-course').value;
                const shift = document.getElementById('filter-shift').value;
                let url = '/dean/api/groups?';
                if (courseId) url += `course_id=${courseId}&`;
                if (shift) url += `shift=${shift}&`;

                const data = await apiCall(url);

                if (!data || data.length === 0) {
                    document.getElementById('groups-table').innerHTML = '<tr><td colspan="10" class="px-5 py-12 text-center text-gray-500">–ì—É—Ä”Ø“≥“≥–æ –Ω–µ—Å—Ç</td></tr>';
                    return;
                }

                const html = data.map((g, i) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-5 py-3"><input type="checkbox" class="group-checkbox" value="${g.id}" onchange="updateBulkCount('group')"></td>
                        <td class="px-5 py-3 text-gray-600">${i+1}</td>
                        <td class="px-5 py-3 font-medium text-gray-800">${escHtml(g.number)}</td>
                        <td class="px-5 py-3 text-gray-600">${g.course_year || '‚Äî'}</td>
                        <td class="px-5 py-3"><span class="px-2 py-1 ${g.shift===1 ? 'bg-yellow-100 text-yellow-800' : 'bg-blue-100 text-blue-800'} rounded text-sm">${g.shift}-–Ω–∞–≤–±–∞—Ç</span></td>
                        <td class="px-5 py-3 text-gray-600">${escHtml(g.curator || '‚Äî')}</td>
                        <td class="px-5 py-3 text-gray-600">${g.total_students}</td>
                        <td class="px-5 py-3"><span class="px-2 py-1 ${g.total_absent > 100 ? 'bg-red-100 text-red-800' : 'bg-gray-100 text-gray-800'} rounded text-sm">${g.total_absent}</span></td>
                        <td class="px-5 py-3"><span class="px-2 py-1 ${g.attendance_pct >= 80 ? 'bg-green-100 text-green-800' : g.attendance_pct >= 60 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'} rounded text-sm">${g.attendance_pct}%</span></td>
                        <td class="px-5 py-3 flex items-center space-x-2">
                            <button onclick="viewGroup(${g.id})" class="text-blue-600 hover:text-blue-800" title="–î–∏–¥–∞–Ω"><i class="fas fa-eye"></i></button>
                            <button onclick="editGroup(${g.id})" class="text-green-600 hover:text-green-800" title="–í–∏—Ä–æ–∏—à"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteGroup(${g.id})" class="text-red-600 hover:text-red-800" title="–ù–µ—Å—Ç"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join('');

                document.getElementById('groups-table').innerHTML = html;

                // Fill import group select
                const importSel = document.getElementById('import-group-select');
                if (importSel) {
                    importSel.innerHTML = '<option value="">‚Äî –ò–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥ ‚Äî</option>' + data.map(g => `<option value="${g.id}">–ì—É—Ä”Ø“≥ ${escHtml(g.number)}</option>`).join('');
                }

                // Fill student filter group select
                const stuGroupSel = document.getElementById('student-filter-group');
                if (stuGroupSel && !stuGroupSel.dataset.loaded) {
                    stuGroupSel.innerHTML = '<option value="">“≤–∞–º–∞ –≥—É—Ä”Ø“≥</option>' + data.map(g => `<option value="${g.id}">–ì—É—Ä”Ø“≥ ${escHtml(g.number)}</option>`).join('');
                }
                const atRiskGroupSel = document.getElementById('at-risk-filter-group');
                if (atRiskGroupSel) {
                    atRiskGroupSel.innerHTML = '<option value="">“≤–∞–º–∞ –≥—É—Ä”Ø“≥</option>' + data.map(g => `<option value="${g.id}">–ì—É—Ä”Ø“≥ ${escHtml(g.number)}</option>`).join('');
                }
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
            finally { setLoading('groups', false); }
        }

        async function createGroup(e) {
            e.preventDefault();
            const form = e.target;
            try {
                await apiCall('/dean/api/groups', { method: 'POST', body: new FormData(form), headers: {} });
                showToast('–ì—É—Ä”Ø“≥ —ç“∑–æ–¥ —à—É–¥', 'success');
                closeModal('group-modal');
                form.reset();
                loadGroups();
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        async function editGroup(id) {
            try {
                const data = await apiCall(`/dean/api/groups/${id}/profile`);
                document.getElementById('edit-group-id').value = id;
                document.getElementById('edit-group-number').value = data.number || '';
                document.getElementById('edit-group-shift').value = data.shift || 1;
                // Load curators into edit-group-curator
                if (allCurators.length === 0) {
                    const curators = await apiCall('/dean/api/curators');
                    allCurators = curators || [];
                }
                loadCuratorOptions(allCurators);
                if (data.curator_id) {
                    document.getElementById('edit-group-curator').value = data.curator_id;
                }
                openModal('edit-group-modal');
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        async function saveGroupEdit(e) {
            e.preventDefault();
            const id = document.getElementById('edit-group-id').value;
            const body = JSON.stringify({
                number: document.getElementById('edit-group-number').value,
                shift: parseInt(document.getElementById('edit-group-shift').value),
                curator_id: document.getElementById('edit-group-curator').value || null,
            });
            try {
                await apiCall(`/dean/api/groups/${id}`, { method: 'PATCH', body });
                showToast('–ì—É—Ä”Ø“≥ –Ω–∞–≤—Å–æ–∑”£ —à—É–¥', 'success');
                closeModal('edit-group-modal');
                loadGroups();
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        async function viewGroup(id) {
            try {
                const data = await apiCall(`/dean/api/groups/${id}/profile`);
                const stuHtml = (data.students || []).map((s, i) =>
                    `<tr class="border-b text-sm"><td class="py-1.5 px-3">${i+1}</td><td class="py-1.5 px-3">${escHtml(s.name)}</td><td class="py-1.5 px-3">${s.code}</td><td class="py-1.5 px-3"><span class="px-2 py-0.5 bg-gray-100 rounded">${s.nb}</span></td></tr>`
                ).join('');
                const html = `
                    <div class="modal active fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target===this)this.remove()">
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="px-6 py-4 border-b flex justify-between items-center sticky top-0 bg-white">
                                <h3 class="text-lg font-bold text-gray-800">–ì—É—Ä”Ø“≥ ${escHtml(data.number)}</h3>
                                <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                            </div>
                            <div class="p-6 space-y-4">
                                <div class="grid grid-cols-4 gap-4">
                                    <div class="bg-blue-50 p-3 rounded-lg text-center"><p class="text-2xl font-bold text-blue-600">${data.total_students}</p><p class="text-xs text-gray-600">–î–æ–Ω–∏—à“∑”Ø—ë–Ω</p></div>
                                    <div class="bg-green-50 p-3 rounded-lg text-center"><p class="text-2xl font-bold text-green-600">${data.attendance_pct}%</p><p class="text-xs text-gray-600">–ò—à—Ç–∏—Ä–æ–∫</p></div>
                                    <div class="bg-yellow-50 p-3 rounded-lg text-center"><p class="text-2xl font-bold text-yellow-600">${data.avg_nb}</p><p class="text-xs text-gray-600">–ú–∏—ë–Ω–∞ NB</p></div>
                                    <div class="bg-purple-50 p-3 rounded-lg text-center"><p class="text-2xl font-bold text-purple-600">${data.course}</p><p class="text-xs text-gray-600">–ö—É—Ä—Å</p></div>
                                </div>
                                <div class="border-t pt-4 text-sm text-gray-600 grid grid-cols-2 gap-2">
                                    <p><strong>–ö—É—Ä–∞—Ç–æ—Ä:</strong> ${escHtml(data.curator||'‚Äî')}</p>
                                    <p><strong>–ù–∞–≤–±–∞—Ç:</strong> ${data.shift}</p>
                                </div>
                                <div class="border-t pt-4">
                                    <h4 class="font-bold text-gray-800 mb-3">–†”Ø–π—Ö–∞—Ç–∏ –¥–æ–Ω–∏—à“∑”Ø—ë–Ω</h4>
                                    <div class="overflow-x-auto">
                                        <table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="py-2 px-3 text-left">#</th><th class="py-2 px-3 text-left">–ù–æ–º</th><th class="py-2 px-3 text-left">–ö–æ–¥</th><th class="py-2 px-3 text-left">NB</th></tr></thead>
                                        <tbody>${stuHtml||'<tr><td colspan="4" class="text-center py-4 text-gray-500">–î–æ–Ω–∏—à“∑”Ø—ë–Ω –Ω–µ—Å—Ç</td></tr>'}</tbody></table>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', html);
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        async function deleteGroup(id) {
            if (!confirm('–ì—É—Ä”Ø“≥—Ä–æ –Ω–µ—Å—Ç –∫—É–Ω–µ–º?')) return;
            try {
                await apiCall(`/dean/api/groups/${id}`, { method: 'DELETE' });
                showToast('–ì—É—Ä”Ø“≥ –Ω–µ—Å—Ç –∫–∞—Ä–¥–∞ —à—É–¥', 'success');
                loadGroups();
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        function toggleBulkSelectAll(type) {
            const masterCb = document.getElementById(`select-all-${type}s`) || document.getElementById(`select-all-${type}s-header`);
            const checked = masterCb ? masterCb.checked : false;
            document.querySelectorAll(`.${type}-checkbox`).forEach(cb => { cb.checked = checked; });
            updateBulkCount(type);
        }

        function updateBulkCount(type) {
            const count = document.querySelectorAll(`.${type}-checkbox:checked`).length;
            const el = document.getElementById(`bulk-count-${type}s`);
            if (el) el.textContent = count;
        }

        function openBulkCuratorModal() {
            const selected = document.querySelectorAll('.group-checkbox:checked');
            if (selected.length === 0) { showToast('–õ—É—Ç—Ñ–∞–Ω –≥—É—Ä”Ø“≥“≥–æ—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥', 'warning'); return; }
            document.getElementById('bulk-groups-count').textContent = selected.length;
            openModal('bulk-curator-modal');
        }

        async function bulkAssignCurator(e) {
            e.preventDefault();
            const curatorId = document.getElementById('bulk-curator-select').value;
            const groupIds = Array.from(document.querySelectorAll('.group-checkbox:checked')).map(cb => parseInt(cb.value));
            if (!curatorId || groupIds.length === 0) { showToast('–ú–∞—ä–ª—É–º–æ—Ç–∏ –Ω–æ–∫–∏—Ñ–æ—è', 'error'); return; }
            try {
                await apiCall('/dean/api/groups/bulk-curators', { method: 'POST', body: JSON.stringify({ curator_id: parseInt(curatorId), group_ids: groupIds }) });
                showToast(`–ö—É—Ä–∞—Ç–æ—Ä –±–∞ ${groupIds.length} –≥—É—Ä”Ø“≥ —Ç–∞—ä–∏–Ω –∫–∞—Ä–¥–∞ —à—É–¥`, 'success');
                closeModal('bulk-curator-modal');
                loadGroups();
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        async function bulkDeleteGroups() {
            const ids = Array.from(document.querySelectorAll('.group-checkbox:checked')).map(cb => parseInt(cb.value));
            if (ids.length === 0) { showToast('–õ—É—Ç—Ñ–∞–Ω –≥—É—Ä”Ø“≥“≥–æ—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥', 'warning'); return; }
            if (!confirm(`${ids.length} –≥—É—Ä”Ø“≥—Ä–æ –Ω–µ—Å—Ç –º–µ–∫—É–Ω–µ–¥?`)) return;
            try {
                await apiCall('/dean/api/groups/bulk-delete', { method: 'POST', body: JSON.stringify({ group_ids: ids }) });
                showToast(`${ids.length} –≥—É—Ä”Ø“≥ –Ω–µ—Å—Ç –∫–∞—Ä–¥–∞ —à—É–¥`, 'success');
                loadGroups();
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        // ============================================
        // STUDENTS
        // ============================================
        async function loadStudents() {
            try {
                setLoading('students', true);
                const groupId = document.getElementById('student-filter-group').value;
                const courseId = document.getElementById('student-filter-course').value;
                const search = document.getElementById('student-search').value;
                let url = `/dean/api/students?page=${currentPage}&page_size=${pageSize}`;
                if (groupId) url += `&group_id=${groupId}`;
                if (courseId) url += `&course_id=${courseId}`;
                if (search) url += `&search=${encodeURIComponent(search)}`;
                const data = await apiCall(url);
                document.getElementById('total-students').textContent = data.total || 0;

                if (!data.students || data.students.length === 0) {
                    document.getElementById('students-table').innerHTML = '<tr><td colspan="9" class="px-5 py-12 text-center text-gray-500">–î–æ–Ω–∏—à“∑”Ø—ë–Ω –Ω–µ—Å—Ç</td></tr>';
                    document.getElementById('pagination-controls').innerHTML = '';
                    return;
                }

                const nbLimit = data.nb_limit || 35;
                const html = data.students.map((s, i) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-5 py-3"><input type="checkbox" class="student-checkbox" value="${s.id}" onchange="updateBulkCount('student')"></td>
                        <td class="px-5 py-3 text-gray-600">${(currentPage-1)*pageSize+i+1}</td>
                        <td class="px-5 py-3 font-medium text-gray-800">${escHtml(s.full_name)}</td>
                        <td class="px-5 py-3 text-gray-600">${s.student_code||'‚Äî'}</td>
                        <td class="px-5 py-3 text-gray-600">${escHtml(s.group_number||'‚Äî')}</td>
                        <td class="px-5 py-3 text-gray-600">${s.course_year||'‚Äî'}</td>
                        <td class="px-5 py-3 text-gray-600">${escHtml(s.region||'‚Äî')}</td>
                        <td class="px-5 py-3">
                            <span class="px-2 py-1 ${s.total_absences >= nbLimit ? 'bg-red-100 text-red-800' : s.total_absences >= nbLimit*0.7 ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'} rounded text-sm font-medium">${s.total_absences}</span>
                        </td>
                        <td class="px-5 py-3 flex items-center space-x-2">
                            <button onclick="viewStudent(${s.id})" class="text-blue-600 hover:text-blue-800" title="–î–∏–¥–∞–Ω"><i class="fas fa-eye"></i></button>
                            <button onclick="deleteStudent(${s.id})" class="text-red-600 hover:text-red-800" title="–ù–µ—Å—Ç"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>`).join('');

                document.getElementById('students-table').innerHTML = html;
                renderPagination(data.pages, currentPage);
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
            finally { setLoading('students', false); }
        }

        function renderPagination(totalPages, current) {
            if (!totalPages || totalPages <= 1) { document.getElementById('pagination-controls').innerHTML = ''; return; }
            let html = '';
            if (current > 1) html += `<button onclick="goToPage(${current-1})" class="px-3 py-1 border rounded hover:bg-gray-50"><i class="fas fa-chevron-left"></i></button>`;
            for (let i = Math.max(1, current-2); i <= Math.min(totalPages, current+2); i++) {
                html += `<button onclick="goToPage(${i})" class="px-3 py-1 border rounded ${i===current ? 'bg-blue-500 text-white border-blue-500' : 'hover:bg-gray-50'}">${i}</button>`;
            }
            if (current < totalPages) html += `<button onclick="goToPage(${current+1})" class="px-3 py-1 border rounded hover:bg-gray-50"><i class="fas fa-chevron-right"></i></button>`;
            document.getElementById('pagination-controls').innerHTML = html;
        }

        function goToPage(page) { currentPage = page; loadStudents(); }

        async function loadStudentFilters() {
            try {
                const groups = await apiCall('/dean/api/groups');
                const sel = document.getElementById('student-filter-group');
                if (sel) {
                    sel.innerHTML = '<option value="">“≤–∞–º–∞ –≥—É—Ä”Ø“≥</option>' + (groups||[]).map(g => `<option value="${g.id}">–ì—É—Ä”Ø“≥ ${escHtml(g.number)}</option>`).join('');
                    sel.dataset.loaded = '1';
                }
            } catch(e) {}
        }

        async function viewStudent(id) {
            try {
                const data = await apiCall(`/dean/api/students/${id}/profile`);
                const attHtml = (data.recent_attendance||[]).map(a =>
                    `<tr class="border-b text-sm"><td class="py-1.5 px-3">${a.date||''}</td><td class="py-1.5 px-3">${escHtml(a.subject||'')}</td><td class="py-1.5 px-3"><span class="px-2 py-0.5 rounded ${a.status==='present'?'bg-green-100 text-green-800':'bg-red-100 text-red-800'}">${a.status==='present'?'–ò—à—Ç–∏—Ä–æ–∫':'“í–æ–∏–±'}</span></td></tr>`
                ).join('');
                const html = `
                    <div class="modal active fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="if(event.target===this)this.remove()">
                        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 max-h-[90vh] overflow-y-auto">
                            <div class="px-6 py-4 border-b flex justify-between items-center sticky top-0 bg-white">
                                <h3 class="text-lg font-bold text-gray-800">${escHtml(data.full_name)}</h3>
                                <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
                            </div>
                            <div class="p-6 space-y-4">
                                <div class="grid grid-cols-2 gap-3 text-sm">
                                    <div><p class="text-xs text-gray-500 uppercase">–ö–æ–¥</p><p class="font-medium">${data.student_code||'‚Äî'}</p></div>
                                    <div><p class="text-xs text-gray-500 uppercase">–ì—É—Ä”Ø“≥</p><p class="font-medium">${escHtml(data.group_number||'‚Äî')}</p></div>
                                    <div><p class="text-xs text-gray-500 uppercase">–ú–∏–Ω—Ç–∞“õ–∞</p><p class="font-medium">${escHtml(data.region||'‚Äî')}</p></div>
                                    <div><p class="text-xs text-gray-500 uppercase">–¢–µ–ª–µ—Ñ–æ–Ω–∏ –≤–æ–ª–∏–¥–∞–π–Ω</p><p class="font-medium">${data.parent_phone ? `<a href="tel:${data.parent_phone}" class="text-blue-600">${data.parent_phone}</a>` : '‚Äî'}</p></div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="bg-red-50 p-3 rounded-lg text-center"><p class="text-2xl font-bold text-red-600">${data.total_absences||0}</p><p class="text-xs text-gray-600">“≤–∞–º–∞–≥”£ NB</p></div>
                                    <div class="bg-blue-50 p-3 rounded-lg text-center"><p class="text-2xl font-bold text-blue-600">${data.nb_status||'ACTIVE'}</p><p class="text-xs text-gray-600">–°—Ç–∞—Ç—É—Å–∏ NB</p></div>
                                </div>
                                ${attHtml ? `<div class="border-t pt-4"><h4 class="font-bold text-gray-800 mb-2 text-sm">–û—Ö–∏—Ä–∏–Ω –¥–∞—Ä—Å“≥–æ</h4><div class="overflow-x-auto"><table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="py-1.5 px-3 text-left">–°–∞–Ω–∞</th><th class="py-1.5 px-3 text-left">–§–∞–Ω</th><th class="py-1.5 px-3 text-left">–°—Ç–∞—Ç—É—Å</th></tr></thead><tbody>${attHtml}</tbody></table></div></div>` : ''}
                            </div>
                        </div>
                    </div>`;
                document.body.insertAdjacentHTML('beforeend', html);
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        async function deleteStudent(id) {
            if (!confirm('–î–æ–Ω–∏—à“∑”Ø—Ä–æ –Ω–µ—Å—Ç –∫—É–Ω–µ–º?')) return;
            try {
                await apiCall(`/dean/api/students/${id}`, { method: 'DELETE' });
                showToast('–î–æ–Ω–∏—à“∑”Ø –Ω–µ—Å—Ç –∫–∞—Ä–¥–∞ —à—É–¥', 'success');
                loadStudents();
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        async function importStudents(e) {
            e.preventDefault();
            const form = e.target;
            const groupId = document.getElementById('import-group-select').value;
            if (!groupId) { showToast('–õ—É—Ç—Ñ–∞–Ω –≥—É—Ä”Ø“≥—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥', 'warning'); return; }
            try {
                showToast('–ò–º–ø–æ—Ä—Ç –¥–∞—Ä “∑–∞—Ä–∞—ë–Ω...', 'info');
                const fd = new FormData(form);
                const data = await apiCall(`/dean/api/students/import?group_id=${groupId}`, { method: 'POST', body: fd, headers: {} });
                showToast(`–ò–º–ø–æ—Ä—Ç —Ç–∞–º–æ–º —à—É–¥: ${data.created} —ç“∑–æ–¥, ${data.skipped} –≥—É–∑–∞—à—Ç`, 'success');
                closeModal('import-modal');
                form.reset();
                loadStudents();
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        async function bulkDeleteStudents() {
            const ids = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => parseInt(cb.value));
            if (ids.length === 0) { showToast('–õ—É—Ç—Ñ–∞–Ω –¥–æ–Ω–∏—à“∑”Ø—ë–Ω—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥', 'warning'); return; }
            if (!confirm(`${ids.length} –¥–æ–Ω–∏—à“∑”Ø—Ä–æ –Ω–µ—Å—Ç –º–µ–∫—É–Ω–µ–¥?`)) return;
            try {
                await apiCall('/dean/api/students/bulk-delete', { method: 'POST', body: JSON.stringify({ student_ids: ids }) });
                showToast(`${ids.length} –¥–æ–Ω–∏—à“∑”Ø –Ω–µ—Å—Ç –∫–∞—Ä–¥–∞ —à—É–¥`, 'success');
                loadStudents();
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        async function bulkNBAction(action) {
            const ids = Array.from(document.querySelectorAll('.student-checkbox:checked')).map(cb => parseInt(cb.value));
            if (ids.length === 0) { showToast('–õ—É—Ç—Ñ–∞–Ω –¥–æ–Ω–∏—à“∑”Ø—ë–Ω—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥', 'warning'); return; }
            try {
                await apiCall('/dean/api/students/nb/bulk-action', { method: 'POST', body: JSON.stringify({ student_ids: ids, action }) });
                showToast('NB –Ω–∞–≤—Å–æ–∑”£ –∫–∞—Ä–¥–∞ —à—É–¥', 'success');
                loadStudents();
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        // ============================================
        // AT-RISK
        // ============================================
        async function loadAtRiskStudents() {
            try {
                setLoading('at-risk', true);
                const groupId = document.getElementById('at-risk-filter-group').value;
                const courseId = document.getElementById('at-risk-filter-course').value;
                let url = '/dean/api/students/at-risk?';
                if (groupId) url += `group_id=${groupId}&`;
                if (courseId) url += `course_id=${courseId}&`;
                const data = await apiCall(url);

                if (!data || data.length === 0) {
                    document.getElementById('at-risk-table').innerHTML = '<tr><td colspan="8" class="px-5 py-12 text-center text-gray-500"><i class="fas fa-check-circle text-green-500 text-2xl mr-2"></i>–î–æ–Ω–∏—à“∑”Ø—ë–Ω–∏ —Ö–∞–≤—Ñ–Ω–æ–∫ –Ω–µ—Å—Ç</td></tr>';
                    return;
                }

                const html = data.map((s, i) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-5 py-3 text-gray-600">${i+1}</td>
                        <td class="px-5 py-3 font-medium text-gray-800">${escHtml(s.full_name)}</td>
                        <td class="px-5 py-3 text-gray-600">${s.student_code||'‚Äî'}</td>
                        <td class="px-5 py-3 text-gray-600">${escHtml(s.group_number||'‚Äî')}</td>
                        <td class="px-5 py-3 text-gray-600">${s.course_year||'‚Äî'}</td>
                        <td class="px-5 py-3"><span class="px-3 py-1 bg-red-100 text-red-800 rounded font-bold">${s.total_absences}</span></td>
                        <td class="px-5 py-3 text-gray-600">${s.parent_phone ? `<a href="tel:${s.parent_phone}" class="text-blue-600 hover:underline">${s.parent_phone}</a>` : '‚Äî'}</td>
                        <td class="px-5 py-3 flex items-center space-x-2">
                            <button onclick="viewStudent(${s.id})" class="text-blue-600 hover:text-blue-800" title="–î–∏–¥–∞–Ω"><i class="fas fa-eye"></i></button>
                            ${s.parent_phone ? `<a href="tel:${s.parent_phone}" class="text-green-600 hover:text-green-800" title="–ó–∞–Ω–≥ –∑–∞–¥–∞–Ω"><i class="fas fa-phone"></i></a>` : ''}
                        </td>
                    </tr>`).join('');
                document.getElementById('at-risk-table').innerHTML = html;
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
            finally { setLoading('at-risk', false); }
        }

        async function loadAtRiskFilters() {
            // Groups already loaded by loadGroups via shared logic
        }

        // ============================================
        // AUDIT LOG
        // ============================================
        async function loadAuditLog() {
            try {
                setLoading('audit-log', true);
                const action = document.getElementById('audit-filter-action').value;
                const date = document.getElementById('audit-filter-date').value;
                let url = '/dean/api/audit-log?';
                if (action) url += `action=${action}&`;
                if (date) url += `date=${date}&`;
                const data = await apiCall(url);

                if (!data || data.length === 0) {
                    document.getElementById('audit-log-table').innerHTML = '<tr><td colspan="5" class="px-5 py-12 text-center text-gray-500">–°–∞–±—Ç“≥–æ –Ω–µ—Å—Ç</td></tr>';
                    return;
                }

                const html = data.map(log => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-5 py-3 text-sm text-gray-600">${formatDate(log.created_at)}</td>
                        <td class="px-5 py-3 text-sm text-gray-800">${escHtml(log.user_name||'‚Äî')}</td>
                        <td class="px-5 py-3"><span class="px-2 py-1 text-xs rounded ${log.action==='CREATE' ? 'bg-green-100 text-green-800' : log.action==='UPDATE' ? 'bg-blue-100 text-blue-800' : 'bg-red-100 text-red-800'}">${log.action}</span></td>
                        <td class="px-5 py-3 text-sm text-gray-600">${log.target_table||'‚Äî'}</td>
                        <td class="px-5 py-3 text-sm text-gray-600">${escHtml(log.description||'‚Äî')}</td>
                    </tr>`).join('');
                document.getElementById('audit-log-table').innerHTML = html;
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
            finally { setLoading('audit-log', false); }
        }

        // ============================================
        // SETTINGS
        // ============================================
        async function loadSettings() {
            try {
                const data = await apiCall('/dean/api/settings');
                document.getElementById('setting-nb-limit').value = data.NB_LIMIT || 35;
                document.getElementById('setting-alert-days').value = data.ALERT_CONSECUTIVE_DAYS || 5;
                document.getElementById('setting-attendance-threshold').value = data.ATTENDANCE_THRESHOLD || 70;
            } catch(e) { console.error('Load settings error:', e); }
        }

        async function saveSettings() {
            try {
                await apiCall('/dean/api/settings', {
                    method: 'POST',
                    body: JSON.stringify({
                        NB_LIMIT: parseInt(document.getElementById('setting-nb-limit').value),
                        ALERT_CONSECUTIVE_DAYS: parseInt(document.getElementById('setting-alert-days').value),
                        ATTENDANCE_THRESHOLD: parseInt(document.getElementById('setting-attendance-threshold').value)
                    })
                });
                showToast('–¢–∞–Ω–∑–∏–º–æ—Ç —Å–∞–±—Ç –∫–∞—Ä–¥–∞ —à—É–¥', 'success');
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        // ============================================
        // PROFILE - Edit
        // ============================================
        async function saveProfile(e) {
            e.preventDefault();
            const body = JSON.stringify({
                full_name: document.getElementById('profile-full-name').value,
                email: document.getElementById('profile-email').value,
                phone: document.getElementById('profile-phone').value,
            });
            try {
                await apiCall('/dean/api/profile', { method: 'PATCH', body });
                showToast('–ü—Ä–æ—Ñ–∏–ª –Ω–∞–≤—Å–æ–∑”£ —à—É–¥. –°–∞“≥–∏—Ñ–∞—Ä–æ –±–æ–∑—Ñ—Ä–µ—à –∫—É–Ω–µ–¥.', 'success');
                closeModal('edit-profile-modal');
                // Update displayed name without page reload
                const fn = document.getElementById('profile-full-name').value;
                document.querySelectorAll('.profile-name-display').forEach(el => el.textContent = fn);
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        // ============================================
        // CHANGE PASSWORD
        // ============================================
        async function changePassword() {
            const currentPw = document.getElementById('cp-current').value;
            const newPw = document.getElementById('cp-new').value;
            const confirmPw = document.getElementById('cp-confirm').value;
            const errEl = document.getElementById('cp-error');
            const sucEl = document.getElementById('cp-success');
            errEl.classList.add('hidden');
            sucEl.classList.add('hidden');

            if (!currentPw || !newPw || !confirmPw) {
                errEl.textContent = '“≤–∞–º–∞–∏ –º–∞–π–¥–æ–Ω“≥–æ—Ä–æ –ø—É—Ä –∫—É–Ω–µ–¥';
                errEl.classList.remove('hidden');
                return;
            }
            if (newPw !== confirmPw) {
                errEl.textContent = '–ü–∞—Ä–æ–ª“≥–æ–∏ –Ω–∞–≤ –º—É–≤–æ—Ñ–∏“õ –Ω–µ—Å—Ç–∞–Ω–¥';
                errEl.classList.remove('hidden');
                return;
            }
            if (newPw.length < 8) {
                errEl.textContent = '–ü–∞—Ä–æ–ª –±–æ—è–¥ “≥–∞–¥–¥–∏ –∞“õ–∞–ª 8 –∞–ª–æ–º–∞—Ç –¥–æ—à—Ç–∞ –±–æ—à–∞–¥';
                errEl.classList.remove('hidden');
                return;
            }
            try {
                await apiCall('/dean/api/change-password', {
                    method: 'POST',
                    body: JSON.stringify({ current_password: currentPw, new_password: newPw })
                });
                sucEl.textContent = '–ü–∞—Ä–æ–ª –±–æ–º—É–≤–∞—Ñ—Ñ–∞“õ–∏—è—Ç –∏–≤–∞–∑ –∫–∞—Ä–¥–∞ —à—É–¥! –î—É–±–æ—Ä–∞ –≤–æ—Ä–∏–¥ —à–∞–≤–µ–¥.';
                sucEl.classList.remove('hidden');
                document.getElementById('cp-current').value = '';
                document.getElementById('cp-new').value = '';
                document.getElementById('cp-confirm').value = '';
                setTimeout(() => { window.location.href = '/logout'; }, 2000);
            } catch(e) {
                errEl.textContent = e.message || '–•–∞—Ç–æ–≥”£ —Ä—É—Ö –¥–æ–¥';
                errEl.classList.remove('hidden');
            }
        }

        // ============================================
        // WEEKLY STATS (4.2, 4.3, 5.1, 8, 9)
        // ============================================
        async function loadWeeklyStats() {
            const lpw = parseInt(document.getElementById('weekly-lpw').value) || 25;
            try {
                const data = await apiCall(`/dean/api/weekly-stats?total_lessons_per_week=${lpw}`);

                // 4.2 + 4.3
                document.getElementById('weekly-att-this').textContent = data.att_pct_this_week + '%';
                document.getElementById('weekly-att-prev').textContent = data.att_pct_prev_week + '%';
                const dynEl = document.getElementById('weekly-dynamics');
                const sym = data.dynamics_symbol;
                const diff = data.dynamics_diff;
                const dynColor = sym === '‚ñ≤' ? 'text-green-600' : sym === '‚ñº' ? 'text-red-600' : 'text-gray-500';
                dynEl.innerHTML = `<span class="${dynColor}">${sym} ${Math.abs(diff)}%</span>`;
                document.getElementById('weekly-week-label').textContent =
                    `${data.week.from} ‚Äî ${data.week.to}`;

                // 9 Smart Alerts
                const alertsEl = document.getElementById('weekly-alerts');
                let alertHtml = '';
                if (data.group_of_week) {
                    const g = data.group_of_week;
                    alertHtml += `<div class="flex items-start space-x-3 p-3 rounded-lg bg-green-50 border border-green-200">
                        <span class="text-2xl">üèÜ</span>
                        <div>
                            <p class="font-bold text-green-800">–ì—É—Ä”Ø“≥–∏ “≥–∞—Ñ—Ç–∞: –ì—É—Ä”Ø“≥ ${escHtml(g.number)}</p>
                            <p class="text-sm text-green-700">–ò—à—Ç–∏—Ä–æ–∫: ${g.att_pct}% | NB%: ${g.nb_pct}% | Risk: üü¢</p>
                        </div>
                    </div>`;
                }
                if (data.smart_alerts && data.smart_alerts.length > 0) {
                    data.smart_alerts.forEach(a => {
                        const cls = a.level === 'error' ? 'bg-red-50 border-red-200 text-red-800' : 'bg-yellow-50 border-yellow-200 text-yellow-800';
                        alertHtml += `<div class="flex items-start space-x-3 p-3 rounded-lg border ${cls}">
                            <span class="text-xl">${a.emoji}</span>
                            <p class="text-sm font-medium">${escHtml(a.msg)}</p>
                        </div>`;
                    });
                }
                if (!alertHtml) alertHtml = '<p class="text-center text-gray-500 py-8"><i class="fas fa-check-circle text-green-500 text-2xl mb-2 block"></i>–û–≥–æ“≥–∏“≥–æ –Ω–µ—Å—Ç</p>';
                alertsEl.innerHTML = alertHtml;

                // 8 TOP 5
                const riskColors = { green: 'bg-green-50 border-green-200', yellow: 'bg-yellow-50 border-yellow-200', orange: 'bg-orange-50 border-orange-200', red: 'bg-red-50 border-red-200' };
                const renderWeekGroup = (g, i, baseClass) => `
                    <div class="flex items-center justify-between p-3 ${baseClass} rounded-lg border">
                        <div class="flex items-center space-x-3">
                            <span class="w-7 h-7 flex items-center justify-center bg-white bg-opacity-60 rounded-full font-bold text-sm">${i+1}</span>
                            <div>
                                <p class="font-medium text-gray-800 text-sm">–ì—É—Ä”Ø“≥ ${escHtml(g.number)}</p>
                                <p class="text-xs text-gray-500">${g.total_students} –¥–æ–Ω–∏—à“∑”Ø | ${g.risk.emoji} ${escHtml(g.risk.label)}</p>
                            </div>
                        </div>
                        <div class="text-right text-sm">
                            <p class="font-bold">NB: ${g.nb_pct}%</p>
                            <p class="text-xs text-gray-500">–ò—à—Ç–∏—Ä–æ–∫: ${g.att_pct}%</p>
                        </div>
                    </div>`;

                document.getElementById('weekly-best-groups').innerHTML =
                    (data.top5_best || []).length
                    ? (data.top5_best || []).map((g,i) => renderWeekGroup(g, i, 'bg-green-50')).join('')
                    : '<p class="text-center text-gray-500 py-4">–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</p>';

                document.getElementById('weekly-worst-groups').innerHTML =
                    (data.top5_worst || []).length
                    ? (data.top5_worst || []).map((g,i) => renderWeekGroup(g, i, 'bg-red-50')).join('')
                    : '<p class="text-center text-gray-500 py-4">–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</p>';

                // 5.1 Risk table
                const riskBadges = {
                    green:  'bg-green-100 text-green-800',
                    yellow: 'bg-yellow-100 text-yellow-800',
                    orange: 'bg-orange-100 text-orange-800',
                    red:    'bg-red-100 text-red-800',
                };
                const tableHtml = (data.group_stats || []).map(g => {
                    const diff = g.nb_pct_prev > 0 ? (g.nb_pct - g.nb_pct_prev).toFixed(1) : '‚Äî';
                    const diffSpan = diff !== '‚Äî'
                        ? `<span class="${parseFloat(diff) > 0 ? 'text-red-600' : 'text-green-600'}">${parseFloat(diff) > 0 ? '‚ñ≤' : '‚ñº'} ${Math.abs(diff)}%</span>`
                        : '‚Äî';
                    return `<tr class="hover:bg-gray-50 transition">
                        <td class="px-5 py-3 font-medium text-gray-800">${escHtml(g.number)}</td>
                        <td class="px-5 py-3 text-gray-600">${g.total_students}</td>
                        <td class="px-5 py-3 font-bold text-gray-800">${g.nb_pct}%</td>
                        <td class="px-5 py-3 text-gray-500">${g.nb_pct_prev}% ${diff !== '‚Äî' ? diffSpan : ''}</td>
                        <td class="px-5 py-3 text-gray-600">${g.att_pct}%</td>
                        <td class="px-5 py-3"><span class="px-2 py-1 rounded text-sm font-medium ${riskBadges[g.risk.color] || ''}">${g.risk.emoji} ${escHtml(g.risk.label)}</span></td>
                    </tr>`;
                }).join('');
                document.getElementById('weekly-group-table').innerHTML =
                    tableHtml || '<tr><td colspan="6" class="px-5 py-8 text-center text-gray-500">–ì—É—Ä”Ø“≥“≥–æ –Ω–µ—Å—Ç</td></tr>';

            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        // ============================================
        // REGISTRY (14)
        // ============================================
        let registryFilters = { course_id: null, shift: null, birth_place: null };

        async function loadRegistry() {
            try {
                let url = '/dean/api/students/registry?';
                if (registryFilters.course_id) url += `course_id=${registryFilters.course_id}&`;
                if (registryFilters.shift) url += `shift=${registryFilters.shift}&`;
                if (registryFilters.birth_place) url += `birth_place=${encodeURIComponent(registryFilters.birth_place)}&`;

                const data = await apiCall(url);
                document.getElementById('registry-total').textContent = data.total || 0;

                // Render filter pills
                renderRegistryFilterPills(data.filters);

                // Render table
                if (!data.students || data.students.length === 0) {
                    document.getElementById('registry-table').innerHTML = '<tr><td colspan="9" class="px-5 py-12 text-center text-gray-500">–î–æ–Ω–∏—à“∑”Ø—ë–Ω –Ω–µ—Å—Ç</td></tr>';
                    return;
                }
                const html = data.students.map((s, i) => `
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-5 py-3 text-gray-600">${i+1}</td>
                        <td class="px-5 py-3 font-medium text-gray-800">${escHtml(s.full_name)}</td>
                        <td class="px-5 py-3 text-gray-500 text-sm">${escHtml(s.student_code||'‚Äî')}</td>
                        <td class="px-5 py-3 text-gray-600">${escHtml(s.group_number||'‚Äî')}</td>
                        <td class="px-5 py-3 text-gray-600">${s.course_year||'‚Äî'}</td>
                        <td class="px-5 py-3"><span class="px-2 py-1 ${s.shift===1?'bg-yellow-100 text-yellow-800':'bg-blue-100 text-blue-800'} rounded text-sm">${s.shift||'‚Äî'}-–Ω–∞–≤–±–∞—Ç</span></td>
                        <td class="px-5 py-3 text-gray-600">${escHtml(s.birth_place||'‚Äî')}</td>
                        <td class="px-5 py-3 text-gray-600">${escHtml(s.parent_phone||'‚Äî')}</td>
                        <td class="px-5 py-3"><span class="px-2 py-1 ${s.total_absences>=35?'bg-red-100 text-red-800':s.total_absences>=20?'bg-yellow-100 text-yellow-800':'bg-green-100 text-green-800'} rounded text-sm">${s.total_absences}</span></td>
                    </tr>`).join('');
                document.getElementById('registry-table').innerHTML = html;
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        function renderRegistryFilterPills(filters) {
            if (!filters) return;
            // Courses
            const coursesEl = document.getElementById('registry-course-filters');
            if (coursesEl) {
                coursesEl.innerHTML = (filters.courses || []).map(c => {
                    const active = registryFilters.course_id == c.id;
                    return `<button onclick="setRegistryFilter('course_id', ${c.id})"
                        class="px-3 py-1 rounded-full text-sm font-medium transition border ${active ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'}">
                        ${c.year}-–∫—É—Ä—Å <span class="ml-1 opacity-70">(${c.count})</span>
                    </button>`;
                }).join('');
            }
            // Shifts
            const shiftsEl = document.getElementById('registry-shift-filters');
            if (shiftsEl) {
                shiftsEl.innerHTML = (filters.shifts || []).map(s => {
                    const active = registryFilters.shift == s.shift;
                    return `<button onclick="setRegistryFilter('shift', ${s.shift})"
                        class="px-3 py-1 rounded-full text-sm font-medium transition border ${active ? 'bg-blue-500 text-white border-blue-500' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'}">
                        ${escHtml(s.label)} <span class="ml-1 opacity-70">(${s.count})</span>
                    </button>`;
                }).join('');
            }
            // Birth places
            const bpEl = document.getElementById('registry-bp-filters');
            if (bpEl) {
                bpEl.innerHTML = (filters.birth_places || []).map(bp => {
                    const active = registryFilters.birth_place === bp.value;
                    return `<button onclick="setRegistryFilter('birth_place', ${JSON.stringify(bp.value)})"
                        class="px-3 py-1 rounded-full text-sm font-medium transition border ${active ? 'bg-indigo-500 text-white border-indigo-500' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-50'}">
                        ${escHtml(bp.value)} <span class="ml-1 opacity-70">(${bp.count})</span>
                    </button>`;
                }).join('');
            }
        }

        function setRegistryFilter(key, value) {
            if (registryFilters[key] == value) {
                registryFilters[key] = null; // toggle off
            } else {
                registryFilters[key] = value;
            }
            loadRegistry();
        }

        function resetRegistryFilters() {
            registryFilters = { course_id: null, shift: null, birth_place: null };
            loadRegistry();
        }

        // ============================================
        // EXPORT
        // ============================================
        async function exportData(type) {
            try {
                showToast('–≠–∫—Å–ø–æ—Ä—Ç –¥–∞—Ä “∑–∞—Ä–∞—ë–Ω...', 'info');
                const response = await fetch(`/dean/api/export/${type}`, { credentials: 'same-origin' });
                if (!response.ok) throw new Error('–•–∞—Ç–æ–≥”£ –¥–∞—Ä —ç–∫—Å–ø–æ—Ä—Ç');
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${type}_${new Date().toISOString().slice(0,10)}.csv`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                window.URL.revokeObjectURL(url);
                showToast('–§–∞–π–ª –∑–µ—Ä–∫–∞—à”£ —à—É–¥', 'success');
            } catch(e) { showToast('–•–∞—Ç–æ–≥”£: ' + e.message, 'error'); }
        }

        // ============================================
        // XSS PROTECTION
        // ============================================
        function escHtml(str) {
            if (str == null) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        // ============================================
        // INIT
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboard();
            // Set current year in header
            document.getElementById('current-year').textContent = new Date().getFullYear();
        });
    </script>
</body>
</html>