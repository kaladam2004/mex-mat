<!DOCTYPE html>
<html lang="tg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ó–∞–º–¥–µ–∫–∞–Ω ‚Äî –ú–µ—Ö-–º–∞—Ç</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#7c3aed;--primary-dark:#6d28d9;--primary-light:#ede9fe;--primary-xlight:#f5f3ff;
  --success:#059669;--success-light:#d1fae5;--warning:#d97706;--warning-light:#fef3c7;
  --danger:#dc2626;--danger-light:#fee2e2;--info:#0284c7;--info-light:#e0f2fe;
  --bg:#f5f3ff;--surface:#fff;--surface2:#faf9ff;--border:#e5e0fd;--border-light:#f0ecff;
  --text:#0f172a;--text-2:#334155;--text-3:#64748b;--text-4:#94a3b8;
  --sidebar-w:256px;--topbar-h:60px;
  --radius:12px;--radius-sm:8px;
  --shadow-sm:0 1px 4px rgba(124,58,237,.08);--shadow:0 4px 16px rgba(124,58,237,.12);
  --tr:all .2s cubic-bezier(.4,0,.2,1);
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;overflow-x:hidden}
.sidebar{width:var(--sidebar-w);min-height:100vh;background:var(--surface);border-right:1.5px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:200;transition:transform .3s ease;overflow-y:auto}
.slogo{padding:1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.75rem;flex-shrink:0}
.slogo img{width:38px;height:38px;border-radius:9px;object-fit:cover;border:2px solid var(--border)}
.sbrand{font-size:.85rem;font-weight:800;color:var(--text)}
.sbrand span{font-size:.7rem;font-weight:500;color:var(--text-3);display:block}
.suser{padding:1rem 1.25rem;border-bottom:1px solid var(--border);flex-shrink:0}
.savatar{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--primary),#a855f7);display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:800;color:#fff;flex-shrink:0}
.surow{display:flex;align-items:center;gap:.75rem;margin-bottom:.5rem}
.suname{font-size:.875rem;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.badge{display:inline-flex;font-size:.7rem;font-weight:600;padding:.2rem .6rem;border-radius:20px}
.badge-purple{background:var(--primary-light);color:var(--primary)}
.snav{flex:1;padding:.625rem .75rem}
.nsec{font-size:.68rem;font-weight:700;color:var(--text-4);text-transform:uppercase;letter-spacing:.08em;padding:.75rem .75rem .35rem}
.nitem{display:flex;align-items:center;gap:.625rem;padding:.65rem .875rem;border-radius:var(--radius-sm);font-size:.83rem;font-weight:600;color:var(--text-3);cursor:pointer;transition:var(--tr);text-decoration:none;border:none;background:none;width:100%;text-align:left;margin-bottom:1px}
.nitem:hover{background:var(--primary-xlight);color:var(--primary)}
.nitem.active{background:var(--primary-light);color:var(--primary);font-weight:700}
.nitem svg{width:15px;height:15px;flex-shrink:0}
.sfoot{padding:.875rem .75rem;border-top:1px solid var(--border);flex-shrink:0;display:flex;gap:.5rem}
.fbtna{display:flex;align-items:center;justify-content:center;gap:.35rem;flex:1;padding:.625rem .5rem;border-radius:var(--radius-sm);font-size:.75rem;font-weight:700;font-family:inherit;cursor:pointer;border:1.5px solid var(--border);background:var(--surface2);color:var(--text-2);text-decoration:none;transition:var(--tr)}
.fbtna:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-xlight)}
.fbtna.dng{color:var(--danger);border-color:var(--danger-light)}.fbtna.dng:hover{background:var(--danger-light)}
.fbtna svg{width:13px;height:13px}
.overlay{display:none;position:fixed;inset:0;background:rgba(15,23,42,.4);z-index:150;backdrop-filter:blur(2px)}
.overlay.show{display:block}
.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh;transition:margin .3s ease}
.topbar{height:var(--topbar-h);background:var(--surface);border-bottom:1.5px solid var(--border);display:flex;align-items:center;padding:0 1.5rem;gap:.875rem;position:sticky;top:0;z-index:100;box-shadow:var(--shadow-sm)}
.mtoggle{display:none;width:36px;height:36px;border:none;background:var(--bg);border-radius:var(--radius-sm);cursor:pointer;align-items:center;justify-content:center;color:var(--text-2);flex-shrink:0}
.mtoggle svg{width:18px;height:18px}
.tbtitle{font-size:.95rem;font-weight:700;color:var(--text);flex:1}
.content{padding:1.5rem;flex:1}
.section{display:none}
.section.active{display:block;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:.875rem;margin-bottom:1.25rem}
.kpi{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:1rem;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:space-between;gap:.875rem}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi.purple::before{background:var(--primary)}.kpi.blue::before{background:#2563eb}.kpi.green::before{background:var(--success)}.kpi.warn::before{background:var(--warning)}.kpi.danger::before{background:var(--danger)}.kpi.info::before{background:var(--info)}
.kpi-text p{font-size:.78rem;color:var(--text-3);font-weight:500}
.kpi-text .kv{font-size:1.75rem;font-weight:700;font-family:'JetBrains Mono',monospace;line-height:1;margin-top:.2rem}
.kpi-ico{width:40px;height:40px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.kpi-ico svg{width:18px;height:18px}
.kpi.purple .kpi-ico{background:var(--primary-light);color:var(--primary)}.kpi.blue .kpi-ico{background:#dbeafe;color:#2563eb}.kpi.green .kpi-ico{background:var(--success-light);color:var(--success)}.kpi.warn .kpi-ico{background:var(--warning-light);color:var(--warning)}.kpi.danger .kpi-ico{background:var(--danger-light);color:var(--danger)}.kpi.info .kpi-ico{background:var(--info-light);color:var(--info)}
.panel{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:1.125rem}
.phead{padding:.875rem 1.125rem;border-bottom:1px solid var(--border-light);display:flex;align-items:center;justify-content:space-between;gap:.875rem;flex-wrap:wrap}
.phead h3{font-size:.9rem;font-weight:700;color:var(--text);display:flex;align-items:center;gap:.5rem;margin:0}
.phead h3 svg{width:14px;height:14px;color:var(--primary)}
.pbody{padding:1.125rem}
.ph{margin-bottom:1.25rem;display:flex;align-items:flex-start;justify-content:space-between;gap:.875rem;flex-wrap:wrap}
.ph h1{font-size:1.2rem;font-weight:800;color:var(--text)}
.ph p{font-size:.82rem;color:var(--text-3);margin-top:.2rem}
.phacts{display:flex;gap:.625rem;flex-wrap:wrap;flex-shrink:0}
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem 1.125rem;border:none;border-radius:var(--radius-sm);font-size:.83rem;font-weight:700;font-family:inherit;cursor:pointer;transition:var(--tr)}
.btn svg{width:14px;height:14px;flex-shrink:0}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark);transform:translateY(-1px)}
.btn-success{background:var(--success);color:#fff}.btn-success:hover{background:#047857}
.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#b91c1c}
.btn-ghost{background:transparent;border:1.5px solid var(--border);color:var(--text-2)}.btn-ghost:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-xlight)}
.btn-sm{padding:.45rem .875rem;font-size:.78rem}.btn-xs{padding:.3rem .625rem;font-size:.72rem}
.btn:disabled{opacity:.6;cursor:not-allowed}
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch}
table.tbl{width:100%;border-collapse:collapse;min-width:520px}
.tbl thead{background:var(--surface2)}
.tbl th{padding:.625rem .875rem;font-size:.72rem;font-weight:700;color:var(--text-3);text-align:left;border-bottom:1.5px solid var(--border);text-transform:uppercase;letter-spacing:.04em}
.tbl td{padding:.7rem .875rem;border-bottom:1px solid var(--border-light);font-size:.83rem}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:var(--primary-xlight)}
.chip{display:inline-flex;align-items:center;font-size:.7rem;font-weight:700;padding:.2rem .625rem;border-radius:20px}
.chip-green{background:var(--success-light);color:var(--success)}.chip-warn{background:var(--warning-light);color:var(--warning)}.chip-red{background:var(--danger-light);color:var(--danger)}.chip-purple{background:var(--primary-light);color:var(--primary)}.chip-blue{background:#dbeafe;color:#1d4ed8}
.filters{display:flex;gap:.625rem;flex-wrap:wrap}
.finp{padding:.6rem .875rem;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.83rem;color:var(--text);font-family:inherit;outline:none;transition:border-color .2s}
.finp:focus{border-color:var(--primary)}.finp::placeholder{color:var(--text-4)}
.modal-ov{display:none;position:fixed;inset:0;background:rgba(15,23,42,.5);z-index:9999;align-items:center;justify-content:center;padding:1rem;backdrop-filter:blur(4px)}
.modal-ov.show{display:flex}
.modal-box{background:var(--surface);border:1.5px solid var(--border);border-radius:16px;padding:1.5rem;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow)}
.mtitle{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem}
.mtitle h3{font-size:1rem;font-weight:800;color:var(--text)}
.mclose{width:30px;height:30px;border:none;background:var(--bg);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-3);transition:var(--tr)}
.mclose:hover{background:var(--danger-light);color:var(--danger)}.mclose svg{width:14px;height:14px}
.fg{margin-bottom:.875rem}
.fg label{display:block;font-size:.75rem;font-weight:700;color:var(--text-2);margin-bottom:.375rem;text-transform:uppercase;letter-spacing:.05em}
.fg .finp{width:100%}
.fg textarea.finp{resize:vertical;min-height:80px}
.mactions{display:flex;gap:.625rem;margin-top:1.125rem}
.mactions .btn{flex:1;justify-content:center}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:1.125rem;margin-bottom:1.125rem}
.toast-cnt{position:fixed;top:72px;right:1.25rem;z-index:99999;display:flex;flex-direction:column;gap:.5rem;pointer-events:none}
.toast{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:.7rem 1rem;font-size:.83rem;display:flex;align-items:center;gap:.625rem;box-shadow:var(--shadow);animation:tIn .25s ease;pointer-events:auto;font-weight:600;max-width:320px}
.toast svg{flex-shrink:0;width:15px;height:15px}
.toast.succ{border-color:rgba(5,150,105,.4)}.toast.succ svg{color:var(--success)}
.toast.err{border-color:rgba(220,38,38,.4)}.toast.err svg{color:var(--danger)}
@keyframes tIn{from{opacity:0;transform:translateX(15px)}to{opacity:1;transform:none}}
.loading{display:flex;align-items:center;justify-content:center;padding:3rem}
.spinner{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:3rem;color:var(--text-3);font-size:.875rem}
.info-row{display:flex;gap:.5rem;align-items:baseline;margin-bottom:.625rem}
.info-row .lbl{font-size:.75rem;color:var(--text-3);min-width:110px;font-weight:600}
.info-row .val{font-size:.875rem;font-weight:600;color:var(--text)}
.status-dot{width:8px;height:8px;border-radius:50%;display:inline-block;flex-shrink:0}
.dot-green{background:var(--success)}.dot-warn{background:var(--warning)}.dot-red{background:var(--danger)}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0);box-shadow:var(--shadow)}
  .main{margin-left:0}.mtoggle{display:inline-flex}
  .content{padding:1rem}.kpi-grid{grid-template-columns:repeat(2,1fr)}.g2{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeSB()"></div>

<aside class="sidebar" id="sidebar">
  <div class="slogo">
    <img src="/static/logo.jpg" alt="Logo">
    <div class="sbrand">–ó–∞–º–¥–µ–∫–∞–Ω<span>–°–∏—Å—Ç–µ–º–∞–∏ –ú–µ—Ö-–º–∞—Ç</span></div>
  </div>
  <div class="suser">
    <div class="surow">
      <div class="savatar">{{ user.full_name[0].upper() if user.full_name else '–ó' }}</div>
      <div style="flex:1;min-width:0">
        <div class="suname">{{ user.full_name or '–ó–∞–º–¥–µ–∫–∞–Ω' }}</div>
      </div>
    </div>
    <span class="badge badge-purple">–ó–∞–º–¥–µ–∫–∞–Ω–∏ —Ñ–∞–∫—É–ª—Ç–µ—Ç</span>
  </div>
  <nav class="snav">
    <div class="nsec">–ê—Å–æ—Å”£</div>
    <button class="nitem active" onclick="showSec('dashboard',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      –£–º—É–º”£
    </button>
    <button class="nitem" onclick="showSec('students',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
      –î–æ–Ω–∏—à“∑”Ø—ë–Ω
    </button>
    <button class="nitem" onclick="showSec('at-risk',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
      –•–∞–≤—Ñ–Ω–æ–∫ (NB)
    </button>
    <button class="nitem" onclick="showSec('groups',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87"/><path d="M16 3.13a4 4 0 010 7.75"/></svg>
      –ì—É—Ä”Ø“≥“≥–æ
    </button>
    <button class="nitem" onclick="showSec('curators',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      –ö—É—Ä–∞—Ç–æ—Ä–æ–Ω
    </button>
    <button class="nitem" onclick="showSec('monitoring',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
      –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
    </button>
    <div class="nsec">–ù–∏–∑–æ–º</div>
    <button class="nitem" onclick="showSec('profile',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      –ü—Ä–æ—Ñ–∏–ª
    </button>
  </nav>
  <div class="sfoot">
    <button class="fbtna" onclick="showSec('change-pw',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
      –ü–∞—Ä–æ–ª
    </button>
    <a href="/logout" class="fbtna dng">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      –ë–∞—Ä–æ–º–∞–¥
    </a>
  </div>
</aside>

<div class="main">
  <header class="topbar">
    <button class="mtoggle" onclick="openSB()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="tbtitle" id="page-title">–£–º—É–º”£</div>
  </header>

  <div class="content">

  <!-- DASHBOARD -->
  <div class="section active" id="sec-dashboard">
    <div class="kpi-grid">
      <div class="kpi blue"><div class="kpi-text"><p>–î–æ–Ω–∏—à“∑”Ø—ë–Ω</p><div class="kv" id="kpi-students">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/></svg></div></div>
      <div class="kpi purple"><div class="kpi-text"><p>–ì—É—Ä”Ø“≥“≥–æ</p><div class="kv" id="kpi-groups">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div></div>
      <div class="kpi green"><div class="kpi-text"><p>–ö—É—Ä–∞—Ç–æ—Ä–æ–Ω</p><div class="kv" id="kpi-curators">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg></div></div>
      <div class="kpi danger"><div class="kpi-text"><p>–•–∞–≤—Ñ–Ω–æ–∫</p><div class="kv" id="kpi-risk">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg></div></div>
      <div class="kpi warn"><div class="kpi-text"><p>–ë–µ –∂—É—Ä–Ω–∞–ª (–∏–º—Ä”Ø–∑)</p><div class="kv" id="kpi-noatt">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div></div>
    </div>
    <div class="g2">
      <div class="panel">
        <div class="phead"><h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>–•–∞–≤—Ñ–Ω–æ–∫—Ç–∞—Ä–∏–Ω –¥–æ–Ω–∏—à“∑”Ø—ë–Ω</h3></div>
        <div id="dash-risk"><div class="loading"><div class="spinner"></div></div></div>
      </div>
      <div class="panel">
        <div class="phead"><h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>–ö—É—Ä—Å“≥–æ</h3></div>
        <div id="dash-courses"><div class="loading"><div class="spinner"></div></div></div>
      </div>
    </div>
  </div>

  <!-- STUDENTS -->
  <div class="section" id="sec-students">
    <div class="ph">
      <div><h1>üéì –î–æ–Ω–∏—à“∑”Ø—ë–Ω</h1></div>
      <div class="phacts">
        <button class="btn btn-success btn-sm" onclick="exportStudents()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          –≠–∫—Å–ø–æ—Ä—Ç
        </button>
      </div>
    </div>
    <div class="panel">
      <div class="phead">
        <div class="filters">
          <select class="finp" id="stu-group" onchange="loadStudents()" style="min-width:130px"><option value="">“≤–∞–º–∞ –≥—É—Ä”Ø“≥</option></select>
          <select class="finp" id="stu-course" onchange="loadStudents()"><option value="">“≤–∞–º–∞ –∫—É—Ä—Å</option><option value="1">1-–∫—É—Ä—Å</option><option value="2">2-–∫—É—Ä—Å</option><option value="3">3-–∫—É—Ä—Å</option><option value="4">4-–∫—É—Ä—Å</option></select>
          <input type="text" class="finp" id="stu-search" placeholder="“∂—É—Å—Ç—É“∑”Ø..." oninput="debStu()" style="flex:1;min-width:150px">
        </div>
      </div>
      <div class="tw"><table class="tbl">
        <thead><tr><th>#</th><th>–ù–æ–º –≤–∞ –Ω–∞—Å–∞–±</th><th>–ì—É—Ä”Ø“≥</th><th>–ö—É—Ä—Å</th><th>NB —Å–æ–∞—Ç</th><th>–¢–µ–ª. –≤–æ–ª–∏–¥–∞–π–Ω</th><th>–ê–º–∞–ª</th></tr></thead>
        <tbody id="stu-tbody"><tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
      </table></div>
      <div style="padding:.875rem 1.125rem;border-top:1px solid var(--border-light);display:flex;justify-content:space-between;flex-wrap:wrap;gap:.5rem">
        <span style="font-size:.8rem;color:var(--text-3)">“∂–∞–º—ä: <strong id="stu-total" style="color:var(--text)">0</strong></span>
        <div id="stu-pager" style="display:flex;gap:.375rem"></div>
      </div>
    </div>
  </div>

  <!-- AT-RISK -->
  <div class="section" id="sec-at-risk">
    <div class="ph">
      <div><h1>üö® –•–∞–≤—Ñ–Ω–æ–∫ (NB)</h1><p>–î–æ–Ω–∏—à“∑”Ø—ë–Ω–µ –∫–∏ NB –∞–∑ “≥–∞–¥–∏ —Ñ–∞—Ä–æ–≤–∞—Ä—Ç–∞—Ä –∞—Å—Ç</p></div>
      <div class="phacts">
        <button class="btn btn-success btn-sm" onclick="exportNB()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          –≠–∫—Å–ø–æ—Ä—Ç NB
        </button>
      </div>
    </div>
    <div class="panel">
      <div class="tw"><table class="tbl">
        <thead><tr><th>#</th><th>–ù–æ–º</th><th>–ì—É—Ä”Ø“≥</th><th>NB —Å–æ–∞—Ç</th><th>–¢–µ–ª. –≤–æ–ª–∏–¥–∞–π–Ω</th><th>–ê–º–∞–ª</th></tr></thead>
        <tbody id="risk-tbody"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
      </table></div>
    </div>
  </div>

  <!-- GROUPS -->
  <div class="section" id="sec-groups">
    <div class="ph">
      <div><h1>üë• –ì—É—Ä”Ø“≥“≥–æ</h1></div>
      <div class="phacts">
        <button class="btn btn-primary btn-sm" onclick="openAddGroup()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          –ò–ª–æ–≤–∞–∏ –≥—É—Ä”Ø“≥
        </button>
      </div>
    </div>
    <div class="panel">
      <div class="tw"><table class="tbl">
        <thead><tr><th>#</th><th>–†–∞“õ–∞–º / –ù–æ–º</th><th>–ö—É—Ä—Å</th><th>–ù–∞–≤–±–∞—Ç / –ó–∞–±–æ–Ω</th><th>–ö—É—Ä–∞—Ç–æ—Ä</th><th>–î–æ–Ω–∏—à“∑”Ø—ë–Ω</th><th>–í–∞–∑—ä</th><th>–ê–º–∞–ª</th></tr></thead>
        <tbody id="groups-tbody"><tr><td colspan="8"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
      </table></div>
    </div>
  </div>

  <!-- CURATORS -->
  <div class="section" id="sec-curators">
    <div class="ph">
      <div><h1>üßë‚Äçüè´ –ö—É—Ä–∞—Ç–æ—Ä–æ–Ω</h1></div>
      <div class="phacts">
        <button class="btn btn-primary btn-sm" onclick="openAddCurator()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          –ò–ª–æ–≤–∞–∏ –∫—É—Ä–∞—Ç–æ—Ä
        </button>
      </div>
    </div>
    <div class="panel">
      <div class="tw"><table class="tbl">
        <thead><tr><th>#</th><th>–ù–æ–º –≤–∞ –Ω–∞—Å–∞–±</th><th>–Æ–∑–µ—Ä–Ω–µ–π–º</th><th>–ì—É—Ä”Ø“≥</th><th>–¢–µ–ª. / Email</th><th>–°–æ–ª–∏ —Ç–∞–≤–∞–ª–ª—É–¥</th><th>–ê–º–∞–ª</th></tr></thead>
        <tbody id="curators-tbody"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
      </table></div>
    </div>
  </div>

  <!-- MONITORING -->
  <div class="section" id="sec-monitoring">
    <div class="ph">
      <div><h1>üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥</h1><p id="mon-date-label">–î–∞–≤–æ–º–æ—Ç–∏ –∏–º—Ä”Ø–∑</p></div>
      <div class="phacts">
        <input type="date" class="finp" id="mon-date" onchange="loadMonitoring()">
        <button class="btn btn-ghost btn-sm" onclick="loadMonitoring()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="1 4 1 10 7 10"/><path d="M3.51 15a9 9 0 102.13-9.36L1 10"/></svg>
          –ù–∞–≤—Å–æ–∑”£
        </button>
      </div>
    </div>
    <div class="kpi-grid" style="grid-template-columns:repeat(3,1fr)">
      <div class="kpi green"><div class="kpi-text"><p>–ü—É—Ä—Ä–∞ –∏“∑—Ä–æ</p><div class="kv" id="mon-filled">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></div></div>
      <div class="kpi danger"><div class="kpi-text"><p>–ò“∑—Ä–æ –Ω–∞—à—É–¥–∞–∞—Å—Ç</p><div class="kv" id="mon-missing">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg></div></div>
      <div class="kpi blue"><div class="kpi-text"><p>“∂–∞–º—ä –≥—É—Ä”Ø“≥</p><div class="kv" id="mon-total">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div></div>
    </div>
    <div class="panel">
      <div class="tw"><table class="tbl">
        <thead><tr><th>#</th><th>–ì—É—Ä”Ø“≥</th><th>–ö—É—Ä—Å</th><th>–ù–∞–≤–±–∞—Ç</th><th>–ö—É—Ä–∞—Ç–æ—Ä</th><th>–î–æ–Ω–∏—à“∑”Ø—ë–Ω</th><th>–î–∞–≤–æ–º–æ—Ç</th></tr></thead>
        <tbody id="mon-tbody"><tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
      </table></div>
    </div>
  </div>

  <!-- PROFILE -->
  <div class="section" id="sec-profile">
    <div class="ph"><div><h1>üë§ –ü—Ä–æ—Ñ–∏–ª</h1></div></div>
    <div style="max-width:560px">
      <!-- Info card -->
      <div class="panel" style="margin-bottom:1rem">
        <div class="phead"><h3>üìã –ú–∞—ä–ª—É–º–æ—Ç–∏ —É–º—É–º”£</h3></div>
        <div class="pbody" id="profile-info-card">
          <div class="loading"><div class="spinner"></div></div>
        </div>
      </div>
      <!-- Edit form -->
      <div class="panel">
        <div class="phead"><h3>‚úèÔ∏è –¢–∞“≥—Ä–∏—Ä–∏ –º–∞—ä–ª—É–º–æ—Ç</h3></div>
        <div class="pbody">
          <form onsubmit="saveProfile(event)">
            <div class="g2">
              <div class="fg"><label>–ù–æ–º—É –Ω–∞—Å–∞–± *</label><input class="finp" id="p-name" required></div>
              <div class="fg"><label>–°–æ–ª–∏ —Ç–∞–≤–∞–ª–ª—É–¥</label><input type="number" class="finp" id="p-birth-year" min="1950" max="2010"></div>
            </div>
            <div class="g2">
              <div class="fg"><label>Email</label><input type="email" class="finp" id="p-email"></div>
              <div class="fg"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input class="finp" id="p-phone" placeholder="+992..."></div>
            </div>
            <div class="g2">
              <div class="fg"><label>–ö–∞—Ñ–µ–¥—Ä–∞ / –í–∞–∑–∏—Ñ–∞</label><input class="finp" id="p-dept"></div>
              <div class="fg"><label>–§–∞–∫—É–ª—Ç–µ—Ç</label><input class="finp" id="p-faculty" disabled></div>
            </div>
            <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center">–°–∞–±—Ç –∫–∞—Ä–¥–∞–Ω</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- CHANGE PW -->
  <div class="section" id="sec-change-pw">
    <div class="ph"><div><h1>üîê –ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—Ä–æ–ª</h1></div></div>
    <div style="max-width:380px">
      <div class="panel"><div class="pbody">
        <form action="/vice-dean/change-password" method="post">
          <div class="fg"><label>–ü–∞—Ä–æ–ª–∏ –Ω–∞–≤ (“≥–∞–¥–¥–∏ –∞“õ–∞–ª 6 –∞–ª–æ–º–∞—Ç)</label><input type="password" class="finp" name="new_password" minlength="6" required placeholder="–ü–∞—Ä–æ–ª–∏ –Ω–∞–≤" autocomplete="new-password" style="font-size:1.1rem;text-align:center;letter-spacing:3px"></div>
          <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center">–ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω</button>
        </form>
      </div></div>
    </div>
  </div>

  </div><!-- /content -->
</div><!-- /main -->

<!-- ‚îÄ‚îÄ‚îÄ MODAL: ADD / EDIT GROUP ‚îÄ‚îÄ‚îÄ -->
<div class="modal-ov" id="modal-group">
  <div class="modal-box">
    <div class="mtitle">
      <h3 id="mg-title">–ò–ª–æ–≤–∞–∏ –≥—É—Ä”Ø“≥</h3>
      <button class="mclose" onclick="closeModal('modal-group')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div id="mg-err" style="display:none;background:var(--danger-light);color:var(--danger);border-radius:8px;padding:.625rem .875rem;font-size:.83rem;margin-bottom:.875rem"></div>
    <div class="g2">
      <div class="fg"><label>–†–∞“õ–∞–º–∏ –≥—É—Ä”Ø“≥ *</label><input class="finp" id="mg-number" placeholder="–º–∏—Å–æ–ª: –ò–¢-101" required></div>
      <div class="fg"><label>–ù–∞–≤–±–∞—Ç *</label><select class="finp" id="mg-shift"><option value="1">1-–Ω–∞–≤–±–∞—Ç</option><option value="2">2-–Ω–∞–≤–±–∞—Ç</option></select></div>
    </div>
    <div class="fg"><label>–ö—É—Ä—Å *</label><select class="finp" id="mg-course" required><option value="">–ò–Ω—Ç–∏—Ö–æ–±...</option></select></div>
    <div class="fg"><label>–ö—É—Ä–∞—Ç–æ—Ä</label><select class="finp" id="mg-curator"><option value="">–ö—É—Ä–∞—Ç–æ—Ä —Ç–∞—ä–∏–Ω –Ω–∞—à—É–¥–∞–∞—Å—Ç</option></select></div>
    <input type="hidden" id="mg-id">
    <div class="mactions">
      <button class="btn btn-ghost" onclick="closeModal('modal-group')">–ë–µ–∫–æ—Ä</button>
      <button class="btn btn-primary" onclick="saveGroup()" id="mg-save-btn">–°–∞–±—Ç –∫–∞—Ä–¥–∞–Ω</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ MODAL: ADD / EDIT CURATOR ‚îÄ‚îÄ‚îÄ -->
<div class="modal-ov" id="modal-curator">
  <div class="modal-box">
    <div class="mtitle">
      <h3 id="mc-title">–ò–ª–æ–≤–∞–∏ –∫—É—Ä–∞—Ç–æ—Ä</h3>
      <button class="mclose" onclick="closeModal('modal-curator')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div id="mc-err" style="display:none;background:var(--danger-light);color:var(--danger);border-radius:8px;padding:.625rem .875rem;font-size:.83rem;margin-bottom:.875rem"></div>
    <div class="g2">
      <div class="fg"><label>–ù–æ–º—É –Ω–∞—Å–∞–± *</label><input class="finp" id="mc-name" required></div>
      <div class="fg"><label>–Æ–∑–µ—Ä–Ω–µ–π–º *</label><input class="finp" id="mc-username" required placeholder="–ª–∞—Ç–∏–Ω–∏—Ü–∞"></div>
    </div>
    <div class="g2">
      <div class="fg"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input class="finp" id="mc-phone" placeholder="+992..."></div>
      <div class="fg"><label>Email</label><input type="email" class="finp" id="mc-email"></div>
    </div>
    <div class="fg"><label>–ö–∞—Ñ–µ–¥—Ä–∞</label><input class="finp" id="mc-dept"></div>
    <div id="mc-pw-info" style="background:var(--info-light);color:var(--info);border-radius:8px;padding:.625rem .875rem;font-size:.8rem;margin-bottom:.875rem">
      üîë –ü–∞—Ä–æ–ª–∏ –∏–±—Ç–∏–¥–æ”£: <strong>020304</strong> (–∫–æ—Ä–±–∞—Ä “≥–∞–Ω–≥–æ–º–∏ –≤–æ—Ä–∏–¥—à–∞–≤”£ —Ç–∞“ì–π–∏—Ä –º–µ–¥–∏“≥–∞–¥)
    </div>
    <input type="hidden" id="mc-id">
    <div class="mactions">
      <button class="btn btn-ghost" onclick="closeModal('modal-curator')">–ë–µ–∫–æ—Ä</button>
      <button class="btn btn-primary" onclick="saveCurator()" id="mc-save-btn">–°–∞–±—Ç –∫–∞—Ä–¥–∞–Ω</button>
    </div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ MODAL: STUDENT PROFILE ‚îÄ‚îÄ‚îÄ -->
<div class="modal-ov" id="modal-student">
  <div class="modal-box" style="max-width:540px">
    <div class="mtitle">
      <h3>–ü—Ä–æ—Ñ–∏–ª–∏ –¥–æ–Ω–∏—à“∑”Ø</h3>
      <button class="mclose" onclick="closeModal('modal-student')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div id="modal-student-body"><div class="loading"><div class="spinner"></div></div></div>
  </div>
</div>

<div class="toast-cnt" id="toasts"></div>

<script>
'use strict';

const BASE = '/vice-dean';
const titles = {
  dashboard:'–£–º—É–º”£', students:'–î–æ–Ω–∏—à“∑”Ø—ë–Ω', 'at-risk':'–•–∞–≤—Ñ–Ω–æ–∫ (NB)',
  groups:'–ì—É—Ä”Ø“≥“≥–æ', curators:'–ö—É—Ä–∞—Ç–æ—Ä–æ–Ω', monitoring:'–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥',
  profile:'–ü—Ä–æ—Ñ–∏–ª', 'change-pw':'–ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—Ä–æ–ª'
};

let stuTO = null, stuPage = 1;
const PAGE = 50;
let _courses = [], _curators = [];

// ‚îÄ‚îÄ NAVIGATION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openSB(){document.getElementById('sidebar').classList.add('open');document.getElementById('overlay').classList.add('show')}
function closeSB(){document.getElementById('sidebar').classList.remove('open');document.getElementById('overlay').classList.remove('show')}

function showSec(name, el) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nitem').forEach(n => n.classList.remove('active'));
  document.getElementById('sec-' + name).classList.add('active');
  if (el) el.classList.add('active');
  document.getElementById('page-title').textContent = titles[name] || name;
  closeSB();
  const loaders = {
    dashboard: loadDashboard,
    students: () => { loadGroupsFilter(); loadStudents(); },
    'at-risk': loadAtRisk,
    groups: loadGroups,
    curators: loadCurators,
    monitoring: () => {
      document.getElementById('mon-date').value = new Date().toISOString().split('T')[0];
      loadMonitoring();
    },
    profile: loadProfile,
  };
  if (loaders[name]) loaders[name]();
}

// ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function api(url, opts = {}) {
  const isFormData = opts.body instanceof FormData;
  const h = {};
  if (!isFormData) h['Content-Type'] = 'application/json';
  const r = await fetch(url, { ...opts, headers: { ...h, ...(opts.headers || {}) } });
  if (!r.ok) {
    let m = '–•–∞—Ç–æ–≥”£';
    try { const e = await r.json(); m = e.detail || m; } catch(e) {}
    throw new Error(m);
  }
  return r.json();
}

function toast(type, msg) {
  const c = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  const icon = type === 'succ'
    ? '<polyline points="20 6 9 17 4 12"/>'
    : '<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>';
  el.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round">${icon}</svg>${msg}`;
  c.appendChild(el);
  setTimeout(() => el.remove(), 3500);
}

function closeModal(id) {
  document.getElementById(id).classList.remove('show');
}

// ‚îÄ‚îÄ DASHBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadDashboard() {
  try {
    const d = await api(`${BASE}/api/stats`);
    document.getElementById('kpi-students').textContent = d.total_students || 0;
    document.getElementById('kpi-groups').textContent = d.total_groups || 0;
    document.getElementById('kpi-curators').textContent = d.total_curators || 0;
    document.getElementById('kpi-risk').textContent = d.high_risk_count || d.high_absence_students || 0;
    document.getElementById('kpi-noatt').textContent = d.groups_no_attendance_today || 0;

    // Top risk students
    const riskEl = document.getElementById('dash-risk');
    const top = (d.high_risk || []).slice(0, 6);
    riskEl.innerHTML = top.length
      ? top.map(s => `<div style="display:flex;align-items:center;gap:.75rem;padding:.625rem 1rem;border-bottom:1px solid var(--border-light)">
          <div style="flex:1;font-size:.83rem;font-weight:600">${s.full_name}</div>
          <div style="font-size:.75rem;color:var(--text-3)">${s.group_number || '‚Äî'}</div>
          <span class="chip chip-red">${s.total_absent_hours} NB</span>
        </div>`).join('')
      : '<div class="empty">–•–∞–≤—Ñ–Ω–æ–∫ –Ω–µ—Å—Ç üéâ</div>';

    // Course stats
    const coursesEl = document.getElementById('dash-courses');
    const cs = d.course_stats || [];
    coursesEl.innerHTML = cs.length
      ? cs.map(c => `<div style="display:flex;align-items:center;justify-content:space-between;padding:.625rem 1rem;border-bottom:1px solid var(--border-light)">
          <span class="chip chip-purple">${c.year}-–∫—É—Ä—Å</span>
          <span style="font-size:.83rem"><strong>${c.students}</strong> –¥–æ–Ω–∏—à“∑”Ø</span>
          <span style="font-size:.8rem;color:var(--text-3)">${c.groups} –≥—É—Ä”Ø“≥</span>
        </div>`).join('')
      : '<div class="empty">–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</div>';
  } catch(e) {
    console.error('Dashboard error:', e);
  }
}

// ‚îÄ‚îÄ STUDENTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadGroupsFilter() {
  try {
    const d = await api(`${BASE}/api/groups`);
    const sel = document.getElementById('stu-group');
    sel.innerHTML = '<option value="">“≤–∞–º–∞ –≥—É—Ä”Ø“≥</option>';
    d.forEach(g => {
      const o = document.createElement('option');
      o.value = g.id;
      o.textContent = `–ì—É—Ä”Ø“≥ ${g.number}`;
      sel.appendChild(o);
    });
  } catch(e) {}
}

function debStu() { clearTimeout(stuTO); stuTO = setTimeout(() => { stuPage = 1; loadStudents(); }, 400); }

async function loadStudents() {
  const g = document.getElementById('stu-group')?.value || '';
  const c = document.getElementById('stu-course')?.value || '';
  const s = document.getElementById('stu-search')?.value || '';
  const p = new URLSearchParams();
  if (g) p.append('group_id', g);
  if (c) p.append('course', c);
  if (s) p.append('search', s);
  p.append('page', stuPage);
  p.append('page_size', PAGE);

  const tb = document.getElementById('stu-tbody');
  tb.innerHTML = '<tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr>';

  try {
    const d = await api(`${BASE}/api/students?${p}`);
    const arr = d.students || d || [];
    const total = d.total || arr.length;
    const nbLimit = d.nb_limit || 35;
    document.getElementById('stu-total').textContent = total;

    if (!arr.length) {
      tb.innerHTML = '<tr><td colspan="7"><div class="empty">–î–æ–Ω–∏—à“∑”Ø —ë—Ñ—Ç –Ω–∞—à—É–¥</div></td></tr>';
      return;
    }
    tb.innerHTML = arr.map((s, i) => `
      <tr>
        <td style="font-family:'JetBrains Mono',monospace;font-size:.8rem">${(stuPage - 1) * PAGE + i + 1}</td>
        <td><strong>${s.full_name || '‚Äî'}</strong></td>
        <td>${s.group_number || '‚Äî'}</td>
        <td><span class="chip chip-purple">${s.course_year || '?'}-–∫—É—Ä—Å</span></td>
        <td><span class="chip ${(s.total_absent_hours || 0) >= nbLimit ? 'chip-red' : (s.total_absent_hours || 0) >= 20 ? 'chip-warn' : 'chip-green'}">${s.total_absent_hours || 0}</span></td>
        <td>${s.parent_phone || '‚Äî'}</td>
        <td><button class="btn btn-ghost btn-xs" onclick="viewStudent(${s.id})">–ü—Ä–æ—Ñ–∏–ª</button></td>
      </tr>`).join('');

    const pages = Math.ceil(total / PAGE);
    const pager = document.getElementById('stu-pager');
    pager.innerHTML = '';
    for (let pg = 1; pg <= Math.min(pages, 8); pg++) {
      const b = document.createElement('button');
      b.style.cssText = `width:32px;height:32px;border:1.5px solid ${pg === stuPage ? 'var(--primary)' : 'var(--border)'};border-radius:8px;background:${pg === stuPage ? 'var(--primary)' : 'var(--surface)'};color:${pg === stuPage ? '#fff' : 'var(--text-2)'};font-size:.8rem;font-weight:600;cursor:pointer;font-family:inherit`;
      b.textContent = pg;
      b.onclick = () => { stuPage = pg; loadStudents(); };
      pager.appendChild(b);
    }
  } catch(e) { toast('err', e.message); }
}

async function viewStudent(sid) {
  document.getElementById('modal-student').classList.add('show');
  document.getElementById('modal-student-body').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const s = await api(`${BASE}/api/students/${sid}`);
    const nbLimit = 35;
    const nbRows = (s.nb_history || []).slice(0, 15).map(r =>
      `<tr><td>${r.date}</td><td><span class="chip chip-red">${r.nb_hours}</span></td><td style="font-size:.78rem;color:var(--text-3)">${r.comment || '‚Äî'}</td><td>${r.is_reasoned ? '<span class="chip chip-green">“∂–æ–∏–∑</span>' : ''}</td></tr>`
    ).join('');

    document.getElementById('modal-student-body').innerHTML = `
      <div style="margin-bottom:1rem">
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem">
          <div style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--primary),#a855f7);display:flex;align-items:center;justify-content:center;font-size:1.25rem;font-weight:800;color:#fff;flex-shrink:0">${(s.full_name||'?')[0].toUpperCase()}</div>
          <div>
            <div style="font-size:1rem;font-weight:800">${s.full_name}</div>
            <div style="font-size:.8rem;color:var(--text-3);font-family:'JetBrains Mono',monospace">${s.student_code || ''}</div>
          </div>
          <span class="chip ${(s.total_absent_hours||0) >= nbLimit ? 'chip-red' : (s.total_absent_hours||0) >= 20 ? 'chip-warn' : 'chip-green'}" style="margin-left:auto">${(s.total_absent_hours||0)} NB</span>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:1rem">
          <div class="info-row"><span class="lbl">–ì—É—Ä”Ø“≥</span><span class="val">${s.group_number || '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–ö—É—Ä—Å</span><span class="val">${s.course_year ? s.course_year + '-–∫—É—Ä—Å' : '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–ù–∞–≤–±–∞—Ç</span><span class="val">${s.group_shift ? s.group_shift + '-–Ω–∞–≤–±–∞—Ç' : '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–®–∞–∫–ª–∏ —Ç–∞—ä–ª–∏–º</span><span class="val">${s.education_type || '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–°–æ–ª–∏ —Ç–∞–≤–∞–ª–ª—É–¥</span><span class="val">${s.birth_year || '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–ó–æ–¥–≥–æ“≥</span><span class="val">${s.birth_place || '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–í–∏–ª–æ—è—Ç</span><span class="val">${s.region || '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–¢–µ–ª. –≤–æ–ª–∏–¥–∞–π–Ω</span><span class="val">${s.parent_phone || '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–û“ì–æ–∑–∏ —Ç–∞“≥—Å–∏–ª</span><span class="val">${s.study_start || '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–•–∞—Ç–º–∏ —Ç–∞—Ö–º–∏–Ω”£</span><span class="val">${s.expected_graduation || '‚Äî'}</span></div>
          ${s.created_at ? `<div class="info-row"><span class="lbl">–°–∞–±—Ç —à—É–¥</span><span class="val" style="font-size:.75rem">${s.created_at.split('T')[0]}</span></div>` : ''}
          ${s.updated_at ? `<div class="info-row"><span class="lbl">–ù–∞–≤—Å–æ–∑”£</span><span class="val" style="font-size:.75rem">${s.updated_at.split('T')[0]}</span></div>` : ''}
        </div>
      </div>
      ${nbRows ? `<div style="font-size:.8rem;font-weight:700;color:var(--text-3);margin-bottom:.5rem;text-transform:uppercase;letter-spacing:.05em">–¢–∞—ä—Ä–∏—Ö–∏ NB (–æ—Ö–∏—Ä–∏–Ω 15)</div>
      <div class="tw"><table class="tbl" style="min-width:300px">
        <thead><tr><th>–°–∞–Ω–∞</th><th>NB</th><th>–ò–∑–æ“≥</th><th>“∂–æ–∏–∑</th></tr></thead>
        <tbody>${nbRows}</tbody>
      </table></div>` : '<div class="empty" style="padding:1.5rem">“ö–∞–π–¥–∏ NB –Ω–µ—Å—Ç</div>'}
    `;
  } catch(e) {
    document.getElementById('modal-student-body').innerHTML = `<div class="empty">–•–∞—Ç–æ–≥”£: ${e.message}</div>`;
  }
}

// ‚îÄ‚îÄ AT-RISK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadAtRisk() {
  const tb = document.getElementById('risk-tbody');
  tb.innerHTML = '<tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr>';
  try {
    const d = await api(`${BASE}/api/at-risk`);
    if (!d.length) {
      tb.innerHTML = '<tr><td colspan="6"><div class="empty">–•–∞–≤—Ñ–Ω–æ–∫ –Ω–µ—Å—Ç üéâ</div></td></tr>';
      return;
    }
    tb.innerHTML = d.map((s, i) => `
      <tr>
        <td style="font-family:'JetBrains Mono',monospace;font-size:.8rem">${i + 1}</td>
        <td><strong>${s.full_name || '‚Äî'}</strong></td>
        <td>${s.group_number || '‚Äî'}</td>
        <td><span class="chip chip-red">${s.total_absent_hours || 0}</span></td>
        <td>${s.parent_phone || '‚Äî'}</td>
        <td><button class="btn btn-ghost btn-xs" onclick="viewStudent(${s.id})">–ü—Ä–æ—Ñ–∏–ª</button></td>
      </tr>`).join('');
  } catch(e) { toast('err', e.message); }
}

// ‚îÄ‚îÄ GROUPS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadGroups() {
  const tb = document.getElementById('groups-tbody');
  tb.innerHTML = '<tr><td colspan="8"><div class="loading"><div class="spinner"></div></div></td></tr>';
  try {
    const d = await api(`${BASE}/api/groups`);
    if (!d.length) {
      tb.innerHTML = '<tr><td colspan="8"><div class="empty">–ì—É—Ä”Ø“≥ –Ω–µ—Å—Ç</div></td></tr>';
      return;
    }
    tb.innerHTML = d.map((g, i) => `
      <tr>
        <td style="font-family:'JetBrains Mono',monospace;font-size:.8rem">${i + 1}</td>
        <td>
          <strong>${g.number || '‚Äî'}</strong>
          ${g.name && g.name !== g.number ? `<br><span style="font-size:.72rem;color:var(--text-3)">${g.name}</span>` : ''}
        </td>
        <td><span class="chip chip-purple">${g.course_year || '?'}-–∫—É—Ä—Å</span></td>
        <td>${g.shift}-–Ω–∞–≤–±–∞—Ç${g.study_lang ? ` <span class="chip chip-blue" style="font-size:.65rem">${g.study_lang}</span>` : ''}</td>
        <td>
          ${g.curator_name
            ? `<span style="font-weight:600">${g.curator_name}</span>${g.curator_phone ? `<br><span style="font-size:.72rem;color:var(--text-3)">${g.curator_phone}</span>` : ''}`
            : '<span style="color:var(--text-4)">–¢–∞—ä–∏–Ω –Ω–∞—à—É–¥–∞–∞—Å—Ç</span>'}
        </td>
        <td><strong>${g.student_count || g.total_students || 0}</strong></td>
        <td>
          <span class="chip ${g.is_closed ? 'chip-red' : g.is_active !== false ? 'chip-green' : 'chip-warn'}">
            ${g.is_closed ? '–ë–∞—Å—Ç–∞' : g.is_active !== false ? '–§–∞—ä–æ–ª' : '“í–∞–π—Ä–∏—Ñ–∞—ä–æ–ª'}
          </span>
          ${g.attendance_today ? '<span class="chip chip-blue" style="margin-left:2px;font-size:.65rem">‚úì –î–∞–≤–æ–º–æ—Ç</span>' : ''}
        </td>
        <td style="white-space:nowrap">
          <button class="btn btn-ghost btn-xs" onclick="viewGroup(${g.id})">üëÅÔ∏è</button>
          ${!g.is_closed ? `<button class="btn btn-ghost btn-xs" onclick="openEditGroup(${g.id}, '${escHtml(g.number)}', ${g.shift}, ${g.course_id || 0}, ${g.curator_id || 0})">‚úèÔ∏è</button>` : ''}
          ${g.is_closed
            ? `<button class="btn btn-xs" style="background:var(--success-light);color:var(--success)" onclick="reopenGroup(${g.id}, '${escHtml(g.number)}')">üîì –ö—É—à–æ</button>`
            : `<button class="btn btn-xs" style="background:var(--warning-light);color:var(--warning)" onclick="closeGroup(${g.id}, '${escHtml(g.number)}')">üîí –ë–∞—Å—Ç</button>`
          }
          <button class="btn btn-xs" style="background:var(--danger-light);color:var(--danger)" onclick="deleteGroup(${g.id}, '${escHtml(g.number)}')">üóëÔ∏è</button>
        </td>
      </tr>`).join('');
  } catch(e) { toast('err', e.message); }
}

function escHtml(s) { return String(s||'').replace(/'/g, "\\'"); }

async function openAddGroup() {
  document.getElementById('mg-title').textContent = '–ò–ª–æ–≤–∞–∏ –≥—É—Ä”Ø“≥';
  document.getElementById('mg-id').value = '';
  document.getElementById('mg-number').value = '';
  document.getElementById('mg-shift').value = '1';
  document.getElementById('mg-err').style.display = 'none';
  await _loadGroupModalData(0, 0);
  document.getElementById('modal-group').classList.add('show');
}

async function openEditGroup(id, number, shift, courseId, curatorId) {
  document.getElementById('mg-title').textContent = '–¢–∞“≥—Ä–∏—Ä–∏ –≥—É—Ä”Ø“≥';
  document.getElementById('mg-id').value = id;
  document.getElementById('mg-number').value = number;
  document.getElementById('mg-shift').value = shift;
  document.getElementById('mg-err').style.display = 'none';
  await _loadGroupModalData(courseId, curatorId);
  document.getElementById('modal-group').classList.add('show');
}

async function _loadGroupModalData(selectedCourse, selectedCurator) {
  // Load courses
  try {
    if (!_courses.length) _courses = await api(`${BASE}/api/courses`);
    const cs = document.getElementById('mg-course');
    cs.innerHTML = '<option value="">–ò–Ω—Ç–∏—Ö–æ–±...</option>';
    _courses.forEach(c => {
      const o = document.createElement('option');
      o.value = c.id;
      o.textContent = `${c.year}-–∫—É—Ä—Å`;
      if (c.id === selectedCourse) o.selected = true;
      cs.appendChild(o);
    });
  } catch(e) {}

  // Load curators
  try {
    if (!_curators.length) _curators = await api(`${BASE}/api/curators`);
    const cc = document.getElementById('mg-curator');
    cc.innerHTML = '<option value="">–ö—É—Ä–∞—Ç–æ—Ä —Ç–∞—ä–∏–Ω –Ω–∞—à—É–¥–∞–∞—Å—Ç</option>';
    _curators.forEach(c => {
      const o = document.createElement('option');
      o.value = c.id;
      o.textContent = c.full_name;
      if (c.id === selectedCurator) o.selected = true;
      cc.appendChild(o);
    });
  } catch(e) {}
}

async function saveGroup() {
  const id        = document.getElementById('mg-id').value;
  const number    = document.getElementById('mg-number').value.trim();
  const shift     = parseInt(document.getElementById('mg-shift').value);
  const course_id = document.getElementById('mg-course').value;
  const curator_id = document.getElementById('mg-curator').value || null;
  const errEl     = document.getElementById('mg-err');
  const btn       = document.getElementById('mg-save-btn');

  if (!number)    { errEl.textContent = '–†–∞“õ–∞–º–∏ –≥—É—Ä”Ø“≥—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥'; errEl.style.display = 'block'; return; }
  if (!course_id) { errEl.textContent = '–ö—É—Ä—Å—Ä–æ –∏–Ω—Ç–∏—Ö–æ–± –∫—É–Ω–µ–¥';       errEl.style.display = 'block'; return; }

  errEl.style.display = 'none';
  btn.disabled = true;
  btn.textContent = '–°–∞–±—Ç...';

  try {
    const payload = {
      number,
      shift,
      course_id: parseInt(course_id),
      curator_id: curator_id ? parseInt(curator_id) : null,
    };

    if (id) {
      await api(`${BASE}/api/groups/${id}`, { method: 'PUT', body: JSON.stringify(payload) });
      toast('succ', '‚úÖ –ì—É—Ä”Ø“≥ –Ω–∞–≤—Å–æ–∑”£ —à—É–¥');
    } else {
      await api(`${BASE}/api/groups`, { method: 'POST', body: JSON.stringify(payload) });
      toast('succ', '‚úÖ –ì—É—Ä”Ø“≥ –∏–ª–æ–≤–∞—à—É–¥');
    }

    _curators = [];
    closeModal('modal-group');
    loadGroups();
    loadGroupsFilter();
  } catch(e) {
    errEl.textContent = e.message;
    errEl.style.display = 'block';
  } finally {
    btn.disabled = false;
    btn.textContent = '–°–∞–±—Ç –∫–∞—Ä–¥–∞–Ω';
  }
}

async function closeGroup(id, name) {
  if (!confirm(`–ì—É—Ä”Ø“≥ ¬´${name}¬ª-—Ä–æ –º–µ–±–∞–Ω–¥–µ–º? –ë–∞—ä–¥–∏ –æ–Ω –∫—É—Ä–∞—Ç–æ—Ä –¥–∞–≤–æ–º–æ—Ç —Å–∞–±—Ç –∫–∞—Ä–¥–∞ –Ω–∞–º–µ—Ç–∞–≤–æ–Ω–∞–¥.`)) return;
  try {
    await api(`${BASE}/api/groups/${id}/close`, { method: 'POST' });
    toast('succ', `üîí –ì—É—Ä”Ø“≥ ¬´${name}¬ª –±–∞—Å—Ç–∞ —à—É–¥`);
    loadGroups();
  } catch(e) { toast('err', e.message); }
}

async function reopenGroup(id, name) {
  if (!confirm(`–ì—É—Ä”Ø“≥ ¬´${name}¬ª-—Ä–æ –∫—É—à–æ–µ–º?`)) return;
  try {
    await api(`${BASE}/api/groups/${id}/reopen`, { method: 'POST' });
    toast('succ', `üîì –ì—É—Ä”Ø“≥ ¬´${name}¬ª –∫—É—à–æ–¥–∞ —à—É–¥`);
    loadGroups();
  } catch(e) { toast('err', e.message); }
}

async function deleteGroup(id, name) {
  if (!confirm(`–ì—É—Ä”Ø“≥ ¬´${name}¬ª-—Ä–æ –Ω–µ—Å—Ç –º–µ–∫—É–Ω–µ–¥?`)) return;
  try {
    await api(`${BASE}/api/groups/${id}`, { method: 'DELETE' });
    toast('succ', '‚úÖ –ì—É—Ä”Ø“≥ –Ω–µ—Å—Ç —à—É–¥');
    loadGroups();
  } catch(e) { toast('err', e.message); }
}

// ‚îÄ‚îÄ CURATORS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadCurators() {
  const tb = document.getElementById('curators-tbody');
  tb.innerHTML = '<tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr>';
  try {
    const d = await api(`${BASE}/api/curators`);
    _curators = d; // cache
    if (!d.length) {
      tb.innerHTML = '<tr><td colspan="6"><div class="empty">–ö—É—Ä–∞—Ç–æ—Ä –Ω–µ—Å—Ç</div></td></tr>';
      return;
    }
    tb.innerHTML = d.map((c, i) => `
      <tr>
        <td style="font-family:'JetBrains Mono',monospace;font-size:.8rem">${i + 1}</td>
        <td>
          <strong>${c.full_name}</strong>
          ${c.department ? `<br><span style="font-size:.72rem;color:var(--text-3)">${c.department}</span>` : ''}
        </td>
        <td>
          <span style="font-family:'JetBrains Mono',monospace;font-size:.78rem">${c.username}</span>
          ${c.force_password_change ? ' <span class="chip chip-warn" style="font-size:.65rem">‚ö† –ü–∞—Ä–æ–ª</span>' : ''}
        </td>
        <td>
          ${c.group_number ? `<span class="chip chip-purple">${c.group_number}</span>` : '<span style="color:var(--text-4)">–¢–∞—ä–∏–Ω –Ω–∞—à—É–¥–∞–∞—Å—Ç</span>'}
        </td>
        <td>
          ${c.phone ? `<a href="tel:${c.phone}" style="color:var(--text-2);text-decoration:none">${c.phone}</a>` : '‚Äî'}
          ${c.email ? `<br><span style="font-size:.72rem;color:var(--text-3)">${c.email}</span>` : ''}
        </td>
        <td>${c.birth_year || '‚Äî'}</td>
        <td style="white-space:nowrap">
          <button class="btn btn-ghost btn-xs" onclick="viewCurator(${c.id})">üëÅÔ∏è</button>
          <button class="btn btn-ghost btn-xs" onclick="openEditCurator(${c.id})">‚úèÔ∏è</button>
          <button class="btn btn-xs" style="background:var(--warning-light);color:var(--warning)" onclick="resetCuratorPw(${c.id}, '${escHtml(c.full_name)}')">üîë</button>
          <button class="btn btn-xs" style="background:var(--danger-light);color:var(--danger)" onclick="deleteCurator(${c.id}, '${escHtml(c.full_name)}')">üóëÔ∏è</button>
        </td>
      </tr>`).join('');
  } catch(e) { toast('err', e.message); }
}

function openAddCurator() {
  document.getElementById('mc-title').textContent = '–ò–ª–æ–≤–∞–∏ –∫—É—Ä–∞—Ç–æ—Ä';
  document.getElementById('mc-id').value = '';
  document.getElementById('mc-name').value = '';
  document.getElementById('mc-username').value = '';
  document.getElementById('mc-phone').value = '';
  document.getElementById('mc-email').value = '';
  document.getElementById('mc-dept').value = '';
  document.getElementById('mc-username').disabled = false;
  document.getElementById('mc-err').style.display = 'none';
  document.getElementById('mc-pw-info').style.display = 'block';
  document.getElementById('modal-curator').classList.add('show');
}

async function openEditCurator(id) {
  document.getElementById('mc-title').textContent = '–¢–∞“≥—Ä–∏—Ä–∏ –∫—É—Ä–∞—Ç–æ—Ä';
  document.getElementById('mc-id').value = id;
  document.getElementById('mc-err').style.display = 'none';
  document.getElementById('mc-pw-info').style.display = 'none';
  document.getElementById('mc-username').disabled = true;
  try {
    const c = await api(`${BASE}/api/curators/${id}`);
    document.getElementById('mc-name').value = c.full_name || '';
    document.getElementById('mc-username').value = c.username || '';
    document.getElementById('mc-phone').value = c.phone || '';
    document.getElementById('mc-email').value = c.email || '';
    document.getElementById('mc-dept').value = c.department || '';
  } catch(e) {}
  document.getElementById('modal-curator').classList.add('show');
}

async function saveCurator() {
  const id = document.getElementById('mc-id').value;
  const full_name = document.getElementById('mc-name').value.trim();
  const username = document.getElementById('mc-username').value.trim();
  const phone = document.getElementById('mc-phone').value.trim() || null;
  const email = document.getElementById('mc-email').value.trim() || null;
  const department = document.getElementById('mc-dept').value.trim() || null;
  const errEl = document.getElementById('mc-err');
  const btn = document.getElementById('mc-save-btn');

  if (!full_name) { errEl.textContent = '–ù–æ–º—É –Ω–∞—Å–∞–±—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥'; errEl.style.display = 'block'; return; }
  if (!id && !username) { errEl.textContent = '–Æ–∑–µ—Ä–Ω–µ–π–º—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥'; errEl.style.display = 'block'; return; }

  errEl.style.display = 'none';
  btn.disabled = true;
  btn.textContent = '–°–∞–±—Ç...';

  try {
    if (id) {
      await api(`${BASE}/api/curators/${id}`, {
        method: 'PUT',
        body: JSON.stringify({ full_name, phone, email, department }),
      });
      toast('succ', '‚úÖ –ö—É—Ä–∞—Ç–æ—Ä –Ω–∞–≤—Å–æ–∑”£ —à—É–¥');
    } else {
      await api(`${BASE}/api/curators`, {
        method: 'POST',
        body: JSON.stringify({ full_name, username, phone, email, department }),
      });
      toast('succ', `‚úÖ –ö—É—Ä–∞—Ç–æ—Ä –∏–ª–æ–≤–∞—à—É–¥. –ü–∞—Ä–æ–ª: 020304`);
    }
    _curators = []; // reset curator cache so group modal reloads fresh
    _courses = [];  // also reset courses cache
    closeModal('modal-curator');
    loadCurators();
  } catch(e) {
    errEl.textContent = e.message;
    errEl.style.display = 'block';
  } finally {
    btn.disabled = false;
    btn.textContent = '–°–∞–±—Ç –∫–∞—Ä–¥–∞–Ω';
  }
}

async function resetCuratorPw(id, name) {
  if (!confirm(`–ü–∞—Ä–æ–ª–∏ ¬´${name}¬ª-—Ä–æ –±–∞ 020304 –±–∞—Ä–≥–∞—Ä–¥–æ–Ω–µ–º?`)) return;
  try {
    await api(`${BASE}/api/curators/${id}/reset-password`, { method: 'POST' });
    toast('succ', `‚úÖ –ü–∞—Ä–æ–ª –±–∞ 020304 –±–∞—Ä–≥–∞—Ä–¥–æ–Ω–∏–¥–∞ —à—É–¥`);
  } catch(e) { toast('err', e.message); }
}

async function deleteCurator(id, name) {
  if (!confirm(`–ö—É—Ä–∞—Ç–æ—Ä ¬´${name}¬ª-—Ä–æ –Ω–µ—Å—Ç –º–µ–∫—É–Ω–µ–¥?`)) return;
  try {
    await api(`${BASE}/api/curators/${id}`, { method: 'DELETE' });
    toast('succ', '‚úÖ –ö—É—Ä–∞—Ç–æ—Ä –Ω–µ—Å—Ç —à—É–¥');
    _curators = [];
    loadCurators();
  } catch(e) { toast('err', e.message); }
}

// ‚îÄ‚îÄ MONITORING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadMonitoring() {
  const d = document.getElementById('mon-date').value || new Date().toISOString().split('T')[0];
  document.getElementById('mon-date-label').textContent = `–î–∞–≤–æ–º–æ—Ç–∏ —Å–∞–Ω–∞–∏: ${d}`;
  const tb = document.getElementById('mon-tbody');
  tb.innerHTML = '<tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr>';
  try {
    const data = await api(`${BASE}/api/monitoring/no-attendance?target_date=${d}`);
    document.getElementById('mon-filled').textContent = data.filled || 0;
    document.getElementById('mon-missing').textContent = data.missing || 0;
    document.getElementById('mon-total').textContent = data.total_groups || 0;
    const groups = data.groups || [];
    if (!groups.length) {
      tb.innerHTML = '<tr><td colspan="7"><div class="empty">–ì—É—Ä”Ø“≥ –Ω–µ—Å—Ç</div></td></tr>';
      return;
    }
    tb.innerHTML = groups.map((g, i) => `
      <tr>
        <td style="font-family:'JetBrains Mono',monospace;font-size:.8rem">${i+1}</td>
        <td><strong>${g.group_number}</strong></td>
        <td><span class="chip chip-purple">${g.course_year || '?'}-–∫—É—Ä—Å</span></td>
        <td>${g.shift}-–Ω–∞–≤–±–∞—Ç</td>
        <td>${g.curator_name || '<span style="color:var(--text-4)">‚Äî</span>'}</td>
        <td>${g.total_students || 0}</td>
        <td>
          <span class="chip ${g.has_attendance ? 'chip-green' : 'chip-red'}">
            ${g.has_attendance ? '‚úÖ –ò“∑—Ä–æ —à—É–¥–∞–∞—Å—Ç' : '‚ùå –ò“∑—Ä–æ –Ω–∞—à—É–¥–∞–∞—Å—Ç'}
          </span>
        </td>
      </tr>`).join('');
  } catch(e) { toast('err', e.message); }
}

// ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function loadProfile() {
  try {
    const d = await api(`${BASE}/api/profile`);
    // Fill edit form
    document.getElementById('p-name').value = d.full_name || '';
    document.getElementById('p-email').value = d.email || '';
    document.getElementById('p-phone').value = d.phone || '';
    document.getElementById('p-faculty').value = d.faculty_name || d.faculty || '';
    document.getElementById('p-dept').value = d.department || '';
    const byEl = document.getElementById('p-birth-year');
    if (byEl) byEl.value = d.birth_year || '';

    // Fill info card
    const card = document.getElementById('profile-info-card');
    if (card) {
      card.innerHTML = `
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1rem">
          <div style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--primary),#a855f7);display:flex;align-items:center;justify-content:center;font-size:1.3rem;font-weight:800;color:#fff">${(d.full_name||'–ó')[0].toUpperCase()}</div>
          <div>
            <div style="font-size:1rem;font-weight:800">${d.full_name||'‚Äî'}</div>
            <span class="badge badge-purple">–ó–∞–º–¥–µ–∫–∞–Ω</span>
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.4rem">
          <div class="info-row"><span class="lbl">ID</span><span class="val" style="font-family:'JetBrains Mono',monospace">#${d.id}</span></div>
          <div class="info-row"><span class="lbl">–Æ–∑–µ—Ä–Ω–µ–π–º</span><span class="val" style="font-family:'JetBrains Mono',monospace">@${d.username}</span></div>
          <div class="info-row"><span class="lbl">–§–∞–∫—É–ª—Ç–µ—Ç</span><span class="val">${d.faculty_name||d.faculty||'‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–°–æ–ª–∏ —Ç–∞–≤–∞–ª–ª—É–¥</span><span class="val">${d.birth_year||'‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–í–µ—Ä—Å–∏—è —Ç–æ–∫–µ–Ω</span><span class="val" style="font-family:'JetBrains Mono',monospace">${d.token_version||1}</span></div>
          ${d.created_at?`<div class="info-row"><span class="lbl">–°–∞–±—Ç</span><span class="val" style="font-size:.72rem">${d.created_at.split('T')[0]}</span></div>`:''}
        </div>`;
    }
  } catch(e) {
    const card = document.getElementById('profile-info-card');
    if (card) card.innerHTML = '<div class="empty">–•–∞—Ç–æ–≥”£</div>';
  }
}

async function saveProfile(e) {
  e.preventDefault();
  const byVal = document.getElementById('p-birth-year')?.value;
  try {
    await api(`${BASE}/api/profile`, {
      method: 'PUT',
      body: JSON.stringify({
        full_name: document.getElementById('p-name').value,
        email: document.getElementById('p-email').value || null,
        phone: document.getElementById('p-phone').value || null,
        department: document.getElementById('p-dept').value || null,
        birth_year: byVal ? parseInt(byVal) : null,
      }),
    });
    toast('succ', '‚úÖ –ü—Ä–æ—Ñ–∏–ª —Å–∞–±—Ç —à—É–¥');
    loadProfile(); // refresh info card
  } catch(err) { toast('err', err.message); }
}

function exportStudents() { window.open(`${BASE}/api/export/students`, '_blank'); }
function exportNB() { window.open(`${BASE}/api/export/nb`, '_blank'); }

document.addEventListener('DOMContentLoaded', loadDashboard);

// ‚îÄ‚îÄ VIEW GROUP PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function viewGroup(gid) {
  document.getElementById('modal-group-view').classList.add('show');
  const body = document.getElementById('modal-group-view-body');
  body.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    // Try to find in DOM data first, otherwise fetch
    let g = null;
    try {
      const groups = await api(`${BASE}/api/groups`);
      g = groups.find(x => x.id === gid);
    } catch(err) {}
    if (!g) throw new Error('–ì—É—Ä”Ø“≥ —ë—Ñ—Ç –Ω–∞—à—É–¥');

    body.innerHTML = `
      <div style="margin-bottom:1rem">
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.25rem">
          <div style="width:52px;height:52px;border-radius:12px;background:linear-gradient(135deg,var(--primary),#a855f7);display:flex;align-items:center;justify-content:center;font-size:1.25rem;font-weight:800;color:#fff;flex-shrink:0">${(g.number||'?')[0]}</div>
          <div>
            <div style="font-size:1.1rem;font-weight:800">${g.number}</div>
            ${g.name && g.name !== g.number ? `<div style="font-size:.8rem;color:var(--text-3)">${g.name}</div>` : ''}
          </div>
          <span class="chip ${g.is_closed ? 'chip-red' : g.is_active !== false ? 'chip-green' : 'chip-warn'}" style="margin-left:auto">
            ${g.is_closed ? '–ë–∞—Å—Ç–∞' : g.is_active !== false ? '–§–∞—ä–æ–ª' : '“í–∞–π—Ä–∏—Ñ–∞—ä–æ–ª'}
          </span>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem">
          <div class="info-row"><span class="lbl">ID</span><span class="val" style="font-family:'JetBrains Mono',monospace">#${g.id}</span></div>
          <div class="info-row"><span class="lbl">–ö—É—Ä—Å</span><span class="val">${g.course_year ? g.course_year + '-–∫—É—Ä—Å' : '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–ù–∞–≤–±–∞—Ç</span><span class="val">${g.shift}-–Ω–∞–≤–±–∞—Ç</span></div>
          <div class="info-row"><span class="lbl">–ó–∞–±–æ–Ω–∏ —Ç–∞—ä–ª–∏–º</span><span class="val">${g.study_lang || '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–î–æ–Ω–∏—à“∑”Ø—ë–Ω</span><span class="val"><strong>${g.total_students || 0}</strong></span></div>
          <div class="info-row"><span class="lbl">–§–∞–∫—É–ª—Ç–µ—Ç ID</span><span class="val">${g.faculty_id || '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–°–æ–ª–∏ —Ç–∞“≥—Å–∏–ª”£</span><span class="val">${g.academic_year_name || (g.academic_year_id ? '#'+g.academic_year_id : '‚Äî')}</span></div>
          <div class="info-row"><span class="lbl">–ë–∞—Å—Ç–∞?</span><span class="val">${g.is_closed ? '‚úÖ “≤–∞' : '‚ùå –ù–µ'}</span></div>
        </div>
        <div style="margin-top:1rem;padding-top:1rem;border-top:1px solid var(--border)">
          <div style="font-size:.75rem;font-weight:700;color:var(--text-3);text-transform:uppercase;margin-bottom:.625rem">–ö—É—Ä–∞—Ç–æ—Ä</div>
          ${g.curator_name
            ? `<div style="display:flex;gap:.75rem;align-items:center">
                <div style="width:38px;height:38px;border-radius:50%;background:var(--primary-light);display:flex;align-items:center;justify-content:center;font-weight:800;color:var(--primary)">${g.curator_name[0]}</div>
                <div>
                  <div style="font-weight:700">${g.curator_name}</div>
                  ${g.curator_username ? `<div style="font-size:.75rem;color:var(--text-3);font-family:'JetBrains Mono',monospace">@${g.curator_username}</div>` : ''}
                  ${g.curator_phone ? `<div style="font-size:.75rem;color:var(--text-3)">${g.curator_phone}</div>` : ''}
                </div>
               </div>`
            : '<span style="color:var(--text-4)">–¢–∞—ä–∏–Ω –Ω–∞—à—É–¥–∞–∞—Å—Ç</span>'}
        </div>
        ${(g.created_at || g.updated_at) ? `
        <div style="margin-top:.875rem;padding-top:.875rem;border-top:1px solid var(--border);display:flex;gap:1rem">
          ${g.created_at ? `<div class="info-row"><span class="lbl" style="min-width:80px">–°–∞–±—Ç</span><span class="val" style="font-size:.75rem">${g.created_at.split('T')[0]}</span></div>` : ''}
          ${g.updated_at ? `<div class="info-row"><span class="lbl" style="min-width:80px">–ù–∞–≤—Å–æ–∑”£</span><span class="val" style="font-size:.75rem">${g.updated_at.split('T')[0]}</span></div>` : ''}
        </div>` : ''}
      </div>
    `;
  } catch(e) {
    body.innerHTML = `<div class="empty">–•–∞—Ç–æ–≥”£: ${e.message}</div>`;
  }
}

// ‚îÄ‚îÄ VIEW CURATOR PROFILE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function viewCurator(uid) {
  document.getElementById('modal-curator-view').classList.add('show');
  const body = document.getElementById('modal-curator-view-body');
  body.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const c = await api(`${BASE}/api/curators/${uid}`);
    body.innerHTML = `
      <div>
        <div style="display:flex;align-items:center;gap:1rem;margin-bottom:1.25rem">
          <div style="width:52px;height:52px;border-radius:50%;background:linear-gradient(135deg,var(--primary),#a855f7);display:flex;align-items:center;justify-content:center;font-size:1.25rem;font-weight:800;color:#fff;flex-shrink:0">${(c.full_name||'?')[0].toUpperCase()}</div>
          <div>
            <div style="font-size:1rem;font-weight:800">${c.full_name}</div>
            <span class="badge badge-purple">–ö—É—Ä–∞—Ç–æ—Ä</span>
          </div>
          ${c.force_password_change ? '<span class="chip chip-warn" style="margin-left:auto">‚ö† –ü–∞—Ä–æ–ª</span>' : ''}
        </div>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:.5rem;margin-bottom:1rem">
          <div class="info-row"><span class="lbl">ID</span><span class="val" style="font-family:'JetBrains Mono',monospace">#${c.id}</span></div>
          <div class="info-row"><span class="lbl">–Æ–∑–µ—Ä–Ω–µ–π–º</span><span class="val" style="font-family:'JetBrains Mono',monospace">@${c.username}</span></div>
          <div class="info-row"><span class="lbl">–¢–µ–ª–µ—Ñ–æ–Ω</span><span class="val">${c.phone || '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">Email</span><span class="val">${c.email || '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–ö–∞—Ñ–µ–¥—Ä–∞</span><span class="val">${c.department || '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–°–æ–ª–∏ —Ç–∞–≤–∞–ª–ª—É–¥</span><span class="val">${c.birth_year || '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–§–∞–∫—É–ª—Ç–µ—Ç ID</span><span class="val">${c.faculty_id || '‚Äî'}</span></div>
          <div class="info-row"><span class="lbl">–í–µ—Ä—Å–∏—è —Ç–æ–∫–µ–Ω</span><span class="val" style="font-family:'JetBrains Mono',monospace">${c.token_version || 1}</span></div>
        </div>

        <div style="padding:1rem;border:1.5px solid var(--border);border-radius:var(--radius-sm);margin-bottom:1rem">
          <div style="font-size:.75rem;font-weight:700;color:var(--text-3);text-transform:uppercase;margin-bottom:.625rem">–ì—É—Ä”Ø“≥“≥–æ</div>
          ${c.groups && c.groups.length
            ? c.groups.map(g => `
              <div style="display:flex;align-items:center;justify-content:space-between;padding:.375rem 0;border-bottom:1px solid var(--border-light)">
                <span class="chip chip-purple">${g.number}</span>
                <span style="font-size:.8rem">${g.course_year ? g.course_year + '-–∫—É—Ä—Å' : '‚Äî'}</span>
                <span style="font-size:.8rem">${g.shift}-–Ω–∞–≤–±–∞—Ç</span>
                <span class="chip ${g.is_active !== false ? 'chip-green' : 'chip-warn'}">${g.is_active !== false ? '–§–∞—ä–æ–ª' : '“í–∞–π—Ä–∏—Ñ–∞—ä–æ–ª'}</span>
              </div>`).join('')
            : '<div style="color:var(--text-4);font-size:.83rem">–ì—É—Ä”Ø“≥ —Ç–∞—ä–∏–Ω –Ω–∞—à—É–¥–∞–∞—Å—Ç</div>'}
        </div>

        ${(c.created_at || c.updated_at) ? `
        <div style="display:flex;gap:1.5rem;font-size:.75rem;color:var(--text-3)">
          ${c.created_at ? `<span>–°–∞–±—Ç: ${c.created_at.split('T')[0]}</span>` : ''}
          ${c.updated_at ? `<span>–ù–∞–≤—Å–æ–∑”£: ${c.updated_at.split('T')[0]}</span>` : ''}
        </div>` : ''}
      </div>
    `;
  } catch(e) {
    body.innerHTML = `<div class="empty">–•–∞—Ç–æ–≥”£: ${e.message}</div>`;
  }
}

</script>

<!-- ‚îÄ‚îÄ‚îÄ MODAL: GROUP PROFILE ‚îÄ‚îÄ‚îÄ -->
<div class="modal-ov" id="modal-group-view">
  <div class="modal-box" style="max-width:560px">
    <div class="mtitle">
      <h3>üìã –ü—Ä–æ—Ñ–∏–ª–∏ –≥—É—Ä”Ø“≥</h3>
      <button class="mclose" onclick="closeModal('modal-group-view')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div id="modal-group-view-body"><div class="loading"><div class="spinner"></div></div></div>
  </div>
</div>

<!-- ‚îÄ‚îÄ‚îÄ MODAL: CURATOR PROFILE ‚îÄ‚îÄ‚îÄ -->
<div class="modal-ov" id="modal-curator-view">
  <div class="modal-box" style="max-width:520px">
    <div class="mtitle">
      <h3>üë§ –ü—Ä–æ—Ñ–∏–ª–∏ –∫—É—Ä–∞—Ç–æ—Ä</h3>
      <button class="mclose" onclick="closeModal('modal-curator-view')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
    </div>
    <div id="modal-curator-view-body"><div class="loading"><div class="spinner"></div></div></div>
  </div>
</div>

</body>
</html>