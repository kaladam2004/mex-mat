<!DOCTYPE html>
<html lang="tg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ó–∞–º–¥–µ–∫–∞–Ω ‚Äî –ú–µ—Ö-–º–∞—Ç</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
  --primary:#7c3aed;--primary-dark:#6d28d9;--primary-light:#ede9fe;--primary-xlight:#f5f3ff;
  --success:#059669;--success-light:#d1fae5;--warning:#d97706;--warning-light:#fef3c7;
  --danger:#dc2626;--danger-light:#fee2e2;
  --bg:#f5f3ff;--surface:#fff;--surface2:#faf9ff;--border:#e5e0fd;--border-light:#f0ecff;
  --text:#0f172a;--text-2:#334155;--text-3:#64748b;--text-4:#94a3b8;
  --sidebar-w:256px;--topbar-h:60px;
  --radius:12px;--radius-sm:8px;--shadow-sm:0 1px 4px rgba(124,58,237,.08);--shadow:0 4px 16px rgba(124,58,237,.12);--tr:all .2s cubic-bezier(.4,0,.2,1);
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;overflow-x:hidden}
/* SIDEBAR */
.sidebar{width:var(--sidebar-w);min-height:100vh;background:var(--surface);border-right:1.5px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:200;transition:transform .3s ease;overflow-y:auto}
.slogo{padding:1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.75rem;flex-shrink:0}
.slogo img{width:38px;height:38px;border-radius:9px;object-fit:cover;border:2px solid var(--border)}
.sbrand{font-size:.85rem;font-weight:800;color:var(--text)}
.sbrand span{font-size:.7rem;font-weight:500;color:var(--text-3);display:block}
.suser{padding:1rem 1.25rem;border-bottom:1px solid var(--border);flex-shrink:0}
.savatar{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--primary),#a855f7);display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:800;color:#fff;flex-shrink:0}
.surow{display:flex;align-items:center;gap:.75rem;margin-bottom:.5rem}
.suname{font-size:.875rem;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.badge{display:inline-flex;font-size:.7rem;font-weight:600;padding:.2rem .6rem;border-radius:20px}
.badge-purple{background:var(--primary-light);color:var(--primary)}
.snav{flex:1;padding:.625rem .75rem}
.nsec{font-size:.68rem;font-weight:700;color:var(--text-4);text-transform:uppercase;letter-spacing:.08em;padding:.75rem .75rem .35rem}
.nitem{display:flex;align-items:center;gap:.625rem;padding:.65rem .875rem;border-radius:var(--radius-sm);font-size:.83rem;font-weight:600;color:var(--text-3);cursor:pointer;transition:var(--tr);text-decoration:none;border:none;background:none;width:100%;text-align:left;margin-bottom:1px}
.nitem:hover{background:var(--primary-xlight);color:var(--primary)}
.nitem.active{background:var(--primary-light);color:var(--primary);font-weight:700}
.nitem svg{width:15px;height:15px;flex-shrink:0}
.sfoot{padding:.875rem .75rem;border-top:1px solid var(--border);flex-shrink:0;display:flex;gap:.5rem}
.fbtna{display:flex;align-items:center;justify-content:center;gap:.35rem;flex:1;padding:.625rem .5rem;border-radius:var(--radius-sm);font-size:.75rem;font-weight:700;font-family:inherit;cursor:pointer;border:1.5px solid var(--border);background:var(--surface2);color:var(--text-2);text-decoration:none;transition:var(--tr)}
.fbtna:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-xlight)}
.fbtna.dng{color:var(--danger);border-color:var(--danger-light)}.fbtna.dng:hover{background:var(--danger-light)}
.fbtna svg{width:13px;height:13px}
/* MAIN */
.overlay{display:none;position:fixed;inset:0;background:rgba(15,23,42,.4);z-index:150;backdrop-filter:blur(2px)}
.overlay.show{display:block}
.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh;transition:margin .3s ease}
.topbar{height:var(--topbar-h);background:var(--surface);border-bottom:1.5px solid var(--border);display:flex;align-items:center;padding:0 1.5rem;gap:.875rem;position:sticky;top:0;z-index:100;box-shadow:var(--shadow-sm)}
.mtoggle{display:none;width:36px;height:36px;border:none;background:var(--bg);border-radius:var(--radius-sm);cursor:pointer;align-items:center;justify-content:center;color:var(--text-2);flex-shrink:0}
.mtoggle svg{width:18px;height:18px}
.tbtitle{font-size:.95rem;font-weight:700;color:var(--text);flex:1}
.content{padding:1.5rem;flex:1}
.section{display:none}
.section.active{display:block;animation:fadeIn .2s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
/* COMPONENTS */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:.875rem;margin-bottom:1.25rem}
.kpi{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:1rem;position:relative;overflow:hidden;display:flex;align-items:center;justify-content:space-between;gap:.875rem}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi.purple::before{background:var(--primary)}.kpi.blue::before{background:#2563eb}.kpi.green::before{background:var(--success)}.kpi.warn::before{background:var(--warning)}.kpi.danger::before{background:var(--danger)}
.kpi-text p{font-size:.78rem;color:var(--text-3);font-weight:500}
.kpi-text .kv{font-size:1.75rem;font-weight:700;font-family:'JetBrains Mono',monospace;line-height:1;margin-top:.2rem}
.kpi-ico{width:40px;height:40px;border-radius:var(--radius-sm);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.kpi-ico svg{width:18px;height:18px}
.kpi.purple .kpi-ico{background:var(--primary-light);color:var(--primary)}.kpi.blue .kpi-ico{background:#dbeafe;color:#2563eb}.kpi.green .kpi-ico{background:var(--success-light);color:var(--success)}.kpi.warn .kpi-ico{background:var(--warning-light);color:var(--warning)}.kpi.danger .kpi-ico{background:var(--danger-light);color:var(--danger)}
.panel{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:1.125rem}
.phead{padding:.875rem 1.125rem;border-bottom:1px solid var(--border-light);display:flex;align-items:center;justify-content:space-between;gap:.875rem;flex-wrap:wrap}
.phead h3{font-size:.9rem;font-weight:700;color:var(--text);display:flex;align-items:center;gap:.5rem;margin:0}
.phead h3 svg{width:14px;height:14px;color:var(--primary)}
.pbody{padding:1.125rem}
.ph{margin-bottom:1.25rem;display:flex;align-items:flex-start;justify-content:space-between;gap:.875rem;flex-wrap:wrap}
.ph h1{font-size:1.2rem;font-weight:800;color:var(--text)}
.ph p{font-size:.82rem;color:var(--text-3);margin-top:.2rem}
.phacts{display:flex;gap:.625rem;flex-wrap:wrap;flex-shrink:0}
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem 1.125rem;border:none;border-radius:var(--radius-sm);font-size:.83rem;font-weight:700;font-family:inherit;cursor:pointer;transition:var(--tr)}
.btn svg{width:14px;height:14px;flex-shrink:0}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark);transform:translateY(-1px)}
.btn-success{background:var(--success);color:#fff}.btn-success:hover{background:#047857}
.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#b91c1c}
.btn-ghost{background:transparent;border:1.5px solid var(--border);color:var(--text-2)}.btn-ghost:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-xlight)}
.btn-sm{padding:.45rem .875rem;font-size:.78rem}.btn-xs{padding:.3rem .625rem;font-size:.72rem}
.btn:disabled{opacity:.6;cursor:not-allowed}
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch}
table.tbl{width:100%;border-collapse:collapse;min-width:560px}
.tbl thead{background:var(--surface2)}
.tbl th{padding:.625rem .875rem;font-size:.72rem;font-weight:700;color:var(--text-3);text-align:left;border-bottom:1.5px solid var(--border);text-transform:uppercase;letter-spacing:.04em}
.tbl td{padding:.7rem .875rem;border-bottom:1px solid var(--border-light);font-size:.83rem}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:var(--primary-xlight)}
.chip{display:inline-flex;align-items:center;font-size:.7rem;font-weight:700;padding:.2rem .625rem;border-radius:20px}
.chip-green{background:var(--success-light);color:var(--success)}.chip-warn{background:var(--warning-light);color:var(--warning)}.chip-red{background:var(--danger-light);color:var(--danger)}.chip-purple{background:var(--primary-light);color:var(--primary)}
.filters{display:flex;gap:.625rem;flex-wrap:wrap}
.finp{padding:.6rem .875rem;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.83rem;color:var(--text);font-family:inherit;outline:none;transition:border-color .2s}
.finp:focus{border-color:var(--primary)}.finp::placeholder{color:var(--text-4)}
.modal-ov{display:none;position:fixed;inset:0;background:rgba(15,23,42,.5);z-index:9999;align-items:center;justify-content:center;padding:1rem;backdrop-filter:blur(4px)}
.modal-ov.show{display:flex}
.modal-box{background:var(--surface);border:1.5px solid var(--border);border-radius:16px;padding:1.5rem;width:100%;max-width:460px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow)}
.mtitle{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem}
.mtitle h3{font-size:1rem;font-weight:800;color:var(--text)}
.mclose{width:30px;height:30px;border:none;background:var(--bg);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-3);transition:var(--tr)}
.mclose:hover{background:var(--danger-light);color:var(--danger)}.mclose svg{width:14px;height:14px}
.fg{margin-bottom:.875rem}
.fg label{display:block;font-size:.75rem;font-weight:700;color:var(--text-2);margin-bottom:.375rem;text-transform:uppercase;letter-spacing:.05em}
.fg .finp{width:100%}
.fg textarea.finp{resize:vertical}
.mactions{display:flex;gap:.625rem;margin-top:1.125rem}
.mactions .btn{flex:1;justify-content:center}
.g2{display:grid;grid-template-columns:1fr 1fr;gap:1.125rem;margin-bottom:1.125rem}
.toast-cnt{position:fixed;top:72px;right:1.25rem;z-index:99999;display:flex;flex-direction:column;gap:.5rem;pointer-events:none}
.toast{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:.7rem 1rem;font-size:.83rem;display:flex;align-items:center;gap:.625rem;box-shadow:var(--shadow);animation:tIn .25s ease;pointer-events:auto;font-weight:600;max-width:300px}
.toast svg{flex-shrink:0;width:15px;height:15px}
.toast.succ{border-color:rgba(5,150,105,.4)}.toast.succ svg{color:var(--success)}
.toast.err{border-color:rgba(220,38,38,.4)}.toast.err svg{color:var(--danger)}
@keyframes tIn{from{opacity:0;transform:translateX(15px)}to{opacity:1;transform:none}}
.loading{display:flex;align-items:center;justify-content:center;padding:3rem}
.spinner{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:3rem;color:var(--text-3);font-size:.875rem}
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
@media(max-width:768px){
  .sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0);box-shadow:var(--shadow)}
  .main{margin-left:0}.mtoggle{display:inline-flex}
  .content{padding:1rem}.kpi-grid{grid-template-columns:repeat(2,1fr)}.g2{grid-template-columns:1fr}
}
</style>
</head>
<body>

<div class="overlay" id="overlay" onclick="closeSB()"></div>

<aside class="sidebar" id="sidebar">
  <div class="slogo">
    <img src="/static/logo.jpg" alt="Logo">
    <div class="sbrand">–ó–∞–º–¥–µ–∫–∞–Ω<span>–°–∏—Å—Ç–µ–º–∞–∏ –ú–µ—Ö-–º–∞—Ç</span></div>
  </div>
  <div class="suser">
    <div class="surow">
      <div class="savatar">{{ user.full_name[0].upper() if user.full_name else '–ó' }}</div>
      <div style="flex:1;min-width:0">
        <div class="suname">{{ user.full_name or '–ó–∞–º–¥–µ–∫–∞–Ω' }}</div>
      </div>
    </div>
    <span class="badge badge-purple">–ó–∞–º–¥–µ–∫–∞–Ω–∏ —Ñ–∞–∫—É–ª—Ç–µ—Ç</span>
  </div>
  <nav class="snav">
    <div class="nsec">–ê—Å–æ—Å”£</div>
    <button class="nitem active" onclick="showSec('dashboard',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
      –£–º—É–º”£
    </button>
    <button class="nitem" onclick="showSec('students',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
      –î–æ–Ω–∏—à“∑”Ø—ë–Ω
    </button>
    <button class="nitem" onclick="showSec('at-risk',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/></svg>
      –•–∞–≤—Ñ–Ω–æ–∫ (NB)
    </button>
    <button class="nitem" onclick="showSec('groups',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
      –ì—É—Ä”Ø“≥“≥–æ
    </button>
    <div class="nsec">–ù–∏–∑–æ–º</div>
    <button class="nitem" onclick="showSec('profile',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      –ü—Ä–æ—Ñ–∏–ª
    </button>
  </nav>
  <div class="sfoot">
    <button class="fbtna" onclick="showSec('change-pw',this)">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
      –ü–∞—Ä–æ–ª
    </button>
    <a href="/logout" class="fbtna dng">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
      –•—É—Ä—É“∑
    </a>
  </div>
</aside>

<div class="main">
  <header class="topbar">
    <button class="mtoggle" onclick="openSB()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
    </button>
    <div class="tbtitle" id="page-title">–£–º—É–º”£</div>
  </header>

  <div class="content">

  <!-- DASHBOARD -->
  <div class="section active" id="sec-dashboard">
    <div class="kpi-grid">
      <div class="kpi blue"><div class="kpi-text"><p>–î–æ–Ω–∏—à“∑”Ø—ë–Ω</p><div class="kv" id="kpi-students">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/></svg></div></div>
      <div class="kpi purple"><div class="kpi-text"><p>–ì—É—Ä”Ø“≥“≥–æ</p><div class="kv" id="kpi-groups">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div></div>
      <div class="kpi green"><div class="kpi-text"><p>–ò—à—Ç–∏—Ä–æ–∫%</p><div class="kv" id="kpi-att">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg></div></div>
      <div class="kpi danger"><div class="kpi-text"><p>–•–∞–≤—Ñ–Ω–æ–∫</p><div class="kv" id="kpi-risk">‚Äî</div></div><div class="kpi-ico"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/></svg></div></div>
    </div>
    <div class="g2">
      <div class="panel">
        <div class="phead"><h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/></svg>–•–∞–≤—Ñ–Ω–æ–∫—Ç–∞—Ä–∏–Ω –¥–æ–Ω–∏—à“∑”Ø—ë–Ω</h3></div>
        <div id="dash-risk"><div class="loading"><div class="spinner"></div></div></div>
      </div>
      <div class="panel">
        <div class="phead"><h3><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/></svg>–ò—à—Ç–∏—Ä–æ–∫ –±–æ –≥—É—Ä”Ø“≥“≥–æ</h3></div>
        <div id="dash-groups"><div class="loading"><div class="spinner"></div></div></div>
      </div>
    </div>
  </div>

  <!-- STUDENTS -->
  <div class="section" id="sec-students">
    <div class="ph">
      <div><h1>üéì –î–æ–Ω–∏—à“∑”Ø—ë–Ω</h1></div>
      <div class="phacts">
        <button class="btn btn-success btn-sm" onclick="exportStudents()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          –≠–∫—Å–ø–æ—Ä—Ç
        </button>
      </div>
    </div>
    <div class="panel">
      <div class="phead">
        <div class="filters">
          <select class="finp" id="stu-group" onchange="loadStudents()"><option value="">“≤–∞–º–∞ –≥—É—Ä”Ø“≥</option></select>
          <select class="finp" id="stu-course" onchange="loadStudents()"><option value="">“≤–∞–º–∞ –∫—É—Ä—Å</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option></select>
          <input type="text" class="finp" id="stu-search" placeholder="“∂—É—Å—Ç—É“∑”Ø..." oninput="debStu()" style="flex:1;min-width:150px">
        </div>
      </div>
      <div class="tw"><table class="tbl">
        <thead><tr><th>#</th><th>–ù–æ–º</th><th>–ì—É—Ä”Ø“≥</th><th>–ö—É—Ä—Å</th><th>NB</th><th>–¢–µ–ª. –≤–æ–ª–∏–¥–∞–π–Ω</th></tr></thead>
        <tbody id="stu-tbody"><tr><td colspan="6"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
      </table></div>
      <div style="padding:.875rem 1.125rem;border-top:1px solid var(--border-light);display:flex;justify-content:space-between;flex-wrap:wrap;gap:.5rem">
        <span style="font-size:.8rem;color:var(--text-3)">“∂–∞–º—ä: <strong id="stu-total" style="color:var(--text)">0</strong></span>
        <div id="stu-pager" style="display:flex;gap:.375rem"></div>
      </div>
    </div>
  </div>

  <!-- AT-RISK -->
  <div class="section" id="sec-at-risk">
    <div class="ph">
      <div><h1>üö® –•–∞–≤—Ñ–Ω–æ–∫ (NB)</h1><p>–î–æ–Ω–∏—à“∑”Ø—ë–Ω–µ –∫–∏ NB –∞–∑ “≥–∞–¥–∏ —Ñ–∞—Ä–ævar—Ç–∞—Ä –∞—Å—Ç</p></div>
      <div class="phacts">
        <button class="btn btn-success btn-sm" onclick="exportNB()">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          –≠–∫—Å–ø–æ—Ä—Ç NB
        </button>
      </div>
    </div>
    <div class="panel">
      <div class="tw"><table class="tbl">
        <thead><tr><th>#</th><th>–ù–æ–º</th><th>–ì—É—Ä”Ø“≥</th><th>NB</th><th>–¢–µ–ª. –≤–æ–ª–∏–¥–∞–π–Ω</th></tr></thead>
        <tbody id="risk-tbody"><tr><td colspan="5"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
      </table></div>
    </div>
  </div>

  <!-- GROUPS -->
  <div class="section" id="sec-groups">
    <div class="ph"><div><h1>üë• –ì—É—Ä”Ø“≥“≥–æ</h1></div></div>
    <div class="panel">
      <div class="tw"><table class="tbl">
        <thead><tr><th>#</th><th>–†–∞“õ–∞–º</th><th>–ö—É—Ä—Å</th><th>–ù–∞–≤–±–∞—Ç</th><th>–ö—É—Ä–∞—Ç–æ—Ä</th><th>–î–æ–Ω–∏—à“∑”Ø—ë–Ω</th><th>Att%</th></tr></thead>
        <tbody id="groups-tbody"><tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
      </table></div>
    </div>
  </div>

  <!-- PROFILE -->
  <div class="section" id="sec-profile">
    <div class="ph"><div><h1>üë§ –ü—Ä–æ—Ñ–∏–ª</h1></div></div>
    <div style="max-width:480px">
      <div class="panel">
        <div class="pbody">
          <form onsubmit="saveProfile(event)">
            <div class="fg"><label>–ù–æ–º—É –Ω–∞—Å–∞–± *</label><input class="finp" id="p-name" required></div>
            <div class="fg"><label>Email</label><input type="email" class="finp" id="p-email"></div>
            <div class="fg"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input class="finp" id="p-phone"></div>
            <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center">–°–∞–±—Ç –∫–∞—Ä–¥–∞–Ω</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- CHANGE PW -->
  <div class="section" id="sec-change-pw">
    <div class="ph"><div><h1>üîê –ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—Ä–æ–ª</h1></div></div>
    <div style="max-width:380px">
      <div class="panel"><div class="pbody">
        <form action="/zamdean/change-password" method="post">
          <div class="fg"><label>–ü–∞—Ä–æ–ª–∏ –Ω–∞–≤ (6 —Ä–∞“õ–∞–º)</label><input type="password" class="finp" name="new_password" maxlength="6" pattern="\d{6}" required placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="letter-spacing:6px;font-size:1.25rem;text-align:center"></div>
          <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center">–ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω</button>
        </form>
      </div></div>
    </div>
  </div>

  </div><!-- /content -->
</div><!-- /main -->

<div class="toast-cnt" id="toasts"></div>

<script>
'use strict';
const titles={dashboard:'–£–º—É–º”£',students:'–î–æ–Ω–∏—à“∑”Ø—ë–Ω','at-risk':'–•–∞–≤—Ñ–Ω–æ–∫ (NB)',groups:'–ì—É—Ä”Ø“≥“≥–æ',profile:'–ü—Ä–æ—Ñ–∏–ª','change-pw':'–ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—Ä–æ–ª'};
let stuTO=null, stuPage=1; const PAGE=50;

function openSB(){document.getElementById('sidebar').classList.add('open');document.getElementById('overlay').classList.add('show')}
function closeSB(){document.getElementById('sidebar').classList.remove('open');document.getElementById('overlay').classList.remove('show')}
function showSec(name,el){
  document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
  document.querySelectorAll('.nitem').forEach(n=>n.classList.remove('active'));
  document.getElementById('sec-'+name).classList.add('active');
  if(el)el.classList.add('active');
  document.getElementById('page-title').textContent=titles[name]||name;
  closeSB();
  const loaders={dashboard:loadDashboard,students:()=>{loadGroupsFilter();loadStudents();},'at-risk':loadAtRisk,groups:loadGroups,profile:loadProfile};
  if(loaders[name])loaders[name]();
}
async function api(url,opts={}){
  const h={};if(!(opts.body instanceof FormData))h['Content-Type']='application/json';
  const r=await fetch(url,{...opts,headers:{...h,...(opts.headers||{})}});
  if(!r.ok){let m='–•–∞—Ç–æ–≥”£';try{const e=await r.json();m=e.detail||m;}catch(e){}throw new Error(m);}
  return r.json();
}
function toast(type,msg){
  const c=document.getElementById('toasts');const el=document.createElement('div');el.className=`toast ${type}`;
  el.innerHTML=`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="${type==='succ'?'20 6 9 17 4 12':''}"/>${type==='err'?'<circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/>':''}</svg>${msg}`;
  c.appendChild(el);setTimeout(()=>el.remove(),3500);
}
async function loadDashboard(){
  try{const d=await api('/zamdean/api/stats');
    document.getElementById('kpi-students').textContent=d.total_students||0;
    document.getElementById('kpi-groups').textContent=d.total_groups||0;
    document.getElementById('kpi-att').textContent=(d.attendance_rate||0)+'%';
    document.getElementById('kpi-risk').textContent=d.high_risk_count||0;
    const risk=document.getElementById('dash-risk');
    const top=(d.high_risk||[]).slice(0,5);
    risk.innerHTML=top.length?top.map(s=>`<div style="display:flex;align-items:center;gap:.75rem;padding:.625rem 1rem;border-bottom:1px solid var(--border-light)"><div style="flex:1;font-size:.83rem;font-weight:600">${s.full_name||'‚Äî'}</div><div style="font-size:.83rem;font-weight:700;color:var(--danger);font-family:'JetBrains Mono',monospace">${s.total_absent_hours||0} –ù–ë</div></div>`).join(''):'<div class="empty">–•–∞–≤—Ñ–Ω–æ–∫ –Ω–µ—Å—Ç</div>';
    const grps=document.getElementById('dash-groups');
    grps.innerHTML=(d.groups||[]).slice(0,5).map(g=>`<div style="padding:.625rem 1rem;border-bottom:1px solid var(--border-light)"><div style="display:flex;justify-content:space-between;margin-bottom:.3rem"><span style="font-size:.83rem;font-weight:700">–ì—É—Ä”Ø“≥ ${g.number||g.group_number||'‚Äî'}</span><span style="font-size:.83rem;font-weight:700;color:var(--primary)">${g.attendance_rate||0}%</span></div><div style="height:5px;background:var(--border);border-radius:5px;overflow:hidden"><div style="height:100%;border-radius:5px;background:linear-gradient(90deg,var(--success),#34d399);width:${g.attendance_rate||0}%"></div></div></div>`).join('')||'<div class="empty">–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</div>';
  }catch(e){}
}
async function loadGroupsFilter(){
  try{const d=await api('/zamdean/api/groups');
    const sel=document.getElementById('stu-group');sel.innerHTML='<option value="">“≤–∞–º–∞ –≥—É—Ä”Ø“≥</option>';
    d.forEach(g=>{const o=document.createElement('option');o.value=g.id;o.textContent=`–ì—É—Ä”Ø“≥ ${g.number}`;sel.appendChild(o);});
  }catch(e){}
}
function debStu(){clearTimeout(stuTO);stuTO=setTimeout(()=>{stuPage=1;loadStudents();},400);}
async function loadStudents(){
  const g=document.getElementById('stu-group')?.value||'';const c=document.getElementById('stu-course')?.value||'';const s=document.getElementById('stu-search')?.value||'';
  const p=new URLSearchParams();if(g)p.append('group_id',g);if(c)p.append('course',c);if(s)p.append('search',s);p.append('page',stuPage);p.append('page_size',PAGE);
  try{const d=await api(`/zamdean/api/students?${p}`);
    const arr=d.students||d||[];const total=d.total||arr.length;
    document.getElementById('stu-total').textContent=total;
    const tb=document.getElementById('stu-tbody');
    if(!arr.length){tb.innerHTML='<tr><td colspan="6"><div class="empty">–î–æ–Ω–∏—à“∑”Ø —ë—Ñ—Ç –Ω–∞—à—É–¥</div></td></tr>';return;}
    tb.innerHTML=arr.map((s,i)=>`<tr><td style="font-family:'JetBrains Mono',monospace;font-size:.8rem">${(stuPage-1)*PAGE+i+1}</td><td><strong>${s.full_name||'‚Äî'}</strong></td><td>${s.group_number||'‚Äî'}</td><td>${s.course_year||'‚Äî'}</td><td><span class="chip ${(s.total_absent_hours||0)>=(d.nb_limit||35)?'chip-red':(s.total_absent_hours||0)>=20?'chip-warn':'chip-green'}">${s.total_absent_hours||0}</span></td><td>${s.parent_phone||'‚Äî'}</td></tr>`).join('');
    const pages=Math.ceil(total/PAGE);const pager=document.getElementById('stu-pager');pager.innerHTML='';
    for(let pg=1;pg<=Math.min(pages,8);pg++){const b=document.createElement('button');b.style.cssText=`width:32px;height:32px;border:1.5px solid var(--border);border-radius:8px;background:${pg===stuPage?'var(--primary)':'var(--surface)'};color:${pg===stuPage?'#fff':'var(--text-2)'};border-color:${pg===stuPage?'var(--primary)':'var(--border)'};font-size:.8rem;font-weight:600;cursor:pointer;font-family:inherit`;b.textContent=pg;b.onclick=()=>{stuPage=pg;loadStudents();};pager.appendChild(b);}
  }catch(e){}
}
async function loadAtRisk(){
  try{const d=await api('/zamdean/api/at-risk');
    const tb=document.getElementById('risk-tbody');
    if(!d.length){tb.innerHTML='<tr><td colspan="5"><div class="empty">–•–∞–≤—Ñ–Ω–æ–∫ –Ω–µ—Å—Ç</div></td></tr>';return;}
    tb.innerHTML=d.map((s,i)=>`<tr><td style="font-family:'JetBrains Mono',monospace;font-size:.8rem">${i+1}</td><td><strong>${s.full_name||'‚Äî'}</strong></td><td>${s.group_number||'‚Äî'}</td><td><span class="chip chip-red">${s.total_absent_hours||0}</span></td><td>${s.parent_phone||'‚Äî'}</td></tr>`).join('');
  }catch(e){}
}
async function loadGroups(){
  try{const d=await api('/zamdean/api/groups');
    const tb=document.getElementById('groups-tbody');
    if(!d.length){tb.innerHTML='<tr><td colspan="7"><div class="empty">–ì—É—Ä”Ø“≥ –Ω–µ—Å—Ç</div></td></tr>';return;}
    tb.innerHTML=d.map((g,i)=>`<tr><td style="font-family:'JetBrains Mono',monospace;font-size:.8rem">${i+1}</td><td><strong>${g.number||'‚Äî'}</strong></td><td><span class="chip chip-purple">${g.course_year||'?'}-–∫—É—Ä—Å</span></td><td>${g.shift}-–Ω–∞–≤–±–∞—Ç</td><td>${g.curator_name||'‚Äî'}</td><td>${g.student_count||0}</td><td><span class="chip ${(g.attendance_rate||0)>=80?'chip-green':(g.attendance_rate||0)>=60?'chip-warn':'chip-red'}">${g.attendance_rate||0}%</span></td></tr>`).join('');
  }catch(e){}
}
async function loadProfile(){
  try{const d=await api('/zamdean/api/profile');
    document.getElementById('p-name').value=d.full_name||'';
    document.getElementById('p-email').value=d.email||'';
    document.getElementById('p-phone').value=d.phone||'';
  }catch(e){}
}
async function saveProfile(e){e.preventDefault();
  const fd=new FormData();
  fd.append('full_name',document.getElementById('p-name').value);
  fd.append('email',document.getElementById('p-email').value||'');
  fd.append('phone',document.getElementById('p-phone').value||'');
  try{await api('/zamdean/api/profile',{method:'PUT',body:fd});toast('succ','‚úÖ –ü—Ä–æ—Ñ–∏–ª —Å–∞–±—Ç —à—É–¥');}
  catch(err){toast('err',err.message);}
}
function exportStudents(){window.open('/zamdean/api/export/students','_blank');}
function exportNB(){window.open('/zamdean/api/export/nb','_blank');}
document.addEventListener('DOMContentLoaded',loadDashboard);
</script>
</body>
</html>