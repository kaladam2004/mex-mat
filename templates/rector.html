<!DOCTYPE html>
<html lang="tj">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ğ ĞµĞºÑ‚Ğ¾Ñ€ â€” ĞœĞµÑ…-Ğ¼Ğ°Ñ‚</title>
    <style>
        /* â”€â”€ RESET â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        :root {
            --primary:      #1e40af;
            --primary-dark: #1e3a8a;
            --primary-light:#3b82f6;
            --secondary:    #64748b;
            --success:      #16a34a;
            --warning:      #d97706;
            --danger:       #dc2626;
            --bg-body:      #f1f5f9;
            --bg-card:      #ffffff;
            --bg-header:    #1e293b;
            --text-main:    #0f172a;
            --text-sub:     #64748b;
            --text-muted:   #94a3b8;
            --text-white:   #ffffff;
            --border:       #e2e8f0;
            --radius:       0.5rem;
            --radius-lg:    1rem;
            --shadow:       0 1px 3px rgba(0,0,0,.1),0 1px 2px rgba(0,0,0,.06);
            --shadow-md:    0 4px 6px rgba(0,0,0,.07),0 2px 4px rgba(0,0,0,.06);
            --tr:           all 0.18s ease;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: var(--bg-body);
            color: var(--text-main);
            font-size: 14px;
            line-height: 1.6;
        }

        /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .r-header {
            background: var(--bg-header);
            color: var(--text-white);
            padding: .75rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
            position: sticky; top: 0; z-index: 200;
            box-shadow: var(--shadow-md);
        }
        .r-logo { display:flex; align-items:center; gap:.5rem; font-weight:700; font-size:1rem; }
        .r-logo img { height:38px; width:38px; border-radius:4px; object-fit:cover; }
        .r-nav { display:flex; gap:.25rem; flex-wrap:wrap; flex:1; }
        .r-nav a {
            color:rgba(255,255,255,.8); text-decoration:none;
            padding:.4rem .85rem; border-radius:var(--radius);
            font-weight:500; font-size:.875rem; transition:var(--tr);
        }
        .r-nav a:hover, .r-nav a.active { background:var(--primary-light); color:#fff; }
        .r-user { display:flex; flex-direction:column; align-items:flex-end; gap:2px; }
        .r-user .role { font-size:.7rem; color:var(--primary-light); text-transform:uppercase; letter-spacing:.06em; }
        .r-user .name { font-size:.875rem; font-weight:600; }
        .r-actions { display:flex; gap:.5rem; }

        /* â”€â”€ BUTTONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .btn {
            display:inline-flex; align-items:center; gap:.3rem;
            padding:.45rem 1rem; border:none; border-radius:var(--radius);
            font-size:.85rem; font-weight:500; cursor:pointer;
            text-decoration:none; transition:var(--tr); white-space:nowrap;
        }
        .btn:disabled { opacity:.55; cursor:not-allowed; }
        .btn-primary   { background:var(--primary);   color:#fff; }
        .btn-primary:hover:not(:disabled) { background:var(--primary-dark); }
        .btn-secondary { background:var(--secondary); color:#fff; }
        .btn-secondary:hover:not(:disabled) { background:#475569; }
        .btn-danger    { background:var(--danger);    color:#fff; }
        .btn-danger:hover:not(:disabled) { background:#b91c1c; }
        .btn-outline   { background:transparent; border:1.5px solid var(--primary); color:var(--primary); }
        .btn-outline:hover:not(:disabled) { background:var(--primary); color:#fff; }
        .btn-sm { padding:.3rem .65rem; font-size:.8rem; }
        .btn-sm.active { background:var(--primary); color:#fff; }

        /* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .r-main {
            max-width:1420px; margin:0 auto;
            padding:1.5rem; display:flex; flex-direction:column; gap:1.5rem;
        }

        /* â”€â”€ SECTIONS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .section { display:none; }
        .section.active { display:block; }

        /* â”€â”€ STAT CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .stats-grid {
            display:grid;
            grid-template-columns: repeat(auto-fit, minmax(175px,1fr));
            gap:1rem;
        }
        .stat-card {
            background:var(--bg-card); border-radius:var(--radius-lg);
            padding:1.25rem; box-shadow:var(--shadow); border:1px solid var(--border);
            transition:var(--tr);
        }
        .stat-card:hover { transform:translateY(-2px); box-shadow:var(--shadow-md); }
        .stat-card.hi {
            background:linear-gradient(135deg, var(--primary), var(--primary-dark));
            color:#fff;
        }
        .stat-card h3 { font-size:.8rem; font-weight:500; color:var(--text-sub); margin-bottom:.4rem; }
        .stat-card.hi h3 { color:rgba(255,255,255,.85); }
        .stat-value { font-size:2rem; font-weight:700; line-height:1; margin-bottom:.25rem; }
        .stat-sub { font-size:.78rem; color:var(--text-muted); }
        .stat-card.hi .stat-sub { color:rgba(255,255,255,.75); }

        /* â”€â”€ KPI ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .kpi-row { display:flex; gap:1rem; flex-wrap:wrap; }
        .kpi-card {
            flex:1 1 160px; background:var(--bg-card); border-radius:var(--radius-lg);
            padding:1rem 1.25rem; box-shadow:var(--shadow); border:1px solid var(--border);
            text-align:center;
        }
        .kpi-label { font-size:.78rem; color:var(--text-sub); margin-bottom:.3rem; }
        .kpi-value { font-size:1.75rem; font-weight:700; }
        .kpi-sub { font-size:.78rem; color:var(--text-muted); margin-top:.2rem; }
        .dyn-up { color:#16a34a; }
        .dyn-down { color:#dc2626; }
        .dyn-flat { color:var(--text-sub); }

        /* â”€â”€ SECTION HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .sec-header {
            display:flex; justify-content:space-between; align-items:center;
            flex-wrap:wrap; gap:.75rem;
            margin-bottom:1rem; padding-bottom:.75rem;
            border-bottom:1px solid var(--border);
        }
        .sec-header h2 { font-size:1.15rem; font-weight:700; color:var(--text-main); }

        /* â”€â”€ FILTERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .filters { display:flex; gap:.5rem; flex-wrap:wrap; align-items:center; }
        .filters select,
        .filters input {
            padding:.42rem .75rem; border:1.5px solid var(--border);
            border-radius:var(--radius); font-size:.85rem;
            background:var(--bg-card); color:var(--text-main); min-width:140px;
            transition:var(--tr);
        }
        .filters select:focus,
        .filters input:focus {
            outline:none; border-color:var(--primary-light);
            box-shadow:0 0 0 3px rgba(59,130,246,.12);
        }

        /* â”€â”€ TABLES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .table-wrap {
            background:var(--bg-card); border-radius:var(--radius-lg);
            box-shadow:var(--shadow); overflow:hidden; border:1px solid var(--border);
        }
        .data-table { width:100%; border-collapse:collapse; font-size:.875rem; }
        .data-table thead { background:var(--bg-header); color:#fff; }
        .data-table th, .data-table td {
            padding:.75rem 1rem; text-align:left; border-bottom:1px solid var(--border);
        }
        .data-table th { font-size:.75rem; text-transform:uppercase; letter-spacing:.05em; font-weight:600; }
        .data-table tbody tr:hover { background:rgba(59,130,246,.04); }
        .data-table tbody tr:last-child td { border-bottom:none; }
        .empty-row td { text-align:center; color:var(--text-muted); padding:2rem; }
        .loading-row td { text-align:center; color:var(--text-sub); padding:2rem; }

        /* â”€â”€ RISK BADGES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .risk {
            display:inline-flex; align-items:center; gap:.3rem;
            padding:.25rem .6rem; border-radius:999px; font-size:.78rem; font-weight:600;
        }
        .risk-low      { background:#dcfce7; color:#166534; }
        .risk-medium   { background:#fef9c3; color:#854d0e; }
        .risk-high     { background:#ffedd5; color:#7c2d12; }
        .risk-critical { background:#fee2e2; color:#7f1d1d; }

        /* â”€â”€ ALERTS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .alerts-grid {
            display:grid;
            grid-template-columns:repeat(auto-fit, minmax(260px,1fr));
            gap:1rem;
        }
        .alert-card {
            background:var(--bg-card); border-radius:var(--radius-lg);
            padding:1.25rem; border-left:4px solid var(--border); box-shadow:var(--shadow);
        }
        .alert-card.error   { border-left-color:#ef4444; background:#fff5f5; }
        .alert-card.warning { border-left-color:#f97316; background:#fffbeb; }
        .alert-card.success { border-left-color:#22c55e; background:#f0fdf4; }
        .alert-card h4 { font-size:.9rem; font-weight:700; margin-bottom:.6rem; display:flex; align-items:center; gap:.4rem; }
        .alert-card ul { list-style:none; font-size:.85rem; color:var(--text-sub); }
        .alert-card li { padding:.3rem 0; border-bottom:1px dashed var(--border); }
        .alert-card li:last-child { border-bottom:none; }

        /* â”€â”€ TOP CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .top-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:1rem; }
        .top-card {
            background:var(--bg-card); border-radius:var(--radius-lg);
            padding:1.25rem; box-shadow:var(--shadow); border:1px solid var(--border);
        }
        .top-card.best  { border-top:3px solid #22c55e; }
        .top-card.worst { border-top:3px solid #ef4444; }
        .top-card h3 { font-size:1rem; font-weight:700; margin-bottom:.25rem; }
        .top-card .subtitle { font-size:.78rem; color:var(--text-muted); margin-bottom:.75rem; }
        .top-card ul { list-style:none; }
        .top-card li {
            display:flex; justify-content:space-between; align-items:center;
            padding:.4rem 0; border-bottom:1px solid var(--border); font-size:.875rem;
        }
        .top-card li:last-child { border-bottom:none; }
        .top-rank { font-weight:700; width:1.5rem; }
        .top-name { flex:1; margin-left:.4rem; }
        .top-val  { font-weight:700; font-size:.82rem; color:var(--primary); }

        /* â”€â”€ PAGINATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .pagination { display:flex; gap:.35rem; flex-wrap:wrap; margin-top:1rem; }
        .pagination .btn { min-width:2rem; justify-content:center; }

        /* â”€â”€ FILTER PILLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .pill-group { display:flex; gap:.4rem; flex-wrap:wrap; margin-bottom:.75rem; }
        .pill {
            padding:.28rem .75rem; border-radius:999px;
            font-size:.8rem; font-weight:500; cursor:pointer;
            background:#e2e8f0; color:var(--text-sub); border:none; transition:var(--tr);
        }
        .pill:hover { background:#cbd5e1; }
        .pill.active { background:var(--primary); color:#fff; }

        /* â”€â”€ MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .modal {
            display:none; position:fixed; inset:0;
            background:rgba(0,0,0,.5); z-index:500;
            align-items:center; justify-content:center; padding:1rem;
        }
        .modal.open { display:flex; }
        .modal-box {
            background:var(--bg-card); border-radius:var(--radius-lg);
            box-shadow:0 20px 60px rgba(0,0,0,.25);
            width:100%; max-width:700px; max-height:90vh;
            display:flex; flex-direction:column; overflow:hidden;
        }
        .modal-head {
            background:var(--bg-header); color:#fff;
            padding:1rem 1.25rem; display:flex; justify-content:space-between; align-items:center;
        }
        .modal-head h3 { font-size:1rem; font-weight:700; }
        .close-btn {
            background:none; border:none; color:#fff; font-size:1.5rem;
            cursor:pointer; line-height:1; padding:0 .25rem;
        }
        .modal-body { padding:1.25rem; overflow-y:auto; flex:1; }
        .modal-foot { padding:.75rem 1.25rem; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:.5rem; }

        /* â”€â”€ PROFILE INFO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .profile-info { display:flex; flex-direction:column; gap:.5rem; margin-bottom:1rem; }
        .profile-info h3 { font-size:1.1rem; font-weight:700; margin-bottom:.5rem; }
        .profile-info p { display:flex; gap:.75rem; font-size:.875rem; }
        .profile-info p strong { min-width:130px; color:var(--text-sub); }

        /* â”€â”€ SETTINGS ROW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        .settings-row {
            background:var(--bg-card); border-radius:var(--radius-lg);
            padding:1rem 1.25rem; display:flex; align-items:center; gap:1rem;
            flex-wrap:wrap; box-shadow:var(--shadow); border:1px solid var(--border);
        }
        .settings-row label { font-size:.85rem; font-weight:600; color:var(--text-sub); }
        .settings-row input[type="number"] {
            width:80px; padding:.35rem .65rem; border:1.5px solid var(--border);
            border-radius:var(--radius); font-size:.875rem;
        }

        /* â”€â”€ SCROLLBAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
        ::-webkit-scrollbar { width:7px; height:7px; }
        ::-webkit-scrollbar-track { background:var(--bg-body); }
        ::-webkit-scrollbar-thumb { background:#94a3b8; border-radius:999px; }

        @media(max-width:768px) {
            .r-main { padding:1rem; }
            .stats-grid { grid-template-columns:repeat(2,1fr); }
            .table-wrap { overflow-x:auto; }
            .data-table { min-width:700px; }
        }
        @media(max-width:480px) {
            .stats-grid { grid-template-columns:1fr; }
        }
    </style>
</head>
<body>

<!-- â•â•â• HEADER â•â•â• -->
<header class="r-header">
    <div class="r-logo">
        <img src="/static/logo.jpg" alt="Ğ›Ğ¾Ğ³Ğ¾Ñ‚Ğ¸Ğ¿">
        <span>ğŸ“ ĞœĞµÑ…-Ğ¼Ğ°Ñ‚</span>
    </div>
    <nav class="r-nav">
        <a href="#" class="active" onclick="showSection('dashboard',this)">ğŸ“Š ĞÑĞ¾ÑÓ£</a>
        <a href="#" onclick="showSection('faculties',this)">ğŸ› Ğ¤Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚Ò³Ğ¾</a>
        <a href="#" onclick="showSection('weekly',this)">ğŸ“ˆ Ğ¢ĞĞŸ 5 / ĞĞ³Ğ¾Ò³Ğ¸Ò³Ğ¾</a>
        <a href="#" onclick="showSection('students',this)">ğŸ‘¨â€ğŸ“ Ğ”Ğ¾Ğ½Ğ¸ÑˆÒ·Ó¯Ñ‘Ğ½</a>
        <a href="#" onclick="showSection('staff',this)">ğŸ‘¨â€ğŸ« ĞšĞ¾Ñ€Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ½</a>
        <a href="#" onclick="showSection('profile',this)">ğŸ‘¤ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»</a>
    </nav>
    <div class="r-user">
        <span class="role">Ğ ĞµĞºÑ‚Ğ¾Ñ€</span>
        <span class="name">{{ user.full_name if user else "Ğ ĞµĞºÑ‚Ğ¾Ñ€" }}</span>
    </div>
    <div class="r-actions">
        <a href="/rector/change-password" class="btn btn-secondary btn-sm">ğŸ”‘ ĞŸĞ°Ñ€Ğ¾Ğ»</a>
        <a href="/logout" class="btn btn-danger btn-sm">ğŸšª Ğ§Ğ¸Ò›Ğ¸Ñˆ</a>
    </div>
</header>

<!-- â•â•â• MAIN â•â•â• -->
<main class="r-main">

    <!-- â•â• LPW Settings (global) â•â• -->
    <div class="settings-row" id="lpw-row">
        <label>ğŸ“… Ğ”Ğ°Ñ€ÑÒ³Ğ¾ Ğ´Ğ°Ñ€ Ò³Ğ°Ñ„Ñ‚Ğ° (LPW):</label>
        <input type="number" id="lpw-input" value="25" min="1" max="100">
        <button class="btn btn-primary btn-sm" onclick="reloadAll()">ğŸ”„ ĞĞ°Ğ²ÑĞ¾Ğ·Ó£</button>
        <span style="font-size:.8rem;color:var(--text-muted)">Ğ˜Ğ½ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€ Ğ±Ğ°Ñ€Ğ¾Ğ¸ Ò³Ğ¸ÑĞ¾Ğ±ĞºÑƒĞ½Ğ¸Ğ¸ NB% Ğ¸ÑÑ‚Ğ¸Ñ„Ğ¾Ğ´Ğ° Ğ¼ĞµÑˆĞ°Ğ²Ğ°Ğ´</span>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SECTION: DASHBOARD
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section active" id="sec-dashboard">
        <!-- 4.1 Stats -->
        <div class="stats-grid" id="stats-grid">
            <div class="stat-card"><h3>ğŸ› Ğ¤Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚Ò³Ğ¾</h3><div class="stat-value" id="s-fac">â€”</div><div class="stat-sub">Ñ„Ğ°ÑŠĞ¾Ğ»: <span id="s-fac-active">â€”</span></div></div>
            <div class="stat-card"><h3>ğŸ“š Ğ“ÑƒÑ€Ó¯Ò³Ò³Ğ¾</h3><div class="stat-value" id="s-grp">â€”</div><div class="stat-sub">Ñ„Ğ°ÑŠĞ¾Ğ»: <span id="s-grp-active">â€”</span></div></div>
            <div class="stat-card"><h3>ğŸ‘¨â€ğŸ“ Ğ”Ğ¾Ğ½Ğ¸ÑˆÒ·Ó¯Ñ‘Ğ½</h3><div class="stat-value" id="s-stu">â€”</div></div>
            <div class="stat-card"><h3>ğŸ‘¨â€ğŸ« ĞšĞ¾Ñ€Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ½</h3><div class="stat-value" id="s-staff">â€”</div></div>
            <!-- 4.2 + 4.3 -->
            <div class="stat-card hi"><h3>ğŸ“Š NB% (Ò³Ğ°Ñ„Ñ‚Ğ°Ğ¸ Ò·Ğ¾Ñ€Ó£)</h3><div class="stat-value" id="s-nb">â€”</div><div class="stat-sub" id="s-dyn">â€”</div></div>
            <div class="stat-card"><h3>âœ… Attendance% (Ò³Ğ°Ñ„Ñ‚Ğ°Ğ¸ Ò·Ğ¾Ñ€Ó£)</h3><div class="stat-value" id="s-att">â€”</div><div class="stat-sub" id="s-att-prev">â€”</div></div>
        </div>

        <!-- KPI week range -->
        <div style="font-size:.8rem;color:var(--text-muted);margin-top:.25rem" id="week-range"></div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SECTION: FACULTIES (5, 5.1, 6)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section" id="sec-faculties">
        <div class="sec-header">
            <h2>ğŸ› Ğ¤Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚Ò³Ğ¾</h2>
            <div class="filters">
                <select id="f-risk" onchange="loadFaculties()">
                    <option value="">Ò²Ğ°Ğ¼Ğ° Risk</option>
                    <option value="low">ğŸŸ¢ ĞœÑƒÑŠÑ‚Ğ°Ğ´Ğ¸Ğ»</option>
                    <option value="medium">ğŸŸ¡ ĞĞ³Ğ¾Ò³Ó£</option>
                    <option value="high">ğŸŸ  Ğ‘Ğ°Ğ»Ğ°Ğ½Ğ´</option>
                    <option value="critical">ğŸ”´ Ğ¢Ğ°Ğ½Ò›Ğ¸Ğ´Ó£</option>
                </select>
                <select id="f-att" onchange="loadFaculties()">
                    <option value="">Ò²Ğ°Ğ¼Ğ° Attendance</option>
                    <option value="90-100">90â€“100%</option>
                    <option value="80-89">80â€“89%</option>
                    <option value="70-79">70â€“79%</option>
                    <option value="0-69">&lt;70%</option>
                </select>
            </div>
        </div>
        <div class="table-wrap">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ğ¤Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚</th>
                        <th>Ğ”ĞµĞºĞ°Ğ½</th>
                        <th>Ğ—Ğ°Ğ¼Ğ´ĞµĞºĞ°Ğ½</th>
                        <th>Ğ“ÑƒÑ€Ó¯Ò³Ò³Ğ¾</th>
                        <th>Ğ”Ğ¾Ğ½Ğ¸ÑˆÒ·Ó¯Ñ‘Ğ½</th>
                        <th>ĞšĞ¾Ñ€Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ½</th>
                        <th>Att%</th>
                        <th>NB%</th>
                        <th>Risk</th>
                        <th>ğŸ‘</th>
                    </tr>
                </thead>
                <tbody id="fac-tbody"><tr class="loading-row"><td colspan="10">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SECTION: WEEKLY â€” TOP5 + ALERTS (8, 9)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section" id="sec-weekly">
        <div class="sec-header">
            <h2>ğŸ“ˆ Ğ¢ĞĞŸ 5 Ñ„Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚Ò³Ğ¾ + ĞĞ³Ğ¾Ò³Ğ¸Ğ½Ğ¾Ğ¼Ğ°Ò³Ğ¾</h2>
            <div style="font-size:.8rem;color:var(--text-muted)" id="weekly-range"></div>
        </div>

        <!-- 9. Smart Alerts -->
        <div class="alerts-grid" id="alerts-grid" style="margin-bottom:1.5rem">
            <div class="alert-card error"><h4>ğŸš¨ Ğ¤Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚Ò³Ğ¾Ğ¸ Ñ…Ğ°Ğ²Ñ„Ğ½Ğ¾Ğº</h4><ul id="al-danger"><li>Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</li></ul></div>
            <div class="alert-card warning"><h4>âš  ĞŸĞ°ÑÑ‚ÑˆĞ°Ğ²Ğ¸Ğ¸ ÑĞºĞ±Ğ¾Ñ€Ğ°</h4><ul id="al-drop"><li>Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</li></ul></div>
            <div class="alert-card success"><h4>ğŸ† Faculty of the week</h4><div id="al-best">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</div></div>
        </div>

        <!-- 8. TOP 5 -->
        <div class="top-grid" id="top-grid">
            <div class="top-card best">
                <h3>ğŸ† Ğ¢ĞĞŸ 5 â€” Ğ±ĞµÒ³Ñ‚Ğ°Ñ€Ğ¸Ğ½</h3>
                <p class="subtitle">ĞšĞ°Ğ¼Ñ‚Ğ°Ñ€Ğ¸Ğ½ NB % (â‰¥50 Ğ´Ğ¾Ğ½Ğ¸ÑˆÒ·Ó¯)</p>
                <ul id="top-best"></ul>
            </div>
            <div class="top-card worst">
                <h3>âš ï¸ Ğ¢ĞĞŸ 5 â€” Ğ±Ğ°Ğ´Ñ‚Ğ°Ñ€Ğ¸Ğ½</h3>
                <p class="subtitle">Ğ—Ğ¸Ñ‘Ğ´Ñ‚Ğ°Ñ€Ğ¸Ğ½ NB % (â‰¥50 Ğ´Ğ¾Ğ½Ğ¸ÑˆÒ·Ó¯)</p>
                <ul id="top-worst"></ul>
            </div>
        </div>

        <!-- All faculty stats table -->
        <div class="sec-header" style="margin-top:1.5rem">
            <h2>ğŸ“‹ Ò²Ğ°Ğ¼Ğ° Ñ„Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚Ò³Ğ¾ (Ò³Ğ°Ñ„Ñ‚Ğ°Ğ²Ó£)</h2>
        </div>
        <div class="table-wrap">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ğ¤Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚</th>
                        <th>Ğ”Ğ¾Ğ½Ğ¸ÑˆÒ·Ó¯Ñ‘Ğ½</th>
                        <th>NB% (Ò·Ğ¾Ñ€Ó£)</th>
                        <th>NB% (Ğ³ÑƒĞ·Ğ°ÑˆÑ‚Ğ°)</th>
                        <th>Att% (Ò·Ğ¾Ñ€Ó£)</th>
                        <th>Att% (Ğ³ÑƒĞ·Ğ°ÑˆÑ‚Ğ°)</th>
                        <th>Risk</th>
                    </tr>
                </thead>
                <tbody id="weekly-tbody"><tr class="loading-row"><td colspan="7">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SECTION: STUDENTS (14)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section" id="sec-students">
        <div class="sec-header">
            <h2>ğŸ‘¨â€ğŸ“ Ğ ĞµĞµÑÑ‚Ñ€Ğ¸ Ğ´Ğ¾Ğ½Ğ¸ÑˆÒ·Ó¯Ñ‘Ğ½</h2>
            <span id="stu-total" style="font-size:.85rem;color:var(--text-sub)"></span>
        </div>

        <!-- 14.1 Filter pills -->
        <div style="background:var(--bg-card);border-radius:var(--radius-lg);padding:1rem;box-shadow:var(--shadow);border:1px solid var(--border);margin-bottom:1rem">
            <div style="font-size:.82rem;color:var(--text-sub);margin-bottom:.5rem;font-weight:600">ğŸ› Ğ¤Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚:</div>
            <div class="pill-group" id="pills-faculty"></div>
            <div style="font-size:.82rem;color:var(--text-sub);margin:.6rem 0 .4rem;font-weight:600">ğŸ“š ĞšÑƒÑ€Ñ:</div>
            <div class="pill-group" id="pills-course"></div>
            <div style="font-size:.82rem;color:var(--text-sub);margin:.6rem 0 .4rem;font-weight:600">ğŸ• ĞĞ°Ğ²Ğ±Ğ°Ñ‚:</div>
            <div class="pill-group" id="pills-shift"></div>
            <div style="font-size:.82rem;color:var(--text-sub);margin:.6rem 0 .4rem;font-weight:600">ğŸ“ Ò¶Ğ¾Ğ¸ Ñ‚Ğ°Ğ²Ğ°Ğ»Ğ»ÑƒĞ´:</div>
            <div class="pill-group" id="pills-bp"></div>
            <button class="btn btn-outline btn-sm" onclick="resetStudentFilters()" style="margin-top:.5rem">âœ• Ğ¢Ğ¾Ğ·Ğ°ĞºÑƒĞ½Ó£</button>
        </div>

        <div class="table-wrap">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Ğ¤Ğ˜Ğ</th>
                        <th>ĞšĞ¾Ğ´</th>
                        <th>Ğ“ÑƒÑ€Ó¯Ò³</th>
                        <th>ĞšÑƒÑ€Ñ</th>
                        <th>Ğ¤Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚</th>
                        <th>ĞĞ°Ğ²Ğ±Ğ°Ñ‚</th>
                        <th>Ò¶Ğ¾Ğ¸ Ñ‚Ğ°Ğ²Ğ°Ğ»Ğ»ÑƒĞ´</th>
                    </tr>
                </thead>
                <tbody id="stu-tbody"><tr class="loading-row"><td colspan="8">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</td></tr></tbody>
            </table>
        </div>
        <div class="pagination" id="stu-pagination"></div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SECTION: STAFF (10)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section" id="sec-staff">
        <div class="sec-header">
            <h2>ğŸ‘¨â€ğŸ« ĞšĞ¾Ñ€Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ½</h2>
            <div class="filters">
                <input type="text" id="staff-search" placeholder="Ò¶ÑƒÑÑ‚ÑƒÒ·Ó¯..." oninput="debounceStaff()">
                <select id="staff-faculty" onchange="loadStaff()">
                    <option value="">Ò²Ğ°Ğ¼Ğ° Ñ„Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚Ò³Ğ¾</option>
                </select>
                <select id="staff-role" onchange="loadStaff()">
                    <option value="">Ò²Ğ°Ğ¼Ğ° Ğ½Ğ°Ò›ÑˆÒ³Ğ¾</option>
                    <option value="DEAN">Ğ”ĞµĞºĞ°Ğ½</option>
                    <option value="VICE_DEAN">Ğ—Ğ°Ğ¼Ğ´ĞµĞºĞ°Ğ½</option>
                    <option value="CURATOR">ĞšÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€</option>
                    <option value="RECTOR">Ğ ĞµĞºÑ‚Ğ¾Ñ€</option>
                </select>
            </div>
        </div>
        <div class="table-wrap">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Ğ¤Ğ˜Ğ</th>
                        <th>ĞĞ°Ò›Ñˆ</th>
                        <th>Ğ¤Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚</th>
                        <th>Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</th>
                        <th>Gmail</th>
                        <th>ğŸ‘</th>
                    </tr>
                </thead>
                <tbody id="staff-tbody"><tr class="loading-row"><td colspan="6">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</td></tr></tbody>
            </table>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         SECTION: PROFILE (3)
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="section" id="sec-profile">
        <div class="sec-header"><h2>ğŸ‘¤ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸ Ñ€ĞµĞºÑ‚Ğ¾Ñ€</h2></div>
        <div style="background:var(--bg-card);border-radius:var(--radius-lg);padding:1.5rem;box-shadow:var(--shadow);border:1px solid var(--border);max-width:600px">
            <div style="display:grid;gap:.75rem">
                <div>
                    <label style="font-size:.82rem;color:var(--text-sub);font-weight:600">ĞĞ¾Ğ¼Ñƒ Ğ½Ğ°ÑĞ°Ğ±</label>
                    <input type="text" id="p-fullname" class="filters" style="width:100%;margin-top:.3rem">
                </div>
                <div>
                    <label style="font-size:.82rem;color:var(--text-sub);font-weight:600">Ğ¡Ğ¾Ğ»Ğ¸ Ñ‚Ğ°Ğ²Ğ°Ğ»Ğ»ÑƒĞ´</label>
                    <input type="number" id="p-birthyear" class="filters" style="width:100%;margin-top:.3rem">
                </div>
                <div>
                    <label style="font-size:.82rem;color:var(--text-sub);font-weight:600">Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½</label>
                    <input type="text" id="p-phone" class="filters" style="width:100%;margin-top:.3rem">
                </div>
                <div>
                    <label style="font-size:.82rem;color:var(--text-sub);font-weight:600">Gmail</label>
                    <input type="email" id="p-gmail" class="filters" style="width:100%;margin-top:.3rem">
                </div>
                <div>
                    <label style="font-size:.82rem;color:var(--text-sub);font-weight:600">Ğ£Ğ½Ğ²Ğ¾Ğ½Ğ¸ Ğ¸Ğ»Ğ¼Ó£</label>
                    <input type="text" id="p-title" class="filters" style="width:100%;margin-top:.3rem">
                </div>
                <div>
                    <label style="font-size:.82rem;color:var(--text-sub);font-weight:600">Ğ‘Ğ¸Ğ¾</label>
                    <textarea id="p-bio" style="width:100%;padding:.5rem .75rem;border:1.5px solid var(--border);border-radius:var(--radius);font-size:.875rem;resize:vertical;min-height:80px;margin-top:.3rem"></textarea>
                </div>
                <div style="display:flex;gap:.5rem">
                    <button class="btn btn-primary" onclick="saveProfile()">ğŸ’¾ Ğ¡Ğ°Ğ±Ñ‚ ĞºĞ°Ñ€Ğ´Ğ°Ğ½</button>
                    <button class="btn btn-outline" onclick="loadProfile()">â†º Ğ‘ĞµĞºĞ¾Ñ€ ĞºĞ°Ñ€Ğ´Ğ°Ğ½</button>
                </div>
                <div id="profile-msg" style="font-size:.85rem;margin-top:.25rem"></div>
            </div>
        </div>
        <div style="margin-top:1.5rem;max-width:600px">
            <a href="/rector/change-password" class="btn btn-secondary">ğŸ”‘ Ğ˜Ğ²Ğ°Ğ· ĞºĞ°Ñ€Ğ´Ğ°Ğ½Ğ¸ Ğ¿Ğ°Ñ€Ğ¾Ğ»</a>
        </div>
    </div>

</main>

<!-- â•â•â• MODAL: Faculty Profile â•â•â• -->
<div class="modal" id="modal-fac">
    <div class="modal-box">
        <div class="modal-head">
            <h3>ğŸ› ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸ Ñ„Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚</h3>
            <button class="close-btn" onclick="closeModal('modal-fac')">Ã—</button>
        </div>
        <div class="modal-body" id="modal-fac-body"><p style="color:var(--text-muted)">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</p></div>
        <div class="modal-foot">
            <button class="btn btn-secondary btn-sm" onclick="closeModal('modal-fac')">ĞŸÓ¯ÑˆĞ¸Ğ´Ğ°Ğ½</button>
        </div>
    </div>
</div>

<!-- â•â•â• MODAL: Group Profile â•â•â• -->
<div class="modal" id="modal-grp">
    <div class="modal-box">
        <div class="modal-head">
            <h3>ğŸ“š ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸ Ğ³ÑƒÑ€Ó¯Ò³</h3>
            <button class="close-btn" onclick="closeModal('modal-grp')">Ã—</button>
        </div>
        <div class="modal-body" id="modal-grp-body"><p style="color:var(--text-muted)">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</p></div>
        <div class="modal-foot">
            <button class="btn btn-secondary btn-sm" onclick="closeModal('modal-grp')">ĞŸÓ¯ÑˆĞ¸Ğ´Ğ°Ğ½</button>
        </div>
    </div>
</div>

<!-- â•â•â• MODAL: User Profile â•â•â• -->
<div class="modal" id="modal-usr">
    <div class="modal-box">
        <div class="modal-head">
            <h3>ğŸ‘¤ ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»Ğ¸ ĞºĞ¾Ñ€Ğ±Ğ°Ñ€</h3>
            <button class="close-btn" onclick="closeModal('modal-usr')">Ã—</button>
        </div>
        <div class="modal-body" id="modal-usr-body"><p style="color:var(--text-muted)">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</p></div>
        <div class="modal-foot">
            <button class="btn btn-secondary btn-sm" onclick="closeModal('modal-usr')">ĞŸÓ¯ÑˆĞ¸Ğ´Ğ°Ğ½</button>
        </div>
    </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// GLOBALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const BASE = '/rector/api';
let lpw = 25;
let _staffDebounce = null;

// Student filters state
let stuFilters = { faculty_id: null, course_year: null, shift: null, birth_place: null };
let stuPage = 1;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showSection(name, el) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.querySelectorAll('.r-nav a').forEach(a => a.classList.remove('active'));
    const sec = document.getElementById('sec-' + name);
    if (sec) sec.classList.add('active');
    if (el) el.classList.add('active');

    // Lazy load
    if (name === 'dashboard')  loadDashboard();
    if (name === 'faculties')  loadFaculties();
    if (name === 'weekly')     loadWeekly();
    if (name === 'students')   { stuPage=1; loadStudents(); }
    if (name === 'staff')      loadStaff();
    if (name === 'profile')    loadProfile();
}

function getLpw() {
    const v = parseInt(document.getElementById('lpw-input').value);
    return (v && v > 0) ? v : 25;
}

function reloadAll() {
    lpw = getLpw();
    const active = document.querySelector('.r-nav a.active');
    const name = active ? active.getAttribute('onclick').match(/'(\w+)'/)?.[1] : 'dashboard';
    showSection(name || 'dashboard', active);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 4.1 / 4.2 / 4.3 â€” DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadDashboard() {
    lpw = getLpw();
    try {
        const r = await fetch(`${BASE}/dashboard?lpw=${lpw}`);
        const d = await r.json();

        set('s-fac',        d.total_faculties ?? 'â€”');
        set('s-fac-active', d.active_faculties ?? 'â€”');
        set('s-grp',        d.total_groups ?? 'â€”');
        set('s-grp-active', d.active_groups ?? 'â€”');
        set('s-stu',        d.total_students ?? 'â€”');
        set('s-staff',      d.total_staff ?? 'â€”');
        set('s-nb',         (d.nb_pct_this_week ?? 0) + '%');
        set('s-att',        (d.att_pct_this_week ?? 0) + '%');
        set('s-att-prev',   `Ò²Ğ°Ñ„Ñ‚Ğ°Ğ¸ Ğ³ÑƒĞ·Ğ°ÑˆÑ‚Ğ°: ${d.att_pct_prev_week ?? 0}%`);

        // 4.3 Dynamics
        const dyn = d.dynamics || {};
        const cls = dyn.color === 'green' ? 'dyn-up' : dyn.color === 'red' ? 'dyn-down' : 'dyn-flat';
        const el = document.getElementById('s-dyn');
        if (el) el.innerHTML = `<span class="${cls}">${dyn.symbol || 'â€”'} ${dyn.label || ''} ${dyn.diff ? '(' + dyn.diff + '%)' : ''}</span>`;

        // Week range
        if (d.week) {
            set('week-range', `ğŸ“… Ò²Ğ°Ñ„Ñ‚Ğ°Ğ¸ Ò·Ğ¾Ñ€Ó£: ${d.week.from} â€” ${d.week.to}`);
        }
    } catch (e) {
        console.error('Dashboard error:', e);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 5 / 5.1 / 6 â€” FACULTIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadFaculties() {
    lpw = getLpw();
    const riskCode = document.getElementById('f-risk')?.value || '';
    const attRange = document.getElementById('f-att')?.value || '';

    let url = `${BASE}/faculties?lpw=${lpw}`;
    if (riskCode) url += `&risk_code=${riskCode}`;
    if (attRange) {
        const [mn, mx] = attRange.split('-').map(Number);
        url += `&att_min=${mn}&att_max=${mx}`;
    }

    const tbody = document.getElementById('fac-tbody');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="10">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</td></tr>';

    try {
        const r = await fetch(url);
        const data = await r.json();
        if (!data.length) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="10">ĞœĞ°ÑŠĞ»ÑƒĞ¼Ğ¾Ñ‚ Ğ½ĞµÑÑ‚</td></tr>';
            return;
        }
        tbody.innerHTML = data.map(f => `
            <tr>
                <td><strong>${esc(f.name)}</strong><br><small style="color:var(--text-muted)">${esc(f.code)}</small></td>
                <td>${esc(f.dean?.full_name || 'â€”')}</td>
                <td>${esc(f.vice_dean?.full_name || 'â€”')}</td>
                <td>${f.active_groups}/${f.total_groups}</td>
                <td>${f.total_students}</td>
                <td>${f.total_staff}</td>
                <td><strong>${f.att_pct}%</strong></td>
                <td><strong>${f.nb_pct}%</strong></td>
                <td>${riskBadge(f.risk)}</td>
                <td><button class="btn btn-sm btn-primary" onclick="openFaculty(${f.id})">ğŸ‘</button></td>
            </tr>
        `).join('');
    } catch (e) {
        tbody.innerHTML = '<tr class="empty-row"><td colspan="10">Ğ¥Ğ°Ñ‚Ğ¾Ğ³Ó£</td></tr>';
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 8 / 9 â€” WEEKLY STATS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadWeekly() {
    lpw = getLpw();
    const url = `${BASE}/weekly-stats?lpw=${lpw}`;

    try {
        const r = await fetch(url);
        const d = await r.json();

        // Range
        if (d.week) set('weekly-range', `ğŸ“… ${d.week.from} â€” ${d.week.to}`);

        // 9 Alerts
        renderAlertList('al-danger', d.smart_alerts?.filter(a => a.type === 'dangerous'));
        renderAlertList('al-drop',   d.smart_alerts?.filter(a => a.type === 'sudden_drop'));

        const bestEl = document.getElementById('al-best');
        if (d.faculty_of_week) {
            bestEl.innerHTML = `<strong>${esc(d.faculty_of_week.name)}</strong><br>Att: ${d.faculty_of_week.att_pct}% | NB: ${d.faculty_of_week.nb_pct}%`;
        } else {
            bestEl.textContent = 'Ò²ĞµÒ· Ñ‡Ğ¸Ğ· Ğ½ĞµÑÑ‚ âœ“';
        }

        // 8 TOP 5
        renderTop('top-best',  d.top5_best,  false);
        renderTop('top-worst', d.top5_worst, true);

        // All stats table
        const tbody = document.getElementById('weekly-tbody');
        if (!d.all_faculty_stats?.length) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="7">ĞœĞ°ÑŠĞ»ÑƒĞ¼Ğ¾Ñ‚ Ğ½ĞµÑÑ‚</td></tr>';
            return;
        }
        tbody.innerHTML = d.all_faculty_stats.map(f => {
            const nbDiff = f.nb_pct - f.nb_pct_prev;
            const nbTrend = nbDiff > 0 ? '<span class="dyn-down">â–²</span>' : nbDiff < 0 ? '<span class="dyn-up">â–¼</span>' : 'â–';
            return `<tr>
                <td><strong>${esc(f.name)}</strong></td>
                <td>${f.student_count}</td>
                <td><strong>${f.nb_pct}%</strong> ${nbTrend}</td>
                <td>${f.nb_pct_prev}%</td>
                <td><strong>${f.att_pct}%</strong></td>
                <td>${f.att_pct_prev}%</td>
                <td>${riskBadge(f.risk)}</td>
            </tr>`;
        }).join('');

    } catch (e) {
        console.error('Weekly error:', e);
    }
}

function renderAlertList(elId, items) {
    const el = document.getElementById(elId);
    if (!el) return;
    if (!items?.length) { el.innerHTML = '<li>Ò²ĞµÒ· Ñ‡Ğ¸Ğ· Ğ½ĞµÑÑ‚ âœ“</li>'; return; }
    el.innerHTML = items.map(a => `<li>${esc(a.msg)}</li>`).join('');
}

function renderTop(elId, items, isWorst) {
    const el = document.getElementById(elId);
    if (!el) return;
    if (!items?.length) { el.innerHTML = '<li class="empty-row"><td colspan="2">ĞœĞ°ÑŠĞ»ÑƒĞ¼Ğ¾Ñ‚ Ğ½ĞµÑÑ‚</td></li>'; return; }
    el.innerHTML = items.map((f, i) => `
        <li>
            <span class="top-rank">${i+1}</span>
            <span class="top-name">${esc(f.name)}</span>
            <span class="top-val">${f.nb_pct}% NB</span>
        </li>
    `).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 14 â€” STUDENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStudents(page) {
    lpw = getLpw();
    if (page) stuPage = page;

    let url = `${BASE}/students?page=${stuPage}&limit=50`;
    if (stuFilters.faculty_id)  url += `&faculty_id=${stuFilters.faculty_id}`;
    if (stuFilters.course_year) url += `&course_year=${stuFilters.course_year}`;
    if (stuFilters.shift)       url += `&shift=${stuFilters.shift}`;
    if (stuFilters.birth_place) url += `&birth_place=${encodeURIComponent(stuFilters.birth_place)}`;

    const tbody = document.getElementById('stu-tbody');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="8">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</td></tr>';

    try {
        const r = await fetch(url);
        const d = await r.json();

        // Update filter pills (Ò³Ğ°Ğ¼ĞµÑˆĞ° Ğ½Ğ°Ğ²ÑĞ¾Ğ·Ó£)
        renderPills('pills-faculty', d.filters?.faculties || [], 'faculty_id', 'id', 'name');
        renderPills('pills-course',  d.filters?.courses   || [], 'course_year', 'year', v => `${v.year}-ĞºÑƒÑ€Ñ`);
        renderPills('pills-shift',   d.filters?.shifts    || [], 'shift', 'shift', 'label');
        renderPills('pills-bp',      d.filters?.birth_places || [], 'birth_place', 'value', 'value');

        set('stu-total', `Ò¶Ğ°Ğ¼ÑŠ: ${d.total} Ğ´Ğ¾Ğ½Ğ¸ÑˆÒ·Ó¯`);

        if (!d.items?.length) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="8">Ğ”Ğ¾Ğ½Ğ¸ÑˆÒ·Ó¯Ñ‘Ğ½ Ñ‘Ñ„Ñ‚ Ğ½Ğ°ÑˆÑƒĞ´Ğ°Ğ½Ğ´</td></tr>';
            renderPagination('stu-pagination', 0, stuPage, loadStudents);
            return;
        }

        const offset = (stuPage - 1) * 50;
        tbody.innerHTML = d.items.map((s, i) => `
            <tr>
                <td>${offset + i + 1}</td>
                <td><strong>${esc(s.full_name)}</strong></td>
                <td><code>${esc(s.student_code || 'â€”')}</code></td>
                <td>${esc(s.group_number || 'â€”')}</td>
                <td>${s.course_year ? s.course_year + '-ĞºÑƒÑ€Ñ' : 'â€”'}</td>
                <td>${esc(s.faculty_name || 'â€”')}</td>
                <td>${s.shift ? s.shift + '-Ğ½Ğ°Ğ²Ğ±Ğ°Ñ‚' : 'â€”'}</td>
                <td>${esc(s.birth_place || 'â€”')}</td>
            </tr>
        `).join('');

        renderPagination('stu-pagination', d.pages, stuPage, loadStudents);
    } catch (e) {
        tbody.innerHTML = '<tr class="empty-row"><td colspan="8">Ğ¥Ğ°Ñ‚Ğ¾Ğ³Ó£</td></tr>';
    }
}

function renderPills(elId, items, filterKey, valueKey, labelKey) {
    const el = document.getElementById(elId);
    if (!el) return;
    if (!items.length) { el.innerHTML = '<span style="font-size:.8rem;color:var(--text-muted)">â€”</span>'; return; }

    el.innerHTML = items.map(item => {
        const val   = typeof valueKey === 'function' ? valueKey(item) : item[valueKey];
        const label = typeof labelKey === 'function' ? labelKey(item) : item[labelKey];
        const cnt   = item.count !== undefined ? ` (${item.count})` : '';
        const isActive = stuFilters[filterKey] == val;
        return `<button class="pill ${isActive ? 'active' : ''}"
                    onclick="toggleFilter('${filterKey}', ${JSON.stringify(val)})">${esc(String(label))}${cnt}</button>`;
    }).join('');
}

function toggleFilter(key, val) {
    stuFilters[key] = stuFilters[key] == val ? null : val;
    stuPage = 1;
    loadStudents();
}

function resetStudentFilters() {
    stuFilters = { faculty_id: null, course_year: null, shift: null, birth_place: null };
    stuPage = 1;
    loadStudents();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 10 â€” STAFF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStaff() {
    const search    = document.getElementById('staff-search')?.value || '';
    const facultyId = document.getElementById('staff-faculty')?.value || '';
    const role      = document.getElementById('staff-role')?.value   || '';

    let url = `${BASE}/users?`;
    if (search.trim().length >= 2) url += `search=${encodeURIComponent(search.trim())}&`;
    if (facultyId) url += `faculty_id=${facultyId}&`;
    if (role)      url += `role=${role}&`;

    const tbody = document.getElementById('staff-tbody');
    tbody.innerHTML = '<tr class="loading-row"><td colspan="6">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</td></tr>';

    try {
        const r = await fetch(url);
        const data = await r.json();
        if (!data.length) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="6">ĞšĞ¾Ñ€Ğ¼Ğ°Ğ½Ğ´Ğ¾Ğ½ Ñ‘Ñ„Ñ‚ Ğ½Ğ°ÑˆÑƒĞ´Ğ°Ğ½Ğ´</td></tr>';
            return;
        }
        tbody.innerHTML = data.map(u => `
            <tr>
                <td><strong>${esc(u.full_name)}</strong></td>
                <td>${roleLabel(u.role)}</td>
                <td>${esc(u.faculty_name || 'â€”')}</td>
                <td>${esc(u.phone || 'â€”')}</td>
                <td>${esc(u.gmail || 'â€”')}</td>
                <td><button class="btn btn-sm btn-primary" onclick="openUser(${u.id})">ğŸ‘</button></td>
            </tr>
        `).join('');
    } catch (e) {
        tbody.innerHTML = '<tr class="empty-row"><td colspan="6">Ğ¥Ğ°Ñ‚Ğ¾Ğ³Ó£</td></tr>';
    }
}

function debounceStaff() {
    clearTimeout(_staffDebounce);
    _staffDebounce = setTimeout(loadStaff, 350);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// 3 â€” PROFILE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadProfile() {
    try {
        const r = await fetch(`${BASE}/profile`);
        const d = await r.json();
        setVal('p-fullname', d.full_name || '');
        setVal('p-birthyear', d.birth_year || '');
        setVal('p-phone', d.phone || '');
        setVal('p-gmail', d.gmail || '');
        setVal('p-title', d.academic_title || '');
        setVal('p-bio', d.bio || '');
        const msg = document.getElementById('profile-msg');
        if (msg) msg.textContent = '';
    } catch (e) { console.error('Profile load error:', e); }
}

async function saveProfile() {
    const payload = {
        full_name:       document.getElementById('p-fullname')?.value,
        birth_year:      parseInt(document.getElementById('p-birthyear')?.value) || null,
        phone:           document.getElementById('p-phone')?.value,
        gmail:           document.getElementById('p-gmail')?.value,
        academic_title:  document.getElementById('p-title')?.value,
        bio:             document.getElementById('p-bio')?.value,
    };
    try {
        const r = await fetch(`${BASE}/profile`, {
            method: 'PATCH',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify(payload),
        });
        const msg = document.getElementById('profile-msg');
        if (r.ok) {
            if (msg) { msg.style.color = 'var(--success)'; msg.textContent = 'âœ… ĞœÑƒĞ²Ğ°Ñ„Ñ„Ğ°Ò›Ğ¾Ğ½Ğ° ÑĞ°Ğ±Ñ‚ ÑˆÑƒĞ´'; }
        } else {
            if (msg) { msg.style.color = 'var(--danger)'; msg.textContent = 'âŒ Ğ¥Ğ°Ñ‚Ğ¾Ğ³Ó£ Ò³Ğ°Ğ½Ğ³Ğ¾Ğ¼Ğ¸ ÑĞ°Ğ±Ñ‚'; }
        }
    } catch (e) {
        console.error('Profile save error:', e);
    }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MODALS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function openFaculty(fid) {
    openModal('modal-fac');
    const body = document.getElementById('modal-fac-body');
    body.innerHTML = '<p style="color:var(--text-muted)">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</p>';
    try {
        const r = await fetch(`${BASE}/faculties/${fid}?lpw=${getLpw()}`);
        const d = await r.json();
        body.innerHTML = `
            <div class="profile-info">
                <h3>${esc(d.name)} <small style="color:var(--text-muted)">(${esc(d.code)})</small></h3>
                <p><strong>Ğ”ĞµĞºĞ°Ğ½:</strong> ${esc(d.dean?.full_name || 'â€”')}</p>
                <p><strong>Ğ—Ğ°Ğ¼Ğ´ĞµĞºĞ°Ğ½:</strong> ${esc(d.vice_dean?.full_name || 'â€”')}</p>
                <p><strong>Ğ“ÑƒÑ€Ó¯Ò³Ò³Ğ¾:</strong> ${d.total_groups}</p>
                <p><strong>Ğ”Ğ¾Ğ½Ğ¸ÑˆÒ·Ó¯Ñ‘Ğ½:</strong> ${d.total_students}</p>
                <p><strong>Att%:</strong> ${d.att_pct}%</p>
                <p><strong>NB%:</strong> ${d.nb_pct}%</p>
                <p><strong>Risk:</strong> ${riskBadge(d.risk)}</p>
            </div>
            <button class="btn btn-primary btn-sm" onclick="openFacultyGroups(${fid})">ğŸ“š Ğ“ÑƒÑ€Ó¯Ò³Ò³Ğ¾</button>
        `;
    } catch {
        body.innerHTML = '<p style="color:var(--danger)">Ğ¥Ğ°Ñ‚Ğ¾Ğ³Ó£</p>';
    }
}

async function openFacultyGroups(fid) {
    const body = document.getElementById('modal-fac-body');
    body.innerHTML = '<p style="color:var(--text-muted)">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</p>';
    try {
        const r = await fetch(`${BASE}/faculties/${fid}/groups?lpw=${getLpw()}`);
        const data = await r.json();
        if (!data.length) { body.innerHTML = '<p style="color:var(--text-muted)">Ğ“ÑƒÑ€Ó¯Ò³Ò³Ğ¾ Ğ½ĞµÑÑ‚</p>'; return; }
        body.innerHTML = `
            <h4 style="margin-bottom:.75rem">Ğ“ÑƒÑ€Ó¯Ò³Ò³Ğ¾Ğ¸ Ñ„Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚</h4>
            <div style="overflow-y:auto;max-height:420px">
            <table class="data-table">
                <thead><tr><th>Ğ“ÑƒÑ€Ó¯Ò³</th><th>ĞšÑƒÑ€Ñ</th><th>ĞĞ°Ğ²Ğ±Ğ°Ñ‚</th><th>ĞšÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€</th><th>Ğ”Ğ¾Ğ½Ğ¸ÑˆÒ·Ó¯Ñ‘Ğ½</th><th>Att%</th><th>NB%</th><th>ğŸ‘</th></tr></thead>
                <tbody>
                    ${data.map(g => `
                        <tr>
                            <td><strong>${esc(g.number)}</strong></td>
                            <td>${g.course_year || 'â€”'}</td>
                            <td>${esc(g.shift_name)}</td>
                            <td>${esc(g.curator?.full_name || 'â€”')}</td>
                            <td>${g.student_count}</td>
                            <td>${g.att_pct}%</td>
                            <td>${g.nb_pct}%</td>
                            <td><button class="btn btn-sm btn-outline" onclick="openGroup(${g.id})">ğŸ‘</button></td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>
            </div>
            <button class="btn btn-secondary btn-sm" style="margin-top:.75rem" onclick="openFaculty(${fid})">â† Ğ‘Ğ¾Ğ·Ğ³Ğ°ÑˆÑ‚</button>
        `;
    } catch {
        body.innerHTML = '<p style="color:var(--danger)">Ğ¥Ğ°Ñ‚Ğ¾Ğ³Ó£</p>';
    }
}

async function openGroup(gid) {
    openModal('modal-grp');
    const body = document.getElementById('modal-grp-body');
    body.innerHTML = '<p style="color:var(--text-muted)">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</p>';
    try {
        const r = await fetch(`${BASE}/groups/${gid}?lpw=${getLpw()}`);
        const d = await r.json();
        body.innerHTML = `
            <div class="profile-info">
                <h3>Ğ“ÑƒÑ€Ó¯Ò³ ${esc(d.number)} <small style="color:var(--text-muted)">(${esc(d.shift_name)})</small></h3>
                <p><strong>ĞšÑƒÑ€Ñ:</strong> ${d.course_year || 'â€”'}</p>
                <p><strong>ĞšÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€:</strong> ${esc(d.curator?.full_name || 'â€”')}</p>
                <p><strong>Ğ”Ğ¾Ğ½Ğ¸ÑˆÒ·Ó¯Ñ‘Ğ½:</strong> ${d.student_count}</p>
                <p><strong>Att%:</strong> ${d.att_pct}%</p>
                <p><strong>NB%:</strong> ${d.nb_pct}%</p>
            </div>
            <h4 style="margin:.75rem 0 .4rem">Ğ¤Ğ˜Ğ Ğ´Ğ¾Ğ½Ğ¸ÑˆÒ·Ó¯Ñ‘Ğ½ (read-only):</h4>
            <div style="max-height:300px;overflow-y:auto">
            <table class="data-table">
                <thead><tr><th>#</th><th>Ğ¤Ğ˜Ğ</th><th>ĞšĞ¾Ğ´</th></tr></thead>
                <tbody>
                    ${(d.students || []).map((s, i) => `
                        <tr><td>${i+1}</td><td>${esc(s.full_name)}</td><td>${esc(s.student_code || 'â€”')}</td></tr>
                    `).join('') || '<tr class="empty-row"><td colspan="3">Ğ”Ğ¾Ğ½Ğ¸ÑˆÒ·Ó¯Ñ‘Ğ½ Ğ½ĞµÑÑ‚</td></tr>'}
                </tbody>
            </table>
            </div>
        `;
    } catch {
        body.innerHTML = '<p style="color:var(--danger)">Ğ¥Ğ°Ñ‚Ğ¾Ğ³Ó£</p>';
    }
}

async function openUser(uid) {
    openModal('modal-usr');
    const body = document.getElementById('modal-usr-body');
    body.innerHTML = '<p style="color:var(--text-muted)">Ğ‘Ğ¾Ñ€ ÑˆÑƒĞ´Ğ°Ğ½...</p>';
    try {
        const r = await fetch(`${BASE}/users/${uid}`);
        const d = await r.json();
        body.innerHTML = `
            <div class="profile-info">
                <h3>${esc(d.full_name)}</h3>
                <p><strong>ĞĞ°Ò›Ñˆ:</strong> ${roleLabel(d.role)}</p>
                <p><strong>Ğ¤Ğ°ĞºÑƒĞ»Ñ‚ĞµÑ‚:</strong> ${esc(d.faculty_name || 'â€”')}</p>
                <p><strong>Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½:</strong> ${esc(d.phone || 'â€”')}</p>
                <p><strong>Gmail:</strong> ${esc(d.gmail || 'â€”')}</p>
                <p><strong>Ğ¡Ğ¾Ğ»Ğ¸ Ñ‚Ğ°Ğ²Ğ°Ğ»Ğ»ÑƒĞ´:</strong> ${d.birth_year || 'â€”'}</p>
                <p><strong>Ğ£Ğ½Ğ²Ğ¾Ğ½Ğ¸ Ğ¸Ğ»Ğ¼Ó£:</strong> ${esc(d.academic_title || 'â€”')}</p>
                <p><strong>Ğ‘Ğ¸Ğ¾:</strong> ${esc(d.bio || 'â€”')}</p>
            </div>
        `;
    } catch {
        body.innerHTML = '<p style="color:var(--danger)">Ğ¥Ğ°Ñ‚Ğ¾Ğ³Ó£</p>';
    }
}

function openModal(id) {
    document.getElementById(id).classList.add('open');
}
function closeModal(id) {
    document.getElementById(id).classList.remove('open');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PAGINATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPagination(elId, pages, current, fn) {
    const el = document.getElementById(elId);
    if (!el) return;
    if (pages <= 1) { el.innerHTML = ''; return; }
    let html = '';
    for (let i = 1; i <= pages; i++) {
        html += `<button class="btn btn-sm ${i === current ? 'active' : ''}" onclick="${fn.name}(${i})">${i}</button>`;
    }
    el.innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function esc(s) {
    if (s === null || s === undefined) return '';
    return String(s)
        .replace(/&/g,'&amp;').replace(/</g,'&lt;')
        .replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
function set(id, val) {
    const el = document.getElementById(id);
    if (el) el.textContent = val;
}
function setVal(id, val) {
    const el = document.getElementById(id);
    if (el) el.value = val;
}
function riskBadge(risk) {
    if (!risk) return 'â€”';
    return `<span class="risk risk-${risk.code}">${risk.emoji} ${risk.label}</span>`;
}
function roleLabel(role) {
    const map = {DEAN:'Ğ”ĞµĞºĞ°Ğ½', VICE_DEAN:'Ğ—Ğ°Ğ¼Ğ´ĞµĞºĞ°Ğ½', CURATOR:'ĞšÑƒÑ€Ğ°Ñ‚Ğ¾Ñ€', RECTOR:'Ğ ĞµĞºÑ‚Ğ¾Ñ€'};
    return map[role] || role || 'â€”';
}

// Close modal on backdrop click
document.addEventListener('click', e => {
    if (e.target.classList.contains('modal')) closeModal(e.target.id);
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
document.addEventListener('DOMContentLoaded', async () => {
    // Load faculty options for staff filter
    try {
        const r = await fetch(`${BASE}/faculties?lpw=25`);
        const data = await r.json();
        const opts = data.map(f => `<option value="${f.id}">${esc(f.name)}</option>`).join('');
        const el = document.getElementById('staff-faculty');
        if (el) el.innerHTML += opts;
    } catch {}

    // Load initial section
    loadDashboard();
});
</script>
</body>
</html>