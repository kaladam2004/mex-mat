<!DOCTYPE html>
<html lang="tg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>–ö—É—Ä–∞—Ç–æ—Ä ‚Äî –°–∏—Å—Ç–µ–º–∞–∏ –ú–µ—Ö-–º–∞—Ç</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
:root{
--primary:#2563eb;--primary-dark:#1d4ed8;--primary-light:#dbeafe;--primary-xlight:#eff6ff;
--success:#059669;--success-light:#d1fae5;
--warning:#d97706;--warning-light:#fef3c7;
--danger:#dc2626;--danger-light:#fee2e2;
--purple:#7c3aed;--purple-light:#ede9fe;
--bg:#f0f4ff;--surface:#fff;--surface2:#f8faff;--border:#dde5f7;--border-light:#eef2fb;
--text:#0f172a;--text-2:#334155;--text-3:#64748b;--text-4:#94a3b8;
--sidebar-w:260px;--topbar-h:60px;
--radius:12px;--radius-sm:8px;--radius-lg:16px;
--shadow-sm:0 1px 4px rgba(37,99,235,.08);
--shadow:0 4px 16px rgba(37,99,235,.1);
--tr:all .2s cubic-bezier(.4,0,.2,1);
}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;display:flex;overflow-x:hidden}
/* ‚îÄ SIDEBAR ‚îÄ */
.sidebar{width:var(--sidebar-w);min-height:100vh;background:var(--surface);border-right:1.5px solid var(--border);display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:200;transition:transform .3s ease;overflow-y:auto}
.sl{padding:1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:.75rem;flex-shrink:0}
.sl-ico{width:40px;height:40px;border-radius:10px;overflow:hidden;flex-shrink:0;border:2px solid var(--border)}
.sl-ico img{width:100%;height:100%;object-fit:cover}
.sl-brand{font-size:.85rem;font-weight:800;color:var(--text)}
.sl-brand span{display:block;font-size:.72rem;font-weight:500;color:var(--text-3);margin-top:1px}
.su{padding:1rem 1.25rem;border-bottom:1px solid var(--border);flex-shrink:0}
.su-row{display:flex;align-items:center;gap:.75rem;margin-bottom:.5rem}
.su-av{width:42px;height:42px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--purple));display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:800;color:#fff;flex-shrink:0}
.su-name{font-size:.875rem;font-weight:700;color:var(--text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.su-sub{font-size:.72rem;color:var(--text-3);margin-top:.1rem}
.badge{display:inline-flex;align-items:center;font-size:.7rem;font-weight:600;padding:.2rem .6rem;border-radius:20px}
.badge-green{background:var(--success-light);color:var(--success)}
.snav{flex:1;padding:.625rem .75rem}
.nsec{font-size:.68rem;font-weight:700;color:var(--text-4);text-transform:uppercase;letter-spacing:.08em;padding:.75rem .75rem .35rem}
.ni{display:flex;align-items:center;gap:.625rem;padding:.65rem .875rem;border-radius:var(--radius-sm);font-size:.83rem;font-weight:600;color:var(--text-3);cursor:pointer;transition:var(--tr);text-decoration:none;border:none;background:none;width:100%;text-align:left;margin-bottom:1px}
.ni:hover{background:var(--primary-xlight);color:var(--primary)}
.ni.active{background:var(--primary-light);color:var(--primary);font-weight:700}
.ni svg{width:15px;height:15px;flex-shrink:0}
.sfoot{padding:.875rem .75rem;border-top:1px solid var(--border);flex-shrink:0;display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
.fbt{display:flex;align-items:center;justify-content:center;gap:.35rem;padding:.6rem .5rem;border-radius:var(--radius-sm);font-size:.75rem;font-weight:700;font-family:inherit;cursor:pointer;border:1.5px solid var(--border);background:var(--surface2);color:var(--text-2);text-decoration:none;transition:var(--tr)}
.fbt:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-xlight)}
.fbt.dng{color:var(--danger);border-color:var(--danger-light)}.fbt.dng:hover{background:var(--danger-light)}
.fbt svg{width:13px;height:13px}
/* ‚îÄ OVERLAY ‚îÄ */
.overlay{display:none;position:fixed;inset:0;background:rgba(15,23,42,.4);z-index:150;backdrop-filter:blur(2px)}
.overlay.show{display:block}
/* ‚îÄ MAIN ‚îÄ */
.main{margin-left:var(--sidebar-w);flex:1;display:flex;flex-direction:column;min-height:100vh;transition:margin .3s ease}
.topbar{height:var(--topbar-h);background:var(--surface);border-bottom:1.5px solid var(--border);display:flex;align-items:center;padding:0 1.5rem;gap:.875rem;position:sticky;top:0;z-index:100;box-shadow:var(--shadow-sm)}
.mnt{display:none;width:36px;height:36px;border:none;background:var(--bg);border-radius:var(--radius-sm);cursor:pointer;align-items:center;justify-content:center;color:var(--text-2);flex-shrink:0}
.mnt svg{width:18px;height:18px}
.tb-title{font-size:.95rem;font-weight:700;color:var(--text);flex:1}
.tb-right{display:flex;align-items:center;gap:.625rem}
.tb-info{font-size:.78rem;color:var(--text-3);background:var(--bg);padding:.35rem .75rem;border-radius:var(--radius-sm);border:1px solid var(--border);display:flex;align-items:center;gap:.4rem;white-space:nowrap}
.tb-info svg{width:12px;height:12px}
.content{padding:1.5rem;flex:1}
.section{display:none}
.section.active{display:block;animation:fi .2s ease}
@keyframes fi{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
/* ‚îÄ PAGE HEADER ‚îÄ */
.ph{margin-bottom:1.25rem;display:flex;align-items:flex-start;justify-content:space-between;gap:.875rem;flex-wrap:wrap}
.ph h1{font-size:1.2rem;font-weight:800;color:var(--text)}
.ph p{font-size:.82rem;color:var(--text-3);margin-top:.2rem}
.ph-a{display:flex;gap:.625rem;flex-wrap:wrap;flex-shrink:0}
/* ‚îÄ BUTTONS ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:.4rem;padding:.6rem 1.125rem;border:none;border-radius:var(--radius-sm);font-size:.83rem;font-weight:700;font-family:inherit;cursor:pointer;transition:var(--tr)}
.btn svg{width:14px;height:14px;flex-shrink:0}
.btn-primary{background:var(--primary);color:#fff}.btn-primary:hover{background:var(--primary-dark);transform:translateY(-1px);box-shadow:0 4px 12px rgba(37,99,235,.3)}
.btn-success{background:var(--success);color:#fff}.btn-success:hover{background:#047857;transform:translateY(-1px)}
.btn-warning{background:var(--warning);color:#fff}.btn-warning:hover{background:#b45309;transform:translateY(-1px)}
.btn-danger{background:var(--danger);color:#fff}.btn-danger:hover{background:#b91c1c}
.btn-purple{background:var(--purple);color:#fff}.btn-purple:hover{background:#6d28d9}
.btn-ghost{background:transparent;border:1.5px solid var(--border);color:var(--text-2)}.btn-ghost:hover{border-color:var(--primary);color:var(--primary);background:var(--primary-xlight)}
.btn-sm{padding:.45rem .875rem;font-size:.78rem}
.btn-xs{padding:.3rem .625rem;font-size:.72rem}
.btn:disabled{opacity:.6;cursor:not-allowed;transform:none!important}
/* ‚îÄ KPI CARDS ‚îÄ */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:.875rem;margin-bottom:1.25rem}
.kpi{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);padding:1.125rem;display:flex;align-items:center;justify-content:space-between;gap:.875rem;position:relative;overflow:hidden}
.kpi::before{content:'';position:absolute;top:0;left:0;right:0;height:3px}
.kpi.blue::before{background:var(--primary)}.kpi.green::before{background:var(--success)}.kpi.warn::before{background:var(--warning)}.kpi.danger::before{background:var(--danger)}.kpi.purple::before{background:var(--purple)}
.kpi-t p{font-size:.78rem;color:var(--text-3);font-weight:500}
.kpi-t .kv{font-size:1.875rem;font-weight:800;color:var(--text);font-family:'JetBrains Mono',monospace;line-height:1;margin-top:.2rem}
.kpi-i{width:46px;height:46px;border-radius:var(--radius);display:flex;align-items:center;justify-content:center;flex-shrink:0}
.kpi-i svg{width:20px;height:20px}
.kpi.blue .kpi-i{background:var(--primary-light);color:var(--primary)}
.kpi.green .kpi-i{background:var(--success-light);color:var(--success)}
.kpi.warn .kpi-i{background:var(--warning-light);color:var(--warning)}
.kpi.danger .kpi-i{background:var(--danger-light);color:var(--danger)}
.kpi.purple .kpi-i{background:var(--purple-light);color:var(--purple)}
/* ‚îÄ PANEL ‚îÄ */
.panel{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius);overflow:hidden;margin-bottom:1.125rem}
.panel-h{padding:.875rem 1.125rem;border-bottom:1px solid var(--border-light);display:flex;align-items:center;justify-content:space-between;gap:.875rem;flex-wrap:wrap}
.panel-h h3{font-size:.9rem;font-weight:700;color:var(--text);display:flex;align-items:center;gap:.5rem;margin:0}
.panel-h h3 svg{width:15px;height:15px;color:var(--primary);flex-shrink:0}
.panel-b{padding:1.125rem}
/* ‚îÄ WEEK STATUS STRIP ‚îÄ */
.week-strip{display:grid;grid-template-columns:repeat(6,1fr);gap:.5rem;margin-bottom:1.125rem}
.wday{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:.5rem .25rem;text-align:center;transition:var(--tr)}
.wday.today{border-color:var(--primary);background:var(--primary-xlight)}
.wday.done{border-color:var(--success);background:var(--success-light)}
.wday.partial{border-color:var(--warning);background:var(--warning-light)}
.wday-name{font-size:.65rem;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:.05em}
.wday-date{font-size:.78rem;font-weight:700;color:var(--text);font-family:'JetBrains Mono',monospace;margin:.15rem 0}
.wday-icon{font-size:.9rem}
/* ‚îÄ MODE TABS ‚îÄ */
.mode-tabs{display:flex;gap:.5rem;margin-bottom:1.125rem;background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:.3rem}
.mode-tab{flex:1;padding:.55rem .75rem;border-radius:6px;border:none;font-size:.82rem;font-weight:700;font-family:inherit;cursor:pointer;transition:var(--tr);color:var(--text-3);background:transparent;display:flex;align-items:center;justify-content:center;gap:.375rem}
.mode-tab.active{background:var(--surface);color:var(--primary);box-shadow:var(--shadow-sm)}
.mode-tab svg{width:14px;height:14px}
/* ‚îÄ JOURNAL TABLE ‚îÄ */
.jt-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch}
.jt{width:100%;border-collapse:collapse}
.jt th{padding:.625rem .5rem;font-size:.68rem;font-weight:700;color:var(--text-3);text-align:center;border-bottom:1.5px solid var(--border);background:var(--surface2);text-transform:uppercase;letter-spacing:.04em;white-space:nowrap}
.jt th.name-col{text-align:left;padding-left:.875rem;min-width:180px}
.jt td{padding:.45rem .35rem;border-bottom:1px solid var(--border-light);font-size:.8rem;vertical-align:middle;text-align:center}
.jt td.name-col{text-align:left;padding-left:.875rem}
.jt tr:last-child td{border-bottom:none}
.jt tr:hover td{background:var(--primary-xlight)}
.jt th.today-col{background:var(--primary-xlight);color:var(--primary)}
.jt td.today-col{background:var(--primary-xlight)}
.jt th.disabled-col{color:var(--text-4)}
.jt td.disabled-col input{opacity:.45;cursor:not-allowed}
.jcell{width:44px;height:34px;border:1.5px solid var(--border);border-radius:6px;text-align:center;font-size:.85rem;font-weight:600;font-family:'JetBrains Mono',monospace;transition:var(--tr);background:var(--bg);color:var(--text-2)}
.jcell:focus{border-color:var(--primary);outline:none;box-shadow:0 0 0 3px rgba(37,99,235,.1);background:#fff}
.jcell.present{background:var(--success-light);border-color:rgba(5,150,105,.4);color:var(--success)}
.jcell.absent{background:var(--danger-light);border-color:rgba(220,38,38,.4);color:var(--danger)}
.jcell.has-comment{box-shadow:0 0 0 2px var(--warning)}
/* ‚îÄ TABLE GENERAL ‚îÄ */
.tw{overflow-x:auto;-webkit-overflow-scrolling:touch}
table.tbl{width:100%;border-collapse:collapse;min-width:520px}
.tbl thead{background:var(--surface2)}
.tbl th{padding:.625rem .875rem;font-size:.72rem;font-weight:700;color:var(--text-3);text-align:left;border-bottom:1.5px solid var(--border);text-transform:uppercase;letter-spacing:.04em;white-space:nowrap}
.tbl td{padding:.75rem .875rem;border-bottom:1px solid var(--border-light);font-size:.83rem}
.tbl tr:last-child td{border-bottom:none}
.tbl tr:hover td{background:var(--primary-xlight)}
.tbl td.mono{font-family:'JetBrains Mono',monospace;font-size:.8rem}
/* ‚îÄ CHIPS ‚îÄ */
.chip{display:inline-flex;align-items:center;gap:.25rem;font-size:.72rem;font-weight:600;padding:.2rem .625rem;border-radius:20px}
.chip-green{background:var(--success-light);color:var(--success)}
.chip-red{background:var(--danger-light);color:var(--danger)}
.chip-warn{background:var(--warning-light);color:var(--warning)}
.chip-blue{background:var(--primary-light);color:var(--primary)}
.chip-purple{background:var(--purple-light);color:var(--purple)}
/* ‚îÄ FILTERS ‚îÄ */
.finp{padding:.65rem .875rem;background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);font-size:.83rem;color:var(--text);font-family:inherit;outline:none;transition:border-color .2s}
.finp:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(37,99,235,.1)}
.finp::placeholder{color:var(--text-4)}
.search-inp{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'/%3E%3Cpath d='m21 21-4.35-4.35'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:.75rem center;padding-left:2.5rem}
/* ‚îÄ MODAL ‚îÄ */
.modal-ov{display:none;position:fixed;inset:0;background:rgba(15,23,42,.5);z-index:9999;align-items:center;justify-content:center;padding:1rem;backdrop-filter:blur(4px)}
.modal-ov.show{display:flex}
.modal-box{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-lg);padding:1.5rem;width:100%;max-width:480px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow)}
.modal-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.25rem}
.modal-title h3{font-size:1rem;font-weight:800;color:var(--text)}
.mcl{width:30px;height:30px;border:none;background:var(--bg);border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--text-3);transition:var(--tr)}
.mcl:hover{background:var(--danger-light);color:var(--danger)}.mcl svg{width:14px;height:14px}
.fg{margin-bottom:.875rem}
.fg label{display:block;font-size:.75rem;font-weight:700;color:var(--text-2);margin-bottom:.375rem;text-transform:uppercase;letter-spacing:.05em}
.fg .finp{width:100%}
.frow2{display:grid;grid-template-columns:1fr 1fr;gap:.75rem}
.modal-actions{display:flex;gap:.625rem;margin-top:1.125rem}
.modal-actions .btn{flex:1;justify-content:center}
/* ‚îÄ NB BARS ‚îÄ */
.nb-bar{display:flex;align-items:flex-end;gap:.5rem;height:130px;padding:.5rem 0}
.nb-bi{flex:1;display:flex;flex-direction:column;align-items:center;gap:.3rem}
.nb-bf{width:100%;border-radius:4px 4px 0 0;transition:height .5s ease;min-height:3px}
.nb-bl{font-size:.65rem;color:var(--text-3);text-align:center;white-space:nowrap}
.nb-bv{font-size:.78rem;font-weight:700;color:var(--text)}
/* ‚îÄ SUPERVISOR CARD ‚îÄ */
.sup-card{background:var(--surface2);border:1.5px solid var(--border);border-radius:var(--radius);padding:1rem;display:flex;align-items:center;gap:.875rem;margin-bottom:.75rem}
.sup-av{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1rem;font-weight:800;color:#fff;flex-shrink:0}
.sup-av.dean{background:linear-gradient(135deg,var(--blue,#2563eb),#1d4ed8)}
.sup-av.vdean{background:linear-gradient(135deg,var(--purple),#6d28d9)}
.sup-av.rector{background:linear-gradient(135deg,var(--danger),#b91c1c)}
.sup-info{flex:1}
.sup-role{font-size:.72rem;font-weight:700;color:var(--text-3);text-transform:uppercase;letter-spacing:.06em}
.sup-name{font-size:.9rem;font-weight:700;color:var(--text);margin:.15rem 0}
.sup-contact{font-size:.78rem;color:var(--text-3)}
.sup-contact a{color:var(--primary);text-decoration:none}
/* ‚îÄ HISTORY TABLE ‚îÄ */
.hist-item{display:flex;align-items:center;gap:.75rem;padding:.6rem 0;border-bottom:1px solid var(--border-light)}
.hist-item:last-child{border-bottom:none}
.hist-date{font-family:'JetBrains Mono',monospace;font-size:.78rem;color:var(--text-3);min-width:80px}
.hist-nb{min-width:50px}
.hist-cmt{font-size:.78rem;color:var(--text-3);flex:1}
/* ‚îÄ GRID 2 ‚îÄ */
.g2{display:grid;grid-template-columns:1fr 1fr;gap:1.125rem;margin-bottom:1.125rem}
/* ‚îÄ LOADING / EMPTY ‚îÄ */
.loading{display:flex;align-items:center;justify-content:center;padding:3rem}
.spinner{width:28px;height:28px;border:3px solid var(--border);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.empty{text-align:center;padding:3rem 1.5rem;color:var(--text-3)}
.empty svg{width:40px;height:40px;margin:0 auto .75rem;display:block;opacity:.25}
.empty p{font-size:.875rem}
/* ‚îÄ TOAST ‚îÄ */
.toast-cnt{position:fixed;top:72px;right:1.25rem;z-index:99999;display:flex;flex-direction:column;gap:.5rem;pointer-events:none}
.toast{background:var(--surface);border:1.5px solid var(--border);border-radius:var(--radius-sm);padding:.7rem 1rem;font-size:.83rem;display:flex;align-items:center;gap:.625rem;box-shadow:var(--shadow);animation:tIn .25s ease;pointer-events:auto;font-weight:600;max-width:320px}
.toast svg{flex-shrink:0;width:15px;height:15px}
.toast.succ{border-color:rgba(5,150,105,.4)}.toast.succ svg{color:var(--success)}
.toast.err{border-color:rgba(220,38,38,.4)}.toast.err svg{color:var(--danger)}
.toast.warn{border-color:rgba(217,119,6,.4)}.toast.warn svg{color:var(--warning)}
@keyframes tIn{from{opacity:0;transform:translateX(15px)}to{opacity:1;transform:none}}
/* ‚îÄ SCROLLBAR ‚îÄ */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
/* ‚îÄ RESPONSIVE ‚îÄ */
@media(max-width:768px){
.sidebar{transform:translateX(-100%)}
.sidebar.open{transform:translateX(0);box-shadow:var(--shadow)}
.main{margin-left:0}
.mnt{display:inline-flex}
.content{padding:1rem}
.kpi-grid{grid-template-columns:repeat(2,1fr)}
.g2{grid-template-columns:1fr}
.frow2{grid-template-columns:1fr}
.tb-info{display:none}
.toast-cnt{left:.875rem;right:.875rem;top:auto;bottom:.875rem}
.jcell{width:36px;height:30px;font-size:.75rem}
.week-strip{grid-template-columns:repeat(3,1fr)}
}
@media(max-width:480px){
.content{padding:.875rem}
.kpi-grid{grid-template-columns:repeat(2,1fr)}
.ph-a{width:100%}
.ph-a .btn{flex:1;justify-content:center}
.mode-tabs{flex-direction:column}
}
</style>
</head>
<body>
<div class="overlay" id="overlay" onclick="closeSB()"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê SIDEBAR ‚ïê‚ïê‚ïê‚ïê -->
<aside class="sidebar" id="sidebar">
<div class="sl">
  <div class="sl-ico"><img src="/static/logo.jpg" alt="Logo" onerror="this.style.display='none'"></div>
  <div class="sl-brand">–ö—É—Ä–∞—Ç–æ—Ä<span>–°–∏—Å—Ç–µ–º–∞–∏ –ú–µ—Ö-–º–∞—Ç</span></div>
</div>
<div class="su">
  <div class="su-row">
    <div class="su-av">{{ user.full_name[0].upper() if user.full_name else 'K' }}</div>
    <div style="flex:1;min-width:0">
      <div class="su-name">{{ user.full_name or '–ö—É—Ä–∞—Ç–æ—Ä' }}</div>
      <div class="su-sub">{{ group.number if group else '–ì—É—Ä”Ø“≥ –Ω–µ—Å—Ç' }}</div>
    </div>
  </div>
  <span class="badge badge-green">‚úÖ –ö—É—Ä–∞—Ç–æ—Ä</span>
</div>
<nav class="snav">
  <div class="nsec">–ê—Å–æ—Å”£</div>
  <button class="ni active" onclick="showSec('journal',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="16" y1="2" x2="16" y2="6"/></svg>
    –ñ—É—Ä–Ω–∞–ª–∏ “≥–∞—Ñ—Ç–∞
  </button>
  <button class="ni" onclick="showSec('students',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/><path d="M6 12v5c3 3 9 3 12 0v-5"/></svg>
    –î–æ–Ω–∏—à“∑”Ø—ë–Ω
  </button>
  <button class="ni" onclick="showSec('nb-stats',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
    –û–º–æ—Ä–∏ –ù–ë
  </button>
  <div class="nsec">–ò—Ç—Ç–∏–ª–æ–æ—Ç</div>
  <button class="ni" onclick="showSec('supervisors',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 00-3-3.87M16 3.13a4 4 0 010 7.75"/></svg>
    –†–æ“≥–±–∞—Ä–æ–Ω
  </button>
  <button class="ni" onclick="showSec('profile',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
    –ü—Ä–æ—Ñ–∏–ª–∏ –º–∞–Ω
  </button>
</nav>
<div class="sfoot">
  <button class="fbt" onclick="showSec('change-pw',this)">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
    –ü–∞—Ä–æ–ª
  </button>
  <a href="/logout" class="fbt dng">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
    –•—É—Ä—É“∑
  </a>
</div>
</aside>

<!-- ‚ïê‚ïê‚ïê‚ïê MAIN ‚ïê‚ïê‚ïê‚ïê -->
<div class="main" id="mainWrap">
<header class="topbar">
  <button class="mnt" onclick="openSB()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
  </button>
  <div class="tb-title" id="page-title">üìã –ñ—É—Ä–Ω–∞–ª–∏ “≥–∞—Ñ—Ç–∞</div>
  <div class="tb-right">
    <div class="tb-info">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
      {{ faculty.name if faculty else '‚Äî' }} ¬∑ {{ group.number if group else '‚Äî' }}
    </div>
    <button class="btn btn-ghost btn-sm" id="refresh-btn" onclick="refreshSec()" title="–ù–∞–≤—Å–æ–∑”£">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" id="refresh-ico"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
    </button>
  </div>
</header>

<div class="content">

{% if error %}
<!-- ‚îÄ ERROR STATE ‚îÄ -->
<div class="empty" style="max-width:480px;margin:4rem auto">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
  <h2 style="font-size:1.25rem;font-weight:800;color:var(--danger);margin-bottom:.5rem">‚ö†Ô∏è –•–∞—Ç–æ–≥”£</h2>
  <p style="font-size:.9rem;color:var(--text-2);margin-bottom:1.5rem">{{ error }}</p>
  <a href="/dean/dashboard" class="btn btn-primary">–ë–∞ –î–µ–∫–∞–Ω –º—É—Ä–æ“∑–∏–∞—Ç –∫—É–Ω–µ–¥ ‚Üí</a>
</div>
{% else %}

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JOURNAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="section active" id="sec-journal">
<div class="ph">
  <div>
    <h1>üìã –ñ—É—Ä–Ω–∞–ª–∏ “≥–∞—Ñ—Ç–∞–∏–Ω–∞</h1>
    <p id="week-label">“≤–∞—Ñ—Ç–∞–∏ “∑–æ—Ä”£</p>
  </div>
  <div class="ph-a">
    <input type="date" class="finp btn-sm" id="week-picker" onchange="loadJournal()">
    <button class="btn btn-ghost btn-sm" onclick="loadJournal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="13" height="13"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 11-2.12-9.36L23 10"/></svg>
      –ù–∞–≤—Å–æ–∑”£
    </button>
  </div>
</div>

<!-- Mode Tabs -->
<div class="mode-tabs">
  <button class="mode-tab active" id="tab-daily" onclick="setMode('daily')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="14" height="14"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
    “≤–∞—Ä—Ä”Ø–∑–∞
  </button>
  <button class="mode-tab" id="tab-weekly" onclick="setMode('weekly')">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" width="14" height="14"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="3" y1="10" x2="21" y2="10"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="16" y1="2" x2="16" y2="6"/></svg>
    “≤–∞—Ñ—Ç–∞–≤”£
  </button>
</div>

<!-- Week Strip -->
<div class="week-strip" id="week-strip"></div>

<!-- Journal Panel -->
<div class="panel">
  <div class="panel-h">
    <h3>
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
      –ì—É—Ä”Ø“≥–∏ {{ group.number if group else '‚Äî' }}
      <span style="font-size:.72rem;font-weight:500;color:var(--text-3)">(0=“≥–æ–∑–∏—Ä ¬∑ 1-8=—Å–æ–∞—Ç“≥–æ–∏ “ì–∞–π–±)</span>
    </h3>
    <div style="display:flex;gap:.5rem;align-items:center;flex-wrap:wrap">
      <span id="mode-hint" style="font-size:.75rem;color:var(--text-3)">–ò–º—Ä”Ø–∑–∏ –∂—É—Ä–Ω–∞–ª—Ä–æ –ø—É—Ä –∫—É–Ω–µ–¥</span>
      <button class="btn btn-success btn-sm" id="save-btn" onclick="saveJournal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" width="13" height="13"><polyline points="20 6 9 17 4 12"/></svg>
        <span id="save-label">–°–∞–±—Ç–∏ –∏–º—Ä”Ø–∑</span>
      </button>
    </div>
  </div>
  <div class="jt-wrap">
    <table class="jt" id="jt">
      <thead><tr id="jt-head">
        <th class="name-col">–î–æ–Ω–∏—à“∑”Ø</th>
        <th>–î—à</th><th>–ï—Å</th><th>–ß–∞</th><th>–ü—à</th><th>“∂–º</th><th>–®–±</th>
        <th>–ù–ë ‚àë</th>
      </tr></thead>
      <tbody id="jt-body">
        <tr><td colspan="8"><div class="loading"><div class="spinner"></div></div></td></tr>
      </tbody>
    </table>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê STUDENTS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="section" id="sec-students">
<div class="ph">
  <div><h1>üéì –î–æ–Ω–∏—à“∑”Ø—ë–Ω</h1></div>
  <div class="ph-a">
    <button class="btn btn-primary btn-sm" onclick="openStudentModal()">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" width="13" height="13"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
      –î–æ–Ω–∏—à“∑”Ø–∏ –Ω–∞–≤
    </button>
  </div>
</div>
<div class="panel">
  <div class="panel-h">
    <input type="text" class="finp search-inp" id="stu-search" placeholder="“∂—É—Å—Ç—É“∑”Ø–∏ –Ω–æ–º..." oninput="debSearch()" style="max-width:280px;flex:1">
    <span id="stu-count" style="font-size:.78rem;color:var(--text-3)"></span>
  </div>
  <div class="tw">
    <table class="tbl">
      <thead><tr>
        <th>#</th><th>–ù–æ–º—É –Ω–∞—Å–∞–±</th><th>–ö–æ–¥</th><th>“∂–æ–∏ —Ç–∞–≤–∞–ª–ª—É–¥</th><th>–¢–µ–ª. –≤–æ–ª–∏–¥–∞–π–Ω</th><th>–ù–ë</th><th>–ê–º–∞–ª–∏—ë—Ç</th>
      </tr></thead>
      <tbody id="stu-tbody">
        <tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr>
      </tbody>
    </table>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê NB STATS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="section" id="sec-nb-stats">
<div class="ph"><div><h1>üìä –û–º–æ—Ä–∏ –ù–ë</h1><p>–¢–∞“õ—Å–∏–º–æ—Ç–∏ —Å–æ–∞—Ç“≥–æ–∏ “ì–∞–π–± –¥–∞—Ä –≥—É—Ä”Ø“≥</p></div></div>

<div class="kpi-grid">
  <div class="kpi green"><div class="kpi-t"><p>“≤–∞–º–∞–≥”£</p><div class="kv" id="nb-total">‚Äî</div></div><div class="kpi-i"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M22 10v6M2 10l10-5 10 5-10 5z"/></svg></div></div>
  <div class="kpi blue"><div class="kpi-t"><p>–ë–µ “ì–∞–π–± (0)</p><div class="kv" id="nb-zero">‚Äî</div></div><div class="kpi-i"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg></div></div>
  <div class="kpi warn"><div class="kpi-t"><p>1-34 —Å–æ–∞—Ç</p><div class="kv" id="nb-mid">‚Äî</div></div><div class="kpi-i"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/></svg></div></div>
  <div class="kpi danger"><div class="kpi-t"><p id="nb-high-label">35+ —Å–æ–∞—Ç</p><div class="kv" id="nb-high">‚Äî</div></div><div class="kpi-i"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg></div></div>
</div>

<div class="g2">
  <div class="panel">
    <div class="panel-h"><h3>üìä –¢–∞“õ—Å–∏–º–æ—Ç</h3></div>
    <div class="panel-b">
      <div class="nb-bar" id="nb-bar"><div class="loading"><div class="spinner"></div></div></div>
    </div>
  </div>
  <div class="panel">
    <div class="panel-h"><h3>üö® –•–∞–≤—Ñ–Ω–æ–∫–æ–Ω</h3></div>
    <div class="tw">
      <table class="tbl" id="nb-risk-tbl">
        <thead><tr><th>–ù–æ–º</th><th>–ù–ë</th><th>–¢–µ–ª. –≤–æ–ª–∏–¥–∞–π–Ω</th></tr></thead>
        <tbody><tr><td colspan="3"><div class="loading"><div class="spinner"></div></div></td></tr></tbody>
      </table>
    </div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê SUPERVISORS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="section" id="sec-supervisors">
<div class="ph"><div><h1>üëî –†–æ“≥–±–∞—Ä–æ–Ω</h1><p>–ú–∞—ä–º—É—Ä–∏—è—Ç–∏ —Ñ–∞–∫—É–ª—Ç–µ—Ç –≤–∞ –¥–æ–Ω–∏—à–≥–æ“≥</p></div></div>
<div id="sup-list"><div class="loading"><div class="spinner"></div></div></div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PROFILE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="section" id="sec-profile">
<div class="ph"><div><h1>üë§ –ü—Ä–æ—Ñ–∏–ª–∏ –º–∞–Ω</h1></div></div>
<div style="max-width:500px">
  <div class="panel">
    <div class="panel-h"><h3>–ú–∞—ä–ª—É–º–æ—Ç–∏ —à–∞—Ö—Å”£</h3></div>
    <div class="panel-b">
      <form id="profile-form" onsubmit="saveProfile(event)">
        <div class="fg"><label>–ù–æ–º—É –Ω–∞—Å–∞–± *</label><input class="finp" id="pf-name" required value="{{ user.full_name or '' }}"></div>
        <div class="frow2">
          <div class="fg"><label>Email</label><input type="email" class="finp" id="pf-email" value="{{ user.email or '' }}"></div>
          <div class="fg"><label>–¢–µ–ª–µ—Ñ–æ–Ω</label><input class="finp" id="pf-phone" value="{{ user.phone or '' }}" placeholder="+992..."></div>
        </div>
        <div class="frow2">
          <div class="fg"><label>–ö–∞—Ñ–µ–¥—Ä–∞</label><input class="finp" id="pf-dept" value="{{ user.department or '' }}"></div>
          <div class="fg"><label>–°–æ–ª–∏ —Ç–∞–≤–∞–ª–ª—É–¥</label><input type="number" class="finp" id="pf-birth" value="{{ user.birth_year or '' }}" min="1950" max="2000"></div>
        </div>
        <button type="submit" class="btn btn-primary" style="width:100%;justify-content:center">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" width="14" height="14"><polyline points="20 6 9 17 4 12"/></svg>
          –°–∞–±—Ç –∫–∞—Ä–¥–∞–Ω
        </button>
      </form>
    </div>
  </div>
</div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê CHANGE PASSWORD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div class="section" id="sec-change-pw">
<div class="ph"><div><h1>üîê –ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω–∏ –ø–∞—Ä–æ–ª</h1></div></div>
<div style="max-width:380px">
  <div class="panel">
    <div class="panel-b">
      <form action="/curator/change-password" method="post">
        <div class="fg">
          <label>–ü–∞—Ä–æ–ª–∏ –Ω–∞–≤ (6 —Ä–∞“õ–∞–º)</label>
          <input type="password" class="finp" name="new_password" maxlength="6" pattern="\d{6}" required
            placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="letter-spacing:6px;font-size:1.25rem;text-align:center;font-family:'JetBrains Mono',monospace">
          <p style="font-size:.72rem;color:var(--text-3);margin-top:.375rem">6 —Ä–∞“õ–∞–º, “≥–∞–º–∞ —è–∫—Ö–µ–ª–∞ –Ω–∞–±–æ—à–∞–Ω–¥</p>
        </div>
        {% if error %}
        <div style="background:var(--danger-light);border:1px solid rgba(220,38,38,.3);border-radius:var(--radius-sm);padding:.75rem;font-size:.83rem;color:var(--danger);margin-bottom:.875rem">‚ö†Ô∏è {{ error }}</div>
        {% endif %}
        <button type="submit" class="btn btn-warning" style="width:100%;justify-content:center">
          üîê –ò–≤–∞–∑ –∫–∞—Ä–¥–∞–Ω
        </button>
      </form>
    </div>
  </div>
</div>
</div>

{% endif %}

</div><!-- /content -->
</div><!-- /main -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MODALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<!-- Student Modal -->
<div class="modal-ov" id="student-modal">
<div class="modal-box">
  <div class="modal-title">
    <h3 id="stu-modal-title">üéì –î–æ–Ω–∏—à“∑”Ø–∏ –Ω–∞–≤</h3>
    <button class="mcl" onclick="closeModal('student-modal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
  </div>
  <form id="stu-form" onsubmit="saveStudent(event)">
    <input type="hidden" id="stu-id">
    <div class="fg"><label>–ù–æ–º—É –Ω–∞—Å–∞–± *</label><input class="finp" id="sf-name" required placeholder="–§–∞–º–∏–ª–∏—è –ù–æ–º –û—Ç–∞—Å–º"></div>
    <div class="frow2">
      <div class="fg"><label>–°–æ–ª–∏ —Ç–∞–≤–∞–ª–ª—É–¥</label><input type="number" class="finp" id="sf-byear" min="1990" max="2010" placeholder="2000"></div>
      <div class="fg"><label>–°–æ–ª–∏ —à—É—Ä—É—ä</label><input type="number" class="finp" id="sf-syear" min="2020" max="2030" placeholder="2023"></div>
    </div>
    <div class="frow2">
      <div class="fg"><label>“∂–æ–∏ —Ç–∞–≤–∞–ª–ª—É–¥</label><input class="finp" id="sf-bplace" placeholder="–í–∏–ª–æ—è—Ç, –Ω–æ“≥–∏—è"></div>
      <div class="fg"><label>“∂–æ–∏ –∑–∏—Å—Ç</label><input class="finp" id="sf-region" placeholder="–®–∞“≥—Ä / –Ω–æ“≥–∏—è"></div>
    </div>
    <div class="frow2">
      <div class="fg"><label>–¢–µ–ª. –¥–æ–Ω–∏—à“∑”Ø</label><input class="finp" id="sf-phone" placeholder="+992..."></div>
      <div class="fg"><label>–¢–µ–ª. –≤–æ–ª–∏–¥–∞–π–Ω</label><input class="finp" id="sf-pphone" placeholder="+992..."></div>
    </div>
    <div class="fg">
      <label>–ù–ë-–∏ –ø–µ—à–∏–Ω–∞ (—Å–æ–∞—Ç“≥–æ)</label>
      <input type="number" class="finp" id="sf-nb" value="0" min="0" max="500">
      <p style="font-size:.7rem;color:var(--text-3);margin-top:.25rem">–ê–≥–∞—Ä –¥–æ–Ω–∏—à“∑”Ø –∞–∑ –≥—É—Ä”Ø“≥–∏ –¥–∏–≥–∞—Ä –∫”Ø—á–∏–¥–∞ –±–æ—à–∞–¥, –ù–ë-–∏ –ø–µ—à–∏–Ω–∞—Ä–æ –≤–æ—Ä–∏–¥ –∫—É–Ω–µ–¥</p>
    </div>
    <div class="modal-actions">
      <button type="submit" class="btn btn-primary" id="stu-submit-btn">–°–∞–±—Ç</button>
      <button type="button" class="btn btn-ghost" onclick="closeModal('student-modal')">–ë–µ–∫–æ—Ä</button>
    </div>
  </form>
</div>
</div>

<!-- Student History Modal -->
<div class="modal-ov" id="hist-modal">
<div class="modal-box" style="max-width:560px">
  <div class="modal-title">
    <h3 id="hist-title">üìÖ –¢–∞—ä—Ä–∏—Ö–∏ “ì–∞–π–±</h3>
    <button class="mcl" onclick="closeModal('hist-modal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
  </div>
  <div id="hist-body"><div class="loading"><div class="spinner"></div></div></div>
</div>
</div>

<!-- Comment Modal -->
<div class="modal-ov" id="comment-modal">
<div class="modal-box" style="max-width:380px">
  <div class="modal-title">
    <h3>üìù –®–∞—Ä“≥</h3>
    <button class="mcl" onclick="closeModal('comment-modal')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
  </div>
  <div style="font-size:.82rem;color:var(--text-2);margin-bottom:.875rem" id="comment-info"></div>
  <div class="fg"><label>–®–∞—Ä“≥ / —Å–∞–±–∞–±</label><textarea class="finp" id="comment-text" rows="3" placeholder="–°–∞–±–∞–±–∏ “ì–∞–π–±..."></textarea></div>
  <input type="hidden" id="comment-sid"><input type="hidden" id="comment-date">
  <div class="modal-actions">
    <button class="btn btn-primary" onclick="saveComment()">–°–∞–±—Ç</button>
    <button class="btn btn-ghost" onclick="closeModal('comment-modal')">–ë–µ–∫–æ—Ä</button>
  </div>
</div>
</div>

<div class="toast-cnt" id="toasts"></div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê JAVASCRIPT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<script>
'use strict';

/* ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ */
let curSec = 'journal';
let journalData = null;   // loaded week data from API
let journalMode = 'daily'; // 'daily' | 'weekly'
let studentsCache = [];
let searchTO = null;

/* ‚îÄ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ‚îÄ */
function openSB() {
  document.getElementById('sidebar').classList.add('open');
  document.getElementById('overlay').classList.add('show');
}
function closeSB() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('overlay').classList.remove('show');
}

/* ‚îÄ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ */
const TITLES = {
  journal: 'üìã –ñ—É—Ä–Ω–∞–ª–∏ “≥–∞—Ñ—Ç–∞', students: 'üéì –î–æ–Ω–∏—à“∑”Ø—ë–Ω',
  'nb-stats': 'üìä –û–º–æ—Ä–∏ –ù–ë', supervisors: 'üëî –†–æ“≥–±–∞—Ä–æ–Ω',
  profile: 'üë§ –ü—Ä–æ—Ñ–∏–ª', 'change-pw': 'üîê –ü–∞—Ä–æ–ª'
};

function showSec(name, el) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.ni').forEach(n => n.classList.remove('active'));
  document.getElementById('sec-' + name).classList.add('active');
  if (el) el.classList.add('active');
  document.getElementById('page-title').textContent = TITLES[name] || name;
  curSec = name;
  closeSB();
  const loads = {
    journal: loadJournal, students: loadStudents,
    'nb-stats': loadNbStats, supervisors: loadSupervisors,
    profile: loadProfile
  };
  if (loads[name]) loads[name]();
}

function refreshSec() {
  const ico = document.getElementById('refresh-ico');
  ico.style.animation = 'spin .7s linear';
  setTimeout(() => ico.style.animation = '', 700);
  if (curSec === 'journal') loadJournal();
  else if (curSec === 'students') loadStudents();
  else if (curSec === 'nb-stats') loadNbStats();
  else if (curSec === 'supervisors') loadSupervisors();
}

/* ‚îÄ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ */
async function api(url, opts = {}) {
  const h = {};
  if (!(opts.body instanceof FormData)) h['Content-Type'] = 'application/json';
  const r = await fetch(url, { credentials: 'same-origin', ...opts, headers: { ...h, ...(opts.headers || {}) } });
  if (r.status === 401 || r.status === 403) { window.location.href = '/login'; throw new Error('–°–µ—Å—Å–∏—è —Ç–∞–º–æ–º —à—É–¥'); }
  if (!r.ok) {
    let m = '–•–∞—Ç–æ–≥”£';
    try { const e = await r.json(); m = e.detail || m; } catch (e) {}
    throw new Error(m);
  }
  return r.json();
}

/* ‚îÄ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ‚îÄ */
function toast(type, msg) {
  const c = document.getElementById('toasts');
  const el = document.createElement('div');
  el.className = `toast ${type}`;
  const icons = {
    succ: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="20 6 9 17 4 12"/></svg>`,
    err: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/></svg>`,
    warn: `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/></svg>`
  };
  el.innerHTML = `${icons[type] || icons.err}${msg}`;
  c.appendChild(el);
  setTimeout(() => el.remove(), 4000);
}

/* ‚îÄ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ */
function openModal(id) { document.getElementById(id).classList.add('show'); }
function closeModal(id) { document.getElementById(id).classList.remove('show'); }
document.querySelectorAll('.modal-ov').forEach(m => m.addEventListener('click', e => { if (e.target === m) m.classList.remove('show'); }));

/* ‚îÄ‚îÄ‚îÄ DATE HELPERS ‚îÄ‚îÄ‚îÄ */
function getMonday() {
  const d = new Date();
  const day = d.getDay() || 7;
  d.setDate(d.getDate() - day + 1);
  return d.toISOString().split('T')[0];
}
const DAY_NAMES = ['–î—à', '–ï—Å', '–ß–∞', '–ü—à', '“∂–º', '–®–±'];
const DAY_NAMES_FULL = ['–î—É—à–∞–Ω–±–µ', '–°–µ—à–∞–Ω–±–µ', '–ß–æ—Ä—à–∞–Ω–±–µ', '–ü–∞–Ω“∑—à–∞–Ω–±–µ', '“∂—É–º—ä–∞', '–®–∞–Ω–±–µ'];
function fmtDate(iso) {
  const d = new Date(iso + 'T00:00:00');
  return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit' });
}
function isToday(iso) {
  return iso === new Date().toISOString().split('T')[0];
}

/* ‚îÄ‚îÄ‚îÄ MODE ‚îÄ‚îÄ‚îÄ */
function setMode(mode) {
  journalMode = mode;
  document.getElementById('tab-daily').classList.toggle('active', mode === 'daily');
  document.getElementById('tab-weekly').classList.toggle('active', mode === 'weekly');
  if (mode === 'daily') {
    document.getElementById('mode-hint').textContent = '–ò–º—Ä”Ø–∑–∏ –∂—É—Ä–Ω–∞–ª—Ä–æ –ø—É—Ä –∫—É–Ω–µ–¥';
    document.getElementById('save-label').textContent = '–°–∞–±—Ç–∏ –∏–º—Ä”Ø–∑';
  } else {
    document.getElementById('mode-hint').textContent = '“≤–∞–º–∞–∏ —Ä”Ø–∑“≥–æ–∏ “≥–∞—Ñ—Ç–∞—Ä–æ –ø—É—Ä –∫—É–Ω–µ–¥';
    document.getElementById('save-label').textContent = '–°–∞–±—Ç–∏ “≥–∞—Ñ—Ç–∞';
  }
  if (journalData) renderJournal(journalData);
}

/* ‚îÄ‚îÄ‚îÄ JOURNAL: LOAD ‚îÄ‚îÄ‚îÄ */
async function loadJournal() {
  const ws = document.getElementById('week-picker');
  if (!ws.value) ws.value = getMonday();

  document.getElementById('jt-body').innerHTML = '<tr><td colspan="8"><div class="loading"><div class="spinner"></div></div></td></tr>';
  document.getElementById('week-strip').innerHTML = '';

  try {
    const d = await api(`/curator/api/journal/week?week_start=${ws.value}`);
    journalData = d;
    renderWeekStrip(d);
    renderJournal(d);

    // Update week label
    const mon = new Date(d.week_start + 'T00:00:00');
    const sat = new Date(d.week_end + 'T00:00:00');
    const fmt = (dt) => dt.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
    document.getElementById('week-label').textContent = `${fmt(mon)} ‚Äî ${fmt(sat)}${d.is_past_week ? ' (—û—Ç–≥–∞–Ω “≥–∞—Ñ—Ç–∞ ‚Äî —Ñ–∞“õ–∞—Ç –∫”Ø—Ä)' : ''}`;

    // Lock save button for past weeks
    const saveBtn = document.getElementById('save-btn');
    saveBtn.disabled = d.is_past_week;
    if (d.is_past_week) saveBtn.title = '–é—Ç–≥–∞–Ω “≥–∞—Ñ—Ç–∞—Ä–æ —Ç–∞“≥—Ä–∏—Ä –∫–∞—Ä–¥–∞–Ω –º—É–º–∫–∏–Ω –Ω–µ—Å—Ç';
  } catch (e) {
    document.getElementById('jt-body').innerHTML = `<tr><td colspan="8"><div class="empty"><p>${e.message}</p></div></td></tr>`;
    toast('err', e.message);
  }
}

/* ‚îÄ‚îÄ‚îÄ JOURNAL: WEEK STRIP ‚îÄ‚îÄ‚îÄ */
function renderWeekStrip(d) {
  const container = document.getElementById('week-strip');
  const days = d.days || [];
  const today = d.today || new Date().toISOString().split('T')[0];
  const status = d.daily_status || {};
  container.innerHTML = days.map((dayStr, i) => {
    const st = status[dayStr] || {};
    const isT = dayStr === today;
    const isDone = st.status === 'COMPLETED';
    const isPart = st.status === 'IN_PROGRESS';
    let cls = '';
    if (isT && !isDone && !isPart) cls = 'today';
    else if (isDone) cls = 'done';
    else if (isPart) cls = 'partial';
    const icon = isDone ? '‚úÖ' : isPart ? '‚ö†Ô∏è' : isT ? 'üìç' : '‚è≥';
    return `<div class="wday ${cls}" title="${DAY_NAMES_FULL[i]}">
      <div class="wday-name">${DAY_NAMES[i]}</div>
      <div class="wday-date">${fmtDate(dayStr)}</div>
      <div class="wday-icon">${icon}</div>
      ${st.total ? `<div style="font-size:.62rem;color:var(--text-3)">${st.marked||0}/${st.total}</div>` : ''}
    </div>`;
  }).join('');
}

/* ‚îÄ‚îÄ‚îÄ JOURNAL: RENDER TABLE ‚îÄ‚îÄ‚îÄ */
function renderJournal(d) {
  const students = Array.isArray(d.students) ? d.students : [];
  const days = Array.isArray(d.days) ? d.days : [];
  const today = d.today || new Date().toISOString().split('T')[0];
  const isPast = d.is_past_week;
  const nb_limit = d.nb_limit || 35;

  // Update header columns with today highlight
  const head = document.getElementById('jt-head');
  head.innerHTML = `<th class="name-col">–î–æ–Ω–∏—à“∑”Ø</th>` +
    days.map((dayStr, i) => {
      const isT = dayStr === today;
      const cls = isT ? ' today-col' : (journalMode === 'daily' && !isT ? ' disabled-col' : '');
      return `<th class="${cls}">${DAY_NAMES[i]}<br><span style="font-size:.65rem;font-weight:500">${fmtDate(dayStr)}</span></th>`;
    }).join('') +
    `<th>–ù–ë ‚àë</th>`;

  if (!students.length) {
    document.getElementById('jt-body').innerHTML = `<tr><td colspan="${days.length + 2}"><div class="empty"><p>–î–æ–Ω–∏—à“∑”Ø—ë–Ω —ë—Ñ—Ç –Ω–∞—à—É–¥–∞–Ω–¥</p></div></td></tr>`;
    return;
  }

  document.getElementById('jt-body').innerHTML = students.map(s => {
    const nbHigh = (s.total_absent_hours || 0) >= nb_limit;
    let row = `<tr>
      <td class="name-col">
        <div style="display:flex;align-items:center;gap:.5rem;flex-wrap:wrap">
          <strong style="font-size:.83rem">${s.full_name || '‚Äî'}</strong>
          <button class="btn btn-ghost btn-xs" onclick="showHistory(${s.id},'${(s.full_name||'').replace(/'/g,'')}')" title="–¢–∞—ä—Ä–∏—Ö–∏ “ì–∞–π–±" style="padding:.2rem .4rem">üìÖ</button>
        </div>
        <div style="font-size:.68rem;color:var(--text-4);font-family:'JetBrains Mono',monospace">${s.student_code || ''}</div>
      </td>`;

    days.forEach(dayStr => {
      const dayData = s.days && s.days[dayStr];
      const val = dayData !== null && dayData !== undefined && dayData.nb_hours !== undefined ? dayData.nb_hours : '';
      const comment = dayData?.comment || '';
      const isT = dayStr === today;
      const readonly = isPast || (journalMode === 'daily' && !isT);
      const cls = 'jcell' + (val === 0 ? ' present' : val > 0 ? ' absent' : '') + (comment ? ' has-comment' : '');
      const tdCls = isT ? 'today-col' : (readonly ? 'disabled-col' : '');

      row += `<td class="${tdCls}">
        <input type="number" class="${cls}"
          data-sid="${s.id}" data-date="${dayStr}"
          value="${val}" min="0" max="8"
          ${readonly ? 'readonly' : ''}
          onchange="onCellChange(this)"
          title="${comment || (readonly ? '–¢–∞“≥—Ä–∏—Ä –º—É–º–∫–∏–Ω –Ω–µ—Å—Ç' : '')}"
        >
        ${!readonly && comment ? `<button onclick="openComment(${s.id},'${dayStr}','${comment.replace(/'/g,'')}')" style="font-size:.6rem;color:var(--warning);border:none;background:none;cursor:pointer" title="–®–∞—Ä“≥">üí¨</button>` : ''}
        ${!readonly && !comment ? `<button onclick="openComment(${s.id},'${dayStr}','')" style="font-size:.6rem;color:var(--text-4);border:none;background:none;cursor:pointer;opacity:.5" title="–®–∞—Ä“≥ –≥—É–∑–æ—à—Ç–∞–Ω">üí¨</button>` : ''}
      </td>`;
    });

    row += `<td><span class="chip ${nbHigh ? 'chip-red' : (s.total_absent_hours||0) > 15 ? 'chip-warn' : 'chip-green'}">${s.total_absent_hours || 0}</span></td></tr>`;
    return row;
  }).join('');
}

/* ‚îÄ‚îÄ‚îÄ CELL CHANGE ‚îÄ‚îÄ‚îÄ */
function onCellChange(input) {
  const val = input.value === '' ? '' : (parseInt(input.value) || 0);
  input.classList.remove('present', 'absent');
  if (val === 0) input.classList.add('present');
  else if (val > 0) input.classList.add('absent');
}

/* ‚îÄ‚îÄ‚îÄ COMMENT ‚îÄ‚îÄ‚îÄ */
function openComment(sid, dayStr, existing) {
  document.getElementById('comment-sid').value = sid;
  document.getElementById('comment-date').value = dayStr;
  document.getElementById('comment-text').value = existing;
  document.getElementById('comment-info').textContent = `${dayStr} ¬∑ ${DAY_NAMES_FULL[new Date(dayStr+'T00:00:00').getDay()-1]||''}`;
  openModal('comment-modal');
}
async function saveComment() {
  const sid = parseInt(document.getElementById('comment-sid').value);
  const dayStr = document.getElementById('comment-date').value;
  const comment = document.getElementById('comment-text').value;
  const input = document.querySelector(`input[data-sid="${sid}"][data-date="${dayStr}"]`);
  const nb_hours = input ? (parseInt(input.value) || 0) : 0;
  try {
    await api('/curator/api/journal/mark', {
      method: 'POST',
      body: JSON.stringify({ student_id: sid, date: dayStr, nb_hours, comment })
    });
    toast('succ', '‚úÖ –®–∞—Ä“≥ —Å–∞–±—Ç —à—É–¥');
    closeModal('comment-modal');
    if (input) { input.classList.toggle('has-comment', !!comment); input.title = comment; }
  } catch (e) { toast('err', e.message); }
}

/* ‚îÄ‚îÄ‚îÄ SAVE JOURNAL ‚îÄ‚îÄ‚îÄ */
async function saveJournal() {
  if (!journalData) { toast('warn', '–ê–≤–≤–∞–ª –∂—É—Ä–Ω–∞–ª—Ä–æ –±–æ—Ä –∫—É–Ω–µ–¥'); return; }
  if (journalData.is_past_week) { toast('warn', '–é—Ç–≥–∞–Ω “≥–∞—Ñ—Ç–∞—Ä–æ —Ç–∞“≥—Ä–∏—Ä –∫–∞—Ä–¥–∞–Ω –º—É–º–∫–∏–Ω –Ω–µ—Å—Ç'); return; }

  const days = journalData.days || [];
  const today = journalData.today;
  const btn = document.getElementById('save-btn');
  btn.disabled = true;

  try {
    if (journalMode === 'daily') {
      // Mark today only via mark-day
      const records = [];
      document.querySelectorAll(`input[data-date="${today}"]`).forEach(inp => {
        const nb = parseInt(inp.value) || 0;
        records.push({ student_id: parseInt(inp.dataset.sid), nb_hours: nb, comment: '' });
      });
      if (!records.length) { toast('warn', '–ò–º—Ä”Ø–∑ –¥–∞—Ä—Å –Ω–µ—Å—Ç'); btn.disabled = false; return; }
      await api('/curator/api/journal/mark-day', {
        method: 'POST',
        body: JSON.stringify({ date: today, records })
      });
      toast('succ', `‚úÖ –ò–º—Ä”Ø–∑ (${today}) —Å–∞–±—Ç —à—É–¥`);
    } else {
      // Save full week
      const daysData = {};
      days.forEach(dayStr => {
        const recs = [];
        document.querySelectorAll(`input[data-date="${dayStr}"]`).forEach(inp => {
          recs.push({ student_id: parseInt(inp.dataset.sid), nb_hours: parseInt(inp.value) || 0, comment: '' });
        });
        daysData[dayStr] = recs;
      });
      await api('/curator/api/journal/save-week', {
        method: 'POST',
        body: JSON.stringify({ week_start: journalData.week_start, days: daysData })
      });
      toast('succ', '‚úÖ “≤–∞—Ñ—Ç–∞ —Å–∞–±—Ç —à—É–¥');
    }
    await loadJournal();
  } catch (e) {
    toast('err', e.message);
  } finally {
    btn.disabled = false;
  }
}

/* ‚îÄ‚îÄ‚îÄ STUDENT HISTORY ‚îÄ‚îÄ‚îÄ */
async function showHistory(id, name) {
  document.getElementById('hist-title').textContent = `üìÖ ${name}`;
  document.getElementById('hist-body').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  openModal('hist-modal');
  try {
    const d = await api(`/curator/api/journal/student/${id}`);
    const records = d.records || [];
    if (!records.length) {
      document.getElementById('hist-body').innerHTML = '<div class="empty"><p>“í–∞–π–± –Ω–µ—Å—Ç</p></div>';
      return;
    }
    document.getElementById('hist-body').innerHTML = `
      <div style="margin-bottom:.875rem;display:flex;gap:.5rem;align-items:center">
        <span style="font-size:.83rem;color:var(--text-3)">“≤–∞–º–∞–≥”£ –ù–ë:</span>
        <span class="chip ${(d.total_absent_hours||0)>=35?'chip-red':'chip-warn'}">${d.total_absent_hours||0} —Å–æ–∞—Ç</span>
      </div>
      ${records.map(r => `
        <div class="hist-item">
          <div class="hist-date">${r.date}</div>
          <div class="hist-nb"><span class="chip ${r.nb_hours>0?'chip-red':'chip-green'}">${r.nb_hours>0?r.nb_hours+'—Å':'‚úì'}</span></div>
          <div class="hist-cmt">${r.comment || (r.nb_hours>0?'<span style="color:var(--text-4)">—à–∞—Ä“≥ –Ω–µ—Å—Ç</span>':'')||''}</div>
        </div>
      `).join('')}
    `;
  } catch (e) {
    document.getElementById('hist-body').innerHTML = `<div class="empty"><p>${e.message}</p></div>`;
  }
}

/* ‚îÄ‚îÄ‚îÄ STUDENTS ‚îÄ‚îÄ‚îÄ */
function debSearch() {
  clearTimeout(searchTO);
  searchTO = setTimeout(loadStudents, 500);
}

async function loadStudents() {
  const search = document.getElementById('stu-search')?.value || '';
  const tbody = document.getElementById('stu-tbody');
  tbody.innerHTML = '<tr><td colspan="7"><div class="loading"><div class="spinner"></div></div></td></tr>';
  try {
    const d = await api(`/curator/api/students?search=${encodeURIComponent(search)}`);
    studentsCache = Array.isArray(d) ? d : [];
    document.getElementById('stu-count').textContent = `${studentsCache.length} –Ω–∞—Ñ–∞—Ä`;
    if (!studentsCache.length) {
      tbody.innerHTML = '<tr><td colspan="7"><div class="empty"><p>–î–æ–Ω–∏—à“∑”Ø —ë—Ñ—Ç –Ω–∞—à—É–¥</p></div></td></tr>';
      return;
    }
    const nb_limit = journalData?.nb_limit || 35;
    tbody.innerHTML = studentsCache.map((s, i) => `
      <tr>
        <td class="mono">${i + 1}</td>
        <td><strong>${s.full_name || '‚Äî'}</strong></td>
        <td class="mono">${s.student_code || '‚Äî'}</td>
        <td style="font-size:.78rem;color:var(--text-3)">${s.birth_place || '‚Äî'}</td>
        <td>${s.parent_phone || '‚Äî'}</td>
        <td><span class="chip ${(s.total_absent_hours||0) >= nb_limit ? 'chip-red' : (s.total_absent_hours||0)>15?'chip-warn':'chip-green'}">${s.total_absent_hours || 0}</span></td>
        <td style="display:flex;gap:.375rem;flex-wrap:wrap">
          <button class="btn btn-ghost btn-xs" onclick="showHistory(${s.id},'${(s.full_name||'').replace(/'/g,'')}')" title="–¢–∞—ä—Ä–∏—Ö–∏ “ì–∞–π–±">üìÖ</button>
          <button class="btn btn-primary btn-xs" onclick="editStudent(${s.id})">‚úèÔ∏è</button>
          <button class="btn btn-danger btn-xs" onclick="deleteStudent(${s.id})">üóë</button>
        </td>
      </tr>`).join('');
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="7"><div class="empty"><p>${e.message}</p></div></td></tr>`;
    toast('err', e.message);
  }
}

function openStudentModal(id) {
  document.getElementById('stu-id').value = id || '';
  const isNew = !id;
  document.getElementById('stu-modal-title').textContent = isNew ? 'üéì –î–æ–Ω–∏—à“∑”Ø–∏ –Ω–∞–≤' : '‚úèÔ∏è –¢–∞“≥—Ä–∏—Ä–∏ –¥–æ–Ω–∏—à“∑”Ø';
  document.getElementById('stu-submit-btn').textContent = isNew ? '–ò–ª–æ–≤–∞ –∫–∞—Ä–¥–∞–Ω' : '–°–∞–±—Ç –∫–∞—Ä–¥–∞–Ω';

  if (id) {
    api(`/curator/api/students/${id}`).then(s => {
      document.getElementById('sf-name').value = s.full_name || '';
      document.getElementById('sf-byear').value = s.birth_year || '';
      document.getElementById('sf-syear').value = s.study_start ? s.study_start.split('-')[0] : '';
      document.getElementById('sf-bplace').value = s.birth_place || '';
      document.getElementById('sf-region').value = s.region || '';
      document.getElementById('sf-phone').value = s.phone || '';
      document.getElementById('sf-pphone').value = s.parent_phone || '';
      document.getElementById('sf-nb').value = s.total_absent_hours || 0;
    }).catch(() => {});
  } else {
    ['sf-name','sf-byear','sf-syear','sf-bplace','sf-region','sf-phone','sf-pphone'].forEach(id => document.getElementById(id).value = '');
    document.getElementById('sf-nb').value = '0';
  }
  openModal('student-modal');
}

function editStudent(id) { openStudentModal(id); }

async function saveStudent(e) {
  e.preventDefault();
  const id = document.getElementById('stu-id').value;
  const isNew = !id;
  const fd = new FormData();
  fd.append('full_name', document.getElementById('sf-name').value);
  fd.append('birth_year', document.getElementById('sf-byear').value || '');
  const sy = document.getElementById('sf-syear').value;
  fd.append('study_start', sy ? `${sy}-09-01` : '');
  fd.append('birth_place', document.getElementById('sf-bplace').value || '');
  fd.append('region', document.getElementById('sf-region').value || '');
  fd.append('phone', document.getElementById('sf-phone').value || '');
  fd.append('parent_phone', document.getElementById('sf-pphone').value || '');
  fd.append('initial_nb_hours', document.getElementById('sf-nb').value || '0');

  const btn = document.getElementById('stu-submit-btn');
  btn.disabled = true;
  try {
    await api(isNew ? '/curator/api/students' : `/curator/api/students/${id}`, { method: isNew ? 'POST' : 'PUT', body: fd });
    toast('succ', isNew ? '‚úÖ –î–æ–Ω–∏—à“∑”Ø –∏–ª–æ–≤–∞ —à—É–¥' : '‚úÖ –°–∞–±—Ç —à—É–¥');
    closeModal('student-modal');
    loadStudents();
    if (curSec === 'journal') loadJournal();
  } catch (err) {
    toast('err', err.message);
  } finally {
    btn.disabled = false;
  }
}

async function deleteStudent(id) {
  if (!confirm('–î–æ–Ω–∏—à“∑”Ø –Ω–µ—Å—Ç –∫–∞—Ä–¥–∞ —à–∞–≤–∞–¥? –ò–Ω –∞–º–∞–ª –±–∞—Ä–Ω–∞–≥–∞—Ä–¥–∞–Ω–¥–∞–∞—Å—Ç.')) return;
  try {
    await api(`/curator/api/students/${id}`, { method: 'DELETE' });
    toast('succ', 'üóë –î–æ–Ω–∏—à“∑”Ø –Ω–µ—Å—Ç —à—É–¥');
    loadStudents();
    if (curSec === 'journal') loadJournal();
  } catch (e) {
    toast('err', e.message);
  }
}

/* ‚îÄ‚îÄ‚îÄ NB STATS ‚îÄ‚îÄ‚îÄ */
async function loadNbStats() {
  try {
    const d = await api('/curator/api/nb-stats');
    const ranges = d.ranges || {};
    const nb_limit = d.nb_limit || 35;

    document.getElementById('nb-total').textContent = d.total_students || 0;
    document.getElementById('nb-zero').textContent = ranges['0'] || 0;
    const mid = (ranges['1-10']||0) + (ranges['11-20']||0) + (ranges['21-34']||0);
    document.getElementById('nb-mid').textContent = mid;
    document.getElementById('nb-high').textContent = ranges['35+'] || 0;
    document.getElementById('nb-high-label').textContent = `${nb_limit}+ —Å–æ–∞—Ç`;

    // Bar chart
    const maxVal = Math.max(...Object.values(ranges), 1);
    const colors = ['#059669','#0891b2','#d97706','#f97316','#dc2626'];
    const labels = ['0','1-10','11-20','21-34','35+'];
    document.getElementById('nb-bar').innerHTML = labels.map((lbl, i) => {
      const val = ranges[lbl] || 0;
      const h = Math.max((val / maxVal) * 100, val > 0 ? 5 : 0);
      return `<div class="nb-bi">
        <div class="nb-bv">${val}</div>
        <div class="nb-bf" style="height:${h}%;background:${colors[i]}"></div>
        <div class="nb-bl">${lbl}</div>
      </div>`;
    }).join('');

    // High risk table
    const highRisk = Array.isArray(d.high_risk) ? d.high_risk : [];
    const ht = document.querySelector('#nb-risk-tbl tbody');
    ht.innerHTML = !highRisk.length
      ? '<tr><td colspan="3"><div class="empty"><p>üéâ –•–∞–≤—Ñ–Ω–æ–∫ –Ω–µ—Å—Ç</p></div></td></tr>'
      : highRisk.map(s => `<tr>
          <td><strong>${s.full_name||'‚Äî'}</strong></td>
          <td><span class="chip chip-red">${s.total_absent_hours||0}</span></td>
          <td>${s.parent_phone ? `<a href="tel:${s.parent_phone}" style="color:var(--primary)">${s.parent_phone}</a>` : '‚Äî'}</td>
        </tr>`).join('');
  } catch (e) {
    toast('err', e.message);
    document.getElementById('nb-bar').innerHTML = '<div class="empty"><p>–ú–∞—ä–ª—É–º–æ—Ç –Ω–µ—Å—Ç</p></div>';
  }
}

/* ‚îÄ‚îÄ‚îÄ SUPERVISORS ‚îÄ‚îÄ‚îÄ */
async function loadSupervisors() {
  const container = document.getElementById('sup-list');
  container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
  try {
    const d = await api('/curator/api/supervisors');
    const list = Array.isArray(d) ? d : [];
    if (!list.length) {
      container.innerHTML = '<div class="empty"><p>–†–æ“≥–±–∞—Ä–æ–Ω —ë—Ñ—Ç –Ω–∞—à—É–¥–∞–Ω–¥</p></div>';
      return;
    }
    const avMap = { '–î–µ–∫–∞–Ω': 'dean', '–ó–∞–º–¥–µ–∫–∞–Ω': 'vdean', '–†–µ–∫—Ç–æ—Ä': 'rector' };
    container.innerHTML = list.map(s => `
      <div class="sup-card">
        <div class="sup-av ${avMap[s.role]||'dean'}">${(s.full_name||'?')[0].toUpperCase()}</div>
        <div class="sup-info">
          <div class="sup-role">${s.role || '‚Äî'}</div>
          <div class="sup-name">${s.full_name || '‚Äî'}</div>
          <div class="sup-contact">
            ${s.email ? `<a href="mailto:${s.email}">üìß ${s.email}</a>` : ''}
            ${s.email && s.phone ? ' ¬∑ ' : ''}
            ${s.phone ? `<a href="tel:${s.phone}">üìû ${s.phone}</a>` : ''}
            ${!s.email && !s.phone ? '–ö–æ–Ω—Ç–∞–∫—Ç –Ω–µ—Å—Ç' : ''}
          </div>
        </div>
      </div>`).join('');
  } catch (e) {
    container.innerHTML = `<div class="empty"><p>${e.message}</p></div>`;
    toast('err', e.message);
  }
}

/* ‚îÄ‚îÄ‚îÄ PROFILE ‚îÄ‚îÄ‚îÄ */
async function loadProfile() {
  try {
    const d = await api('/curator/api/profile');
    document.getElementById('pf-name').value = d.full_name || '';
    document.getElementById('pf-email').value = d.email || '';
    document.getElementById('pf-phone').value = d.phone || '';
    document.getElementById('pf-dept').value = d.department || '';
    document.getElementById('pf-birth').value = d.birth_year || '';
    if (d.force_password_change) {
      toast('warn', '‚ö†Ô∏è –®—É–º–æ –±–æ—è–¥ –ø–∞—Ä–æ–ª—Ä–æ –∏–≤–∞–∑ –∫—É–Ω–µ–¥!');
      setTimeout(() => showSec('change-pw', null), 1500);
    }
  } catch (e) { toast('err', e.message); }
}

async function saveProfile(e) {
  e.preventDefault();
  const fd = new FormData();
  fd.append('full_name', document.getElementById('pf-name').value);
  fd.append('email', document.getElementById('pf-email').value || '');
  fd.append('phone', document.getElementById('pf-phone').value || '');
  fd.append('department', document.getElementById('pf-dept').value || '');
  fd.append('birth_year', document.getElementById('pf-birth').value || '');
  const btn = e.target.querySelector('button[type="submit"]');
  btn.disabled = true;
  try {
    await api('/curator/api/profile', { method: 'PUT', body: fd });
    toast('succ', '‚úÖ –ü—Ä–æ—Ñ–∏–ª —Å–∞–±—Ç —à—É–¥');
  } catch (err) {
    toast('err', err.message);
  } finally {
    btn.disabled = false;
  }
}

/* ‚îÄ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ */
document.addEventListener('DOMContentLoaded', () => {
  const wp = document.getElementById('week-picker');
  if (wp) wp.value = getMonday();
  loadJournal();
});
</script>

</body>
</html>